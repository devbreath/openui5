/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery",'./InputBase','./DatePicker','sap/ui/model/type/Date','./library','sap/ui/core/library','sap/ui/core/Control','sap/ui/Device','sap/ui/core/format/DateFormat','sap/ui/core/LocaleData','sap/ui/core/Core','sap/ui/core/format/TimezoneUtil','./TimePickerClocks','./DateTimePickerRenderer','./SegmentedButton','./SegmentedButtonItem','./ResponsivePopover','./Button',"sap/ui/core/IconPool","sap/ui/qunit/utils/waitForThemeApplied","sap/ui/dom/jquery/cursorPos"],function(q,I,D,a,l,c,C,b,d,L,e,T,f,g,S,h,R,B,k,w){"use strict";var P=l.PlacementType,m=l.ButtonType,n="Phone",o=c.CalendarType;var p=D.extend("sap.m.DateTimePicker",{metadata:{library:"sap.m",properties:{minutesStep:{type:"int",group:"Misc",defaultValue:1},secondsStep:{type:"int",group:"Misc",defaultValue:1},showCurrentTimeButton:{type:"boolean",group:"Behavior",defaultValue:false},showTimezone:{type:"boolean",group:"Behavior"},timezone:{type:"string",group:"Data"}},designtime:"sap/m/designtime/DateTimePicker.designtime",dnd:{draggable:false,droppable:true}},constructor:function(i,j,z){var A;if(typeof i!=='string'&&i!==undefined){z=j;j=i;i=j&&j.id;}A=j?Object.keys(j).sort(function(K,E){if(K==="timezone"){return-1;}else if(E==="timezone"){return 1;}return 0;}).reduce(function(E,F){E[F]=j[F];return E;},{}):j;D.call(this,i,A,z);}});var r={Short:"short",Medium:"medium",Long:"long",Full:"full"};var s=C.extend("sap.m.internal.DateTimePickerPopup",{metadata:{library:"sap.m",properties:{forcePhoneView:{type:"boolean",group:"Behavior",defaultValue:false}},aggregations:{_switcher:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},calendar:{type:"sap.ui.core.Control",multiple:false},clocks:{type:"sap.ui.core.Control",multiple:false}}},renderer:{apiVersion:2,render:function(i,j){i.openStart("div",j);i.class("sapMDateTimePopupCont").class("sapMTimePickerDropDown");i.openEnd();var z=j.getAggregation("_switcher");if(z){i.openStart("div");i.class("sapMTimePickerSwitch");i.openEnd();i.renderControl(z);i.close("div");}var A=j.getCalendar();if(A){i.renderControl(A);}i.openStart("div");i.class("sapMTimePickerSep");i.openEnd();i.close("div");var E=j.getClocks();if(E){i.renderControl(E);}i.close("div");}},init:function(){},onBeforeRendering:function(){var i=this.getAggregation("_switcher");if(!i){var j=e.getLibraryResourceBundle("sap.m");var z=j.getText("DATETIMEPICKER_DATE");var A=j.getText("DATETIMEPICKER_TIME");i=new S(this.getId()+"-Switch",{selectedKey:"Cal",items:[new h(this.getId()+"-Switch-Cal",{key:"Cal",text:z}),new h(this.getId()+"-Switch-Clk",{key:"Clk",text:A})]});i.attachSelect(this._handleSelect,this);this.setAggregation("_switcher",i,true);}if(b.system.phone||q('html').hasClass("sapUiMedia-Std-Phone")||this.getForcePhoneView()){i.setVisible(true);i.setSelectedKey("Cal");this.getCalendar().attachSelect(function(){this._addCalendarDelegate();}.bind(this));this._addCalendarDelegate();}else{i.setVisible(false);}},_addCalendarDelegate:function(){var i=this.getAggregation("_switcher"),O={onAfterRendering:function(){this._switchVisibility(i.getSelectedKey());this.getCalendar().removeDelegate(O);}.bind(this)};this.getCalendar().addDelegate(O);},_handleSelect:function(E){var K=E.getParameter("key");this._switchVisibility(K);if(K==="Clk"){this.getClocks()._focusActiveButton();}},_switchVisibility:function(K){var i=this.getCalendar(),j=this.getClocks();if(!i||!j){return;}if(K==="Cal"){i.$().css("display","flex");j.$().css("display","none");i.getFocusDomRef()&&i.getFocusDomRef().focus();}else{i.$().css("display","none");j.$().css("display","");}},switchToTime:function(){var i=this.getAggregation("_switcher");if(i&&i.getVisible()){i.setSelectedKey("Clk");this._switchVisibility("Clk");}},getSpecialDates:function(){return this._oDateTimePicker.getSpecialDates();}});p.prototype.init=function(){D.prototype.init.apply(this,arguments);this._bOnlyCalendar=false;};p.prototype._formatValueAndUpdateOutput=function(i,V){delete this._prefferedValue;if(!this.getDomRef()){return;}var O=i?this._formatValue(i):V;if(!i){var F=this._fallbackParse(V);if(typeof F==="string"){this._bValid=true;this._prefferedValue=F;O=F;}}if(this._bPreferUserInteraction){this.handleInputValueConcurrency(O);}else if(this._$input.val()!==O){this._$input.val(O);this._curpos=this._$input.cursorPos();}};p.prototype.setTimezone=function(i){var j,F,N;if(this.getTimezone()===i){return this;}j=this.getDateValue()||this._parseValue(this.getValue(),false);F=this._formatValue(j,false);this.setProperty("timezone",i);this._oDisplayFormat=null;this._oValueFormat=null;this._oDisplayFormatWithTimezone=null;this._oValueFormatWithTimezone=null;if(this._oTimezonePopup){this._oTimezonePopup.setTitle(this._getTranslatedTimezone(true));}N=this._parseValue(F,true);if(N){this.setProperty("dateValue",N);this.setProperty("value",this._formatValue(N,true));}return this;};p.prototype.ontap=function(E){if(E.target.parentElement.classList.contains("sapMDTPTimezoneLabel")){this._togglePopoverOpen(this._getTimezoneNamePopup(),E.target);return;}D.prototype.ontap.apply(this,arguments);};p.prototype.onAfterRendering=function(){D.prototype.onAfterRendering.apply(this,arguments);if(this._getShowTimezone()){w().then(function(){var i=this.$().find(".sapMDummyContent"),j;if(!i||!i.length){return;}j=i[0].getBoundingClientRect().width;this.$("inner").css("max-width",(j+2)+"px");}.bind(this));}};p.prototype.getIconSrc=function(){return k.getIconURI("date-time");};p.prototype.exit=function(){D.prototype.exit.apply(this,arguments);if(this._oClocks){this._oClocks.destroy();delete this._oClocks;}this._oTimezonePopup=undefined;this._oPopupContent=undefined;b.media.detachHandler(this._handleWindowResize,this);};p.prototype.setDisplayFormat=function(i){this._oDisplayFormatWithTimezone=null;D.prototype.setDisplayFormat.apply(this,arguments);if(this._oClocks){this._oClocks.setValueFormat(x.call(this));this._oClocks.setDisplayFormat(x.call(this));}return this;};p.prototype.setValueFormat=function(V){this._oValueFormatWithTimezone=null;return D.prototype.setValueFormat.apply(this,arguments);};p.prototype.setMinutesStep=function(M){this.setProperty('minutesStep',M,true);if(this._oClocks){this._oClocks.setMinutesStep(M);}return this;};p.prototype._getDefaultValueStyle=function(){return r.Medium;};p.prototype.setMinDate=function(i){D.prototype.setMinDate.call(this,i);if(i){this._oMinDate.setHours(i.getHours(),i.getMinutes(),i.getSeconds());}return this;};p.prototype.setMaxDate=function(i){D.prototype.setMaxDate.call(this,i);if(i){this._oMaxDate.setHours(i.getHours(),i.getMinutes(),i.getSeconds());}return this;};p.prototype.setSecondsStep=function(i){this.setProperty('secondsStep',i,true);if(this._oClocks){this._oClocks.setSecondsStep(i);}return this;};p.prototype.setShowCurrentTimeButton=function(i){var j=this._oClocks;j&&j.setShowCurrentTimeButton(i);return this.setProperty("showCurrentTimeButton",i);};p.prototype._getTimezoneNamePopup=function(){var i;if(this._oTimezonePopup){this._oTimezonePopup.setTitle(this._getTranslatedTimezone(true));return this._oTimezonePopup;}this._oTimezonePopup=new R({showArrow:false,placement:P.VerticalPreferredBottom,offsetX:0,offsetY:3,horizontalScrolling:false,title:this._getTimezone(true)});this.addDependent(this._oTimezonePopup);if(b.system.phone){i=e.getLibraryResourceBundle("sap.m");this._oTimezonePopup.setEndButton(new B({text:i.getText("SUGGESTIONSPOPOVER_CLOSE_BUTTON"),type:m.Emphasized,press:function(){this._oTimezonePopup.close();}.bind(this)}));}return this._oTimezonePopup;};p.prototype._togglePopoverOpen=function(i,O){if(i.isOpen()){i.close();}else{i.openBy(O||this.getDomRef());}};p.prototype._getFormatter=function(i){var j=this._getTimezoneFormatterCacheName(i);if(!this[j]){this[j]=d.getDateTimeWithTimezoneInstance(this._getTimezoneFormatOptions(i));}return this[j];};p.prototype._getBindingFormatOptions=function(){var i=this.getBinding("value")||this.getBinding("dateValue"),j;if(i){j=i.getType();}if(this._isSupportedBindingType(j)){return q.extend({},j.getFormatOptions());}};p.prototype._getTimezoneFormatOptions=function(i){var F=this._getBindingFormatOptions()||{},j=i?this.getDisplayFormat():this.getValueFormat(),z=this.getBinding("value")||this.getBinding("dateValue"),A=z&&z.getType&&z.getType();if(i||!this._getTimezone()||(A&&!A.isA(["sap.ui.model.odata.type.DateTimeWithTimezone"]))){F.showTimezone=false;}if(F.relative===undefined){F.relative=false;}if(F.calendarType===undefined){F.calendarType=i?this.getDisplayFormatType():o.Gregorian;}if(F.strictParsing===undefined){F.strictParsing=true;}if(j&&!this._isSupportedBindingType(A)){F[this._checkStyle(j)?"style":"pattern"]=j;}return F;};p.prototype._getTimezoneFormatterCacheName=function(i){return i?"_oDisplayFormatWithTimezone":"_oValueFormatWithTimezone";};p.prototype._getShowTimezone=function(){var i=this.getBinding("value")||this.getBinding("dateValue"),j=i&&i.getType();if(this.getShowTimezone()===undefined&&j&&j.isA(["sap.ui.model.odata.type.DateTimeWithTimezone"])){return j.getFormatOptions().showTimezone!==false;}return this.getShowTimezone();};p.prototype._getTimezone=function(U){var i=this.getBinding("value")||this.getBinding("dateValue"),j=i&&i.getType();if(!this.getTimezone()&&j&&j.isA(["sap.ui.model.odata.type.DateTimeWithTimezone"])&&i.aValues[1]){return i.aValues[1];}return this.getTimezone()||(U&&e.getConfiguration().getTimezone());};p.prototype._getTranslatedTimezone=function(U){return L.getInstance(e.getConfiguration().getFormatSettings().getFormatLocale()).getTimezoneTranslations()[this._getTimezone(U)];};p.prototype._checkStyle=function(z){if(D.prototype._checkStyle.apply(this,arguments)){return true;}else if(z.indexOf("/")>0){var A=[r.Short,r.Medium,r.Long,r.Long];var E=false;for(var i=0;i<A.length;i++){var F=A[i];for(var j=0;j<A.length;j++){var G=A[j];if(z==F+"/"+G){E=true;break;}}if(E){break;}}return E;}return false;};p.prototype._parseValue=function(V,i,j){var z=this.getBinding("value")||this.getBinding("dateValue"),A=z&&z.getType(),E;if(A&&A.isA(["sap.ui.model.odata.type.DateTimeWithTimezone"])){var F=z.getCurrentValues().slice(0);F[1]=j||this._getTimezone(true);return A.parseValue(V,"string",F)[0];}E=this._getFormatter(i).parse(V,j||this._getTimezone(true));if(!E||!E.length){return null;}return E[0];};p.prototype._formatValue=function(i,V,j){if(!i){return"";}return this._getFormatter(!V).format(i,j||this._getTimezone(true));};p.prototype._fallbackParse=function(V){return this._getFallbackParser().parse(V)?"":null;};p.prototype._getFallbackParser=function(){if(!this._fallbackParser){this._fallbackParser=d.getDateTimeWithTimezoneInstance({showDate:false,showTime:false,showTimezone:true});}return this._fallbackParser;};p.prototype._getPickerParser=function(){if(!this._clocksParser){this._clocksParser=d.getDateTimeWithTimezoneInstance({showTimezone:false});}return this._clocksParser;};p.prototype._getLocaleBasedPattern=function(i){var j=L.getInstance(e.getConfiguration().getFormatSettings().getFormatLocale()),z=i.indexOf("/");if(z>0){return j.getCombinedDateTimePattern(i.substr(0,z),i.substr(z+1));}else{return j.getCombinedDateTimePattern(i,i);}};p.prototype._createPopup=function(){var i,j,z,O,A,E;if(!this._oPopup){z=e.getLibraryResourceBundle("sap.m");O=z.getText("TIMEPICKER_SET");A=z.getText("TIMEPICKER_CANCEL");this._oPopupContent=new s(this.getId()+"-PC");this._oPopupContent._oDateTimePicker=this;this._oOKButton=new B(this.getId()+"-OK",{text:O,type:m.Emphasized,press:_.bind(this)});var H=this._getValueStateHeader();this._oPopup=new R(this.getId()+"-RP",{showCloseButton:false,showHeader:false,placement:P.VerticalPreferedBottom,beginButton:this._oOKButton,content:[H,this._oPopupContent],afterOpen:u.bind(this),afterClose:v.bind(this)});H.setPopup(this._oPopup._oControl);if(b.system.phone){i=this.$("inner").attr("aria-labelledby");j=i?document.getElementById(i).getAttribute("aria-label"):"";this._oPopup.setTitle(j);this._oPopup.setShowHeader(true);this._oPopup.setShowCloseButton(true);}else{this._oPopup._getPopup().setDurations(0,0);this._oPopup.setEndButton(new B(this.getId()+"-Cancel",{text:A,press:t.bind(this)}));}this._oPopup.addStyleClass("sapMDateTimePopup");E=this._oPopup.getAggregation("_popup");if(E.setShowArrow){E.setShowArrow(false);}this.setAggregation("_popup",this._oPopup,true);}};p.prototype._openPopup=function(i){if(!this._oPopup){return;}if(!i){i=this.getDomRef();}this.addStyleClass(I.ICON_PRESSED_CSS_CLASS);var j=this._oPopup.getAggregation("_popup");j.oPopup.setExtraContent([i]);this._oPopup.openBy(i||this);};p.prototype._createPopupContent=function(){var N=!this._oCalendar;D.prototype._createPopupContent.apply(this,arguments);if(N){this._oPopupContent.setCalendar(this._oCalendar);this._oCalendar.attachSelect(y,this);}if(!this._oClocks){this._oClocks=new f(this.getId()+"-Clocks",{minutesStep:this.getMinutesStep(),secondsStep:this.getSecondsStep(),valueFormat:x.call(this),displayFormat:x.call(this),localeId:this.getLocaleId(),showCurrentTimeButton:this.getShowCurrentTimeButton()});this._oPopupContent.setClocks(this._oClocks);}};p.prototype._attachAfterRenderingDelegate=function(){};p.prototype._selectFocusedDateValue=function(i){var j=this._oCalendar;j.removeAllSelectedDates();j.addSelectedDate(i);return this;};p.prototype._fillDateRange=function(){var i=this.getDateValue(),j=true,F;if(i){i=new Date(i.getTime());this._oOKButton.setEnabled(true);}else{j=false;i=this.getInitialFocusedDateValue();if(!i){i=new Date();this._oCalendar.removeAllSelectedDates();}var M=this._oMaxDate.getTime();if(i.getTime()<this._oMinDate.getTime()||i.getTime()>M){i=this._oMinDate;}this._oOKButton.setEnabled(false);}F=this._getPickerParser().format(i,this._getTimezone(true));i=this._getPickerParser().parse(F,T.getLocalTimezone())[0];this._oCalendar.focusDate(i);if(j){if(!this._oDateRange.getStartDate()||this._oDateRange.getStartDate().getTime()!=i.getTime()){this._oDateRange.setStartDate(i);}}this._oClocks._setTimeValues(i);};p.prototype._getSelectedDate=function(){var i=D.prototype._getSelectedDate.apply(this,arguments),j,z;if(i){j=this._oClocks.getTimeValues();z=this._oClocks._getDisplayFormatPattern();if(z.search("h")>=0||z.search("H")>=0){i.setHours(j.getHours());}if(z.search("m")>=0){i.setMinutes(j.getMinutes());}if(z.search("s")>=0){i.setSeconds(j.getSeconds());}if(i.getTime()<this._oMinDate.getTime()){i=new Date(this._oMinDate.getTime());}else if(i.getTime()>this._oMaxDate.getTime()){i=new Date(this._oMaxDate.getTime());}}return i;};p.prototype.getLocaleId=function(){return e.getConfiguration().getFormatSettings().getFormatLocale().toString();};p.prototype.getAccessibilityInfo=function(){var i=D.prototype.getAccessibilityInfo.apply(this,arguments);i.type=e.getLibraryResourceBundle("sap.m").getText("ACC_CTR_TYPE_DATETIMEINPUT");return i;};function _(E){this._handleCalendarSelect();}function t(E){this.onsaphide(E);if(!this.getDateValue()){this._oCalendar.removeAllSelectedDates();}}p.prototype._handleWindowResize=function(i){var j=this.getAggregation("_popup").getContent()[1].getAggregation("_switcher"),z=this.getAggregation("_popup").getContent()[1].getCalendar(),A=this.getAggregation("_popup").getContent()[1].getClocks();if(i.name===n){j.setVisible(true);this.getAggregation("_popup").getContent()[1]._switchVisibility(j.getSelectedKey());}else{j.setVisible(false);A.$().css("display","");z.$().css("display","flex");}};function u(E){this._oCalendar.focus();b.media.attachHandler(this._handleWindowResize,this);this.fireAfterValueHelpOpen();}function v(){this.removeStyleClass(I.ICON_PRESSED_CSS_CLASS);this._oCalendar._closePickers();b.media.detachHandler(this._handleWindowResize,this);this.fireAfterValueHelpClose();}function x(){var i=this.getDisplayFormat();var j;var z=this.getBinding("value");if(z&&z.oType&&(z.oType instanceof a)){i=z.oType.getOutputPattern();}else if(z&&z.oType&&z.oType.oFormat){i=z.oType.oFormat.oFormatOptions.pattern;}else{i=this.getDisplayFormat();}if(!i){i=r.Medium;}var A=i.indexOf("/");if(A>0&&this._checkStyle(i)){i=i.substr(A+1);}if(i==r.Short||i==r.Medium||i==r.Long||i==r.Full){var E=e.getConfiguration().getFormatSettings().getFormatLocale();var F=L.getInstance(E);j=F.getTimePattern(i);}else{j=i;}return j;}function y(E){this._oPopupContent.switchToTime();this._oPopupContent.getClocks()._focusActiveButton();this._oOKButton.setEnabled(true);}return p;});
