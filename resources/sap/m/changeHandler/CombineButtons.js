/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/uid","sap/ui/fl/util/ManagedObjectModel"],function(u){"use strict";var C={};var c="$sap.m.flexibility.CombineButtonsModel";function h(b,m,a,M,p,P,v,o,r){var s="";var e="";var O="";var f=[];var i=sap.ui.getCore().getConfiguration().getRTL();var g=[];return b.reduce(function(j,B,k){var I;var l=k;var n;var q;var S=o.buttonsIdForSave[l];var t;var w="$sap.m.flexibility.MenuButtonModel"+l;return j.then(m.getProperty.bind(m,B,"text")).then(function(R){t=R;return m.createControl("sap.m.MenuItem",a,v,S);}).then(function(x){n=x;return m.findIndexInParentAggregation(B);}).then(function(x){r.insertIndexes[l]=x;return m.createControl("sap.ui.fl.util.ManagedObjectModel",a,v,Object.assign({},S,{id:S.id+'-managedObjectModel'}),{object:B,name:c});}).then(function(x){q=x;return m.insertAggregation(n,"dependents",q,0,v);}).then(function(){return m.createControl("sap.ui.core.CustomData",a,v,Object.assign({},S,{id:S.id+'-customData'}),{key:"{ path: '"+c+">key' }",value:"{ path: '"+c+">value' }"});}).then(function(x){m.bindProperty(n,"text",c+">/text");m.bindProperty(n,"icon",c+">/icon");m.bindProperty(n,"enabled",c+">/enabled");m.bindProperty(n,"visible",c+">/visible");return m.bindAggregation(n,"customData",{path:c+">/customData",template:x,templateShareable:false},v);}).then(function(){if(t){i?g.unshift(t):g.push(t);}var N=Object.assign({},S,{id:S.id+'-originalButtonId'});return m.createControl("sap.ui.core.CustomData",a,v,N);}).then(function(R){I=R;m.setProperty(I,"key","originalButtonId");m.setProperty(I,"value",m.getId(B));return m.removeAggregation(p,P,B);}).then(function(){return m.insertAggregation(p,"dependents",B,0,v);}).then(function(){m.insertAggregation(B,"customData",I,0,v);}).then(function(){m.insertAggregation(M,"items",n,l,v);}).then(function(){return m.createControl("sap.ui.fl.util.ManagedObjectModel",a,v,Object.assign({},S,{id:S.id+'-managedObjectModelMenuItem'}),{object:n,name:w});}).then(function(x){f[l]=x;s=s+O+"${"+w+">/enabled}";e=e+O+"${"+w+">/visible}";O=" || ";return{menuButtonModels:f,menuButtonName:g,propertyEnabled:s,propertyVisible:e};});},Promise.resolve());}C.applyChange=function(o,a,p){if(p.modifier.targets!=="jsControlTree"){return Promise.reject(new Error("Combine buttons change can't be applied on XML tree"));}var b=o.getContent();var m=p.modifier;var v=p.view;var A=p.appComponent;var P;var s;var i;var e;var B;var M;var f;var r={parentAggregation:"",insertIndexes:[]};var g=[];var j=[];return Promise.resolve().then(m.bySelector.bind(m,b.combineButtonSelectors[0],A,v)).then(function(R){s=R;P=m.getParent(s);var k=[];b.combineButtonSelectors.forEach(function(l){var n=Promise.resolve().then(m.bySelector.bind(m,l,A,v));k.push(n);});return Promise.all(k);}).then(function(k){B=k;return m.getParentAggregationName(B[0],P);}).then(function(R){e=R;r.parentAggregation=e;return m.findIndexInParentAggregation(s);}).then(function(k){i=k;return m.createControl("sap.m.Menu",A,v,b.menuIdSelector);}).then(function(k){M=k;return m.attachEvent(M,"itemSelected","sap.m.changeHandler.CombineButtons.pressHandler");}).then(function(){return h(B,m,A,M,P,e,v,b,r);}).then(function(k){g=k.menuButtonModels;j=k.menuButtonName;var l=k.propertyVisible;var n=k.propertyEnabled;return m.createControl("sap.m.MenuButton",A,v,b.menuButtonIdSelector,{visible:"{= "+l+"}",enabled:"{= "+n+"}"});}).then(function(k){f=k;return g.reduce(function(l,n){return l.then(m.insertAggregation.bind(m,f,"dependents",n,0,v));},Promise.resolve());}).then(function(){m.setProperty(f,"text",j.join("/"));return Promise.resolve().then(m.insertAggregation.bind(m,f,"menu",M,0,v)).then(m.insertAggregation.bind(m,P,e,f,i,v)).then(function(){o.setRevertData(r);});});};function d(a,m){return a.reduce(function(p,o){return p.then(function(){return m.getProperty(o,"key");}).then(function(k){if(k==="originalButtonId"){return m.destroy(o);}return undefined;});},Promise.resolve());}C.revertChange=function(o,a,p){var m=p.modifier;var v=p.view;var r=o.getRevertData();var b=o.getContent();var P=r.parentAggregation;var M,e,B;return Promise.resolve().then(function(){return m.bySelector(b.menuButtonIdSelector,p.appComponent,v);}).then(function(R){M=R;e=m.getParent(M);B=b.combineButtonSelectors.slice().reverse();return m.removeAggregation(e,P,M);}).then(function(){return m.destroy(M);}).then(function(){var l=B.length;return B.reduce(function(f,g,i){var I=i;var j;return f.then(function(){return m.bySelector(g,p.appComponent,v);}).then(function(R){j=R;return m.getAggregation(j,"customData");}).then(function(k){return d(k,m);}).then(function(){return m.insertAggregation(e,P,j,r.insertIndexes[l-I-1],v);});},Promise.resolve()).then(function(){o.resetRevertData();});});};C.completeChangeContent=function(o,s,p){var m=p.modifier;var a=p.appComponent;var b=s.combineElementIds;if(b&&b.length>1){var e={};o.addDependentControl(b,"combinedButtons",p);e.combineButtonSelectors=b.map(function(f){return m.getSelector(f,a);});e.menuButtonIdSelector=m.getSelector(a.createId(u()),a);e.menuIdSelector=m.getSelector(a.createId(u()),a);e.buttonsIdForSave=b.map(function(){return m.getSelector(a.createId(u()),a);});o.setContent(e);}else{throw new Error("Combine buttons action cannot be completed: oSpecificChangeInfo.combineElementIds attribute required");}};C.pressHandler=function(e){var b=e.getParameter("item").getModel(c).getObject();b.firePress();};return C;},true);
