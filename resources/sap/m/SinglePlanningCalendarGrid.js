/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['./SinglePlanningCalendarUtilities','sap/ui/core/Control','sap/ui/core/LocaleData','sap/ui/core/Locale','sap/ui/core/InvisibleText','sap/ui/core/format/DateFormat','sap/ui/core/format/TimezoneUtil','sap/ui/core/Core','sap/ui/core/date/UniversalDate','sap/ui/core/dnd/DragDropInfo','sap/ui/unified/library','sap/ui/unified/calendar/DatesRow','sap/ui/unified/calendar/CalendarDate','sap/ui/unified/calendar/CalendarUtils','sap/ui/unified/DateTypeRange','sap/ui/events/KeyCodes','./SinglePlanningCalendarGridRenderer','sap/ui/core/delegate/ItemNavigation',"sap/ui/thirdparty/jquery",'./PlanningCalendarLegend','sap/ui/core/InvisibleMessage','sap/ui/core/library'],function(S,C,L,a,I,D,T,b,U,c,u,d,e,f,g,K,h,k,q,P,l,m){"use strict";var R=4.3125,n=3,B=2.125,o=1.5625,H=3600000/2,O=60*1000,p=0.4375,F=0,r=24,s=m.InvisibleMessageMode;var t=C.extend("sap.m.SinglePlanningCalendarGrid",{metadata:{library:"sap.m",properties:{startDate:{type:"object",group:"Data"},startHour:{type:"int",group:"Data",defaultValue:0},endHour:{type:"int",group:"Data",defaultValue:24},fullDay:{type:"boolean",group:"Data",defaultValue:true},enableAppointmentsDragAndDrop:{type:"boolean",group:"Misc",defaultValue:false},enableAppointmentsResize:{type:"boolean",group:"Misc",defaultValue:false},enableAppointmentsCreate:{type:"boolean",group:"Misc",defaultValue:false},scaleFactor:{type:"float",group:"Data",defaultValue:1}},aggregations:{appointments:{type:"sap.ui.unified.CalendarAppointment",multiple:true,singularName:"appointment",dnd:{draggable:true}},specialDates:{type:"sap.ui.unified.DateTypeRange",multiple:true,singularName:"specialDate"},_columnHeaders:{type:"sap.ui.unified.calendar.DatesRow",multiple:false,visibility:"hidden"},_intervalPlaceholders:{type:"sap.m.SinglePlanningCalendarGrid._internal.IntervalPlaceholder",multiple:true,visibility:"hidden",dnd:{droppable:true}},_blockersPlaceholders:{type:"sap.m.SinglePlanningCalendarGrid._internal.IntervalPlaceholder",multiple:true,visibility:"hidden",dnd:{droppable:true}}},dnd:true,associations:{ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"},legend:{type:"sap.m.PlanningCalendarLegend",multiple:false}},events:{appointmentSelect:{parameters:{appointment:{type:"sap.ui.unified.CalendarAppointment"},appointments:{type:"sap.ui.unified.CalendarAppointment[]"}}},appointmentDrop:{parameters:{appointment:{type:"sap.ui.unified.CalendarAppointment"},startDate:{type:"object"},endDate:{type:"object"},copy:{type:"boolean"}}},appointmentResize:{parameters:{appointment:{type:"sap.ui.unified.CalendarAppointment"},startDate:{type:"object"},endDate:{type:"object"}}},appointmentCreate:{parameters:{startDate:{type:"object"},endDate:{type:"object"}}},cellPress:{parameters:{startDate:{type:"object"},endDate:{type:"object"}}}}}});t.prototype.init=function(){var i=new Date(),j=new d(this.getId()+"-columnHeaders",{showDayNamesLine:false,showWeekNumbers:false,startDate:i}).addStyleClass("sapMSinglePCColumnHeader"),x=(60-i.getSeconds())*1000,y=this._getCoreLocaleData().getTimePattern("medium");j._setAriaRole("columnheader");this.setAggregation("_columnHeaders",j);this.setStartDate(i);this._setColumns(7);this._configureBlockersDragAndDrop();this._configureAppointmentsDragAndDrop();this._configureAppointmentsResize();this._configureAppointmentsCreate();this._oUnifiedRB=sap.ui.getCore().getLibraryResourceBundle("sap.ui.unified");this._oFormatStartEndInfoAria=D.getDateTimeInstance({pattern:"EEEE dd/MM/yyyy 'at' "+y});this._oFormatAriaFullDayCell=D.getDateTimeInstance({pattern:"EEEE dd/MM/yyyy"});this._sLegendId=undefined;setTimeout(this._updateRowHeaderAndNowMarker.bind(this),x);};t.prototype.exit=function(){if(this._oItemNavigation){this.removeDelegate(this._oItemNavigation);this._oItemNavigation.destroy();delete this._oItemNavigation;}};t.prototype.onBeforeRendering=function(){var A=this._createAppointmentsMap(this.getAppointments()),i=this.getStartDate(),j=e.fromLocalJSDate(i),x=this._getColumns();this._oVisibleAppointments=this._calculateVisibleAppointments(A.appointments,this.getStartDate(),x);this._oAppointmentsToRender=this._calculateAppointmentsLevelsAndWidth(this._oVisibleAppointments);this._aVisibleBlockers=this._calculateVisibleBlockers(A.blockers,j,x);this._oBlockersToRender=this._calculateBlockersLevelsAndWidth(this._aVisibleBlockers);if(this._iOldColumns!==x||this._oOldStartDate!==i){this._createBlockersDndPlaceholders(i,x);this._createAppointmentsDndPlaceholders(i,x);}this._oInvisibleMessage=l.getInstance();};t.prototype.onmousedown=function(E){var i=E.target.classList;this._isResizeHandleBottomMouseDownTarget=i.contains("sapMSinglePCAppResizeHandleBottom");this._isResizeHandleTopMouseDownTarget=i.contains("sapMSinglePCAppResizeHandleTop");};t.prototype._isResizingPerformed=function(){return this._isResizeHandleBottomMouseDownTarget||this._isResizeHandleTopMouseDownTarget;};t.prototype._configureBlockersDragAndDrop=function(){this.addDragDropConfig(new c({sourceAggregation:"appointments",targetAggregation:"_blockersPlaceholders",dragStart:function(E){if(!this.getEnableAppointmentsDragAndDrop()){E.preventDefault();return false;}var i=function(){var $=q(".sapMSinglePCOverlay");setTimeout(function(){$.addClass("sapMSinglePCOverlayDragging");});q(document).one("dragend",function(){$.removeClass("sapMSinglePCOverlayDragging");});};i();}.bind(this),dragEnter:function(E){var i=E.getParameter("dragSession"),A=i.getDragControl(),j=i.getDropControl(),x=this.isAllDayAppointment(A._getStartDateWithTimezoneAdaptation(),A._getEndDateWithTimezoneAdaptation()),y=function(){var $=q(i.getIndicator()),z=A.$().outerHeight(),G=A.$().outerWidth(),J=j.$().closest(".sapMSinglePCBlockersColumns").get(0).getBoundingClientRect(),M=j.getDomRef().getBoundingClientRect(),N=(M.left+G)-(J.left+J.width);if(x){$.css("min-height",z);$.css("min-width",Math.min(G,G-N));}else{$.css("min-height",i.getDropControl().$().outerHeight());$.css("min-width",i.getDropControl().$().outerWidth());}};if(!i.getIndicator()){setTimeout(y,0);}else{y();}}.bind(this),drop:function(E){var i=E.getParameter("dragSession"),A=i.getDragControl(),j=i.getDropControl(),x=j.getDate().getJSDate(),y,z=E.getParameter("browserEvent"),G=(z.metaKey||z.ctrlKey),J=this.isAllDayAppointment(A._getStartDateWithTimezoneAdaptation(),A._getEndDateWithTimezoneAdaptation());y=new Date(x);if(J){y.setMilliseconds(A._getEndDateWithTimezoneAdaptation().getTime()-A._getStartDateWithTimezoneAdaptation().getTime());}this.$().find(".sapMSinglePCOverlay").removeClass("sapMSinglePCOverlayDragging");if(J&&A._getStartDateWithTimezoneAdaptation().getTime()===x.getTime()){return;}this.fireAppointmentDrop({appointment:A,startDate:x,endDate:y,copy:G});}.bind(this)}));};t.prototype._configureAppointmentsDragAndDrop=function(){this.addDragDropConfig(new c({sourceAggregation:"appointments",targetAggregation:"_intervalPlaceholders",dragStart:function(E){if(!this.getEnableAppointmentsDragAndDrop()||this._isResizingPerformed()){E.preventDefault();return false;}var i=function(){var $=q(".sapMSinglePCOverlay");setTimeout(function(){$.addClass("sapMSinglePCOverlayDragging");});q(document).one("dragend",function(){$.removeClass("sapMSinglePCOverlayDragging");});};i();}.bind(this),dragEnter:function(E){var i=E.getParameter("dragSession"),A=i.getDragControl(),j=i.getDropControl(),x=this.isAllDayAppointment(A._getStartDateWithTimezoneAdaptation(),A._getEndDateWithTimezoneAdaptation()),y=function(){var $=q(i.getIndicator()),z=A.$().outerHeight(),G=j.$().closest(".sapMSinglePCColumn").get(0).getBoundingClientRect(),J=i.getDropControl().getDomRef().getBoundingClientRect(),M=(J.top+z)-(G.top+G.height);if(x){$.css("min-height",2*i.getDropControl().$().outerHeight());}else{$.css("min-height",Math.min(z,z-M));}};if(!i.getIndicator()){setTimeout(y,0);}else{y();}}.bind(this),drop:function(E){var i=E.getParameter("dragSession"),A=i.getDragControl(),j=i.getDropControl(),x=j.getDate().getJSDate(),y,z=E.getParameter("browserEvent"),G=(z.metaKey||z.ctrlKey),J=this.isAllDayAppointment(A._getStartDateWithTimezoneAdaptation(),A._getEndDateWithTimezoneAdaptation());y=new Date(x);if(J){y.setHours(y.getHours()+1);}else{y.setMilliseconds(A._getEndDateWithTimezoneAdaptation().getTime()-A._getStartDateWithTimezoneAdaptation().getTime());}this.$().find(".sapMSinglePCOverlay").removeClass("sapMSinglePCOverlayDragging");if(!J&&A._getStartDateWithTimezoneAdaptation().getTime()===x.getTime()){return;}this.fireAppointmentDrop({appointment:A,startDate:x,endDate:y,copy:G});}.bind(this)}));};t.prototype._configureAppointmentsResize=function(){var i=new c({sourceAggregation:"appointments",targetAggregation:"_intervalPlaceholders",dragStart:function(E){if(!this.getEnableAppointmentsResize()||!this._isResizingPerformed()){E.preventDefault();return;}var j=E.getParameter("dragSession"),x=j.getDragControl(),y=E.getParameter("browserEvent")&&E.getParameter("browserEvent").target||null;x._sAppointmentPartSuffix=y&&y.id?y.id.replace(x.getId()+"-",""):"";var $=this.$().find(".sapMSinglePCOverlay"),z=q(j.getIndicator()),A=x.$();if(this._isResizeHandleBottomMouseDownTarget){j.setComplexData("bottomHandle","true");}if(this._isResizeHandleTopMouseDownTarget){j.setComplexData("topHandle","true");}z.addClass("sapUiDnDIndicatorHide");setTimeout(function(){$.addClass("sapMSinglePCOverlayDragging");},0);q(document).one("dragend",function(){var G=j.getComplexData("appointmentStartingBoundaries");$.removeClass("sapMSinglePCOverlayDragging");z.removeClass("sapUiDnDIndicatorHide");A.css({top:G.top,height:G.height,"z-index":"auto",opacity:1});});E.getParameter("browserEvent").dataTransfer.setDragImage(v(),0,0);}.bind(this),dragEnter:function(E){var j=E.getParameter("dragSession"),A=j.getDragControl().$().get(0),x=j.getDropControl().getDomRef(),y=j.getComplexData("appointmentStartingBoundaries"),z=function(){var $=q(j.getIndicator());$.addClass("sapUiDnDIndicatorHide");},G,J,M,V,N;if(!y){y={top:A.offsetTop,bottom:A.offsetTop+A.getBoundingClientRect().height,height:A.getBoundingClientRect().height};j.setComplexData("appointmentStartingBoundaries",y);}V=j.getData("bottomHandle")?y.top:y.bottom;G=Math.min(V,x.offsetTop);J=Math.max(V,x.offsetTop+x.getBoundingClientRect().height);M=J-G;N={top:G,height:M,"z-index":1,opacity:0.8};j.getDragControl().$().css(N);if(!j.getIndicator()){setTimeout(z,0);}else{z();}},drop:function(E){var j=E.getParameter("dragSession"),A=j.getDragControl(),x=this.indexOfAggregation("_intervalPlaceholders",j.getDropControl()),y=j.getComplexData("appointmentStartingBoundaries"),z;z=this._calcResizeNewHoursAppPos(A._getStartDateWithTimezoneAdaptation(),A._getEndDateWithTimezoneAdaptation(),x,j.getComplexData("bottomHandle"));this.$().find(".sapMSinglePCOverlay").removeClass("sapMSinglePCOverlayDragging");q(j.getIndicator()).removeClass("sapUiDnDIndicatorHide");A.$().css({top:y.top,height:y.height,"z-index":"auto",opacity:1});if(A._getEndDateWithTimezoneAdaptation().getTime()===z.endDate.getTime()&&A._getStartDateWithTimezoneAdaptation().getTime()===z.startDate.getTime()){return;}this.fireAppointmentResize({appointment:A,startDate:z.startDate,endDate:z.endDate});}.bind(this)});this.addDragDropConfig(i);};t.prototype._configureAppointmentsCreate=function(){this.addDragDropConfig(new c({targetAggregation:"_intervalPlaceholders",dragStart:function(E){if(!this.getEnableAppointmentsCreate()){E.preventDefault();return;}var i=E.getParameter("browserEvent");var $=this.$().find(".sapMSinglePCOverlay");setTimeout(function(){$.addClass("sapMSinglePCOverlayDragging");});q(document).one("dragend",function(){$.removeClass("sapMSinglePCOverlayDragging");q(".sapUiAppCreate").remove();q(".sapUiDnDDragging").removeClass("sapUiDnDDragging");});i.dataTransfer.setDragImage(v(),0,0);var G=E.getParameter("target"),j=G.getAggregation("_intervalPlaceholders"),x=j[0].getDomRef().getBoundingClientRect(),y=x.height,z=Math.floor((x.top-G.getDomRef().getBoundingClientRect().top)/y),A=E.getParameter("dragSession"),J=Math.floor(i.offsetY/y)-z,M,N;if(this._iColumns===1){M=J;}else{var Q=64,V=2,W=Math.floor(j[0].getDomRef().getBoundingClientRect().width)-V,X=Math.floor(Math.floor((i.offsetX-Q))/W),Y=j.length/this._iColumns;M=J+((X)*Y);}if(M<0){M=0;}N=j[M].getDomRef().getBoundingClientRect();A.setComplexData("startingRectsDropArea",{top:Math.ceil(J*y),left:N.left});A.setComplexData("startingDropDate",j[M].getDate());}.bind(this),dragEnter:function(E){var i=E.getParameter("dragSession"),j=i.getDropControl(),x=j.getDomRef(),y=x.offsetHeight,z=x.offsetTop,A=z,G=x.getBoundingClientRect().left,J=G,M=j.$().parents(".sapMSinglePCColumn").get(0),$=q(".sapUiAppCreate");if(!$.get(0)){$=q("<div></div>").addClass("sapUiCalendarApp sapUiCalendarAppType01 sapUiAppCreate");$.appendTo(M);}q(".sapUiDnDDragging").removeClass("sapUiDnDDragging");if(!i.getComplexData("startingRectsDropArea")){i.setComplexData("startingRectsDropArea",{top:z,left:G});i.setComplexData("startingDropDate",j.getDate());}else{A=i.getComplexData("startingRectsDropArea").top;J=i.getComplexData("startingRectsDropArea").left;}if(G!==J){E.preventDefault();return false;}j.$().closest(".sapMSinglePCColumn").find(".sapMSinglePCAppointments").addClass("sapUiDnDDragging");$.css({top:Math.min(A,z)+2,height:Math.abs(A-z)+y-4,left:3,right:3,"z-index":2});i.setIndicatorConfig({display:"none"});},drop:function(E){var i=E.getParameter("dragSession"),j=i.getDropControl(),x=(60/(this.getScaleFactor()*2))*60*1000,y=i.getComplexData("startingDropDate").getTime(),z=j.getDate().getJSDate().getTime(),A=Math.min(y,z),G=Math.max(y,z)+x;this.fireAppointmentCreate({startDate:new Date(A),endDate:new Date(G)});q(".sapUiAppCreate").remove();q(".sapUiDnDDragging").removeClass("sapUiDnDDragging");}.bind(this)}));};t.prototype._calcResizeNewHoursAppPos=function(A,i,j,x){var M=(60/(this.getScaleFactor()*2))*60*1000,y=this.getAggregation("_intervalPlaceholders")[j].getDate().getTime(),z=y+M,V=x?A.getTime():i.getTime(),E=Math.min(V,y),G=Math.max(V,z);return{startDate:new Date(E),endDate:new Date(G)};};t.prototype._adjustAppointmentsHeightforCompact=function(i,j,x,y){var A,z,E,G,J,M,N,Q,V=this._getRowHeight(),W=0;if(this._oAppointmentsToRender[i]){this._oAppointmentsToRender[i].oAppointmentsList.getIterator().forEach(function(X){A=X.getData();z=this.getDomRef().querySelector("#"+A.getId()+"-"+y+"_"+W);E=A._getStartDateWithTimezoneAdaptation();G=A._getEndDateWithTimezoneAdaptation();N=j.getTime()>E.getTime();Q=x.getTime()<G.getTime();J=N?0:this._calculateTopPosition(E);M=Q?0:this._calculateBottomPosition(G);z.style["top"]=J+"rem";z.style["bottom"]=M+"rem";z.querySelector(".sapUiCalendarApp").style["minHeight"]=(V/2-0.1875)+"rem";++W;}.bind(this));}};t.prototype._adjustBlockersHeightforCompact=function(){var M=this._getBlockersToRender().iMaxlevel,i=(M+1)*this._getBlockerRowHeight(),j=this._getColumns()===1?i+p:i,x=this._getBlockerRowHeight();if(M>0){j=j+0.1875;}this.$().find(".sapMSinglePCBlockersColumns").css("height",j+"rem");this._oBlockersToRender.oBlockersList.getIterator().forEach(function(y){y.getData().$().css("top",(x*y.level+0.0625)+"rem");});};t.prototype._adjustBlockersHeightforCozy=function(){var M=this._getBlockersToRender()&&this._getBlockersToRender().iMaxlevel,i;if(this._getColumns()===1){i=(M+1)*this._getBlockerRowHeight();this.$().find(".sapMSinglePCBlockersColumns").css("height",(i+p)+"rem");}};t.prototype.onAfterRendering=function(){var j=this._getColumns(),x=this.getStartDate(),y=this._getRowHeight();if(y===n){for(var i=0;i<j;i++){var z=new e(x.getFullYear(),x.getMonth(),x.getDate()+i),A=this._getDateFormatter().format(z.toLocalJSDate()),E=new U(z.getYear(),z.getMonth(),z.getDate(),this._getVisibleStartHour()),G=new U(z.getYear(),z.getMonth(),z.getDate(),this._getVisibleEndHour(),59,59);this._adjustAppointmentsHeightforCompact(A,E,G,i);}this._adjustBlockersHeightforCompact();}else{this._adjustBlockersHeightforCozy();}this._updateRowHeaderAndNowMarker();_.call(this);};t.prototype._appFocusHandler=function(E,i){var j=sap.ui.getCore().byId(E.target.id)||this._findSrcControl(E);if(j&&j.isA("sap.ui.unified.CalendarAppointment")){this.fireAppointmentSelect({appointment:undefined,appointments:this._toggleAppointmentSelection(undefined,true)});this._focusCellWithKeyboard(j,i);E.preventDefault();}};t.prototype._cellFocusHandler=function(E,i){var G=E.target,j=this._getDateFormatter(),x;if(G.classList.contains("sapMSinglePCRow")||G.classList.contains("sapMSinglePCBlockersColumn")){x=j.parse(G.getAttribute("data-sap-start-date"));if(this._isBorderReached(x,i)){this.fireEvent("borderReached",{startDate:x,next:i===K.ARROW_RIGHT,fullDay:G.classList.contains("sapMSinglePCBlockersColumn")});}}};t.prototype.onsapup=function(E){this._appFocusHandler(E,K.ARROW_UP);};t.prototype.onsapdown=function(E){this._appFocusHandler(E,K.ARROW_DOWN);};t.prototype.onsapright=function(E){this._appFocusHandler(E,K.ARROW_RIGHT);this._cellFocusHandler(E,K.ARROW_RIGHT);};t.prototype.onsapleft=function(E){this._appFocusHandler(E,K.ARROW_LEFT);this._cellFocusHandler(E,K.ARROW_LEFT);};t.prototype.setStartDate=function(i){this._oOldStartDate=this.getStartDate();this.getAggregation("_columnHeaders").setStartDate(i);return this.setProperty("startDate",i);};t.prototype.applyFocusInfo=function(x){var V=this._getVisibleBlockers(),y=this._getVisibleAppointments(),z=Object.keys(y),A,i,j;if(this._sSelectedAppointment){this._sSelectedAppointment.focus();return this;}for(i=0;i<V.length;++i){if(V[i].getId()===x.id){V[i].focus();return this;}}for(i=0;i<z.length;++i){A=y[z[i]];for(j=0;j<A.length;++j){if(A[j].getId()===x.id){A[j].focus();return this;}}}return this;};t.prototype.getSelectedAppointments=function(){return this.getAppointments().filter(function(A){return A.getSelected();});};t.prototype._toggleAppointmentSelection=function(A,j){var x=[],y=A&&A.getDomRef(),z,E,i;if(j){z=this.getAppointments();for(i=0,E=z.length;i<E;i++){if((!A||z[i].getId()!==A.getId())&&z[i].getSelected()){z[i].setProperty("selected",false);x.push(z[i]);}}}if(A){A.setProperty("selected",!A.getSelected());x.push(A);this._sSelectedAppointment=A.getSelected()&&y?A:undefined;}else{this._sSelectedAppointment=undefined;}return x;};t.prototype._isBorderReached=function(i,j){var G=e.fromLocalJSDate(this.getStartDate()),x=new e(G.getYear(),G.getMonth(),G.getDate()+this._getColumns()-1),y=e.fromLocalJSDate(i),z=j===K.ARROW_LEFT&&y.isSame(G),A=j===K.ARROW_RIGHT&&y.isSame(x);return z||A;};t.prototype._focusCellWithKeyboard=function(A,i){var j=this.isAllDayAppointment(A._getStartDateWithTimezoneAdaptation(),A._getEndDateWithTimezoneAdaptation()),x=this._getDateFormatter(),y=new Date(A._getStartDateWithTimezoneAdaptation().getFullYear(),A._getStartDateWithTimezoneAdaptation().getMonth(),A._getStartDateWithTimezoneAdaptation().getDate(),A._getStartDateWithTimezoneAdaptation().getHours()),G=new Date(this.getStartDate().getFullYear(),this.getStartDate().getMonth(),this.getStartDate().getDate(),this.getStartDate().getHours());if(y<G){y=G;}if(this._isBorderReached(y,i)){this.fireEvent("borderReached",{startDate:y,next:i===K.ARROW_RIGHT,fullDay:j});return;}switch(i){case K.ARROW_UP:if(!j){y.setHours(y.getHours()-1);}break;case K.ARROW_DOWN:if(!j){y.setHours(y.getHours()+1);}break;case K.ARROW_LEFT:y.setDate(y.getDate()-1);break;case K.ARROW_RIGHT:y.setDate(y.getDate()+1);break;default:}if(j&&i!==K.ARROW_DOWN){q("[data-sap-start-date='"+x.format(y)+"'].sapMSinglePCBlockersColumn").trigger("focus");}else{q("[data-sap-start-date='"+x.format(y)+"'].sapMSinglePCRow").trigger("focus");}};t.prototype.ontap=function(E){this._fireSelectionEvent(E);};t.prototype.onkeydown=function(E){if(E.which===K.SPACE||E.which===K.ENTER){this._fireSelectionEvent(E);var i=this._findSrcControl(E);if(i&&i.isA("sap.ui.unified.CalendarAppointment")){var j=i.getSelected()?"APPOINTMENT_SELECTED":"APPOINTMENT_UNSELECTED";this._oInvisibleMessage.announce(this._oUnifiedRB.getText(j),s.Polite);}E.preventDefault();}};t.prototype._findSrcControl=function(E){var i=E.target,j=i.parentElement,A;if(!j){return E.srcControl;}else if(j.classList.contains("sapUiCalendarRowApps")){A=j.getAttribute("data-sap-ui-related")||j.id;}else{A=i.getAttribute("data-sap-ui-related")||i.id;}return this.getAppointments().find(function(x){return x.sId===A;});};t.prototype._fireSelectionEvent=function(E){var i=this._findSrcControl(E),G=E.target;if(E.target.classList.contains("sapMSinglePCRow")||E.target.classList.contains("sapMSinglePCBlockersColumn")){this.fireEvent("cellPress",{startDate:this._getDateFormatter().parse(G.getAttribute("data-sap-start-date")),endDate:this._getDateFormatter().parse(G.getAttribute("data-sap-end-date"))});this.fireAppointmentSelect({appointment:undefined,appointments:this._toggleAppointmentSelection(undefined,true)});}else if(i&&i.isA("sap.ui.unified.CalendarAppointment")){if(G.parentElement&&G.parentElement.getAttribute("id")){var j=G.parentElement.getAttribute("id");var x=G.parentElement.getAttribute("data-sap-ui-related");var y=j.replace(x+"-","");i._setAppointmentPartSuffix(y);}this.fireAppointmentSelect({appointment:i,appointments:this._toggleAppointmentSelection(i,!(E.ctrlKey||E.metaKey))});}};t.prototype._getVisibleStartHour=function(){return(this.getFullDay()||!this.getStartHour())?F:this.getStartHour();};t.prototype._getVisibleEndHour=function(){return((this.getFullDay()||!this.getEndHour())?r:this.getEndHour())-1;};t.prototype._isVisibleHour=function(i){var j=this.getStartHour(),E=this.getEndHour();if(!this.getStartHour()){j=F;}if(!this.getEndHour()){E=r;}if(j>E){return j<=i||i<E;}return j<=i&&i<E;};t.prototype._shouldHideRowHeader=function(i){var j=new Date().getHours(),x=f._areCurrentMinutesLessThan(15)&&j===i,y=f._areCurrentMinutesMoreThan(45)&&j===i-1;return x||y;};t.prototype._parseDateStringAndHours=function(i,j){var x=this._getDateFormatter().parse(i);if(j){x.setHours(j);}return x;};t.prototype._getDateFormatter=function(){if(!(this._oDateFormat instanceof D)){this._oDateFormat=D.getDateTimeInstance({pattern:"yyyyMMdd-HHmm"});}return this._oDateFormat;};t.prototype._formatTimeAsString=function(i){var j=this._getHoursPattern()+":mm",x=D.getTimeInstance({pattern:j},new a(this._getCoreLocaleId()));return x.format(i);};t.prototype._addAMPM=function(i){var A=this._getAMPMFormat();return" "+A.format(i);};t.prototype._calculateTopPosition=function(i){var j=i.getHours()-this._getVisibleStartHour(),M=i.getMinutes(),x=this._getRowHeight();return(x*j)+(x/60)*M;};t.prototype._calculateBottomPosition=function(i){var j=this._getVisibleEndHour()+1-i.getHours(),M=i.getMinutes(),x=this._getRowHeight();return(x*j)-(x/60)*M;};t.prototype._updateRowHeaderAndNowMarker=function(){var i=new Date();this._updateNowMarker(i);this._updateRowHeaders(i);setTimeout(this._updateRowHeaderAndNowMarker.bind(this),O);};t.prototype._updateNowMarker=function(i){var $=this.$("nowMarker"),j=this.$("nowMarkerText"),x=this.$("nowMarkerAMPM"),y=!this._isVisibleHour(i.getHours()),M=new Date(i.getTime());M=this._convertToTimezone(M);$.toggleClass("sapMSinglePCNowMarkerHidden",y);$.css("top",this._calculateTopPosition(M)+"rem");j.text(this._formatTimeAsString(i));x.text(this._addAMPM(i));j.append(x);};t.prototype._convertToTimezone=function(i){var j=b.getConfiguration().getTimezone();var N=f._createUniversalUTCDate(i,undefined,true);N=new Date(i.getUTCFullYear(),i.getUTCMonth(),i.getUTCDate(),i.getUTCHours(),i.getUTCMinutes(),i.getUTCSeconds());N.setUTCFullYear(i.getUTCFullYear());N=T.convertToTimezone(N,j);return N;};t.prototype._updateRowHeaders=function(i){var $=this.$(),j=i.getHours(),N=j+1;$.find(".sapMSinglePCRowHeader").removeClass("sapMSinglePCRowHeaderHidden");if(this._shouldHideRowHeader(j)){$.find(".sapMSinglePCRowHeader"+j).addClass("sapMSinglePCRowHeaderHidden");}else if(this._shouldHideRowHeader(N)){$.find(".sapMSinglePCRowHeader"+N).addClass("sapMSinglePCRowHeaderHidden");}};t.prototype._createAppointmentsMap=function(A){var i=this;return A.reduce(function(M,j){var x=j._getStartDateWithTimezoneAdaptation(),y=j._getEndDateWithTimezoneAdaptation(),z,E,G;if(!x||!y){return M;}if(!i.isAllDayAppointment(x,y)){z=e.fromLocalJSDate(x);E=e.fromLocalJSDate(y);while(z.isSameOrBefore(E)){G=i._getDateFormatter().format(z.toLocalJSDate());if(!M.appointments[G]){M.appointments[G]=[];}M.appointments[G].push(j);z.setDate(z.getDate()+1);}}else{M.blockers.push(j);}return M;},{appointments:{},blockers:[]});};t.prototype._calculateVisibleAppointments=function(A,j,x){var V={},y,z,E;for(var i=0;i<x;i++){y=new e(j.getFullYear(),j.getMonth(),j.getDate()+i);z=this._getDateFormatter().format(y.toLocalJSDate());E=this._isAppointmentFitInVisibleHours(y);if(A[z]){V[z]=A[z].filter(E,this).sort(this._sortAppointmentsByStartHourCallBack);}}return V;};t.prototype._isAppointmentFitInVisibleHours=function(i){return function(A){var j=A._getStartDateWithTimezoneAdaptation().getTime(),x=A._getEndDateWithTimezoneAdaptation().getTime(),y=(new U(i.getYear(),i.getMonth(),i.getDate(),this._getVisibleStartHour())).getTime(),z=(new U(i.getYear(),i.getMonth(),i.getDate(),this._getVisibleEndHour(),59,59)).getTime();var E=j<y&&x>z,G=j>=y&&j<z,J=x>y&&x<=z;return E||G||J;};};t.prototype._calculateAppointmentsLevelsAndWidth=function(V){var i=H-((this.getScaleFactor()-1)*5*60*1000);var j=this;return Object.keys(V).reduce(function(A,x){var M=0,y=new S.list(),z=V[x];z.forEach(function(E){var G=new S.node(E),J=E._getStartDateWithTimezoneAdaptation().getTime();if(y.getSize()===0){y.add(G);return;}y.getIterator().forEach(function(N){var Q=true,W=N.getData(),X=W._getStartDateWithTimezoneAdaptation().getTime(),Y=W._getEndDateWithTimezoneAdaptation().getTime(),Z=Y-X;if(Z<i){Y=Y+(i-Z);}if(J>=X&&J<Y){G.level++;M=Math.max(M,G.level);}if(N.next&&N.next.level===G.level){Q=false;}if(J>=Y&&Q){this.interrupt();}});y.insertAfterLevel(G.level,G);});A[x]={oAppointmentsList:j._calculateAppointmentsWidth(y),iMaxLevel:M};return A;},{});};t.prototype._calculateAppointmentsWidth=function(A){A.getIterator().forEach(function(i){var j=i.getData(),x=i.level,y=i.level,z=j._getStartDateWithTimezoneAdaptation().getTime(),E=j._getEndDateWithTimezoneAdaptation().getTime(),G=E-z;if(G<H){E=E+(H-G);}new S.iterator(A).forEach(function(J){var M=J.getData(),N=J.level,Q=M._getStartDateWithTimezoneAdaptation().getTime(),V=M._getEndDateWithTimezoneAdaptation().getTime(),W=V-Q;if(W<H){V=V+(H-W);}if(y>=N){return;}if(z>=Q&&z<V||E>Q&&E<V||z<=Q&&E>=V){i.width=N-y;this.interrupt();return;}if(x<N){x=N;i.width++;}});});return A;};t.prototype._calculateVisibleBlockers=function(i,j,x){var y=new e(j.getYear(),j.getMonth(),j.getDate()+x-1),z=this._isBlockerVisible(j,y);return i.filter(z).sort(this._sortAppointmentsByStartHourCallBack);};t.prototype._isBlockerVisible=function(V,i){return function(A){var j=e.fromLocalJSDate(A._getStartDateWithTimezoneAdaptation()),x=e.fromLocalJSDate(A._getEndDateWithTimezoneAdaptation());var y=j.isBefore(V)&&x.isAfter(i),z=f._isBetween(j,V,i,true),E=f._isBetween(x,V,i,true);return y||z||E;};};t.prototype._calculateBlockersLevelsAndWidth=function(V){var M=0,i=new S.list();V.forEach(function(j){var x=new S.node(j),y=e.fromLocalJSDate(j._getStartDateWithTimezoneAdaptation()),z=e.fromLocalJSDate(j._getEndDateWithTimezoneAdaptation());x.width=f._daysBetween(z,y);if(i.getSize()===0){i.add(x);return;}i.getIterator().forEach(function(A){var E=true,G=A.getData(),J=e.fromLocalJSDate(G._getStartDateWithTimezoneAdaptation()),N=e.fromLocalJSDate(G._getEndDateWithTimezoneAdaptation());if(y.isSameOrAfter(J)&&y.isSameOrBefore(N)){x.level++;M=Math.max(M,x.level);}if(A.next&&A.next.level===x.level){E=false;}if(y.isSameOrAfter(N)&&E){this.interrupt();}});i.insertAfterLevel(x.level,x);},this);return{oBlockersList:i,iMaxlevel:M};};t.prototype._sortAppointmentsByStartHourCallBack=function(A,i){return A.getStartDate().getTime()-i.getStartDate().getTime()||i.getEndDate().getTime()-A.getEndDate().getTime();};t.prototype._getVisibleAppointments=function(){return this._oVisibleAppointments;};t.prototype._getAppointmentsToRender=function(){return this._oAppointmentsToRender;};t.prototype._getVisibleBlockers=function(){return this._aVisibleBlockers;};t.prototype._getBlockersToRender=function(){return this._oBlockersToRender;};t.prototype._setColumns=function(i){this._iOldColumns=this._iColumns;this._iColumns=i;this.getAggregation("_columnHeaders").setDays(i);this.invalidate();return this;};t.prototype._getColumns=function(){return this._iColumns;};t.prototype._getRowHeight=function(){return this._isCompact()?n*this.getScaleFactor():R*this.getScaleFactor();};t.prototype._getBlockerRowHeight=function(){return this._isCompact()?o:B;};t.prototype._isCompact=function(){var i=this.getDomRef();while(i&&i.classList){if(i.classList.contains("sapUiSizeCompact")){return true;}i=i.parentNode;}return false;};t.prototype._getCoreLocaleId=function(){if(!this._sLocale){this._sLocale=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale().toString();}return this._sLocale;};t.prototype._getCoreLocaleData=function(){var i,j;if(!this._oLocaleData){i=this._getCoreLocaleId();j=new a(i);this._oLocaleData=L.getInstance(j);}return this._oLocaleData;};t.prototype._hasAMPM=function(){var i=this._getCoreLocaleData();return i.getTimePattern("short").search("a")>=0;};t.prototype._getHoursFormat=function(){var i=this._getCoreLocaleId();if(!this._oHoursFormat||this._oHoursFormat.oLocale.toString()!==i){var j=new a(i),x=this._getHoursPattern();this._oHoursFormat=D.getTimeInstance({pattern:x},j);}return this._oHoursFormat;};t.prototype._getHoursPattern=function(){return this._hasAMPM()?"h":"H";};t.prototype._getAMPMFormat=function(){var i=this._getCoreLocaleId(),j=new a(i);if(!this._oAMPMFormat||this._oAMPMFormat.oLocale.toString()!==i){this._oAMPMFormat=D.getTimeInstance({pattern:"a"},j);}return this._oAMPMFormat;};t.prototype._getColumnHeaders=function(){return this.getAggregation("_columnHeaders");};t.prototype._getAppointmentAnnouncementInfo=function(A){var i=this._oUnifiedRB.getText("CALENDAR_START_TIME"),E=this._oUnifiedRB.getText("CALENDAR_END_TIME"),j=this._oFormatStartEndInfoAria.format(A._getStartDateWithTimezoneAdaptation()),x=this._oFormatStartEndInfoAria.format(A._getEndDateWithTimezoneAdaptation()),y=i+": "+j+"; "+E+": "+x;return y+"; "+P.findLegendItemForItem(sap.ui.getCore().byId(this._sLegendId),A);};t.prototype.enhanceAccessibilityState=function(i,A){if(i.getId()===this._getColumnHeaders().getId()){A.labelledby=I.getStaticId("sap.m","PLANNINGCALENDAR_DAYS");}};t.prototype._getCellStartEndInfo=function(i,E){var j=this._oUnifiedRB.getText("CALENDAR_START_TIME"),x=this._oUnifiedRB.getText("CALENDAR_END_TIME"),y=!E;if(y){return j+": "+this._oFormatAriaFullDayCell.format(i)+"; ";}return j+": "+this._oFormatStartEndInfoAria.format(i)+"; "+x+": "+this._oFormatStartEndInfoAria.format(E);};t.prototype.isAllDayAppointment=function(A,i){return f._isMidnight(A)&&f._isMidnight(i);};t.prototype._createBlockersDndPlaceholders=function(j,x){this.destroyAggregation("_blockersPlaceholders");for(var i=0;i<x;i++){var y=new U(j.getFullYear(),j.getMonth(),j.getDate()+i);var z=new w({date:y});this.addAggregation("_blockersPlaceholders",z,true);}};t.prototype._createAppointmentsDndPlaceholders=function(x,z){var A=this._getVisibleStartHour(),E=this._getVisibleEndHour();this._dndPlaceholdersMap={};this.destroyAggregation("_intervalPlaceholders");for(var i=0;i<z;i++){var G=new e(x.getFullYear(),x.getMonth(),x.getDate()+i);if(!this._dndPlaceholdersMap[G]){this._dndPlaceholdersMap[G]=[];}for(var j=A;j<=E;j++){var J=this._dndPlaceholdersMap[G],Y=G.getYear(),M=G.getMonth(),N=G.getDate(),Q=this.getScaleFactor()*2,V=60/Q*60;for(var y=0;y<Q;y++){J.push(this._createAppointmentsDndPlaceHolder(new U(Y,M,N,j,0,V*y)));}}}};t.prototype._createAppointmentsDndPlaceHolder=function(i){var j=new w({date:i});this.addAggregation("_intervalPlaceholders",j,true);return j;};t.prototype._getSpecialDates=function(){var j=this.getSpecialDates();for(var i=0;i<j.length;i++){var N=j[i].getSecondaryType()===u.CalendarDayType.NonWorking&&j[i].getType()!==u.CalendarDayType.NonWorking;if(N){var x=new g();x.setType(u.CalendarDayType.NonWorking);x.setStartDate(j[i].getStartDate());if(j[i].getEndDate()){x.setEndDate(j[i].getEndDate());}j.push(x);}}return j;};function v(){var $=q("<span></span>").addClass("sapUiCalAppResizeGhost");$.appendTo(document.body);setTimeout(function(){$.remove();},0);return $.get(0);}var w=C.extend("sap.m.SinglePlanningCalendarGrid._internal.IntervalPlaceholder",{metadata:{library:"sap.m",properties:{date:{type:"object",group:"Data"}}},renderer:{apiVersion:2,render:function(i,j){i.openStart("div",j).class("sapMSinglePCPlaceholder").openEnd().close("div");}}});function _(){var i=this.getDomRef(),j=this.$().find(".sapMSinglePCBlockersColumn").toArray();this._aGridCells=Array.prototype.concat(j);for(var x=0;x<=this._getVisibleEndHour();++x){j=this.$().find("div[data-sap-hour='"+x+"']").toArray();this._aGridCells=this._aGridCells.concat(j);}if(!this._oItemNavigation){this._oItemNavigation=new k();this.addDelegate(this._oItemNavigation);}this._oItemNavigation.setRootDomRef(i);this._oItemNavigation.setItemDomRefs(this._aGridCells);this._oItemNavigation.setCycling(false);this._oItemNavigation.setDisabledModifiers({sapnext:["alt","meta"],sapprevious:["alt","meta"],saphome:["alt","meta"],sapend:["meta"]});this._oItemNavigation.setTableMode(true,true).setColumns(this._getColumns());this._oItemNavigation.setPageSize(this._aGridCells.length);}return t;});
