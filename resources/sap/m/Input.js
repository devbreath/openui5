/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['./InputBase','sap/ui/core/Item','sap/ui/core/Core','sap/ui/core/LabelEnablement','sap/ui/core/AccessKeysEnablement','./ColumnListItem','./GroupHeaderListItem','sap/ui/core/SeparatorItem','./Table','./library','sap/ui/core/IconPool','sap/ui/Device','./SuggestionsPopover','./Toolbar','./ToolbarSpacer','./Button',"sap/ui/core/ResizeHandler","sap/ui/dom/containsOrEquals","sap/base/assert","sap/base/util/deepEqual","sap/m/inputUtils/wordStartsWithValue","sap/m/inputUtils/inputsDefaultFilter","sap/m/inputUtils/highlightDOMElements","sap/m/inputUtils/typeAhead","sap/ui/events/KeyCodes","sap/m/inputUtils/filterItems","sap/m/inputUtils/ListHelpers","sap/m/inputUtils/calculateSelectionStart","sap/m/inputUtils/selectionRange","./InputRenderer","sap/ui/base/ManagedObject","sap/ui/base/ManagedObjectObserver","sap/ui/dom/jquery/selectText"],function(I,a,C,L,A,b,G,S,T,l,c,D,d,e,f,B,R,g,h,j,w,k,m,t,K,n,o,p,s,q,M,r){"use strict";var u=l.ListType;var v=l.InputTextFormatMode;var x=l.InputType;var y=l.ListMode;var z=l.ListSeparators;var E=I.extend("sap.m.Input",{metadata:{interfaces:["sap.ui.core.IAccessKeySupport"],library:"sap.m",properties:{type:{type:"sap.m.InputType",group:"Data",defaultValue:x.Text},maxLength:{type:"int",group:"Behavior",defaultValue:0},dateFormat:{type:"string",group:"Misc",defaultValue:'YYYY-MM-dd',deprecated:true},showValueHelp:{type:"boolean",group:"Behavior",defaultValue:false},valueHelpIconSrc:{type:"sap.ui.core.URI",group:"Behavior",defaultValue:"sap-icon://value-help"},showSuggestion:{type:"boolean",group:"Behavior",defaultValue:false},valueHelpOnly:{type:"boolean",group:"Behavior",defaultValue:false},filterSuggests:{type:"boolean",group:"Behavior",defaultValue:true},maxSuggestionWidth:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:null},startSuggestion:{type:"int",group:"Behavior",defaultValue:1},showTableSuggestionValueHelp:{type:"boolean",group:"Behavior",defaultValue:true},description:{type:"string",group:"Misc",defaultValue:null},fieldWidth:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:'50%'},valueLiveUpdate:{type:"boolean",group:"Behavior",defaultValue:false},selectedKey:{type:"string",group:"Data",defaultValue:""},textFormatMode:{type:"sap.m.InputTextFormatMode",group:"Misc",defaultValue:v.Value},textFormatter:{type:"any",group:"Misc",defaultValue:""},suggestionRowValidator:{type:"any",group:"Misc",defaultValue:""},enableSuggestionsHighlighting:{type:"boolean",group:"Behavior",defaultValue:true},enableTableAutoPopinMode:{type:"boolean",group:"Behavior",defaultValue:false},autocomplete:{type:"boolean",group:"Behavior",defaultValue:true},showClearIcon:{type:"boolean",defaultValue:false},effectiveShowClearIcon:{type:"boolean",defaultValue:false,visibility:"hidden"},separateSuggestions:{type:"boolean",defaultValue:false,visibility:"hidden"},highlightAccKeysRef:{type:"boolean",defaultValue:false,visibility:"hidden"},accesskey:{type:"string",defaultValue:"",visibility:"hidden"}},defaultAggregation:"suggestionItems",aggregations:{suggestionItems:{type:"sap.ui.core.Item",multiple:true,singularName:"suggestionItem"},suggestionColumns:{type:"sap.m.Column",multiple:true,singularName:"suggestionColumn",bindable:"bindable",forwarding:{getter:"_getSuggestionsTable",aggregation:"columns"}},suggestionRows:{type:"sap.m.ColumnListItem",altTypes:["sap.m.GroupHeaderListItem"],multiple:true,singularName:"suggestionRow",bindable:"bindable",forwarding:{getter:"_getSuggestionsTable",aggregation:"items"}},_suggestionPopup:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},_valueHelpIcon:{type:"sap.ui.core.Icon",multiple:false,visibility:"hidden"}},associations:{selectedItem:{type:"sap.ui.core.Item",multiple:false},selectedRow:{type:"sap.m.ColumnListItem",multiple:false}},events:{liveChange:{parameters:{value:{type:"string"},escPressed:{type:"boolean"},previousValue:{type:"string"}}},valueHelpRequest:{parameters:{fromSuggestions:{type:"boolean"}}},suggest:{parameters:{suggestValue:{type:"string"},suggestionColumns:{type:"sap.m.ListBase"}}},suggestionItemSelected:{parameters:{selectedItem:{type:"sap.ui.core.Item"},selectedRow:{type:"sap.m.ColumnListItem"}}},submit:{parameters:{value:{type:"string"}}}},designtime:"sap/m/designtime/Input.designtime"}});c.insertFontFaceStyle();E._DEFAULTFILTER_TABULAR=function(V,H){var J=H.getCells(),i=0;for(;i<J.length;i++){if(J[i].getText){if(w(J[i].getText(),V)){return true;}}}return false;};E._DEFAULTRESULT_TABULAR=function(H){if(!H||H.isA("sap.m.GroupHeaderListItem")){return"";}var J=H.getCells(),i=0;for(;i<J.length;i++){if(J[i].getText){return J[i].getText();}}return"";};E.prototype.init=function(){I.prototype.init.call(this);this._iSetCount=0;this._sProposedItemText=null;this._oRb=sap.ui.getCore().getLibraryResourceBundle("sap.m");if(this.getId().indexOf("popup-input")===-1){this._createSuggestionsPopover();}this._setTypedInValue("");this._bClearButtonPressed=false;this._bAfterOpenFinisihed=false;A.registerControl(this);};var F=function(H){var i=L.getReferencingLabels(this);i.forEach(function(J){C.byId(J).setProperty("highlightAccKeysRef",H);},this);};E.prototype.getAccessKeysFocusTarget=function(){return this.getFocusDomRef();};E.prototype.onAccKeysHighlightStart=function(){F.call(this,true);};E.prototype.onAccKeysHighlightEnd=function(){F.call(this,false);};E.prototype.exit=function(){I.prototype.exit.call(this);this._deregisterEvents();this.cancelPendingSuggest();if(this._iRefreshListTimeout){clearTimeout(this._iRefreshListTimeout);this._iRefreshListTimeout=null;}this._destroySuggestionsTable();if(this._getSuggestionsPopover()){this._oSuggestionPopup=null;this._oSuggPopover.destroy();this._oSuggPopover=null;}this.$().off("click");};E.prototype.onBeforeRendering=function(){var i=this.getSelectedKey(),H=this.getShowValueHelp()&&this.getEnabled()&&this.getEditable(),J=this.getProperty("effectiveShowClearIcon")&&this.getEnabled()&&this.getEditable(),N=this._oValueHelpIcon,O=this._getSuggestionsPopover(),P=O&&this._isSuggestionsPopoverOpen(),Q=O&&O.getInput(),V=P?O._getValueStateHeader().getText():null,U=P?O._getValueStateHeader().getValueState():"";I.prototype.onBeforeRendering.call(this);if(this.getShowClearIcon()){this._getClearIcon().setProperty("visible",J);}else if(this._oClearButton){this._getClearIcon().setProperty("visible",false);}this._deregisterEvents();if(i&&!this.getSelectedItem()&&this.getSuggestionItemByKey(i)){this.setSelectedKey(i);}if(this.getShowSuggestion()){if(this.getShowTableSuggestionValueHelp()){this._addShowMoreButton();}else{this._removeShowMoreButton();}if(Q){Q.setType(this.getType());}}if(H){N=this._getValueHelpIcon();N.setProperty("visible",true,true);}else if(N){N.setProperty("visible",false,true);}if(!this.getWidth()){this.setProperty("width","100%",true);}if(this._hasTabularSuggestions()){this._getSuggestionsTable().setAutoPopinMode(this.getEnableTableAutoPopinMode());this._getSuggestionsTable().setContextualWidth(this.getEnableTableAutoPopinMode()?"Auto":"Inherit");}if(P&&((this.getValueStateText()&&V!==this.getValueStateText())||(this.getValueState()!==U)||(this.getFormattedValueStateText()))){this._updateSuggestionsPopoverValueState();}};E.prototype._getDisplayText=function(i){var H=this.getTextFormatter();if(H){return H(i);}var J=i.getText(),N=i.getKey(),O=this.getTextFormatMode();switch(O){case v.Key:return N;case v.ValueKey:return J+' ('+N+')';case v.KeyValue:return'('+N+') '+J;default:return J;}};E.prototype._onValueUpdated=function(i){if(this._bSelectingItem||i===this._sSelectedValue){return;}var H=this.getSelectedKey(),J,N=this._getSuggestionsPopover(),O=N&&N.getItemsContainer();if(H===''){return;}if(this._hasTabularSuggestions()){J=this._getSuggestionsTable()&&!!this._getSuggestionsTable().getSelectedItem();}else{J=O&&!!O.getSelectedItem();}if(J){return;}this.setProperty("selectedKey",'',true);this.setAssociation("selectedRow",null,true);this.setAssociation("selectedItem",null,true);this.fireSuggestionItemSelected({selectedItem:null,selectedRow:null});};E.prototype.setSelectionItem=function(i,H){this._bSelectingItem=true;if(!i){this.setAssociation("selectedItem",null,true);this.setValue('');return;}var J=this._iSetCount,N;this.setAssociation("selectedItem",i,true);this.setProperty("selectedKey",i.getKey(),true);if(H){this.fireSuggestionItemSelected({selectedItem:i});}if(J!==this._iSetCount){N=this.getValue();}else{N=this._getDisplayText(i);}this._sSelectedValue=N;this.updateInputField(N);if(this.bIsDestroyed){return;}if(!(this.isMobileDevice()&&this.isA("sap.m.MultiInput"))){this._closeSuggestionPopup();}this._bSelectingItem=false;this._resetTypeAhead();};E.prototype.addSuggestionRowGroup=function(i,H,J){H=H||new G({title:M.escapeSettingsValue(i.text)||M.escapeSettingsValue(i.key)});this._createSuggestionPopupContent(true);this.addAggregation("suggestionRows",H,J);return H;};E.prototype.addSuggestionItemGroup=function(i,H,J){H=H||new S({text:M.escapeSettingsValue(i.text)||M.escapeSettingsValue(i.key)});this._createSuggestionPopupContent(false);this.addAggregation("suggestionItems",H,J);return H;};E.prototype.setSelectedItem=function(i){if(typeof i==="string"){i=sap.ui.getCore().byId(i);}if(i!==null&&!(i instanceof a)){return this;}this.setSelectionItem(i);return this;};E.prototype.setSelectedKey=function(i){i=this.validateProperty("selectedKey",i);this.setProperty("selectedKey",i,true);if(this._hasTabularSuggestions()){return this;}if(!i){this.setSelectionItem();return this;}var H=this.getSuggestionItemByKey(i);this.setSelectionItem(H);return this;};E.prototype.getSuggestionItemByKey=function(H){var J=this.getSuggestionItems()||[],N,i;for(i=0;i<J.length;i++){N=J[i];if(N.getKey()===H){return N;}}};E.prototype._getFormattedValueStateText=function(){var i=this._isSuggestionsPopoverOpen(),V=i?this._getSuggestionsPopover()._getValueStateHeader().getFormattedText():null;if(i&&V){return V;}else{return I.prototype.getFormattedValueStateText.call(this);}};E.prototype.setSelectionRow=function(i,H){if(!i){this.setAssociation("selectedRow",null,true);return;}this._bSelectingItem=true;var J,N=this.getSuggestionRowValidator();if(N){J=N(i);if(!(J instanceof a)){J=null;}}var O=this._iSetCount,P="",Q;this.setAssociation("selectedRow",i,true);if(J){P=J.getKey();}this.setProperty("selectedKey",P,true);if(H){this.fireSuggestionItemSelected({selectedRow:i});}if(O!==this._iSetCount){Q=this.getValue();}else{if(J){Q=this._getDisplayText(J);}else{Q=this._getRowResultFunction()(i);}}this._sSelectedValue=Q;this.updateInputField(Q);if(this.bIsDestroyed){return;}if(!(this.isMobileDevice()&&this.isA("sap.m.MultiInput")&&this._isMultiLineMode)){this.setSelectionUpdatedFromList(false);this._closeSuggestionPopup();}this._bSelectingItem=false;};E.prototype.setSelectedRow=function(i){if(typeof i==="string"){i=sap.ui.getCore().byId(i);}if(i!==null&&!(i instanceof b)){return this;}this.setSelectionRow(i);return this;};E.prototype._getValueHelpIcon=function(){var i=this,H=this.getValueHelpIconSrc();if(!this._oValueHelpIcon){this._oValueHelpIcon=this.addEndIcon({id:this.getId()+"-vhi",src:H,useIconTooltip:false,alt:this._oRb.getText("INPUT_VALUEHELP_BUTTON"),decorative:false,noTabStop:true,press:function(J){if(!i.getValueHelpOnly()){var P=this.getParent(),$;if(D.support.touch){$=P.$('inner');$.attr('readonly','readonly');P.focus();$.removeAttr('readonly');}else{P.focus();}i.bValueHelpRequested=true;i._fireValueHelpRequest(false);}}});}else if(this._oValueHelpIcon.getSrc()!==H){this._oValueHelpIcon.setSrc(H);}return this._oValueHelpIcon;};E.prototype._getClearIcon=function(){var i=this;if(this._oClearButton){return this._oClearButton;}this._oClearButton=this.addEndIcon({src:c.getIconURI("decline"),noTabStop:true,visible:false,alt:this._oRb.getText("INPUT_CLEAR_ICON_ALT"),useIconTooltip:false,decorative:false,press:function(){if(i.getValue()!==""){i.fireChange({value:""});i.fireLiveChange({value:""});i.setValue("");i._bClearButtonPressed=true;setTimeout(function(){if(D.system.desktop){i.focus();i._closeSuggestionPopup();}},0);}}},0);return this._oClearButton;};E.prototype._fireValueHelpRequest=function(i){var H="";if(this.getShowSuggestion()&&!this.isMobileDevice()){H=this._getTypedInValue()||"";}else{H=this.getDOMValue();}this.fireValueHelpRequest({fromSuggestions:i,_userInputValue:H});};E.prototype._fireValueHelpRequestForValueHelpOnly=function(){if(this.getEnabled()&&this.getEditable()&&this.getShowValueHelp()&&this.getValueHelpOnly()){if(D.system.phone){this.focus();}this._fireValueHelpRequest(false);}};E.prototype.ontap=function(i){I.prototype.ontap.call(this,i);if(this.isValueHelpOnlyOpener(i.target)){this._fireValueHelpRequestForValueHelpOnly();}if(this.shouldSuggetionsPopoverOpenOnMobile(i)){this._openSuggestionsPopover();}this._bClearButtonPressed=false;};E.prototype.shouldSuggetionsPopoverOpenOnMobile=function(i){return this.isMobileDevice()&&this.getEditable()&&this.getEnabled()&&this.getShowSuggestion()&&(!this._bClearButtonPressed)&&i.target.id!==this.getId()+"-vhi";};E.prototype.setFilterFunction=function(i){if(i===null||i===undefined){this._fnFilter=k;return this;}h(typeof(i)==="function","Input.setFilterFunction: first argument fnFilter must be a function on "+this);this._fnFilter=i;return this;};E.prototype._getFilterFunction=function(i){if(typeof this._fnFilter==="function"&&!i){return this._fnFilter;}return!this._hasTabularSuggestions()?k:E._DEFAULTFILTER_TABULAR;};E.prototype.setRowResultFunction=function(i){var H;if(i===null||i===undefined){this._fnRowResultFilter=E._DEFAULTRESULT_TABULAR;return this;}h(typeof(i)==="function","Input.setRowResultFunction: first argument fnFilter must be a function on "+this);this._fnRowResultFilter=i;H=this.getSelectedRow();if(H){this.setSelectedRow(H);}return this;};E.prototype._getRowResultFunction=function(i){if(typeof this._fnRowResultFilter==="function"&&!i){return this._fnRowResultFilter;}return E._DEFAULTRESULT_TABULAR;};E.prototype.closeSuggestions=function(){this._closeSuggestionPopup();};E.prototype._doSelect=function(i,H){var J=this._$input[0];if(J){var $=this._$input;J.focus();$.selectText(i?i:0,H?H:$.val().length);}return this;};E.prototype._isIncrementalType=function(){var i=this.getType();if(i==="Number"||i==="Date"||i==="Datetime"||i==="Month"||i==="Time"||i==="Week"){return true;}return false;};E.prototype.onsapescape=function(i){if(this._isSuggestionsPopoverOpen()){i.originalEvent._sapui_handledByControl=true;this.setSelectionUpdatedFromList(false);this._closeSuggestionPopup();if(this._getTypedInValue()!==this.getValue()){this.setValue(this._getTypedInValue());}return;}if(this.getValueLiveUpdate()){this.setProperty("value",this.getLastValue(),true);}if(I.prototype.onsapescape){I.prototype.onsapescape.apply(this,arguments);}};E.prototype.onsapenter=function(i){var P=this._isSuggestionsPopoverOpen(),H=!this.hasStyleClass("sapMFocus")&&P,J=this._hasTabularSuggestions()?this.getSuggestionRows():this.getSuggestionItems(),V,N;this.cancelPendingSuggest();H&&this.setSelectionUpdatedFromList(true);if(this.getShowSuggestion()&&this._bDoTypeAhead&&P){N=this._getSuggestionsPopover().getItemsContainer().getSelectedItem();if(this._hasTabularSuggestions()){N&&this.setSelectionRow(N,true);}else{N&&this.setSelectionItem(o.getItemByListItem(J,N),true);}}if(P&&!this.isComposingCharacter()){this._closeSuggestionPopup();V=this.getDOMValue()?this.getDOMValue().length:null;this.selectText(V,V);}!H&&I.prototype.onsapenter.apply(this,arguments);if(this.getEnabled()&&this.getEditable()&&!(this.getValueHelpOnly()&&this.getShowValueHelp())){this.fireSubmit({value:this.getValue()});}if(!this.isMobileDevice()){this._resetTypeAhead();}};E.prototype.onsapfocusleave=function(i){var H=this._getSuggestionsPopover(),P=H&&H.getPopover(),J=P&&P.isA("sap.m.Popover"),N=i.relatedControlId&&sap.ui.getCore().byId(i.relatedControlId),O=N&&N.getFocusDomRef(),Q=P&&O&&g(P.getDomRef(),O);if(J){if(Q&&!H.getValueStateActiveState()){this._bPopupHasFocus=true;if(D.system.desktop&&j(P.getFocusDomRef(),O)||N.isA("sap.m.GroupHeaderListItem")){this.focus();}}else{if(this.getDOMValue()===this._sSelectedSuggViaKeyboard){this._sSelectedSuggViaKeyboard=null;}}}if(!Q){I.prototype.onsapfocusleave.apply(this,arguments);}this.bValueHelpRequested=false;};E.prototype.onsaptabnext=function(){if(!this.isMobileDevice()&&this._sProposedItemText&&!this._bAfterOpenFinisihed){var i=this.getSuggestionItems().filter(function(H){return H.getText()===this._sProposedItemText;}.bind(this))[0];if(i){this.setSelectionItem(i,true);this.selectText(0,0);}}};E.prototype.onmousedown=function(i){if(this._isSuggestionsPopoverOpen()){i.stopPropagation();}};["onsapup","onsapdown","onsappageup","onsappagedown","onsaphome","onsapend"].forEach(function(N){E.prototype[N]=function(i){if((N==="onsapup"||N==="onsapdown")&&this.isComposingCharacter()){return;}if(this.getShowSuggestion()){this._getSuggestionsPopover().handleListNavigation(this,i);if(this._isIncrementalType()){i.setMarked();}this.setSelectionUpdatedFromList(true);}};});E.prototype.setSelectionUpdatedFromList=function(U){this._bSelectionUpdatedFromList=U;};E.prototype.getSelectionUpdatedFromList=function(){return this._bSelectionUpdatedFromList;};E.prototype.updateSelectionFromList=function(i){if(this._hasTabularSuggestions()&&(this.getSelectedRow()!==i)){this.setSelectionRow(i,true);}else{var N=o.getItemByListItem(this.getSuggestionItems(),i);N&&(this.getSelectedItem()!==N.getId())&&this.setSelectionItem(N,true);}this.setSelectionUpdatedFromList(false);};E.prototype._deregisterEvents=function(){this._deregisterPopupResize();if(this.isMobileDevice()&&this._getSuggestionsPopover()&&this._getSuggestionsPopover().getPopover()){this.$().off("click");}};E.prototype.updateSuggestionItems=function(){this._bSuspendInvalidate=true;this.updateAggregation("suggestionItems");this._synchronizeSuggestions();this._bSuspendInvalidate=false;return this;};E.prototype.invalidate=function(){if(!this._bSuspendInvalidate){I.prototype.invalidate.apply(this,arguments);}};E.prototype.cancelPendingSuggest=function(){if(this._iSuggestDelay){clearTimeout(this._iSuggestDelay);this._iSuggestDelay=null;}};E.prototype._triggerSuggest=function(V){var i=this._getSuggestionsPopover().getItemsContainer();this.cancelPendingSuggest();this._bShouldRefreshListItems=true;if(!V){V="";}if(V.length>=this.getStartSuggestion()){this._iSuggestDelay=setTimeout(function(){if(this._sPrevSuggValue!==V){this._bBindingUpdated=false;this.fireSuggest({suggestValue:V});if(!this._bBindingUpdated){this._refreshItemsDelayed();}this._sPrevSuggValue=V;}}.bind(this),300);}else if(this.isMobileDevice()){if(i instanceof T){i.addStyleClass("sapMInputSuggestionTableHidden");}else if(i&&i.destroyItems){i.destroyItems();}}else if(this._isSuggestionsPopoverOpen()){setTimeout(function(){var N=this.getDOMValue()||'';if(N.length<this.getStartSuggestion()){this._closeSuggestionPopup();}}.bind(this),0);}};E.prototype._shouldTriggerSuggest=function(){return!this._bPopupHasFocus&&!this.getStartSuggestion()&&!this.getValue()&&this.getShowSuggestion();};E.prototype.setShowTableSuggestionValueHelp=function(V){var i=this._getSuggestionsPopover();this.setProperty("showTableSuggestionValueHelp",V,true);if(!i.getPopover()){return this;}if(V){this._addShowMoreButton();}else{this._removeShowMoreButton();}return this;};E.prototype.onchange=function(i){if(this.getShowValueHelp()||this.getShowSuggestion()||this.getProperty("effectiveShowClearIcon")){return;}this.onChange(i);};E.prototype.oninput=function(i){I.prototype.oninput.call(this,i);if(i.isMarked("invalid")){return;}var V=this.getDOMValue(),H,J,N;if(this.getValueLiveUpdate()){this.setProperty("value",V,true);this._onValueUpdated(V);}this.fireLiveChange({value:V,newValue:V});this.addStyleClass("sapMFocus");if(this.getShowSuggestion()&&!this.isMobileDevice()){H=this._getSuggestionsPopover();J=H.getItemsContainer();this._triggerSuggest(V);if(J&&!H.getValueStateActiveState()){N=J&&J.getSelectedItem();J.removeStyleClass("sapMListFocus");N&&N.removeStyleClass("sapMLIBFocused");}else if(H.getValueStateActiveState()&&document.activeElement.tagName!=="A"){H._getValueStateHeader().removeStyleClass("sapMPseudoFocus");}}this._handleTypeAhead(this);};E.prototype.onkeydown=function(i){this._bDoTypeAhead=!D.os.android&&this.getAutocomplete()&&(i.which!==K.BACKSPACE)&&(i.which!==K.DELETE);};E.prototype.onkeyup=function(i){var V=this.getValue();var H=this.getLastValue();if([K.BACKSPACE,K.DELETE].indexOf(i.which)!==-1&&!V){this.getShowSuggestion()&&this.setSelectedKey(null);(H!==V)&&this.setLastValue(H);}this.getShowClearIcon()&&this.setProperty("effectiveShowClearIcon",!!V);};E.prototype.getValue=function(){return this.getDomRef("inner")&&this._$input?this.getDOMValue():this.getProperty("value");};E.prototype._refreshItemsDelayed=function(){clearTimeout(this._iRefreshListTimeout);this._iRefreshListTimeout=setTimeout(this._refreshListItems.bind(this),0);};E.prototype._clearSuggestionPopupItems=function(){var i=this._getSuggestionsPopover().getItemsContainer();if(!i){return;}if(i instanceof T){i.removeSelections(true);}else{i.destroyItems();}};E.prototype._hideSuggestionPopup=function(){var i=this._getSuggestionsPopover(),P=i.getPopover(),H=i.getItemsContainer();if(!this.isMobileDevice()){if(this._isSuggestionsPopoverOpen()){this._sCloseTimer=setTimeout(function(){this.cancelPendingSuggest();if(this._getTypedInValue()){this.setDOMValue(this._getTypedInValue());}P.close();}.bind(this),0);}}else if(this._hasTabularSuggestions()&&H){H.addStyleClass("sapMInputSuggestionTableHidden");}this.$("SuggDescr").text("");this.$("inner").removeAttr("aria-activedescendant");};E.prototype._openSuggestionPopup=function(O){if(!this.isMobileDevice()){if(this._sCloseTimer){clearTimeout(this._sCloseTimer);this._sCloseTimer=null;}if(!this._isSuggestionsPopoverOpen()&&!this._sOpenTimer&&O!==false&&this.getShowSuggestion()){this._sOpenTimer=setTimeout(function(){this._sOpenTimer=null;this._getSuggestionsPopover()&&this._openSuggestionsPopover();}.bind(this),0);}}};E.prototype._applySuggestionAcc=function(N){var i="",H=this._oRb;setTimeout(function(){if(N===1){i=H.getText("INPUT_SUGGESTIONS_ONE_HIT");}else if(N>1){i=H.getText("INPUT_SUGGESTIONS_MORE_HITS",N);}else{i=H.getText("INPUT_SUGGESTIONS_NO_HIT");}this.$("SuggDescr").text(i);}.bind(this),0);};E.prototype._refreshListItems=function(){var i=this.getShowSuggestion(),H=this._bDoTypeAhead?this._getTypedInValue():(this.getDOMValue()||""),J,N;if(!i||!this._bShouldRefreshListItems||!this.getDomRef()||(!this.isMobileDevice()&&!this.$().hasClass("sapMInputFocused"))){return null;}this._clearSuggestionPopupItems();if(H.length<this.getStartSuggestion()){this._hideSuggestionPopup();return false;}J=this._getFilteredSuggestionItems(H);N=J.items.length;if(N>0&&!this.getValueHelpOnly()){this._openSuggestionPopup(this.getValue().length>=this.getStartSuggestion());}else{this._hideSuggestionPopup();}this._applySuggestionAcc(N);};E.prototype.addSuggestionItem=function(i){this.addAggregation("suggestionItems",i,true);this._synchronizeSuggestions();this._createSuggestionPopupContent();return this;};E.prototype.insertSuggestionItem=function(i,H){this.insertAggregation("suggestionItems",H,i,true);this._synchronizeSuggestions();this._createSuggestionPopupContent();return this;};E.prototype.removeSuggestionItem=function(i){var H=this.removeAggregation("suggestionItems",i,true);this._synchronizeSuggestions();return H;};E.prototype.removeAllSuggestionItems=function(){var i=this.removeAllAggregation("suggestionItems",true);this._synchronizeSuggestions();return i;};E.prototype.destroySuggestionItems=function(){this.destroyAggregation("suggestionItems",true);this._synchronizeSuggestions();return this;};E.prototype.bindAggregation=function(){if(arguments[0]==="suggestionRows"||arguments[0]==="suggestionColumns"||arguments[0]==="suggestionItems"){this._createSuggestionPopupContent(arguments[0]==="suggestionRows"||arguments[0]==="suggestionColumns");this._bBindingUpdated=true;}return I.prototype.bindAggregation.apply(this,arguments);};E.prototype._closeSuggestionPopup=function(){this._bShouldRefreshListItems=false;this.cancelPendingSuggest();this._isSuggestionsPopoverOpen()&&this._getSuggestionsPopover().getPopover().close();if(!this.isMobileDevice()&&this.$().hasClass("sapMInputFocused")){this.openValueStateMessage();}this.$("SuggDescr").text("");this.$("inner").removeAttr("aria-activedescendant");this._sPrevSuggValue=null;};E.prototype._synchronizeSuggestions=function(){var i=this._getSuggestionsPopover(),P=i&&i.getInput(),H=P&&P.getFocusDomRef();if(document.activeElement===this.getFocusDomRef()||document.activeElement===H){this._bShouldRefreshListItems=true;this._refreshItemsDelayed();}if(!this.getDomRef()||this._isSuggestionsPopoverOpen()){return;}this._synchronizeSelection();};E.prototype._synchronizeSelection=function(){var i=this.getSelectedKey();if(!i){return;}if(this.getValue()&&!this.getSelectedItem()&&!this.getSelectedRow()){return;}this.setSelectedKey(i);};E.prototype.onfocusin=function(i){I.prototype.onfocusin.apply(this,arguments);this.addStyleClass("sapMInputFocused");if(!this.isMobileDevice()&&this._isSuggestionsPopoverOpen()){this.closeValueStateMessage();}if(this._shouldTriggerSuggest()){this._triggerSuggest(this.getValue());}this._bPopupHasFocus=undefined;this._sPrevSuggValue=null;};E.prototype.oncompositionend=function(i){I.prototype.oncompositionend.apply(this,arguments);if(!D.browser.firefox){this._handleTypeAhead(this);}};E.prototype._handleTypeAhead=function(i){var V=this.getValue();if((i&&i.getValue().toLowerCase())===(this._sProposedItemText&&this._sProposedItemText.toLowerCase())){return;}this._setTypedInValue(V);i._sProposedItemText=null;if(!this._bDoTypeAhead||V===""||V.length<this.getStartSuggestion()||document.activeElement!==this.getFocusDomRef()){return;}var H=i._hasTabularSuggestions(),J=H?i.getSuggestionRows():i.getSuggestionItems(),N=function(P){if(!P){return"";}return H?i._getRowResultFunction()(P):P.getText();};var O=t(V,this,J,function(P){return this._formatTypedAheadValue(N(P));}.bind(this));i._sProposedItemText=N(O[0]);};E.prototype._resetTypeAhead=function(i){i=i||this;i._sProposedItemText=null;this._setTypedInValue('');};E.prototype.onsapright=function(){var V=this.getValue();if(!this.getAutocomplete()){return;}if(this._getTypedInValue()!==V){this._setTypedInValue(V);this.fireLiveChange({value:V,newValue:V});}};E.prototype._formatTypedAheadValue=function(N){var i=this._getTypedInValue();if(N.toLowerCase().indexOf(i.toLowerCase())===0){return i.concat(N.substring(i.length,N.length));}else{return N;}};E.prototype.onsapshow=function(i){if(!this.getEnabled()||!this.getEditable()||!this.getShowValueHelp()){return;}this.bValueHelpRequested=true;this._fireValueHelpRequest(false);i.preventDefault();i.stopPropagation();};E.prototype.onsaphide=E.prototype.onsapshow;E.prototype.onsapselect=function(i){this._fireValueHelpRequestForValueHelpOnly();};E.prototype.onfocusout=function(i){I.prototype.onfocusout.apply(this,arguments);this.removeStyleClass("sapMInputFocused");this.$("SuggDescr").text("");};E.prototype._hasTabularSuggestions=function(){return!!(this.getAggregation("suggestionColumns")&&this.getAggregation("suggestionColumns").length);};E.prototype._getSuggestionsTable=function(){if(this._bIsBeingDestroyed){return null;}if(!this._oSuggestionsTable){this._oSuggestionsTable=this._createSuggestionsTable();}return this._oSuggestionsTable;};E.prototype._destroySuggestionsTable=function(){if(this._oSuggestionsTable){this._oSuggestionsTable.destroy();this._oSuggestionsTable=null;}};E.prototype._createSuggestionsTable=function(){var i;var H=new T(this.getId()+"-popup-table",{mode:y.SingleSelectMaster,showNoData:false,showSeparators:this.getProperty("separateSuggestions")?z.Inner:z.None,width:"100%",enableBusyIndicator:false,rememberSelections:false,itemPress:function(J){if(D.system.desktop){this.focus();}var N=J.getParameter("listItem");this.setSelectionRow(N,true);}.bind(this),sticky:[l.Sticky.ColumnHeaders]});H.addEventDelegate({onAfterRendering:function(){var J;if(!this.getEnableSuggestionsHighlighting()){return;}J=H.$().find('tbody .sapMLabel');m(J,this._getTypedInValue());}},this);if(this.isMobileDevice()){H.addStyleClass("sapMInputSuggestionTableHidden");}H.updateItems=function(){T.prototype.updateItems.apply(this,arguments);this._refreshItemsDelayed();return this;};i=new r(function(J){var N=J.mutation;var O=J.child;var P=J.name==="items";switch(N){case"insert":if(P){O.setType(u.Active);this._createSuggestionPopupContent(true);this._synchronizeSuggestions();}break;case"remove":if(P){this._synchronizeSuggestions();}break;default:break;}}.bind(this));i.observe(H,{aggregations:["items","columns"]});return H;};E.prototype.clone=function(){var i=I.prototype.clone.apply(this,arguments);i.setRowResultFunction(this._fnRowResultFilter);i.setValue(this.getValue());return i;};E.prototype.setValue=function(V){this._iSetCount++;I.prototype.setValue.call(this,V);this._onValueUpdated(V);this._setTypedInValue("");this.setProperty("effectiveShowClearIcon",!!V);return this;};E.prototype.setDOMValue=function(i){this._$input.val(i);};E.prototype.getDOMValue=function(){return this._$input.val();};E.prototype._getInputValue=function(){var V=I.prototype._getInputValue.apply(this,arguments);return V;};E.prototype.updateInputField=function(N){if(this._isSuggestionsPopoverOpen()&&this.isMobileDevice()){this._getSuggestionsPopover().getInput().setValue(N)._doSelect();}else{N=this._getInputValue(N);this.setDOMValue(N);this.onChange(null,null,N);}};E.prototype.getAccessibilityInfo=function(){var i=I.prototype.getAccessibilityInfo.apply(this,arguments);i.description=((i.description||"")+" "+this.getDescription()).trim();return i;};E.prototype.preventChangeOnFocusLeave=function(i){return this.bFocusoutDueRendering||this.bValueHelpRequested;};E.prototype._getShowMoreButton=function(){return this._getSuggestionsPopover().getShowMoreButton();};E.prototype._getShowMoreButtonPress=function(){var i,H=this._getTypedInValue();if(this.getShowTableSuggestionValueHelp()){if(H){i=H;this.updateDomValue(i);this._resetTypeAhead();this._setTypedInValue(i);}this._fireValueHelpRequest(true);this._closeSuggestionPopup();}};E.prototype._addShowMoreButton=function(){var i=this._getSuggestionsPopover();var P=i&&i.getPopover();if(!P||!this._hasTabularSuggestions()||this._getShowMoreButton()){return;}var H=new B({text:this._oRb.getText("INPUT_SUGGESTIONS_SHOW_ALL"),press:this._getShowMoreButtonPress.bind(this)});if(P.isA("sap.m.Dialog")){i.setShowMoreButton(H);}else{i.setShowMoreButton(new e({content:[new f(),H]}));}};E.prototype._removeShowMoreButton=function(){var i=this._getSuggestionsPopover();var P=i&&i.getPopover();if(P&&this._hasTabularSuggestions()&&this._getShowMoreButton()){i.removeShowMoreButton();}};E.prototype._hasShowSelectedButton=function(){return false;};E.prototype._createSuggestionPopupContent=function(i){var H=this._getSuggestionsPopover();var J=H.getItemsContainer();if(J&&((J.isA("sap.m.Table")&&!i)||(J.isA("sap.m.List")&&i))){J.destroy();J=null;this._destroySuggestionsTable();}if(this._bIsBeingDestroyed||!H||J){return;}H.initContent(this.getId(),i?this._getSuggestionsTable():null);if(!this._hasTabularSuggestions()&&!i){this._decorateSuggestionsPopoverList(H.getItemsContainer());}else{this._decorateSuggestionsPopoverTable();}};E.prototype._decorateSuggestionsPopoverList=function(i){if(!i||!i.isA("sap.m.List")){return;}i.addEventDelegate({onAfterRendering:function(){var H,J;if(!this.getEnableSuggestionsHighlighting()){return;}H=i.$().find('.sapMSLIInfo, .sapMSLITitleOnly');J=this._bDoTypeAhead?this._getTypedInValue():this.getValue();J=(J||"").toLowerCase();m(H,J);}},this);i.attachItemPress(function(H){if(D.system.desktop){this.focus();}var J=H.getParameter("listItem");if(!J.isA("sap.m.GroupHeaderListItem")){this.setSelectionItem(o.getItemByListItem(this.getSuggestionItems(),J),true);}},this);};E.prototype._decorateSuggestionsPopoverTable=function(){if(this.getShowTableSuggestionValueHelp()){this._addShowMoreButton();}};E.prototype._decoratePopupInput=function(i){if(!i){return;}i.setValueLiveUpdate(true);i.setValueState(this.getValueState());i.setShowValueHelp(this.getShowValueHelp());i.attachValueHelpRequest(function(){this.fireValueHelpRequest({fromSuggestions:true});this._getSuggestionsPopover().iPopupListSelectedIndex=-1;this._closeSuggestionPopup();}.bind(this));i.attachLiveChange(function(H){var V=H.getParameter("newValue");this.setDOMValue(this._getInputValue(this._getSuggestionsPopover().getInput().getValue()));this._triggerSuggest(V);this.fireLiveChange({value:V,newValue:V});}.bind(this));i._handleTypeAhead=function(){E.prototype._handleTypeAhead.call(i,this);}.bind(this);i._resetTypeAhead=function(){E.prototype._resetTypeAhead.call(i,this);}.bind(this);i.addEventDelegate({onsapenter:function(){this.setValue(this._sProposedItemText);}},this);return i;};E.prototype.forwardEventHandlersToSuggPopover=function(i){i.setOkPressHandler(this._closeSuggestionPopup.bind(this));i.setCancelPressHandler(this._closeSuggestionPopup.bind(this));};E.prototype._getSuggestionsPopover=function(){return this._oSuggPopover;};E.prototype._createSuggestionsPopover=function(){var i=this._oSuggPopover=new d(this);i.decorateParent(this);i.setInputLabels(this.getLabels.bind(this));this._createSuggestionsPopoverPopup();this.forwardEventHandlersToSuggPopover(i);i.attachEvent(d.M_EVENTS.SELECTION_CHANGE,function(H){var J=H.getParameter("newItem"),N=this.calculateNewValue(J),O=J&&J.isA("sap.m.GroupHeaderListItem"),P=this.getFocusDomRef(),Q=P&&P.value.substring(0,P.selectionStart),U=H.getParameter("previousItem"),V=U&&U.isA("sap.m.GroupHeaderListItem"),W=p(s(P,V),N,Q,V);if(!J||O){this.setDOMValue(Q);}else{this.setDOMValue(N);W=(W===0&&N.indexOf(Q)===0)?Q.length:W;this._doSelect(W);}this._sSelectedSuggViaKeyboard=N;},this);if(this.getShowTableSuggestionValueHelp()){this._addShowMoreButton();}return this._oSuggPopover;};E.prototype.calculateNewValue=function(i){if(!i||(i&&i.isA("sap.m.GroupHeaderListItem"))){return"";}if(i.isA("sap.m.ColumnListItem")){return this._getInputValue(this._getRowResultFunction()(i));}if(i.isA("sap.m.StandardListItem")){return this._getInputValue(i.getTitle());}};E.prototype._createSuggestionsPopoverPopup=function(){var i=this._getSuggestionsPopover();var P;i.createSuggestionPopup(this,{showSelectedButton:this._hasShowSelectedButton()},E);this._decoratePopupInput(i.getInput());P=i.getPopover();P.attachBeforeOpen(function(){this._updateSuggestionsPopoverValueState();},this);P.attachBeforeClose(function(){this._updateSuggestionsPopoverValueState();},this);P.attachAfterOpen(function(){this._handleTypeAhead(this);},this);if(this.isMobileDevice()){P.attachBeforeClose(function(){this.setDOMValue(this._getInputValue(i.getInput().getValue()));this.onChange();},this).attachAfterClose(function(){var H=i.getItemsContainer();if(!H){return;}if(T&&!(H instanceof T)){H.destroyItems();}else{H.removeSelections(true);}}).attachAfterOpen(function(){this._triggerSuggest(this.getValue());this._refreshListItems();},this).attachBeforeOpen(function(){var H=i.getInput();["placeholder","maxLength","value","showClearIcon","effectiveShowClearIcon"].forEach(function(J){H.setProperty(J,this.getProperty(J));},this);},this);}else{P.attachAfterClose(function(){var H=this._getSuggestionsPopover().getItemsContainer();var J=H&&H.getSelectedItem();var N=this.getDomRef();if(this.getSelectionUpdatedFromList()){this.updateSelectionFromList(J);}if(!H){return;}this._bAfterOpenFinisihed=false;if(H instanceof T){J&&J.removeStyleClass("sapMLIBFocused");H.removeSelections(true);}else{H.destroyItems();}this._deregisterPopupResize();if(N&&N.contains(document.activeElement)){this.addStyleClass("sapMFocus");}},this).attachBeforeOpen(function(){i._sPopoverContentWidth=this.getMaxSuggestionWidth();i.resizePopup(this);this._registerPopupResize();this._bAfterOpenFinisihed=false;},this).attachAfterOpen(function(){this._bAfterOpenFinisihed=true;},this);}this.setAggregation("_suggestionPopup",P);this._oSuggestionPopup=P;};E.prototype._registerPopupResize=function(){var i=this._getSuggestionsPopover();this._sPopupResizeHandler=R.register(this,i.resizePopup.bind(i,this));};E.prototype._deregisterPopupResize=function(){if(this._sPopupResizeHandler){this._sPopupResizeHandler=R.deregister(this._sPopupResizeHandler);}};E.prototype.showItems=function(i){var H,J,N=this._getFilterFunction();if(!this.getEnabled()||!this.getEditable()||this.getValueHelpOnly()){return;}this.setFilterFunction(i||function(){return true;});this._clearSuggestionPopupItems();H=this._getFilteredSuggestionItems(this.getDOMValue());J=H.items.length;if(J>0){this._openSuggestionPopup();}else{this._hideSuggestionPopup();}this._applySuggestionAcc(J);this.setFilterFunction(N);};E.prototype.shouldValueStateMessageBeOpened=function(){var i=I.prototype.shouldValueStateMessageBeOpened.apply(this,arguments);if(!i||this._isSuggestionsPopoverOpen()){return false;}return true;};E.prototype._isSuggestionsPopoverOpen=function(){return this._getSuggestionsPopover()&&this._getSuggestionsPopover().isOpen();};E.prototype.isMobileDevice=function(){return D.system.phone;};E.prototype._openSuggestionsPopover=function(){this.closeValueStateMessage();this._updateSuggestionsPopoverValueState();this._getSuggestionsPopover().getPopover().open();};E.prototype._updateSuggestionsPopoverValueState=function(){var i=this._getSuggestionsPopover(),V=this.getValueState(),N=this.getValueState()!==i._getValueStateHeader().getValueState(),H=this.getFormattedValueStateText(),J=this.getValueStateText();if(!i){return;}if(this._isSuggestionsPopoverOpen()&&!H&&!N){this.setFormattedValueStateText(i._getValueStateHeader().getFormattedText());}i.updateValueState(V,(H||J),this.getShowValueStateMessage());if(this.isMobileDevice()){i.getInput().setValueState(V);}};E.prototype.setShowValueHelp=function(i){var H=this._getSuggestionsPopover()&&this._getSuggestionsPopover().getInput();this.setProperty("showValueHelp",i);if(H){H.setShowValueHelp(i);}return this;};E.prototype.isValueHelpOnlyOpener=function(i){return true;};E.prototype._getFilteredSuggestionItems=function(V){var i,H=this._getSuggestionsPopover().getItemsContainer();if(this._hasTabularSuggestions()){if(this.isMobileDevice()&&H){H.removeStyleClass("sapMInputSuggestionTableHidden");}i=this.filterTabularItems(this.getSuggestionRows(),V);}else{i=n(this,this.getSuggestionItems(),V,this.getFilterSuggests(),true,this._getFilterFunction());this._mapItems(i);}return i;};E.prototype.filterTabularItems=function(i,V){var H,J=this.getFilterSuggests(),N=[],O=[],P=false,Q=this._getFilterFunction();i.forEach(function(U){if(U.isA("sap.m.GroupHeaderListItem")){O.push({header:U,visible:false});}else{H=!J||Q(V,U);U.setVisible(H);H&&N.push(U);if(!P&&H&&this._sProposedItemText===this._getRowResultFunction()(U)){U.setSelected(true);P=true;}if(O.length&&H){O[O.length-1].visible=true;}}},this);O.forEach(function(U){U.header.setVisible(U.visible);});this._getSuggestionsTable().invalidate();return{items:N,groups:O};};E.prototype._mapItems=function(i){var H=this.getSuggestionItems(),J=i.items,N=i.groups,O=N.map(function(W){return W.header;}),P=false,Q=this._getSuggestionsPopover().getItemsContainer(),U,V;H.filter(function(W){return(J.indexOf(W)>-1)||(O.indexOf(W)>-1);}).map(function(W){U=o.createListItemFromCoreItem(W,true);Q.addItem(U);if(!P&&this._sProposedItemText===W.getText()){U.setSelected(true);P=true;}return W;},this).filter(function(W){return O.indexOf(W)>-1;}).forEach(function(W){V=O.indexOf(W);if(V>-1){U=o.getListItem(W);U&&U.setVisible(N[V].visible);}});};E.prototype._setTypedInValue=function(V){this._sTypedInValue=V;return this;};E.prototype._getTypedInValue=function(){return this._sTypedInValue;};E.prototype._setSeparateSuggestions=function(V){var i=this._getSuggestionsTable();this.setProperty("separateSuggestions",V);if(i){i.setShowSeparators(V?z.Inner:z.None);}return this;};return E;});
