/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/m/library","sap/ui/core/Control","sap/ui/core/Core","sap/ui/core/delegate/ScrollEnablement","./WizardProgressNavigator","sap/ui/core/util/ResponsivePaddingsEnablement","sap/ui/Device","./WizardRenderer","sap/ui/core/CustomData","sap/base/Log","sap/ui/thirdparty/jquery","sap/ui/dom/jquery/Focusable"],function(l,C,a,S,W,R,D,b,c,L,q){"use strict";var d=l.PageBackgroundDesign;var e=l.WizardRenderMode;var f=C.extend("sap.m.Wizard",{metadata:{library:"sap.m",designtime:"sap/m/designtime/Wizard.designtime",interfaces:["sap.f.IDynamicPageStickyContent"],properties:{width:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:"auto"},height:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:"100%"},showNextButton:{type:"boolean",group:"Behavior",defaultValue:true},finishButtonText:{type:"string",group:"Appearance",defaultValue:"Review"},enableBranching:{type:"boolean",group:"Behavior",defaultValue:false},backgroundDesign:{type:"sap.m.PageBackgroundDesign",group:"Appearance",defaultValue:d.Standard},renderMode:{type:"sap.m.WizardRenderMode",group:"Appearance",defaultValue:e.Scroll}},defaultAggregation:"steps",aggregations:{steps:{type:"sap.m.WizardStep",multiple:true,singularName:"step"},_progressNavigator:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},_nextButton:{type:"sap.m.Button",multiple:false,visibility:"hidden"}},associations:{
/**
					 * This association controls the current activated step of the wizard (meaning the last step)
					 * For example if we have A->B->C->D steps, we are on step A and we setCurrentStep(C) A,B and C are going to be activated. D will still remain unvisited.
					 * The parameter needs to be a Wizard step that is part of the current Wizard
					 * @since 1.50
					 */
currentStep:{type:"sap.m.WizardStep",multiple:false}},events:{stepActivate:{parameters:{index:{type:"int"}}},navigationChange:{parameters:{step:{type:"sap.m.WizardStep"}}},complete:{parameters:{}}},dnd:{draggable:false,droppable:true}}});f.CONSTANTS={MINIMUM_STEPS:3,MAXIMUM_STEPS:8,ANIMATION_TIME:300,SCROLL_OFFSET:16};R.call(f.prototype,{header:{suffix:"progressNavigator"},content:{suffix:"step-container"}});f.prototype.init=function(){this._iStepCount=0;this._aStepPath=[];this._bScrollLocked=false;this._oScroller=this._initScrollEnablement();this._oResourceBundle=a.getLibraryResourceBundle("sap.m");this._initProgressNavigator();this._initResponsivePaddingsEnablement();this._iNextButtonHeight=0;};f.prototype.onBeforeRendering=function(){var s=this._getStartingStep();if(!this._isMinStepCountReached()||this._isMaxStepCountExceeded()){L.error("The Wizard is supposed to handle from 3 to 8 steps.");}this._saveInitialValidatedState();if(s&&this._aStepPath.indexOf(s)<0){this._activateStep(s);s._setNumberInvisibleText(1);}};f.prototype.onAfterRendering=function(){if(!this.getCurrentStep()){this.setAssociation("currentStep",this._getStartingStep(),true);}var s=this._getCurrentStepInstance();if(s){this._activateAllPreceedingSteps(s);}this._attachScrollHandler();this._renderPageMode();};f.prototype._renderPageMode=function(s){var i,o,r;if(this.getRenderMode()!==e.Page){return;}if(s){i=this._aStepPath.indexOf(s)+1;o=s;}else{i=this._getProgressNavigator().getCurrentStep();o=this._aStepPath[i-1];}r=a.createRenderManager();r.renderControl(this._updateStepTitleNumber(o,i));r.flush(this.getDomRef("step-container"));r.destroy();};f.prototype._updateStepTitleNumber=function(s,i){var o=s.getCustomData().filter(function(g){return g.getKey()==="stepIndex";})[0];if(o){o.setValue(i);}else{s.addCustomData(new c({key:"stepIndex",value:i}));}return s;};f.prototype.exit=function(){var o=this.getDomRef("step-container");if(o){o.onscroll=null;}this._oScroller.destroy();this._oScroller=null;this._aStepPath=null;this._iStepCount=null;this._bScrollLocked=null;this._oResourceBundle=null;this._iNextButtonHeight=null;};f.prototype.validateStep=function(s){if(!this._containsStep(s)){L.error("The wizard does not contain this step");return this;}s.setValidated(true);return this;};f.prototype.invalidateStep=function(s){if(!this._containsStep(s)){L.error("The wizard does not contain this step");return this;}s.setValidated(false);return this;};f.prototype.nextStep=function(){var i=this._getProgressNavigator().getProgress()-1;var o=this._aStepPath[i];this.validateStep(o);o._complete();return this;};f.prototype.previousStep=function(){var p=this._getProgressNavigator().getProgress()-2;if(p>=0){this.discardProgress(this._aStepPath[p]);}return this;};f.prototype.getProgress=function(){return this._getProgressNavigator().getProgress();};f.prototype.getProgressStep=function(){return this._aStepPath[this.getProgress()-1];};f.prototype.goToStep=function(s,F){var u=function(){var p=this._getProgressNavigator();p&&p._updateCurrentStep(this._aStepPath.indexOf(s)+1);};if(!this.getVisible()||this._aStepPath.indexOf(s)<0){return this;}else if(this.getRenderMode()===e.Page){u.call(this);this._renderPageMode(s);return this;}s._setNumberInvisibleText(this.getProgress());var t=this,m={scrollTop:this._getStepScrollOffset(s)},A={queue:false,duration:f.CONSTANTS.ANIMATION_TIME,start:function(){t._bScrollLocked=true;},complete:function(){t._bScrollLocked=false;u.call(t);if(F||F===undefined){t._focusFirstStepElement(s);}}};q(this.getDomRef("step-container")).animate(m,A);return this;};f.prototype.discardProgress=function(s,p){var P=this.getProgress(),g=this._aStepPath,I=this._aStepPath.indexOf(s),o=this._aStepPath[I],h=I+1;if(h>P||h<=0){L.warning("The given step is either not yet reached, or is not present in the wizard control.");return this;}this._getProgressNavigator().discardProgress(h,true);this._updateProgressNavigator();this._restoreInitialValidatedState(h);for(var i=h;i<g.length;i++){g[i]._deactivate();if(g[i].getSubsequentSteps().length>1){g[i].setNextStep(null);}}this.setAssociation("currentStep",s);o.setWizardContext({sButtonText:this._getNextButtonText(),bLast:true});if(s.getSubsequentSteps().length>1&&!p){s.setNextStep(null);}g.splice(h);return this;};f.prototype.setCurrentStep=function(s){var o=(typeof s==="string")?a.byId(s):s;if(!this.getEnableBranching()){this.setAssociation("currentStep",s,true);}if(o&&this._isStepReachable(o)){this._activateAllPreceedingSteps(o);}else{L.error("The given step could not be set as current step.");}return this;};f.prototype.setShowNextButton=function(v){this.setProperty("showNextButton",v,true);this.getSteps().forEach(function(s){s.setWizardContext({bParentAllowsButtonShow:v});});return this;};f.prototype.getFinishButtonText=function(){if(this.getProperty("finishButtonText")==="Review"){return this._oResourceBundle.getText("WIZARD_FINISH");}else{return this.getProperty("finishButtonText");}};f.prototype.addStep=function(w){if(this._isMaxStepCountExceeded()){L.error("The Wizard is supposed to handle up to 8 steps.");return this;}w.setWizardContext({bParentAllowsButtonShow:this.getShowNextButton()});this._incrementStepCount();return this.addAggregation("steps",w);};f.prototype.setBackgroundDesign=function(B){var s=this.getBackgroundDesign();this.setProperty("backgroundDesign",B,true);this.$().removeClass("sapMWizardBg"+s).addClass("sapMWizardBg"+this.getBackgroundDesign());return this;};f.prototype.insertStep=function(w,i){throw new Error("Dynamic step insertion is not yet supported.");};f.prototype.removeStep=function(w){throw new Error("Dynamic step removal is not yet supported.");};f.prototype.removeAllSteps=function(){this._resetStepCount();return this.removeAllAggregation("steps").map(function(s){return s;},this);};f.prototype.destroySteps=function(){this._resetStepCount();return this.destroyAggregation("steps");};f.prototype._getStickyContent=function(){return this._getProgressNavigator();};f.prototype._returnStickyContent=function(){if(this.bIsDestroyed){return;}this._getStickyContent().$().prependTo(this.$());};f.prototype._setStickySubheaderSticked=function(i){this._bStickyContentSticked=i;};f.prototype._getStickySubheaderSticked=function(){return this._bStickyContentSticked;};f.prototype._activateAllPreceedingSteps=function(s){if(this._aStepPath.indexOf(s)>=0){this.discardProgress(s,true);return;}while(this.getProgressStep()!==s){this.nextStep();}};f.prototype._isNextStepDetermined=function(s,p){if(!this.getEnableBranching()){return true;}s=s||this._getCurrentStepInstance();return this._getNextStep(s,p)!==null;};f.prototype._isStepReachable=function(s){if(this.getEnableBranching()){var o=this._getStartingStep();while(o!==s){o=o._getNextStepReference();if(o==null){return false;}}this.setAssociation("currentStep",s);return true;}else{return this.getSteps().indexOf(s)>=0;}};f.prototype._initScrollEnablement=function(){return new S(this,null,{scrollContainerId:this.getId()+"-step-container",horizontal:false,vertical:true});};f.prototype._initProgressNavigator=function(){var t=this,p=new W(this.getId()+"-progressNavigator",{stepChanged:this._handleStepChanged.bind(this)});p._setOnEnter(function(E,s){var o=t._aStepPath[s];setTimeout(function(){this._focusFirstStepElement(o);}.bind(t),f.CONSTANTS.ANIMATION_TIME);});this.setAggregation("_progressNavigator",p);};f.prototype._handleNextButtonPress=function(){var p=this._getProgressNavigator(),P=p.getProgress(),s=this.isStepFinal();if(s){this.fireComplete();}else{var o=this.getProgressStep();if(!this._isNextStepDetermined(o,P)){throw new Error("The wizard is in branching mode, and the nextStep association is not set.");}p.incrementProgress();this._handleStepActivated(p.getProgress());this._handleStepChanged(p.getProgress(),true);}};f.prototype._getStepScrollOffset=function(s){var o=this.getDomRef("step-container"),i=o?o.scrollTop:0,g=0,A=0,n=this._getNextButtonHeight(),h=s.getDomRef()?s.getDomRef().scrollHeight:0,j=o?o.clientHeight:0;if(s&&s.$()&&s.$().position()){g=s.$().position().top||0;}if(n>0&&h>j){A=n;}this._setNextButtonHeight(0);return(i+g)-(f.CONSTANTS.SCROLL_OFFSET+A);};f.prototype._focusFirstStepElement=function(s){var $=s.$();if($&&$.firstFocusableDomRef()){$.firstFocusableDomRef().focus();}};f.prototype._handleStepChanged=function(E,s){var p=((typeof E==="number")?E:E.getParameter("current"))-2,P=this._aStepPath[p],o=this._getNextStep(P,p),F=D.system.desktop?true:false;!s&&this.fireNavigationChange({step:o});this.goToStep(o,F);};f.prototype._handleStepActivated=function(i){var p=i-2,P=this._aStepPath[p],n=this._getNextStep(P,p),N=this._getNextButton().getDomRef();this._setNextButtonHeight(N?N.offsetHeight:0);this._activateStep(n);this._updateProgressNavigator();this.fireStepActivate({index:i});this.setAssociation("currentStep",this.getProgressStep(),true);this.getProgressStep().setWizardContext({bLast:true,bReviewStep:this.isStepFinal(),sButtonText:this._getNextButtonText()});};f.prototype._isMaxStepCountExceeded=function(){var s=this._getStepCount();if(this.getEnableBranching()){return false;}return s>=f.CONSTANTS.MAXIMUM_STEPS;};f.prototype._isMinStepCountReached=function(){var s=this._getStepCount();return s>=f.CONSTANTS.MINIMUM_STEPS;};f.prototype._getStepCount=function(){return this._iStepCount;};f.prototype._incrementStepCount=function(){this._iStepCount+=1;this._getProgressNavigator().setStepCount(this._getStepCount());};f.prototype._decrementStepCount=function(){this._iStepCount-=1;this._getProgressNavigator().setStepCount(this._getStepCount());};f.prototype._resetStepCount=function(){this._iStepCount=0;this._getProgressNavigator().setStepCount(this._getStepCount());};f.prototype._getProgressNavigator=function(){return this.getAggregation("_progressNavigator");};f.prototype._saveInitialValidatedState=function(){if(this._aInitialValidatedState){return;}this._aInitialValidatedState=this.getSteps().map(function(s){return s.getValidated();});};f.prototype._restoreInitialValidatedState=function(I){var s=this._aStepPath,A=this.getSteps();for(var i=I;i<s.length;i++){var o=s[i],g=A.indexOf(o),h=this._aInitialValidatedState[g];o.setValidated(h);}};f.prototype._getNextStep=function(s,p){if(!this.getEnableBranching()){return this.getSteps()[p+1];}if(p<0){return this._getStartingStep();}var n=s._getNextStepReference();if(n===null){throw new Error("The wizard is in branching mode, and no next step is defined for "+"the current step, please set one.");}if(!this._containsStep(n)){throw new Error("The next step that you have defined is not part of the wizard steps aggregation."+"Please add it to the wizard control.");}var g=s.getSubsequentSteps();if(g.length>0&&!s._containsSubsequentStep(n.getId())){throw new Error("The next step that you have defined is not contained inside the subsequentSteps"+" association of the current step.");}return n;};f.prototype.isStepFinal=function(){var s,i=this._getStepCount(),p=this.getProgress();if(this.getEnableBranching()){s=this._aStepPath[this._aStepPath.length-1]._isLeaf();}else{s=p===i;}return s;};f.prototype._getNextButtonText=function(){if(this.isStepFinal()){return this.getFinishButtonText();}else{return this._oResourceBundle.getText("WIZARD_STEP")+" "+(this.getProgress()+1);}};f.prototype._getNextButton=function(){var s=this._getCurrentStepInstance();if(s){return s.getAggregation("_nextButton");}else{return null;}};f.prototype._updateProgressNavigator=function(){var p=this._getProgressNavigator(),o=this._getStartingStep(),A=this.getSteps(),s=[o.getTitle()],g=[o.getIcon()],h=[o.getOptional()],i=1;if(this.getEnableBranching()){while(!o._isLeaf()&&o._getNextStepReference()!==null){i++;o=o._getNextStepReference();s.push(o.getTitle());h.push(o.getOptional());g.push(o.getIcon());}p.setVaryingStepCount(o._isBranched());p.setStepCount(i);}else{s=A.map(function(j){return j.getTitle();});h=A.map(function(j){return j.getOptional();});g=A.map(function(j){return j.getIcon();});}p.setStepTitles(s);p._aStepOptionalIndication=h;p.setStepIcons(g);};f.prototype._getStartingStep=function(){return this.getSteps()[0];};f.prototype._attachScrollHandler=function(){var o=this.getDomRef("step-container");o.onscroll=this._scrollHandler.bind(this);};f.prototype._scrollHandler=function(E){if(this._bScrollLocked){return;}var s=E.target.scrollTop,p=this._getProgressNavigator(),o=this._aStepPath[p.getCurrentStep()-1],g=this._aStepPath[p.getCurrentStep()],h=o&&o.getDomRef();if(!h){return;}var i=h.clientHeight,j=h.offsetTop,k=100;if(s+k>=j+i&&p._isActiveStep(p._iCurrentStep+1)){p.nextStep();this.fireNavigationChange({step:g});}var m=this.getSteps();for(var n=0;n<m.length;n++){if(s+k<=j){p.previousStep();o=this._aStepPath[p.getCurrentStep()-1];h=o&&o.getDomRef();this.fireNavigationChange({step:o});if(!h){break;}j=h.offsetTop;}}};f.prototype._getCurrentStepInstance=function(){return a.byId(this.getCurrentStep());};f.prototype._containsStep=function(s){return this.getSteps().some(function(o){return o===s;});};f.prototype._checkCircularReference=function(s){if(this._aStepPath.indexOf(s)>=0){throw new Error("The step that you are trying to activate has already been visited. You are creating "+"a loop inside the wizard.");}};f.prototype._activateStep=function(s){this._checkCircularReference(s);this._aStepPath.push(s);s._activate();};f.prototype._getNextButtonHeight=function(){return this._iNextButtonHeight;};f.prototype._setNextButtonHeight=function(h){this._iNextButtonHeight=h;};return f;});
