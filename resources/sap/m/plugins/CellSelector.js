/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./PluginBase","sap/ui/events/KeyCodes","sap/ui/core/Core","sap/ui/thirdparty/jquery","sap/base/Log"],function(P,K,C,q,L){"use strict";var S={NEXT:1,PREVIOUS:2};var a="sapMPluginsCellSelector";var b=P.extend("sap.m.plugins.CellSelector",{metadata:{library:"sap.m",properties:{},events:{}}});b.prototype.onActivate=function(o){o.addDelegate(this,true,this);this._oSession={};this._oSession.oCanvas={};var s=this.getConfig("scrollEvent");s&&o.attachEvent(s,this._handleScroll,this);};b.prototype.onDeactivate=function(o){o.removeDelegate(this,this);this._oSession={};this._oSession.oCanvas={};var s=this.getConfig("scrollEvent");s&&o.detachEvent(s,this._handleScroll,this);};b.prototype.getSelectedCells=function(){if(!this._bSelecting){return{};}var n=g(this._oSession.mSource,this._oSession.mTarget);var s={};for(var r=n.from.rowIndex;r<n.to.rowIndex;r++){var R=this.getConfig("contextByIndex",this.getControl(),r),d=[];for(var i=n.from.colIndex;i<n.to.colIndex;i++){var o=this.getConfig("columnByIndex",this.getControl(),i);if(o){d.push(i);}}s[r]={rowContext:R,columnIndices:d};}return s;};b.prototype.onsapspace=function(e){if(e.isMarked()){return;}else if(!this.getConfig("isSelectionEnabled",this.getControl())){L.error("Cell selection is inactive, because preconditions are not met.");return;}var t=e.target;var o=this.getConfig("getCellInfo",this.getControl(),t);if(o){this._bSelecting=true;if(this._oSession.mSource){if(this._oSession.mSource.rowIndex!==o.rowIndex||this._oSession.mSource.colIndex!==o.colIndex){this._oSession.mSource=null;this._oSession.mTarget=null;}}this._oSession.mSource=o;this._oSession.mStart=o;this._selectCells(this._oSession.mSource,o,{info:{focus:o}});e.preventDefault();e.setMarked();}};b.prototype.onsapnext=b.prototype.onsapprevious=function(e){if(!this._bSelecting){return;}this._clearSelection();};b.prototype.onsaphome=b.prototype.onsapend=b.prototype.onsapnext;b.prototype.onsapnextmodifiers=function(e){this._selectNextCell(e,false,1);};b.prototype.onsappreviousmodifiers=function(e){this._selectNextCell(e,true.valueOf,-1);};b.prototype._selectNextCell=function(e,i,d){if(!this._bSelecting||!e.shiftKey||e.isMarked()||!this._isInSelectionArea(e.target)){return;}var f=this.getConfig("getCellInfo",this.getControl(),e.target);var F=Object.assign({},this._oSession.mSource);var t=Object.assign({},this._oSession.mTarget);var k=i?K.ARROW_UP:K.ARROW_DOWN,D=i?S.PREVIOUS:S.NEXT;var T=e.keyCode==k?"row":"col";t[T+"Index"]+=d;f[T+"Index"]+=d;if(!this.getConfig("isNavigatableCell",this.getControl(),t)){return;}this._selectCells(F,t,{info:{focus:f,direction:D}});e.preventDefault();e.setMarked();};b.prototype.onsapspacemodifiers=function(e){if(!this._bSelecting||e.isMarked()){return;}var t=Object.assign({},this._oSession.mTarget);var f=this.getConfig("getCellInfo",this.getControl(),e.target);if(e.shiftKey){this._oSession.mSource.colIndex=-Infinity;t.colIndex=Infinity;this._selectCells(this._oSession.mSource,t,{info:{focus:f,boundaryChange:true}});}else if(e.ctrlKey||e.metaKey){this._oSession.mSource.rowIndex=-Infinity;t.rowIndex=Infinity;this._selectCells(this._oSession.mSource,t,{info:{focus:f,boundaryChange:true}});}e.preventDefault();e.setMarked();};b.prototype.onsaphomemodifiers=function(e){if(!this._bSelecting||e.isMarked()||!e.shiftKey||!this._isInSelectionArea(e.target)){return;}var t=Object.assign({},this._oSession.mTarget);t.colIndex=-Infinity;this._selectCells(this._oSession.mSource,t,{info:{focus:t,boundaryChange:true}});e.setMarked();};b.prototype.onsapendmodifiers=function(e){if(!this._bSelecting||e.isMarked()||!e.shiftKey||!this._isInSelectionArea(e.target)){return;}var t=Object.assign({},this._oSession.mTarget);t.colIndex=Infinity;this._selectCells(this._oSession.mSource,t,{info:{focus:t,boundaryChange:true}});e.setMarked();};b.prototype.onkeydown=function(e){if(this._bSelecting){if(c(e,K.A,true,true)){this._clearSelection();}e.preventDefault();e.setMarked();}};b.prototype.onkeyup=function(e){if(!this._bSelecting){return;}e.setMarked();};b.prototype._isInSelectionArea=function(t){var f=this.getConfig("getCellInfo",this.getControl(),t);var i=false;if(f){var n=g(this._oSession.mSource,this._oSession.mTarget);var r=this.getControl().getRows();i=!(f.rowIndex<n.from.rowIndex||f.rowIndex>n.to.rowIndex||f.colIndex<n.from.colIndex||f.colIndex>n.to.colIndex)||f.rowIndex==r[0].getIndex()||f.rowIndex==r[r.length-1].getIndex();}return i;};b.prototype._selectCells=function(f,t,o){if(!this._bSelecting){return;}this._oSession.aCells=[];this._savePreviousSelectionAreas();this._eraseSelection();if(!this._oSession.mTarget){this._oSession.mTarget=t;}if(!f){this._oSession.mSource=f=t;}if(!o){o={};}var B=g(f,t);var s=this.getConfig("selectCells",this.getControl(),B,o);this._oSession.aCells=s.cells;this._drawSelection(s.bounds,s.borderOptions);if(o&&o.info&&!o.info.boundaryChange){this._oSession.mSource=f;this._oSession.mTarget=t;}else{this._oSession.mSource=B.from;this._oSession.mTarget=B.to;}};b.prototype._drawSelection=function(B,o){var s=this.getConfig("getSelectionAreas",this.getControl(),B.from,B.to);s.forEach(function(A,i){var t=this.getControl().getDomRef(A.container),f=this.getConfig("getCellRef",this.getControl(),A.from),T=this.getConfig("getCellRef",this.getControl(),A.to);var F,m,d;var e={};if(!f||!T){return;}F=f.getBoundingClientRect();m=T.getBoundingClientRect();d=t.getBoundingClientRect();var O=A.hasOffset?d.left:0;e.left=Math.min(F.left,m.left)-O;e.top=Math.min(F.top,m.top)-d.top;e.width=Math.max(m.right,F.right)-e.left-O;e.height=Math.max(m.bottom,F.bottom)-e.top-d.top;e.noBorderTop=!o.top;e.noBorderBottom=!o.bottom;e.noBorderRight=s.length>1&&i<(s.length-1)?true:false;e.noBorderLeft=s.length>1&&i>0?true:false;this._drawSelectionArea(e,A.container);}.bind(this));};b.prototype._drawSelectionArea=function(t,s){if(!this._oSession.oCanvas[s]){this._oSession.oCanvas[s]=document.createElement("div");this._oSession.oCanvas[s].className=a+"Canvas";}if(!this._oSession.oCanvas[s].isConnected){this.getControl().getDomRef(s).append(this._oSession.oCanvas[s]);}var o=this._oSession.oCanvas[s].style;o.left=t.left+"px";o.top=t.top+"px";o.width=t.width+"px";o.height=t.height+"px";o.display="block";o.borderTop=t.noBorderTop?"0px":"";o.borderBottom=t.noBorderBottom?"0px":"";o.borderRight=t.noBorderRight?"0px":"";o.borderLeft=t.noBorderLeft?"0px":"";};b.prototype._clearSelection=function(){this._bSelecting=false;this._eraseSelection();this._oSession.mSource=null;this._oSession.mTarget=null;};b.prototype._eraseSelection=function(){Object.values(this._oSession.oCanvas).forEach(function(A){A.style="";});};b.prototype._handleScroll=function(e){if(!this._bSelecting){return;}this._selectCells(this._oSession.mSource,this._oSession.mTarget);};b.prototype._savePreviousSelectionAreas=function(){Object.entries(this._oSession.oCanvas).forEach(function(e){var s=e[0],A=e[1];if(A.style.left&&A.style.top&&A.style.width&&A.style.height){if(!this._oSession.previousSelection){this._oSession.previousSelection={};}this._oSession.previousSelection[s]={top:parseFloat(A.style.top),left:parseFloat(A.style.left),width:parseFloat(A.style.width),height:parseFloat(A.style.height)};}}.bind(this));};function g(f,t){return{from:{rowIndex:Math.min(f.rowIndex,t.rowIndex),colIndex:Math.min(f.colIndex,t.colIndex)},to:{rowIndex:Math.max(f.rowIndex,t.rowIndex),colIndex:Math.max(f.colIndex,t.colIndex)}};}function c(e,k,s,d){return e.keyCode==k&&e.shiftKey==s&&(e.ctrlKey==d||e.metaKey==d);}P.setConfigs({"sap.m.Table":{selectableCells:".sapMListTblCell:not([aria-hidden=true])"},"sap.ui.table.Table":{container:"tableCtrlCnt",selectableCells:".sapUiTableDataCell",scrollEvent:"firstVisibleRowChanged",isSelectionEnabled:function(o){return!(o.getSelectionBehavior()!=="RowSelector"||o.getSelectionMode()=="None");},getCellRef:function(t,p){var r=this._getRowByIndex(t,p.rowIndex);if(r){var o=this._getColumns(t)[p.colIndex];var d=o&&r.getCells()[p.colIndex];if(d){return d.$().closest(".sapUiTableDataCell")[0];}}},getCellInfo:function(t,T){return{rowIndex:this.rowIndex(null,T),colIndex:this.colIndex(t,T)};},getSelectionAreas:function(t,f,T){var A=[],F=t.getFixedColumnCount();if(F>0&&(f.colIndex<F||f.colIndex===-Infinity)){var i=T.colIndex===Infinity?F-1:Math.min(T.colIndex,F-1);var m={rowIndex:f.rowIndex,colIndex:f.colIndex},d={rowIndex:T.rowIndex,colIndex:i};A.push({container:"sapUiTableCtrlScrFixed",from:m,to:d});}if(T.colIndex>=F||T.colIndex===Infinity){A.push({container:this.container,from:f,to:T,hasOffset:true});}return A;},selectCells:function(t,s,o){var B={},d={top:true,bottom:true};B.from=Object.assign({},s.from);B.to=Object.assign({},s.to);var e=[];if(o&&o.info){if(o.info.focus.rowIndex===-Infinity){o.info.focus.rowIndex=0;}else if(o.info.focus.rowIndex===Infinity){o.info.focus.rowIndex=t._getTotalRowCount();}if(o.info.focus.colIndex===-Infinity){o.info.focus.colIndex=0;}else if(o.info.focus.colIndex===Infinity){o.info.focus.colIndex=this._getColumns(t).length-1;}this._focusCell(t,o.info.focus,o.info.direction);}var f=t.getFirstVisibleRow()+t.getFixedRowCount();var l=f+t.getVisibleRowCount()-t.getFixedBottomRowCount()-t.getFixedRowCount()-1;var i=f+t.getVisibleRowCount()-t.getFixedRowCount()-t.getFixedBottomRowCount();if((B.from.rowIndex<f&&B.to.rowIndex<f||B.from.rowIndex>l&&B.to.rowIndex>l)&&!(B.from.rowIndex<t.getFixedRowCount()||B.to.rowIndex>=i)){B.from={};B.to={};}else{if((B.from.rowIndex<f&&B.from.rowIndex>(t.getFixedRowCount()-1))||B.from.rowIndex===-Infinity){B.from.rowIndex=f;d.top=B.from.rowIndex==0?true:false;if(s.from.rowIndex===-Infinity){s.from.rowIndex=0;B.from.rowIndex=t.getFixedRowCount()>0?0:f;}}if((B.to.rowIndex>l&&B.to.rowIndex<(t._getTotalRowCount()-t.getFixedBottomRowCount()))||B.to.rowIndex===Infinity){B.to.rowIndex=l;d.bottom=B.to.rowIndex==t._getTotalRowCount()-1?true:false;if(s.to.rowIndex===Infinity){s.to.rowIndex=t._getTotalRowCount()-1;B.to.rowIndex=t.getFixedRowCount()>0?t._getTotalRowCount()-1:l;}}}if(B.from.colIndex===-Infinity&&B.from.colIndex===Infinity){B.from.rowIndex=o.info.focus.rowIndex;s.from.rowIndex=o.info.focus.rowIndex;}var v=this._getColumns(t);B.from.colIndex=s.from.colIndex=Math.max(s.from.colIndex,0);B.to.colIndex=s.to.colIndex=Math.min(s.to.colIndex,v.length-1);for(var r=s.from.rowIndex;r<=s.to.rowIndex;r++){var R=this._getRowByIndex(t,r);if(R){for(var h=s.from.colIndex;h<=s.to.colIndex;h++){e.push([r,h]);}}}return{bounds:B,borderOptions:d,cells:e};},rowIndex:function(t,o){return q(o).control(0,true).getIndex();},colIndex:function(t,o){return this._getColumns(t).indexOf(C.byId(o.getAttribute("data-sap-ui-colid")));},contextByIndex:function(t,r){return t.getContextByIndex(r);},columnByIndex:function(t,i){var o=this._getColumns(t)[i];if(!o.getVisible()){return;}return o;},isNavigatableCell:function(t,p){if(p.rowIndex<0||p.rowIndex>=t._getTotalRowCount()||p.colIndex<0||p.colIndex>=this._getColumns(t).length){return false;}return true;},_scrollRow:function(t,d,r){var f=t.getFirstVisibleRow();if(r>=0&&r<t._getTotalRowCount()){if(t.getFixedRowCount()>0&&r==t.getFixedRowCount()){t.setFirstVisibleRow(0);}else{d==S.NEXT?f++:f--;t.setFirstVisibleRow(f);}}},_focusCell:function(t,p,d){var o=this.getCellRef(t,p);if(!o){this._scrollRow(t,d,p.rowIndex);o=this.getCellRef(t,p);}o&&o.focus();},_getColumns:function(t){return t.getColumns().filter(function(o){return o.shouldRender();});},_getRowByIndex:function(t,r){var I=t.getRows();for(var i=0;i<I.length;i++){if(I[i].getIndex()==r){return I[i];}}}}},b);return b;});
