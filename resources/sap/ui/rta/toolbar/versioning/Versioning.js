/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/m/GroupHeaderListItem","sap/ui/base/ManagedObject","sap/ui/core/format/DateFormat","sap/ui/core/Fragment","sap/ui/core/library","sap/ui/fl/write/api/Version","sap/ui/model/Sorter","sap/ui/rta/Utils"],function(G,M,D,F,c,V,S,U){"use strict";var a=c.MessageType;var b="sapUiRtaDraftVersionAccent";var A="sapUiRtaActiveVersionAccent";var d=M.extend("sap.ui.rta.toolbar.versioning.Versioning",{metadata:{properties:{toolbar:{type:"any"}}},constructor:function(){M.prototype.constructor.apply(this,arguments);this.oTextResources=this.getToolbar().getTextResources();}});function v(E){var o=E.getSource().getBindingContext("versions");var m=V.Number.Original;if(o){m=o.getProperty("version");}this.getToolbar().fireEvent("switchVersion",{version:m});}function e(m){return m.some(function(o){return o.type===V.Type.Active;});}function f(m){return e(m)?a.None:a.Success;}function g(m){return e(m)?this.oTextResources.getText("LBL_INACTIVE"):this.oTextResources.getText("LBL_ACTIVE");}function h(t){switch(t){case V.Type.Draft:return a.Warning;case V.Type.Active:return a.Success;default:return a.None;}}function i(t){switch(t){case V.Type.Draft:return this.oTextResources.getText("TIT_DRAFT");case V.Type.Active:return this.oTextResources.getText("LBL_ACTIVE");default:return this.oTextResources.getText("LBL_INACTIVE");}}function j(t,T){if(T===V.Type.Draft){return this.oTextResources.getText("TIT_DRAFT");}return t||this.oTextResources.getText("TIT_VERSION_1");}function k(m,I){var t=I||m;if(!t){return"";}return D.getInstance({format:"yMMMdjm"}).format(new Date(t));}function l(o){return new G({title:o.key?this.oTextResources.getText("TIT_VERSION_HISTORY_PUBLISHED"):this.oTextResources.getText("TIT_VERSION_HISTORY_UNPUBLISHED"),upperCase:false,visible:this.getToolbar().getModel("controls").getProperty("/publishVisible")}).addStyleClass("sapUiRtaVersionHistoryGrouping").addStyleClass("sapUiRtaVersionHistory");}function s(o,t){switch(t){case V.Type.Draft:o.addStyleClass(b);o.removeStyleClass(A);break;case V.Type.Active:o.addStyleClass(A);o.removeStyleClass(b);break;default:o.removeStyleClass(A);o.removeStyleClass(b);}}d.prototype.formatVersionButtonText=function(m,n){var t="";var T="Active";m=m||[];if(n===undefined||n===V.Number.Original){t=this.oTextResources.getText("TIT_ORIGINAL_APP");T=V.Type.Inactive;if(m.length===0||(m.length===1&&m[0].type===V.Type.Draft)){T=V.Type.Active;}}else{var o=m.find(function(p){return p.version===n;});if(o){T=o.type;if(n===V.Number.Draft){t=this.oTextResources.getText("TIT_DRAFT");}else{t=o.title||this.oTextResources.getText("TIT_VERSION_1");}}}s(this.getToolbar().getControl("versionButton"),T);return t;};d.prototype.formatPublishVersionVisibility=function(p,m,n,o){return p&&m&&n!==V.Number.Draft&&o==="adaptation";};d.prototype.formatDiscardDraftVisible=function(m,n,o){return m===V.Number.Draft&&n&&o==="adaptation";};d.prototype.showVersionHistory=function(E){var o=E.getSource();if(!this._oVersionHistoryDialogPromise){this._oVersionHistoryDialogPromise=F.load({name:"sap.ui.rta.toolbar.versioning.VersionHistory",id:this.getToolbar().getId()+"_fragment--sapUiRta_versionHistoryDialog",controller:{formatVersionTitle:j.bind(this),formatVersionTimeStamp:k,formatHighlight:h,formatHighlightText:i.bind(this),formatOriginalAppHighlight:f,formatOriginalAppHighlightText:g.bind(this),versionSelected:v.bind(this),getGroupHeaderFactory:l.bind(this)}}).then(function(m){this.getToolbar().addDependent(m);return m;}.bind(this));}return this._oVersionHistoryDialogPromise.then(function(m){if(!m.isOpen()){m.openBy(o);if(this.getToolbar().getModel("controls").getProperty("/publishVisible")){var L=this.getToolbar().getControl("versionHistoryDialog--versionList");var n=new S({path:"isPublished",group:true});L.getBinding("items").sort(n);}}else{m.close();}}.bind(this));};d.prototype.openActivateVersionDialog=function(m){if(!this._oActivateVersionDialogPromise){this._oActivateVersionDialogPromise=F.load({name:"sap.ui.rta.toolbar.versioning.VersionTitleDialog",id:this.getToolbar().getId()+"_fragment--sapUiRta_activateVersionDialog",controller:{onConfirmVersioningDialog:function(){var n=this.getToolbar().getControl("activateVersionDialog--versionTitleInput").getValue();this.getToolbar().fireEvent("activate",{versionTitle:n});this._oActivateVersionDialog.close();}.bind(this),onCancelVersioningDialog:function(){this._oActivateVersionDialog.close();}.bind(this),onVersionTitleLiveChange:function(E){var n=E.getParameter("value");this.getToolbar().getControl("activateVersionDialog--confirmVersionTitleButton").setEnabled(!!n);}.bind(this)}}).then(function(o){this._oActivateVersionDialog=o;o.addStyleClass(U.getRtaStyleClassName());this.getToolbar().addDependent(this._oActivateVersionDialog);}.bind(this));}else{this.getToolbar().getControl("activateVersionDialog--versionTitleInput").setValue("");this.getToolbar().getControl("activateVersionDialog--confirmVersionTitleButton").setEnabled(false);}return this._oActivateVersionDialogPromise.then(function(){var t=this.oTextResources.getText("TIT_VERSION_TITLE_DIALOG");if(m!==V.Number.Draft){t=this.oTextResources.getText("TIT_REACTIVATE_VERSION_TITLE_DIALOG");}this._oActivateVersionDialog.setTitle(t);return this._oActivateVersionDialog.open();}.bind(this));};return d;});
