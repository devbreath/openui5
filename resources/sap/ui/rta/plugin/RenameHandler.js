/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/BindingParser","sap/ui/thirdparty/jquery","sap/ui/Device","sap/ui/rta/plugin/Plugin","sap/ui/dt/Overlay","sap/ui/dt/ElementUtil","sap/ui/dt/OverlayRegistry","sap/ui/rta/Utils","sap/ui/dt/DOMUtil","sap/ui/events/KeyCodes","sap/ui/dt/OverlayUtil"],function(B,q,D,P,O,E,a,U,b,K,c){"use strict";var e="\xa0";function d(n,o){if(o===n){throw Error("sameTextError");}var f;var g;try{f=B.complexParser(n,undefined,true);}catch(h){g=true;}if(f&&typeof f==="object"||g){throw Error(sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta").getText("RENAME_BINDING_ERROR_TEXT"));}}var R={errorStyleClass:"sapUiRtaErrorBg",validators:{noEmptyText:{validatorFunction:function(n){return n!==e;},errorMessage:sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta").getText("RENAME_EMPTY_ERROR_TEXT")}},_manageClickEvent:function(v){var o=v.getSource?v.getSource():v;if(o.isSelected()&&this.isRenameAvailable(o)&&this.isRenameEnabled([o])){o.attachBrowserEvent("click",R._onClick,this);}else{o.detachBrowserEvent("click",R._onClick,this);}},_setEditableFieldPosition:function(){if(this._$editableField){this._$editableField.offset({left:this._$oEditableControlDomRef.offset().left});this._$editableField.offset({top:this._$oEditableControlDomRef.offset().top});}},startEdit:function(p){this.setBusy(true);this._oEditedOverlay=p.overlay;var o=p.overlay.getElement();var f=this._oEditedOverlay.getDesignTimeMetadata();var v=f.getAssociatedDomRef(o,p.domRef);if(!U.isElementInViewport(v)){v.get(0).scrollIntoView();}this._$oEditableControlDomRef=q(v);var m=typeof p.getTextMutators==="function"?p.getTextMutators(o):{getText:function(){return this._$oEditableControlDomRef.text();}.bind(this),setText:function(n){this._$oEditableControlDomRef.text(n);}.bind(this)};this._fnGetControlText=m.getText;this._fnSetControlText=m.setText;var w=0;var g=a.getOverlay(v instanceof q?v.get(0).id:v.id);if(!g){g=this._oEditedOverlay;var _=q(E.getDomRef(o));var h=this._$oEditableControlDomRef.parent();var C=parseInt(_.outerWidth());if(!isNaN(C)){var i=parseInt(this._$oEditableControlDomRef.outerWidth());var j=parseInt(h.outerWidth());w=C-i;if(w<0&&j){if(h.get(0).id!==_.get(0).id&&h.children(":visible").length===1&&h.children(":visible").get(0).id===this._$oEditableControlDomRef.get(0).id&&C>j){w=C-j;}else{w=0;}}}}var k=q("<div class='sapUiRtaEditableField'></div>").css({"white-space":"nowrap",overflow:"hidden",width:"calc(100% - ("+w+"px))"}).appendTo(g.$());this._$editableField=q("<div contentEditable='true'></div>").appendTo(k);var s=this._fnGetControlText();if(s===""){this._fnSetControlText("_?_");this._$editableField.text("");}else{this._$editableField.text(s);}this.setOldValue(R._getCurrentEditableFieldText.call(this));b.copyComputedStyle(this._$oEditableControlDomRef,this._$editableField);this._$editableField.children().remove();this._$editableField.css("visibility","hidden");this._$editableField.css({"-moz-user-modify":"read-write","-webkit-user-modify":"read-write","-ms-user-modify":"read-write","user-modify":"read-write","user-select":"text","-webkit-user-select":"text","text-overflow":"clip","white-space":"nowrap"});if(D.browser.name==="ed"&&o.getMetadata().getName()==="sap.ui.fl.variants.VariantManagement"){this._$editableField.css({"line-height":"normal"});}O.getMutationObserver().ignoreOnce({target:this._$oEditableControlDomRef.get(0)});this._$editableField.one("focus",R._onEditableFieldFocus.bind(this));this._$editableField.on("blur",R._onEditableFieldBlur.bind(this));this._$editableField.on("keydown",R._onEditableFieldKeydown.bind(this));this._$editableField.on("dragstart",R._stopPropagation.bind(this));this._$editableField.on("drag",R._stopPropagation.bind(this));this._$editableField.on("dragend",R._stopPropagation.bind(this));this._$editableField.on("click",R._stopPropagation.bind(this));this._$editableField.on("mousedown",R._stopPropagation.bind(this));this._$oEditableControlDomRef.css("visibility","hidden");k.offset({left:this._$oEditableControlDomRef.offset().left});R._setEditableFieldPosition();this._$editableField.css("visibility","");this._$editableField.trigger("focus");this._aOverlaysWithScrollbar=c.findParentOverlaysWithScrollbar(g);this._aOverlaysWithScrollbar.forEach(function(l){l.attachScrollSynced(R._setEditableFieldPosition,this);}.bind(this));p.overlay.setSelected(true);sap.ui.getCore().getEventBus().publish("sap.ui.rta",p.pluginMethodName,{overlay:p.overlay,editableField:this._$editableField});},_setDesignTime:function(o){this._aSelection=[];var f=this.getDesignTime();if(f){f.getSelectionManager().detachChange(R._onDesignTimeSelectionChange,this);}P.prototype.setDesignTime.apply(this,arguments);if(o){o.getSelectionManager().attachChange(R._onDesignTimeSelectionChange,this);this._aSelection=this.getSelectedOverlays();}},_onDesignTimeSelectionChange:function(o){var s=o.getParameter("selection");this._aSelection.forEach(R._manageClickEvent,this);s.forEach(R._manageClickEvent,this);this._aSelection=s;},_stopPropagation:function(o){o.stopPropagation();},_preventDefault:function(o){o.preventDefault();},_onEditableFieldFocus:function(o){var f=o.target;var r=document.createRange();r.selectNodeContents(f);var s=window.getSelection();s.removeAllRanges();s.addRange(r);},_stopEdit:function(r,p){var o;this.setBusy(false);if(this._fnGetControlText()==="_?_"){this._fnSetControlText("");}this._oEditedOverlay.$().find(".sapUiRtaEditableField").remove();O.getMutationObserver().ignoreOnce({target:this._$oEditableControlDomRef.get(0)});this._$oEditableControlDomRef.css("visibility","visible");if(r){o=this._oEditedOverlay;o.setSelected(true);o.focus();}this._aOverlaysWithScrollbar.forEach(function(f){f.detachScrollSynced(R._setEditableFieldPosition,this);}.bind(this));delete this._$editableField;delete this._$oEditableControlDomRef;delete this._oEditedOverlay;delete this._bBlurOrKeyDownStarted;delete this._fnGetControlText;delete this._fnSetControlText;sap.ui.getCore().getEventBus().publish("sap.ui.rta",p,{overlay:o});},_onEditableFieldBlur:function(){return R._handlePostRename.call(this,false);},_handlePostRename:function(r,o){if(!this._bBlurOrKeyDownStarted){this._oEditedOverlay.removeStyleClass(R.errorStyleClass);this._bBlurOrKeyDownStarted=true;if(o){R._preventDefault.call(this,o);R._stopPropagation.call(this,o);}return Promise.resolve().then(R._validateNewText.bind(this)).then(this._emitLabelChangeEvent.bind(this)).catch(function(f){if(f.message==="sameTextError"){return;}throw f;}).then(function(f){this.stopEdit(r);if(typeof f==="function"){f();}}.bind(this)).catch(function(f){return R._handleInvalidRename.call(this,f.message,r);}.bind(this));}return Promise.resolve();},_handleInvalidRename:function(s,r){return U.showMessageBox("error",s,{titleKey:"RENAME_ERROR_TITLE"}).then(function(){var o=this._oEditedOverlay;o.setIgnoreEnterKeyUpOnce(false);o.addStyleClass(R.errorStyleClass);this.stopEdit(r);this.startEdit(o);}.bind(this));},_validateNewText:function(){var s;var n=R._getCurrentEditableFieldText.call(this);d(n,this.getOldValue());var r=this.getResponsibleElementOverlay(this._oEditedOverlay);var o=this.getAction(r);var v=o&&o.validators||[];v.some(function(V){var f;if(typeof V==="string"&&R.validators[V]){f=R.validators[V];}else{f=V;}if(!f.validatorFunction(n)){s=f.errorMessage;return true;}});if(s){throw Error(s);}},_onEditableFieldKeydown:function(o){switch(o.keyCode){case K.ENTER:this._oEditedOverlay.setIgnoreEnterKeyUpOnce(true);return R._handlePostRename.call(this,true,o);case K.ESCAPE:this._oEditedOverlay.removeStyleClass(R.errorStyleClass);this.stopEdit(true);R._preventDefault.call(this,o);break;case K.DELETE:R._stopPropagation.call(this,o);break;default:}return Promise.resolve();},_getCurrentEditableFieldText:function(){var t=this._$editableField.text().trim();return t===""?e:t;},_onClick:function(o){var f=sap.ui.getCore().byId(o.currentTarget.id);if(this.isRenameEnabled([f])&&!o.metaKey&&!o.ctrlKey){this.startEdit(f);R._preventDefault.call(this,o);}},_exit:function(){if(this._$oEditableControlDomRef){this.stopEdit(false);}}};return R;},true);
