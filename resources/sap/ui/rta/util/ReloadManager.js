/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/merge","sap/ui/fl/apply/api/FlexRuntimeInfoAPI","sap/ui/fl/write/api/ReloadInfoAPI","sap/ui/fl/write/api/VersionsAPI","sap/ui/fl/Layer","sap/ui/fl/Utils","sap/ui/rta/Utils"],function(m,F,R,V,L,a,U){"use strict";var b={};var u={};var r={NOT_NEEDED:"NO_RELOAD",VIA_HASH:"CROSS_APP_NAVIGATION",RELOAD_PAGE:"HARD_RELOAD"};function c(p){return{target:{semanticObject:p.semanticObject,action:p.action,context:p.contextRaw},params:p.params,appSpecificRoute:p.appSpecificRoute,writeHistory:false};}function g(o){var s;var i=o.layer===L.CUSTOMER;if(o.hasHigherLayerChanges&&o.isDraftAvailable){s=i?"MSG_VIEWS_OR_PERSONALIZATION_AND_DRAFT_EXISTS":"MSG_HIGHER_LAYER_CHANGES_AND_DRAFT_EXISTS";}else if(o.hasHigherLayerChanges&&o.allContexts){s="MSG_RESTRICTED_CONTEXT_EXIST_AND_PERSONALIZATION";}else if(o.hasHigherLayerChanges){s=i?"MSG_PERSONALIZATION_OR_PUBLIC_VIEWS_EXISTS":"MSG_HIGHER_LAYER_CHANGES_EXIST";}else if(o.isDraftAvailable){s="MSG_DRAFT_EXISTS";}else if(o.allContexts){s="MSG_RESTRICTED_CONTEXT_EXIST";}return s;}function d(o){var i=o.layer===L.CUSTOMER;if(o.hasHigherLayerChanges){if(!i){return"MSG_RELOAD_WITH_ALL_CHANGES";}if(o.isDraftAvailable){return"MSG_RELOAD_WITH_VIEWS_PERSONALIZATION_AND_WITHOUT_DRAFT";}if(o.allContexts){return"MSG_RELOAD_WITH_PERSONALIZATION_AND_RESTRICTED_CONTEXT";}return"MSG_RELOAD_WITH_PERSONALIZATION_AND_VIEWS";}if(o.initialDraftGotActivated){return"MSG_RELOAD_ACTIVATED_DRAFT";}if(o.isDraftAvailable){return"MSG_RELOAD_WITHOUT_DRAFT";}if(o.changesNeedReload){return"MSG_RELOAD_NEEDED";}if(o.allContexts){return"MSG_RELOAD_WITHOUT_ALL_CONTEXT";}return undefined;}function h(o){var s=d(o);if(s){return U.showMessageBox("information",s,{titleKey:"HEADER_RELOAD_NEEDED"});}return Promise.resolve();}function t(o,v,D){if(u.CrossApplicationNavigation&&v){if(o.isDraftAvailable){V.loadDraftForApplication({control:o.selector,layer:o.layer,allContexts:o.allContexts});}else{V.loadVersionForApplication({control:o.selector,layer:o.layer,allContexts:o.allContexts});}}var s=g(o);var p=D?Promise.resolve():U.showMessageBox("information",s);return p.then(function(){b.enableAutomaticStart(o.layer,o.selector);o.onStart=true;return b.triggerReload(o);}).then(function(){return true;});}function e(o){o.parameters=document.location.search;if(o.onStart){R.handleParametersOnStart(o,"standalone");}else{R.handleUrlParameters(o,"standalone");}if(document.location.search===o.parameters){b.reloadPage();}else{b.setUriParameters(o.parameters);}}function f(o){o.URLParsingService=u.URLParsing;o.parsedHash=a.getParsedURLHash(u.URLParsing);o.parameters=o.parsedHash.params;var C=o.onStart?R.handleParametersOnStart(o,"flp"):R.handleUrlParameters(o,"flp");if(C){u.CrossApplicationNavigation.toExternal(c(o.parsedHash));}else{u.AppLifeCycle.reloadCurrentApp();}if(o.triggerHardReload){b.reloadPage();}}b.setUShellServices=function(p){u=p;};b.enableAutomaticStart=function(l,o){var s=F.getFlexReference({element:o});var p=s||true;window.sessionStorage.setItem("sap.ui.rta.restart."+l,p);};b.disableAutomaticStart=function(l){window.sessionStorage.removeItem("sap.ui.rta.restart."+l);};b.needsAutomaticStart=function(l){return!!window.sessionStorage.getItem("sap.ui.rta.restart."+l);};b.triggerReload=function(o){if(a.getUshellContainer()){f(o);}else{e(o);}};b.reloadPage=function(){window.location.reload();};b.setUriParameters=function(p){document.location.search=p;};b.handleReloadOnStart=function(p){m(p,{hasHigherLayerChanges:false,isDraftAvailable:false,ignoreMaxLayerParameter:false,includeCtrlVariants:true,URLParsingService:u.URLParsing});return R.getReloadReasonsForStart(p).then(function(o){if(o.hasHigherLayerChanges||o.isDraftAvailable||o.allContexts){return t(o,p.versioningEnabled,p.developerMode);}return undefined;});};b.checkReloadOnExit=function(p){return p.changesNeedReloadPromise.then(function(C){p.changesNeedReload=C;p.URLParsingService=u.URLParsing;var o=R.getReloadMethod(p);return h(o).then(function(){o.triggerHardReload=o.reloadMethod===r.RELOAD_PAGE;return o;});});};b.handleUrlParametersOnExit=function(o){if(o.layer!==L.USER&&o.reloadMethod!==r.NOT_NEEDED){o.removeVersionParameter=true;b.triggerReload(o);}};return b;});
