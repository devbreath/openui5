/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['sap/ui/core/Control','sap/ui/Device','sap/ui/core/delegate/ItemNavigation','sap/ui/unified/calendar/CalendarUtils','sap/ui/unified/calendar/CalendarDate',"sap/ui/unified/DateRange",'sap/ui/unified/library','sap/ui/core/format/DateFormat','sap/ui/core/library','sap/ui/core/Locale','sap/ui/core/LocaleData',"./YearPickerRenderer","sap/ui/events/KeyCodes","sap/ui/thirdparty/jquery"],function(C,D,I,a,b,c,l,d,e,L,f,Y,K,q){"use strict";var g=e.CalendarType;var h=C.extend("sap.ui.unified.calendar.YearPicker",{metadata:{library:"sap.ui.unified",properties:{year:{type:"int",group:"Data",defaultValue:2000,deprecated:true},years:{type:"int",group:"Appearance",defaultValue:20},intervalSelection:{type:"boolean",group:"Behavior",defaultValue:false},columns:{type:"int",group:"Appearance",defaultValue:4},date:{type:"object",group:"Data"},primaryCalendarType:{type:"sap.ui.core.CalendarType",group:"Appearance"},secondaryCalendarType:{type:"sap.ui.core.CalendarType",group:"Appearance"},_middleDate:{type:"object",group:"Data",visibility:"hidden"}},aggregations:{selectedDates:{type:"sap.ui.unified.DateRange",multiple:true,singularName:"selectedDate"}},events:{select:{},pageChange:{}}},renderer:Y});h.prototype.init=function(){var s=sap.ui.getCore().getConfiguration().getCalendarType();this.setProperty("primaryCalendarType",s);this._oYearFormat=d.getDateInstance({format:"y",calendarType:s});this._oFormatYyyymmdd=d.getInstance({pattern:"yyyyMMdd",calendarType:g.Gregorian});this._oMinDate=a._minDate(this.getPrimaryCalendarType());this._oMaxDate=a._maxDate(this.getPrimaryCalendarType());};h.prototype.onAfterRendering=function(){_.call(this);this.focus();};h.prototype.exit=function(){if(this._aMPSelectedDates&&this._aMPSelectedDates.length){this._aMPSelectedDates.forEach(function(o){o.destroy();});this._aMPSelectedDates=undefined;}};h.prototype.getFocusDomRef=function(){return this.getDomRef()&&this._oItemNavigation.getItemDomRefs()[this._iSelectedIndex];};h.prototype.setYear=function(y){this.setProperty("year",y);y=this.getProperty("year");var o=new b(y,0,1,this.getPrimaryCalendarType()),s=this._getSelectedDates()[0],i=this.getAggregation("selectedDates");if(!s||this.getIntervalSelection()){return this;}if(!this._oSelectedDatesControlOrigin){if(!i||!i.length){this.addAggregation("selectedDates",s);}!this.getIntervalSelection()&&s.setStartDate(o.toLocalJSDate());}this.setDate(o.toLocalJSDate());return this;};h.prototype.setDate=function(o){var M=a._maxDate(this.getProperty("primaryCalendarType")).getYear(),i,y,n,H;o&&a._checkJSDateObject(o);y=o.getFullYear();a._checkYearInValidRange(y);i=b.fromLocalJSDate(o,this.getPrimaryCalendarType());i.setMonth(0,1);this.setProperty("date",o);this.setProperty("year",i.getYear());this._oDate=i;n=this.getYears();H=Math.floor(n/2);if(o.getFullYear()<H){this._iSelectedIndex=o.getFullYear()-1;}else if(o.getFullYear()>M-H){this._iSelectedIndex=M+n-o.getFullYear()-1;}else{this._iSelectedIndex=H;}this.setProperty("_middleDate",i);return this;};h.prototype._getDate=function(){if(!this._oDate){var y=this.getYear();this._oDate=new b(y,0,1,this.getPrimaryCalendarType());}return this._oDate;};h.prototype._setSelectedDatesControlOrigin=function(o){this._oSelectedDatesControlOrigin=o;};h.prototype.getSelectedDates=function(){if(this._oSelectedDatesControlOrigin){return this._oSelectedDatesControlOrigin.getSelectedDates();}return this.getAggregation("selectedDates");};h.prototype._getSelectedDates=function(){var s=this.getSelectedDates();if(s){return s;}else if(!this._aMPSelectedDates||!this._aMPSelectedDates.length){this._aMPSelectedDates=[new c()];this._aMPSelectedDates[0].setStartDate(this._getDate().toLocalJSDate());return this._aMPSelectedDates;}else{return this._aMPSelectedDates;}};h.prototype.setPrimaryCalendarType=function(s){this.setProperty("primaryCalendarType",s);this._oYearFormat=d.getDateInstance({format:"y",calendarType:s});if(this._oDate){this._oDate=new b(this._oDate,s);this._oDate.setMonth(0,1);}this._oMinDate=new b(this._oMinDate,s);this._oMaxDate=new b(this._oMaxDate,s);if(this._getSecondaryCalendarType()){this.setColumns(2);this.setYears(8);}return this;};h.prototype.nextPage=function(){this._updatePage(true,this._oItemNavigation.getFocusedIndex());return this;};h.prototype.previousPage=function(){this._updatePage(false,this._oItemNavigation.getFocusedIndex());return this;};h.prototype.onsapspace=function(E){E.preventDefault();};h.prototype.onsapselect=function(E){var i=this._oItemNavigation.getFocusedIndex();var s=this._selectYear(i);if(s){this.fireSelect();}};h.prototype.onmouseover=function(E){var t=E.target,s=this._getSelectedDates()[0],S,F,y;if(!s){return;}if(s.getStartDate()){S=b.fromLocalJSDate(s.getStartDate(),this.getPrimaryCalendarType());S.setMonth(0,1);}if(t.classList.contains("sapUiCalItem")){y=t.getAttribute("data-sap-year-start");F=b.fromUTCDate(this._oFormatYyyymmdd.parse(y,true),this.getPrimaryCalendarType());if(this._isSelectionInProgress()){this._markInterval(S,F);}}};h.prototype.onmousedown=function(E){this._oMousedownPosition={clientX:E.clientX,clientY:E.clientY};};h.prototype.onmouseup=function(E){var t=E.target,s=this._getSelectedDates()[0],i,y,S,F,$=this._oItemNavigation.getItemDomRefs();if(this._bMousedownChange){this._bMousedownChange=false;if(this.getIntervalSelection()&&t.classList.contains("sapUiCalItem")&&s){y=t.getAttribute("data-sap-year-start");F=b.fromUTCDate(this._oFormatYyyymmdd.parse(y,true),this.getPrimaryCalendarType());S=b.fromLocalJSDate(s.getStartDate(),this.getPrimaryCalendarType());S.setMonth(0,1);if(!F.isSame(S)&&!s.getEndDate()){i=$.index(t);this._selectYear.call(this,i);this._oItemNavigation.focusItem(i);}}this.fireSelect();}else if(D.support.touch&&this._isValueInThreshold(this._oMousedownPosition.clientX,E.clientX,10)&&this._isValueInThreshold(this._oMousedownPosition.clientY,E.clientY,10)){i=this._oItemNavigation.getFocusedIndex();if(!$[i].classList.contains("sapUiCalItemDsbl")){this._selectYear(i);this.fireSelect();}}};h.prototype._markInterval=function(s,E){var n=this._oItemNavigation.getItemDomRefs(),F,y,i;if(s.isAfter(E)){E=[s,s=E][0];}for(i=0;i<n.length;++i){y=n[i].getAttribute("data-sap-year-start");F=b.fromUTCDate(this._oFormatYyyymmdd.parse(y,true),this.getPrimaryCalendarType());if(this._bMousedownChange){if((F.isSame(s)||F.isSame(E))&&!a._isOutside(F,this._oMinDate,this._oMaxDate)){q(n[i]).addClass("sapUiCalItemSel");}else{q(n[i]).removeClass("sapUiCalItemSel");}}if(a._isBetween(F,s,E)&&a._isBetween(F,this._oMinDate,this._oMaxDate)){q(n[i]).addClass("sapUiCalItemSelBetween");}else{q(n[i]).removeClass("sapUiCalItemSelBetween");}}};h.prototype.getFirstRenderedDate=function(){var F;if(this.getDomRef()){var i=this._oItemNavigation.getItemDomRefs();F=b.fromUTCDate(this._oFormatYyyymmdd.parse(q(i[0]).attr("data-sap-year-start"),true),this.getPrimaryCalendarType()).toLocalJSDate();}return F;};h.prototype._isValueInThreshold=function(r,v,t){var i=r-t,u=r+t;return v>=i&&v<=u;};h.prototype.setSecondaryCalendarType=function(s){this.setProperty("secondaryCalendarType",s);if(this._getSecondaryCalendarType()){this.setColumns(2);this.setYears(8);}return this;};h.prototype._getSecondaryCalendarType=function(){return this.getSecondaryCalendarType()===this.getPrimaryCalendarType()?undefined:this.getSecondaryCalendarType();};h.prototype._getDisplayedSecondaryDates=function(o){var s=this.getSecondaryCalendarType(),F=new b(o,o.getCalendarType()),i=new b(o,o.getCalendarType());F.setMonth(0,1);F=new b(F,s);i.setYear(i.getYear()+1);i.setMonth(0,1);i.setDate(i.getDate()-1);i=new b(i,s);return{start:F,end:i};};h.prototype._getLocale=function(){var p=this._oSelectedDatesControlOrigin;if(p&&p._getLocale){return p._getLocale();}else if(!this._sLocale){this._sLocale=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale().toString();}return this._sLocale;};h.prototype._getLocaleData=function(){var p=this._oSelectedDatesControlOrigin;if(p&&p._getLocaleData){return p._getLocaleData();}else if(!this._oLocaleData){var s=this._getLocale();var o=new L(s);this._oLocaleData=f.getInstance(o);}return this._oLocaleData;};h.prototype._checkFirstDate=function(o){var y=this.getYears(),M=new b(this._oMaxDate,this.getPrimaryCalendarType());if(!M.isSame(a._maxDate(this.getPrimaryCalendarType()))){return o;}M.setYear(M.getYear()-y+1);if(o.isAfter(M)&&o.getYear()!=M.getYear()){o=new b(M,this.getPrimaryCalendarType());o.setMonth(0,1);}else if(o.isBefore(this._oMinDate)&&o.getYear()!=this._oMinDate.getYear()){o=new b(this._oMinDate,this.getPrimaryCalendarType());o.setMonth(0,1);}return o;};h.prototype._checkDateEnabled=function(o){var E=true;if((o.isAfter(this._oMaxDate)&&o.getYear()!=this._oMaxDate.getYear())||(o.isBefore(this._oMinDate)&&o.getYear()!=this._oMinDate.getYear())){E=false;}return E;};h.prototype._updatePage=function(F,s,i){var n=this._oItemNavigation.getItemDomRefs();var o=b.fromUTCDate(this._oFormatYyyymmdd.parse(q(n[0]).attr("data-sap-year-start"),true),this.getPrimaryCalendarType());var y=this.getYears();if(F){var M=new b(this._oMaxDate,this.getPrimaryCalendarType());M.setYear(M.getYear()-y+1);if(o.isBefore(M)){o.setYear(o.getYear()+y);if(o.isAfter(M)){s=s+(o.getYear()-M.getYear());if(s>y-1){s=y-1;}o=new b(this._oMaxDate,this.getPrimaryCalendarType());this._oDate.setMonth(0,1);}}else{return;}}else{if(o.isAfter(this._oMinDate)){o.setYear(o.getYear()-y);if(o.isBefore(this._oMinDate)){s=s-(this._oMinDate.getYear()-o.getYear());if(s<0){s=0;}o=new b(this._oMinDate,this.getPrimaryCalendarType());}}else{return;}}o.setYear(o.getYear()+Math.floor(y/2));this._iSelectedIndex=s;this.setProperty("_middleDate",o);if(i){this.firePageChange();}};h.prototype._selectYear=function(n){var o=this._oItemNavigation.getItemDomRefs(),$=q(o[n]),y=$.attr("data-sap-year-start"),F=b.fromUTCDate(this._oFormatYyyymmdd.parse(y,true),this.getPrimaryCalendarType()),s=this._getSelectedDates()[0],p=this.getAggregation("selectedDates"),S;if($.hasClass("sapUiCalItemDsbl")){return false;}if(!this._isSelectionInProgress()){var r=true;}this.setProperty("year",F.getYear(),r);this.setProperty("date",F.toLocalJSDate(),r);if(!s){return true;}if(!this._oSelectedDatesControlOrigin){if(!p||!p.length){this.addAggregation("selectedDates",s);}!this.getIntervalSelection()&&s.setStartDate(F.toLocalJSDate(),r);}if(this.getIntervalSelection()){if(!s.getStartDate()){s.setStartDate(F.toLocalJSDate(),r);}else if(!s.getEndDate()){S=b.fromLocalJSDate(s.getStartDate(),this.getPrimaryCalendarType());if(F.isBefore(S)){s.setEndDate(S.toLocalJSDate(),r);s.setStartDate(F.toLocalJSDate(),r);}else{s.setEndDate(F.toLocalJSDate(),r);}}else{s.setStartDate(F.toLocalJSDate(),r);s.setEndDate(undefined,r);}}if(r){for(var i=0;i<o.length;i++){$=q(o[i]);y=$.attr("data-sap-year-start");var t=b.fromUTCDate(this._oFormatYyyymmdd.parse(y,true),this.getPrimaryCalendarType());var A=this._fnShouldApplySelection(t);var u=this._fnShouldApplySelectionBetween(t);if(A){$.addClass("sapUiCalItemSel");$.removeClass("sapUiCalItemSelBetween");$.attr("aria-selected","true");}if(u){$.addClass("sapUiCalItemSelBetween");$.attr("aria-selected","true");}if(!A&&!u){$.removeClass("sapUiCalItemSel");$.removeClass("sapUiCalItemSelBetween");$.attr("aria-selected","false");}}}return true;};h.prototype._isSelectionInProgress=function(){var s=this._getSelectedDates()[0];if(!s){return false;}return this.getIntervalSelection()&&s.getStartDate()&&!s.getEndDate();};function _(){var F=this.getDate()?b.fromLocalJSDate(this.getDate(),this.getPrimaryCalendarType()):this._getDate(),r=this.getDomRef(),n=this.$().find(".sapUiCalItem"),o,y,p,i;for(i=0;i<n.length;++i){y=n[i].getAttribute("data-sap-year-start");p=b.fromUTCDate(this._oFormatYyyymmdd.parse(y,true),this.getPrimaryCalendarType());if(p.isSame(F)){o=i;break;}}if(!this._oItemNavigation){this._oItemNavigation=new I();this._oItemNavigation.attachEvent(I.Events.AfterFocus,j,this);this._oItemNavigation.attachEvent(I.Events.FocusAgain,k,this);this._oItemNavigation.attachEvent(I.Events.BorderReached,m,this);this.addDelegate(this._oItemNavigation);this._oItemNavigation.setHomeEndColumnMode(true,true);this._oItemNavigation.setDisabledModifiers({sapnext:["alt","meta"],sapprevious:["alt","meta"],saphome:["alt","meta"],sapend:["meta"]});}this._oItemNavigation.setRootDomRef(r);this._oItemNavigation.setItemDomRefs(n);this._oItemNavigation.setCycling(false);this._oItemNavigation.setColumns(this.getColumns(),true);if(a._isBetween(F,this._oMinDate,this._oMaxDate,true)){this._oItemNavigation.setFocusedIndex(o);}this._oItemNavigation.setPageSize(n.length);}function j(o){var i=o.getParameter("index"),E=o.getParameter("event"),t=this._oItemNavigation.aItemDomRefs[i],s=this._getSelectedDates()[0],S,F,y;if(!E){return;}if(E.type==="mousedown"){this._handleMousedown(E,i);}else if(E.type==="sapnext"||E.type==="sapprevious"){if(!s){return;}if(s.getStartDate()){S=b.fromLocalJSDate(s.getStartDate(),this.getPrimaryCalendarType());S.setMonth(0,1);}y=t.getAttribute("data-sap-year-start");F=b.fromUTCDate(this._oFormatYyyymmdd.parse(y,true),this.getPrimaryCalendarType());if(this._isSelectionInProgress()){this._markInterval(S,F);}}}function k(o){j.call(this,o);}h.prototype._handleMousedown=function(E,i){if(E.button||D.support.touch&&!D.system.combi){return;}var s=this._selectYear(i);if(s){this._bMousedownChange=true;}E.preventDefault();E.setMark("cancelAutoClose");};function m(o){var E=o.getParameter("event"),i=this._oItemNavigation.getFocusedIndex(),y=this.getYears(),n=this.getColumns(),s=this._getSelectedDates()[0],p=this._oItemNavigation.getItemDomRefs(),S,F,r;if(s&&s.getStartDate()){S=b.fromLocalJSDate(s.getStartDate(),this.getPrimaryCalendarType());S.setMonth(0,1);}if(E.type){if(n===0){n=y;}switch(E.type){case"sapnext":case"sapnextmodifiers":if(E.keyCode===K.ARROW_DOWN&&n<y){r=p[i-y+n].getAttribute("data-sap-year-start");F=b.fromUTCDate(this._oFormatYyyymmdd.parse(r,true),this.getPrimaryCalendarType());this._updatePage(true,i-y+n,true);this._iSelectedIndex=i-y+n;}else{r=p[0].getAttribute("data-sap-year-start");F=b.fromUTCDate(this._oFormatYyyymmdd.parse(r,true),this.getPrimaryCalendarType());this._updatePage(true,0,true);}break;case"sapprevious":case"sappreviousmodifiers":if(E.keyCode===K.ARROW_UP&&n<y){r=p[y-n+i].getAttribute("data-sap-year-start");F=b.fromUTCDate(this._oFormatYyyymmdd.parse(r,true),this.getPrimaryCalendarType());this._updatePage(false,y-n+i,true);this._iSelectedIndex=y-n+i;}else{r=p[y-1].getAttribute("data-sap-year-start");F=b.fromUTCDate(this._oFormatYyyymmdd.parse(r,true),this.getPrimaryCalendarType());this._updatePage(false,y-1,true);}break;case"sappagedown":r=p[i].getAttribute("data-sap-year-start");F=b.fromUTCDate(this._oFormatYyyymmdd.parse(r,true),this.getPrimaryCalendarType());this._updatePage(true,i,true);break;case"sappageup":r=p[i].getAttribute("data-sap-year-start");F=b.fromUTCDate(this._oFormatYyyymmdd.parse(r,true),this.getPrimaryCalendarType());this._updatePage(false,i,true);break;default:break;}}this._isSelectionInProgress()&&this._markInterval(S,F);}h.prototype._fnShouldApplySelection=function(o){var s=this._getSelectedDates()[0],S,E;if(!s){return false;}S=s.getStartDate();E=s.getEndDate();if(S){S=b.fromLocalJSDate(S,this.getPrimaryCalendarType());S.setMonth(0,1);}if(this.getIntervalSelection()&&S&&E){E=b.fromLocalJSDate(E,this.getPrimaryCalendarType());E.setMonth(0,1);if(o.isSame(S)||o.isSame(E)){return true;}}else if(S&&o.isSame(S)){return true;}return false;};h.prototype._fnShouldApplySelectionBetween=function(o){var s=this._getSelectedDates()[0],S,E;if(!s){return false;}S=s.getStartDate();E=s.getEndDate();if(this.getIntervalSelection()&&S&&E){S=b.fromLocalJSDate(S,this.getPrimaryCalendarType());S.setMonth(0,1);E=b.fromLocalJSDate(E,this.getPrimaryCalendarType());E.setMonth(0,1);if(a._isBetween(o,S,E)){return true;}}return false;};return h;});
