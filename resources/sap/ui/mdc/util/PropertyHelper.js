/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/Object","sap/ui/base/DataType","sap/base/util/merge","sap/base/util/isPlainObject","sap/base/Log"],function(B,D,m,a,L){"use strict";var A={name:{type:"string",mandatory:true,allowedForComplexProperty:true},label:{type:"string",mandatory:true,allowedForComplexProperty:true},tooltip:{type:"string",allowedForComplexProperty:true},visible:{type:"boolean","default":{value:true},allowedForComplexProperty:true},path:{type:"string",valueForComplexProperty:null},typeConfig:{type:{className:{type:"string"},baseType:{type:"string"},typeInstance:{type:"object"}},valueForComplexProperty:null},maxConditions:{type:"int","default":{value:-1},valueForComplexProperty:null},caseSensitive:{type:"boolean","default":{value:true}},group:{type:"string",allowedForComplexProperty:true},groupLabel:{type:"string",allowedForComplexProperty:true},filterable:{type:"boolean","default":{value:true},valueForComplexProperty:false},sortable:{type:"boolean","default":{value:true},valueForComplexProperty:false},key:{type:"boolean",valueForComplexProperty:false},groupable:{type:"boolean",valueForComplexProperty:false},propertyInfos:{type:"PropertyReference[]",allowedForComplexProperty:true},unit:{type:"PropertyReference"},text:{type:"PropertyReference"},exportSettings:{type:"object","default":{value:{},ignoreIfNull:true},allowedForComplexProperty:true},visualSettings:{type:{widthCalculation:{type:{minWidth:{type:"int","default":{value:2}},maxWidth:{type:"int","default":{value:19}},defaultWidth:{type:"int","default":{value:8}},gap:{type:"float","default":{value:0}},includeLabel:{type:"boolean","default":{value:true}},truncateLabel:{type:"boolean","default":{value:true}},verticalArrangement:{type:"boolean","default":{value:false}},excludeProperties:{type:"PropertyReference[]"}},"default":{value:{},ignoreIfNull:true}}},"default":{value:{}},allowedForComplexProperty:true},required:{type:"boolean"},hiddenFilter:{type:"boolean"}};var p={isComplex:function(){return P.isPropertyComplex(this);},getSimpleProperties:function(){return this.propertyInfosProperties||[this];},getSortableProperties:function(){return this.getSimpleProperties().filter(function(i){return i.sortable;});},getFilterableProperties:function(){return this.getSimpleProperties().filter(function(i){return i.filterable;});},getGroupableProperties:function(){return this.getSimpleProperties().filter(function(i){return i.groupable;});},getVisibleProperties:function(){return this.getSimpleProperties().filter(function(i){return i.visible;});}};var c=["name","label","tooltip","visible","path","typeConfig","maxConditions","group","groupLabel","caseSensitive"];var _=new WeakMap();function s(O){return JSON.stringify(O,function(K,V){return V===undefined?null:V;})||"";}function r(M,i){var x=s(i);L.warning("Invalid property definition: "+M+(x?"\n"+x:""));}function t(M,i){var x=i?s(i):null;throw new Error("Invalid property definition: "+M+(x?"\n"+x:""));}function e(i,x){x.map(function(y){Object.keys(p).forEach(function(M){Object.defineProperty(y,M,{value:function(){return p[M].call(this);},writable:true});});});}function d(O){var K=Object.getOwnPropertyNames(O);Object.freeze(O);for(var i=0;i<K.length;i++){var V=O[K[i]];if(typeof V==="function"){Object.freeze(V);}else if(a(V)&&!Object.isFrozen(V)){d(V);}else if(Array.isArray(V)){d(V);}}}function b(O,i){if(!i){return O;}return i.split(".").reduce(function(C,S){return C&&C[S]?C[S]:null;},O);}function g(i){var T;if(typeof i==="object"){T="object";}else{T=i.replace("PropertyReference","string");}return D.getType(T);}function f(i){var x=g(i);if(x.isArrayType()){return x.getBaseType().getDefaultValue();}else{return x.getDefaultValue();}}function h(i,x){x.forEach(function(y){i.prepareProperty(y);});d(x);}function j(i,x,y,z,C,E){var T=z==null;var F=[];var I=P.isPropertyComplex(x);if(T){E=_.get(i).mAttributeMetadata;C=x;}if(!C){return[];}for(var G in E){var H=E[G];var J=T?G:z+"."+G;var V=C[G];if(I&&!H.allowedForComplexProperty){if("valueForComplexProperty"in H){C[G]=H.valueForComplexProperty;}continue;}if(V!=null&&typeof H.type==="string"&&H.type.startsWith("PropertyReference")||J==="propertyInfos"){if(I||J!=="propertyInfos"){k(C,G,y);}continue;}if(V==null){l(C,H,z,G,F,V);}if(typeof H.type==="object"){F=F.concat(j(i,x,y,J,C[G],H.type));}}return F;}function k(i,x,y){var z=i[x];var C;var E=x;if(Array.isArray(z)){C=z.map(function(N){return y[N];});E+="Properties";}else{C=y[z];E+="Property";}Object.defineProperty(i,E,{value:C});}function l(i,x,S,y,z,V){if("default"in x){var C=x.default;if(V===null&&C.ignoreIfNull&&"value"in C){return;}if(C.value===undefined){i[y]=f(x.type);}else if(typeof C.value==="string"&&C.value.startsWith("attribute:")){z.push({source:C.value.substring(C.value.indexOf(":")+1),targetPath:S,targetAttribute:y,targetType:x.type});}else if(typeof C.value==="object"){i[y]=m({},C.value);}else{i[y]=C.value;}}else{i[y]=f(x.type);}}function n(i){return Object.freeze(i.reduce(function(M,x){M[x.name]=x;return M;},{}));}function o(i,x,y){for(var z in i){var C=i[z];var E=x==null?z:x+"."+z;if(x==="extension"){o(C.type,E);continue;}if(y&&C.allowedForComplexProperty!==false){C.allowedForComplexProperty=true;}if(typeof C.type==="object"){o(C.type,E,C.allowedForComplexProperty);}}}function q(x,E){var M=0;E=E||{};for(var i=0;i<x.length;i++){if("extension"in x[i]){t("Property contains invalid attribute 'extension'.",x[i]);}if(x[i].name in E){x[i].extension=E[x[i].name];M++;}else{x[i].extension={};}}if(M!==Object.keys(E).length){throw new Error("At least one property extension does not point to an existing property.");}}function u(i,x,y,E,z,C){var F={};var I=c.concat(z||[]).reduce(function(M,N){if(N in A){M[N]=A[N];}return M;},Object.assign({},i._mExperimentalAdditionalAttributes));if(C){F.mAttributeMetadata=Object.assign({extension:{type:C,mandatory:true,allowedForComplexProperty:true}},I);F.aMandatoryExtensionAttributes=Object.keys(C).filter(function(M){return C[M].mandatory;});}else{F.mAttributeMetadata=I;F.aMandatoryExtensionAttributes=[];}o(F.mAttributeMetadata);F.aMandatoryAttributes=Object.keys(F.mAttributeMetadata).filter(function(M){return F.mAttributeMetadata[M].mandatory;});var G=m([],y);var H=n(G);if(C){q(G,m({},E));}var J=_.get(i);var K=J&&J.aRawProperties;_.set(i,F);i.validateProperties(G,K);F.oParent=x||null;F.aRawProperties=y;F.aProperties=G;F.mProperties=H;F._={mExtensions:E,aAllowedAttributes:z,mExtensionAttributeMetadata:C};e(i,G);h(i,G);}var P=B.extend("sap.ui.mdc.util.PropertyHelper",{constructor:function(i,E,x,y,z){B.call(this);if(!Array.isArray(i)){t("Property infos must be an array.");}if(E){if(!z){throw new Error("Property extensions are not supported.");}else if(!a(E)){throw new Error("Property extensions must be a plain object.");}}if(x&&!B.isA(x,"sap.ui.base.ManagedObject")){throw new Error("The type of the parent is invalid.");}if(this._mExperimentalAdditionalAttributes){Object.keys(A).concat("extension").forEach(function(C){if(C in this._mExperimentalAdditionalAttributes){throw new Error("The attribute '"+C+"' is reserved and cannot be overridden by additional attributes.");}}.bind(this));}u(this,x,i,E,y,z);}});P.prototype.validateProperties=function(x,y){var U=new Set();for(var i=0;i<x.length;i++){this.validateProperty(x[i],x,y);U.add(x[i].name);}if(U.size!==x.length){t("Properties do not have unique names.");}};P.prototype.validateProperty=function(i,x,y){if(!a(i)){t("Property info must be a plain object.",i);}v(this,i,x);if(P.isPropertyComplex(i)){if(i.propertyInfos.length===0){t("Complex property does not reference existing properties.",i);}}_.get(this).aMandatoryAttributes.forEach(function(M){if(!(M in i)){r("Property does not contain mandatory attribute '"+M+"'.",i);}else if(i[M]==null){t("Property does not contain mandatory attribute '"+M+"'.",i);}});_.get(this).aMandatoryExtensionAttributes.forEach(function(M){if(!(M in i.extension)){r("Property does not contain mandatory attribute 'extension."+M+"'.",i);}else if(i.extension[M]==null){t("Property does not contain mandatory attribute 'extension."+M+"'.",i);}});};function v(i,x,y,z,C,E){var T=z==null;if(T){E=_.get(i).mAttributeMetadata;C=x;}for(var F in C){var G=E[F];var H=T?F:z+"."+F;var V=C[F];if(!G){r("Property contains invalid attribute '"+H+"'.",x);}else if(P.isPropertyComplex(x)&&!G.allowedForComplexProperty){r("Complex property contains invalid attribute '"+H+"'.",x);}else if(typeof G.type==="object"&&V&&typeof V==="object"){v(i,x,y,H,V,G.type);}else if(V!=null&&!g(G.type).isValid(V)){t("The value of '"+H+"' is invalid.",x);}else if(V&&typeof G.type==="string"&&G.type.startsWith("PropertyReference")){w(i,x,y,H,V,G);}}}function w(x,y,z,C,E,F){var G=F.type.endsWith("[]")?E:[E];var U=new Set(G);if(G.indexOf(y.name)>-1){t("Property references itself in the '"+C+"' attribute",y);}if(U.size!==G.length){t("Property contains duplicate names in the '"+C+"' attribute.",y);}for(var i=0;i<z.length;i++){if(U.has(z[i].name)){if(P.isPropertyComplex(z[i])){t("Property references complex properties in the '"+C+"' attribute.",y);}U.delete(z[i].name);}}if(U.size>0){t("Property references non-existing properties in the '"+C+"' attribute.",y);}}P.prototype.prepareProperty=function(i){var x=this.getPropertyMap();var y=j(this,i,x);y.forEach(function(z){var C=b(i,z.targetPath);if(C){var V=b(i,z.source);if(V==null){V=f(z.targetType);}C[z.targetAttribute]=V;if(typeof z.targetType==="string"&&z.targetType.startsWith("PropertyReference")){k(C,z.targetAttribute,x);}}});};P.prototype.getParent=function(){var i=_.get(this);return i?i.oParent:null;};P.prototype.setProperties=function(i){var x=_.get(this);u(this,x.oParent,i,x._.mExtensions,x._.aAllowedAttributes,x._.mExtensionAttributeMetadata);return this;};P.prototype.getProperties=function(){var i=_.get(this);return i?i.aProperties:[];};P.prototype.getPropertyMap=function(){var i=_.get(this);return i?i.mProperties:{};};P.prototype.getProperty=function(N){return this.getPropertyMap()[N]||null;};P.prototype.hasProperty=function(N){return N in this.getPropertyMap();};P.isPropertyComplex=function(i){return i!=null&&typeof i==="object"?"propertyInfos"in i:false;};P.prototype.getSortableProperties=function(){return this.getProperties().filter(function(i){return i.sortable;});};P.prototype.getFilterableProperties=function(){return this.getProperties().filter(function(i){return i.filterable;});};P.prototype.getGroupableProperties=function(){return this.getProperties().filter(function(i){return i.groupable;});};P.prototype.getKeyProperties=function(){return this.getProperties().filter(function(i){return i.key;});};P.prototype.getVisibleProperties=function(){return this.getProperties().filter(function(i){return i.visible;});};P.prototype.destroy=function(){B.prototype.destroy.apply(this,arguments);_.delete(this);};return P;});
