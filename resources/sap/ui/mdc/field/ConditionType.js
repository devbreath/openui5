/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['sap/ui/model/SimpleType','sap/ui/model/FormatException','sap/ui/model/ParseException','sap/ui/model/ValidateException','sap/ui/model/type/String','sap/ui/mdc/enum/FieldDisplay','sap/ui/mdc/condition/FilterOperatorUtil','sap/ui/mdc/condition/Operator','sap/ui/mdc/condition/Condition','sap/ui/mdc/enum/BaseType','sap/ui/mdc/enum/ConditionValidated','sap/base/util/merge','sap/base/strings/whitespaceReplacer','sap/ui/base/SyncPromise'],function(S,F,P,V,a,b,c,O,C,B,d,m,w,e){"use strict";var t="sap.ui.mdc.raw";var T="sap.ui.mdc.raw:";var f=S.extend("sap.ui.mdc.field.ConditionType",{constructor:function(i,N){S.apply(this,arguments);this.sName="Condition";this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");this._oCalls={active:0,last:0,condition:undefined,exception:undefined};}});f.prototype.destroy=function(){S.prototype.destroy.apply(this,arguments);if(this._oDefaultType){this._oDefaultType.destroy();delete this._oDefaultType;}this._bDestroyed=true;};f.prototype.formatValue=function(i,N){if(i==undefined||i==null||this._bDestroyed){return null;}if(typeof i!=="object"||!i.operator||!i.values||!Array.isArray(i.values)){throw new F("No valid condition provided");}if(!N){N="string";}var Q=o.call(this);var R=y(Q);var U=this.oFormatOptions.preventGetDescription;z.call(this,i,Q);switch(this.getPrimitiveType(N)){case"string":case"any":var X=n.call(this);var Y=s.call(this);var Z=c.getEQOperator(Y);if(!this.oFormatOptions.maxConditions||this.oFormatOptions.maxConditions===1){this._oCalls.active++;this._oCalls.last++;}var $=this._oCalls.last;if(!U&&X!==b.Value&&i.validated===d.Validated&&(R||(i.operator===Z.name&&!i.values[1]))){var a1=this.oFormatOptions.bindingContext;var b1=this.oFormatOptions.conditionModel;var c1=this.oFormatOptions.conditionModelName;var d1=R?i.values[0][1]:i.values[0];return e.resolve().then(function(){return K.call(this,d1,i,Q,a1,b1,c1);}.bind(this)).then(function(e1){if(e1){i=m({},i);if(R){Q=p.call(this);i.operator=Z.name;if(typeof e1!=="object"){e1={key:d1,description:e1};}}if(typeof e1==="object"){i=D.call(this,i,e1);}else if(i.values.length===1){i.values.push(e1);}else{i.values[1]=e1;}}return g.call(this,i,undefined,$,true,Q);}.bind(this)).catch(function(e1){var f1;if(!(e1 instanceof F)||!I.call(this)){f1=e1;}return g.call(this,i,f1,$,true,Q);}.bind(this)).unwrap();}return g.call(this,i,undefined,$,true,Q);default:var W=M(N);if(W>=0){if(v.call(this,Q)){return i.values.length>=1?i.values[0][W]:null;}}else if(N===t){return i.values.length>=1?i.values[0]:null;}else if(Q&&i.values.length>=1){return Q.formatValue(i.values[0],N);}throw new F("Don't know how to format Condition to "+N);}};function _(i,N){var Q=n.call(this);var R=y(N);if(R&&i.values.length>1&&i.values[0][1]===i.values[1][1]){i=m({},i);i.operator="EQ";i.values.splice(1);}var U=(this.oFormatOptions.hideOperator&&i.values.length===1)||R;var W=c.getOperator(i.operator);var X=x.call(this);if(!W){throw new F("No valid condition provided, Operator wrong.");}var Y=W.format(i,N,Q,U,X);var Z=this.oFormatOptions.convertWhitespaces;if(Z&&(G.call(this,N)===B.String||Q!==b.Value)){Y=w(Y);}return Y;}function g(i,N,Q,R,U){if(this._oCalls.active>0){this._oCalls.active--;}if(Q<this._oCalls.last&&(this._oCalls.condition!==undefined||this._oCalls.exception!==undefined)){i=this._oCalls.condition;N=this._oCalls.exception;}if(Q===this._oCalls.last&&this._oCalls.active>0){this._oCalls.condition=m({},i);this._oCalls.exception=N;}else if(this._oCalls.active===0&&this._oCalls.last>0){this._oCalls={active:0,last:0,condition:undefined,exception:undefined};}if(N){throw N;}var W;if(R){W=_.call(this,i,U);}else{W=h.call(this,i,U);}return W;}f.prototype.parseValue=function(i,N){if(this._bDestroyed){return null;}if(!N){N="string";}else if(N==="any"&&typeof i==="string"){N="string";}var Q=this.oFormatOptions.navigateCondition;if(Q){var R=this.formatValue(Q,N);if(R===i){return m({},Q);}}var U=n.call(this);var W=H.call(this);var X=o.call(this);var Y=q.call(this);var Z=s.call(this);var $=y(X);var a1;if(i===null||i===undefined||(i===""&&!W)){if(!v.call(this,X)){return null;}}A.call(this,X);switch(this.getPrimitiveType(N)){case"string":var d1;var e1=false;var f1=false;if(Z.length===1){d1=c.getOperator(Z[0]);f1=true;}else{var g1=c.getMatchingOperators(Z,i);if(g1.length===0){d1=L.call(this,Z,X);if(W&&!v.call(this,X)){var h1=c.getEQOperator(Z);if(Z.indexOf(h1.name)>=0){e1=!!d1&&d1.name!==h1.name;d1=h1;}}f1=true;}else{var i1=g1.filter(function(d1){return d1.valueTypes.length===0;});if(i1.length>=1){d1=i1[0];}else{d1=g1[0];}}}if(d1){if($&&d1!==c.getEQOperator(Z)){throw new P("unsupported operator");}var j1;var k1=v.call(this,X);var l1=x.call(this);this._oCalls.active++;this._oCalls.last++;var m1=this._oCalls.last;if((!k1||$)&&d1.validateInput&&W){j1=j.call(this,d1,i,X,f1,e1,Z,U,true);if(j1 instanceof Promise){return E.call(this,j1);}else{return j1;}}else{try{if(i===""&&k1&&f1){j1=C.createCondition(d1.name,[X.parseValue(i,"string",X._aCurrentValue)],undefined,undefined,d.NotValidated);}else{j1=d1.getCondition(i,X,U,f1,l1);}}catch(n1){var o1=n1;if(o1 instanceof P&&Y){try{Y.parseValue(i,"string",Y._aCurrentValue);}catch(p1){o1=p1;}}return g.call(this,undefined,o1,m1,false,X);}}if(j1){return g.call(this,j1,undefined,m1,false,X);}}throw new P("Cannot parse value "+i);default:if(X){if(Z.length===1){a1=Z[0];}else{a1=L.call(this,Z,X).name;if(Z.indexOf(a1)<0){a1=undefined;}}if(a1){var b1=M(N);if(b1>=0){if(v.call(this,X)){var c1=m([],X._aCurrentValue);c1[b1]=i;return C.createCondition(a1,[c1],undefined,undefined,d.NotValidated);}}else if(N===t){return C.createCondition(a1,[i],undefined,undefined,d.NotValidated);}else{return C.createCondition(a1,[X.parseValue(i,N)],undefined,undefined,d.NotValidated);}}}throw new P("Don't know how to parse Condition from "+N);}};function h(i,N){var Q=y(N);var R=v.call(this,N);if(i&&!Q&&R){var U=q.call(this)||N;var W=U.getMetadata().getName();var X=U.getFormatOptions();var Y=U.getConstraints();var Z=this.oFormatOptions.delegate;var $=this.oFormatOptions.payload;var a1=Z&&Z.getTypeUtil($).getBaseType(W,X,Y);if((a1===B.Unit||a1===B.DateTime)&&!i.values[0][1]&&N._aCurrentValue){var b1=N._aCurrentValue[1]?N._aCurrentValue[1]:null;i.values[0][1]=b1;if(i.operator==="BT"){i.values[1][1]=b1;}}}z.call(this,i,N);return i;}function j(i,N,Q,U,R,W,X,Y){var Z;var $;var a1=true;var b1=true;var c1=false;var d1;var e1;var f1=this.oFormatOptions.bindingContext;var g1=this.oFormatOptions.conditionModel;var h1=this.oFormatOptions.conditionModelName;var i1;if(N===""){i1=[];Z=N;d1=N;}else{i1=i.getValues(N,X,U);Z=Y?i1[0]:i1[1];$=Y?i1[1]:i1[0];c1=X!==b.Value;b1=X===b.Value||X===b.ValueDescription;d1=b1?Z||$:$||Z;}var j1=function(n1){if(n1&&!(n1 instanceof P)&&!(n1 instanceof F)){throw n1;}if(!n1._bNotUnique){if(N===""){return null;}if(Y&&i1[0]&&i1[1]){return j.call(this,i,N,Q,U,R,W,X,false);}if(R){return k.call(this,Q,W,N,X);}}if(I.call(this)){return l.call(this,Q,W,N,X);}throw new P(n1.message);};var k1=function(o1){if(o1){var i1=[o1.key];if(i.valueTypes.length>1&&i.valueTypes[1]!==O.ValueType.Static){i1.push(o1.description);}return C.createCondition(i.name,i1,o1.inParameters,o1.outParameters,d.Validated,o1.payload);}else if(N===""){return null;}else{return j1.call(this,new P(this._oResourceBundle.getText("valuehelp.VALUE_NOT_EXIST",[N])));}};var l1=this._oCalls.last;var m1=function(o1,p1){var q1;var r1;try{q1=p1.call(this,o1);if(y(Q)){if(q1){if(q1.operator!=="EQ"){throw new P("unsupported operator");}var s1=Q._aCurrentValue&&Q._aCurrentValue[0]!==undefined?Q._aCurrentValue[0]:null;var t1=q1.values[0];q1.values=[[s1,t1]];}else if(N===""){q1=C.createCondition(i.name,[Q.parseValue(N,"string",Q._aCurrentValue)],undefined,undefined,d.NotValidated);}}}catch(n1){r1=n1;}return g.call(this,q1,r1,l1,false,Q);};try{if(y(Q)){e1=Q.parseValue(d1,"string",Q._aCurrentValue);Q.validateValue(e1);e1=e1[1];}else{e1=Q.parseValue(d1,"string");Q.validateValue(e1);}}catch(n1){if(n1&&!(c1&&(n1 instanceof P||n1 instanceof V))){throw n1;}a1=false;b1=false;e1=undefined;}return e.resolve().then(function(){return J.call(this,d1,e1,Q,f1,b1,a1,c1,g1,h1);}.bind(this)).then(function(o1){return m1.call(this,o1,k1);}.bind(this)).catch(function(n1){return m1.call(this,n1,j1);}.bind(this)).unwrap();}function k(i,N,Q,R){var U=L.call(this,N,i);var W;if(U&&N.indexOf(U.name)>=0){W=U.getCondition(Q,i,b.Value,true);W.validated=d.NotValidated;}return W;}function l(i,N,Q,R){var U;if(y(i)){U=c.getEQOperator("EQ");}else if(N.length===1){U=c.getOperator(N[0]);}else{U=c.getEQOperator(N);if(N.indexOf(U.name)<0){U=undefined;}}if(!U){throw new P("Cannot parse value "+Q);}var W=U.getCondition(Q,i,b.Value,true);if(W){W.validated=d.NotValidated;if(y(i)&&Array.isArray(W.values[0])){W.values[0]=W.values[0][1];}}return W;}f.prototype.validateValue=function(i){var N=o.call(this);var Q=q.call(this);var R=s.call(this);var U=y(N);var W=x.call(this);if(i===undefined||this._bDestroyed){return null;}else if(i===null){if(c.onlyEQ(R)){try{if(N.hasOwnProperty("_sParsedEmptyString")&&N._sParsedEmptyString!==null){N.validateValue(N._sParsedEmptyString);}else{N.validateValue(null);}}catch(X){if(X instanceof V){throw X;}else{return null;}}}return null;}if(typeof i!=="object"||!i.operator||!i.values||!Array.isArray(i.values)){throw new V(this._oResourceBundle.getText("field.VALUE_NOT_VALID"));}var Y=c.getOperator(i.operator);if(U){Y=c.getEQOperator();}if(!Y||R.indexOf(Y.name)===-1){throw new V("No valid condition provided, Operator wrong.");}try{Y.validate(i.values,N,W);}catch(Z){if(Z instanceof V&&Q){Y.validate(i.values,Q,W);}throw Z;}};function n(){var i=this.oFormatOptions.display;if(!i){i=b.Value;}return i;}function o(){var i=this.oFormatOptions.valueType;if(!i){i=p.call(this);}return i;}function p(){if(!this._oDefaultType){this._oDefaultType=new a();}return this._oDefaultType;}function q(){return this.oFormatOptions.originalDateType;}function r(){return this.oFormatOptions.additionalType;}function s(){var i=this.oFormatOptions.operators;if(!i||i.length===0){i=c.getOperatorsForType(B.String);}return i;}function u(){var i=this.oFormatOptions.fieldHelpID;if(i){var N=sap.ui.getCore().byId(i);if(N&&N.isValidationSupported()){return N;}}return null;}function v(i){return i&&i.isA("sap.ui.model.CompositeType");}function x(){return this.oFormatOptions.compositeTypes;}function y(i){if(v(i)){var N=i.getFormatOptions();var Q=!N||!N.hasOwnProperty("showMeasure")||N.showMeasure;var R=!N||!N.hasOwnProperty("showNumber")||N.showNumber;var U=!N||!N.hasOwnProperty("showTimezone")||N.showTimezone;var W=!N||!N.hasOwnProperty("showDate")||N.showDate;var X=!N||!N.hasOwnProperty("showTime")||N.showTime;if((Q&&!R)||(U&&!W&&!X)){return true;}}return false;}function z(i,N){if(v.call(this,N)&&i&&i.values[0]){N._aCurrentValue=m([],i.values[0]);var Q=r.call(this);if(v.call(this,Q)){Q._aCurrentValue=m([],i.values[0]);}var R=q.call(this);if(v.call(this,R)){R._aCurrentValue=m([],i.values[0]);}}}function A(i){if(v.call(this,i)){var N=r.call(this);if(v.call(this,N)){if(!N._aCurrentValue){N._aCurrentValue=[];}i._aCurrentValue=N._aCurrentValue;}}}function D(i,R){i.values=[R.key,R.description];if(R.inParameters){i.inParameters=R.inParameters;}if(R.outParameters){i.outParameters=R.outParameters;}return i;}function E(i){if(this.oFormatOptions.asyncParsing){this.oFormatOptions.asyncParsing(i);}return i;}function G(i){var N=i.getMetadata().getName();var Q=i.getFormatOptions();var R=i.getConstraints();var U=this.oFormatOptions.delegate;var W=this.oFormatOptions.payload;var X=U?U.getTypeUtil(W).getBaseType(N,Q,R):B.String;if(X===B.Unit){X=B.Numeric;}return X;}function H(){var i=u.call(this);var N=this.oFormatOptions.delegate;var Q=this.oFormatOptions.payload;if(N){return N.isInputValidationEnabled(Q,i);}else{return!!i;}}function I(){var i=u.call(this);var N=this.oFormatOptions.delegate;var Q=this.oFormatOptions.payload;if(N){return N.isInvalidInputAllowed(Q,i);}else if(i){return!i.getValidateInput();}else{return true;}}function J(i,N,Q,R,U,W,X,Y,Z){var $=u.call(this);var a1=this.oFormatOptions.delegate;var b1=this.oFormatOptions.payload;var c1=this.oFormatOptions.control;var d1={value:i,parsedValue:N,dataType:Q,inParameters:undefined,outParameters:undefined,bindingContext:R,checkKeyFirst:U,checkKey:W,checkDescription:X,conditionModel:Y,conditionModelName:Z,exception:P,control:c1};if(a1){return a1.getItemForValue(b1,$,d1);}else if($){return $.getItemForValue(d1);}}function K(i,N,Q,R,U,W){var X=u.call(this);var Y=this.oFormatOptions.delegate;var Z=this.oFormatOptions.payload;var $=this.oFormatOptions.control;if(Y){return Y.getDescription(Z,X,i,N.inParameters,N.outParameters,R,U,W,N.payload,$,Q);}else if(X){if(X.isA("sap.ui.mdc.ValueHelp")){var a1={value:i,parsedValue:i,dataType:Q,context:{inParameters:N.inParameters,outParameters:N.outParameters,payload:N.payload},bindingContext:R,conditionModel:U,conditionModelName:W,checkKey:true,checkDescription:false,caseSensitive:true,exception:F,control:$};return X.getItemForValue(a1);}else{return X.getTextForKey(i,N.inParameters,N.outParameters,R,U,W);}}}function L(N,Q){var R=this.oFormatOptions.defaultOperatorName;var U;if(R){U=c.getOperator(R);}else{U=c.getDefaultOperator(G.call(this,Q));}if(U&&N.indexOf(U.name)<0){for(var i=0;i<N.length;i++){U=c.getOperator(N[i]);if(U.exclude||!U.hasRequiredValues()){U=undefined;}else{break;}}}return U;}function M(i){var N=-1;if(i.startsWith(T)){N=parseInt(i[T.length]);}return N;}return f;});
