/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['sap/ui/mdc/valuehelp/base/FilterableListContent','sap/ui/mdc/util/loadModules','sap/base/util/deepEqual','sap/ui/mdc/enum/SelectType','sap/ui/mdc/library','sap/m/library',"sap/ui/table/library","sap/ui/thirdparty/jquery",'sap/ui/mdc/condition/FilterConverter','sap/base/util/restricted/_throttle','sap/ui/mdc/util/Common'],function(F,l,d,S,a,L,u,q,b,t,C){"use strict";var c=L.ListMode;var e=L.Sticky;var M=a.SelectionMode;var U=u.VisibleRowCountMode;var f=u.SelectionMode;var g=u.SelectionBehavior;var _=function(T){var i,v=i=T&&T.getType();if(!v){i="Table";}else if(typeof v==="object"){if(v.isA("sap.ui.mdc.table.ResponsiveTableType")){i="ResponsiveTable";}else{i="Table";}}return i;};var h=function(){var T=this._getTable();var I=T&&T._oTable;var v=T.getRowBinding();var w=function(){return this._oUITableSelectionPlugin||I;}.bind(this);var x=function(i,z){var A=z?S.Add:S.Remove;if(!z&&this._isSingleSelect()){A=S.Add;}this._fireSelect({type:A,conditions:i});};var y={"ResponsiveTable":{getListBindingInfo:function(){return I&&I.getBindingInfo("items");},getItems:function(){return I.getItems();},getSelectedItems:function(){return I.getSelectedItems();},modifySelection:function(i,z){if(i.getSelected()!==z){i.setSelected(z);}},handleItemPress:function(E){var i=E.getParameter("listItem");if(!this.isTypeahead()||!this._isSingleSelect()){i.setSelected(!i.getSelected());}var z=this._getListBindingInfo().model;var A=i.getBindingContext(z);var V=this._getItemFromContext(A);var B=V&&this._createCondition(V.key,V.description,V.payload);x.call(this,[B],i.getSelected());},handleSelectionChange:function(E){if(!this.isTypeahead()||!this._isSingleSelect()){var P=E.getParameters();var i=P.listItems||P.listItem&&[P.listItem];var z=this._getListBindingInfo().model;var A=i.map(function(B){var D=B.getBindingContext(z);var V=this._getItemFromContext(D);return V&&this._createCondition(V.key,V.description,V.payload);}.bind(this));x.call(this,A,P.selected);}},adjustTable:function(){var i=I.getSticky();if(!i||i.length===0){I.setSticky([e.ColumnHeaders]);}if(this._isSingleSelect()){I.setMode(c.SingleSelectLeft);}else{I.setMode(c.MultiSelect);}},handleScrolling:function(i){var z=this.getScrollDelegate();if(z){I.scrollToIndex(i).catch(function(E){});return true;}},handleListBinding:function(){}},"Table":{getListBindingInfo:function(){return I&&I.getBindingInfo("rows");},getItems:function(){return I.getRows().filter(function(R){var i=R.getBindingContext();return i&&i.getObject();});},getSelectedItems:function(){var i=w().getSelectedIndices();var z=i.reduce(function(R,A){var B=I.getContextByIndex(A);return B?R.concat(B):R;},[]);return y["Table"].getItems().filter(function(R){return z.indexOf(R.getBindingContext())>=0;});},modifySelection:function(i,z){var A=i.getBindingContext();var B=y["Table"].getContexts().indexOf(A);var D=w().getSelectedIndices().indexOf(B)>=0;if(z&&!D){return this._isSingleSelect()?w().setSelectedIndex(B):w().addSelectionInterval(B,B);}else if(!z&&D){return w().removeSelectionInterval(B,B);}},handleItemPress:function(E){},handleSelectionChange:function(E){if(this._bScrolling||this._bBusy){return;}var R=E.getParameter("rowIndices");var z=y["Table"].getContexts().filter(function(i,K){return R.indexOf(K)>=0;});var A=y["Table"].getItems().filter(function(i,K){return z.indexOf(i.getBindingContext())>=0;});var B=[],D=[];var G=y["Table"].getSelectedItems();var H=this.getConditions();A.forEach(function(K,i){var N=this._isItemSelected(K,H);var O=G.indexOf(K)!==-1;if(N!==O){var P=G.indexOf(K)!==-1?B:D;var V=this._getItemFromContext(K.getBindingContext());var Q=V&&this._createCondition(V.key,V.description,V.payload);P.push(Q);}}.bind(this));var J=this._isSingleSelect();if(B.length){x.call(this,B,true);if(J){return;}}if(D.length){x.call(this,D,false);}},adjustTable:function(){var R=I.getRowMode();if(!R){I.setVisibleRowCountMode(U.Auto);I.setMinAutoRowCount(3);}else if(R.isA("sap.ui.table.rowmodes.AutoRowMode")){R.setMinRowCount(3);}var i=this._isSingleSelect()?f.Single:f.MultiToggle;I.setSelectionBehavior(g.Row);w().setSelectionMode(i);},handleScrolling:function(i){var z=I.getFirstVisibleRow();if(typeof i==="undefined"||i<0){i=z-1;}if(i>=0&&i!=z){I.setFirstVisibleRow(i);return Promise.resolve();}return false;},getContexts:function(){return v&&v.getAllCurrentContexts();},handleListBinding:function(){v.attachEvent("change",this._handleUpdateFinished.bind(this));}}};return y[this._sTableType];};function j(){if(this._oTableHelper&&!this._bSelectionIsUpdating){this._bSelectionIsUpdating=true;var i=this._oTableHelper.getItems();var v=this.getConditions();var w=[];for(var I in i){var x=i[I];var y=this._isItemSelected(x,v);w.push(this._oTableHelper.modifySelection.call(this,x,y));}Promise.all(w).then(function(){this._bSelectionIsUpdating=false;}.bind(this));}}var k=t(j,100,{leading:true});var m=F.extend("sap.ui.mdc.valuehelp.content.MDCTable",{metadata:{library:"sap.ui.mdc",interfaces:["sap.ui.mdc.valuehelp.IDialogContent"],properties:{},aggregations:{table:{type:"sap.ui.mdc.Table",multiple:false}},events:{},defaultAggregation:"table"}});m.prototype.init=function(){F.prototype.init.apply(this,arguments);this._oObserver.observe(this,{aggregations:["table"]});this._addPromise("listBinding");};var n=function(){var i=this._getTable().getRowBinding();if(i){this._oTableHelper=h.call(this);this._oTableHelper.handleListBinding.call(this);s.call(this);this._resolvePromise("listBinding",i);}};var o=function(){if(this._oTable&&!this._oTable.getHeader()){this._oTable.setHeader(this._oResourceBundle.getText("valuehelp.TABLETITLENONUMBER"));}};m.prototype._handleConditionsUpdate=function(){k.call(this);};m.prototype._handleUpdateFinished=function(E){this._bScrolling=false;this._bSearchTriggered=false;k.call(this);};m.prototype._handleFirstVisibleRowChanged=function(E){this._bScrolling=true;k.call(this);};m.prototype._handleBusyStateChanged=function(E){this._bBusy=E.getParameter("busy");};var p=function(i,v){if(!i){return;}if(v==="remove"){if(this._sTableType==="Table"){i.detachEvent("cellClick",this._handleItemPress,this);i.detachEvent("rowSelectionChange",this._handleSelectionChange,this);i.detachEvent("rowsUpdated",this._handleUpdateFinished,this);i.detachEvent("firstVisibleRowChanged",this._handleFirstVisibleRowChanged,this);i.detachEvent("busyStateChanged",this._handleBusyStateChanged,this);if(this._oUITableSelectionPlugin){this._oUITableSelectionPlugin.detachEvent("selectionChange",this._handleSelectionChange,this);}this._oUITableSelectionPlugin=undefined;}else if(this._sTableType==="ResponsiveTable"){i.detachEvent("itemPress",this._handleItemPress,this);i.detachEvent("selectionChange",this._handleSelectionChange,this);i.detachEvent("updateFinished",this._handleUpdateFinished,this);}this._oObserver.unobserve(i);}else{if(this._sTableType==="Table"){this._oObserver.observe(i,{bindings:["rows"],aggregations:["plugins"]});i.attachEvent("cellClick",this._handleItemPress,this);i.attachEvent("rowSelectionChange",this._handleSelectionChange,this);i.attachEvent("rowsUpdated",this._handleUpdateFinished,this);i.attachEvent("firstVisibleRowChanged",this._handleFirstVisibleRowChanged,this);i.attachEvent("busyStateChanged",this._handleBusyStateChanged,this);this._oUITableSelectionPlugin=i.getPlugins().find(function(P){return P.isA("sap.ui.table.plugins.SelectionPlugin");});if(this._oUITableSelectionPlugin){this._oUITableSelectionPlugin.attachEvent("selectionChange",this._handleSelectionChange,this);}}else if(this._sTableType==="ResponsiveTable"){this._oObserver.observe(i,{bindings:["items"]});i.attachEvent("itemPress",this._handleItemPress,this);i.attachEvent("selectionChange",this._handleSelectionChange,this);i.attachEvent("updateFinished",this._handleUpdateFinished,this);}}};m.prototype._handleSearch=function(E){var i=this.getFilterFields();var v=E.getSource();var w=v.getInternalConditions();var x=i&&w[i]&&w[i][0];var y=x&&x.values[0];this.setFilterValue(y);};m.prototype._observeChanges=function(i){if(["_defaultFilterBar","filterBar"].indexOf(i.name)!==-1){r.call(this);}if(i.name==="table"){var T=i.child;if(i.mutation==="remove"){this._oObserver.unobserve(T);this._oTable=null;this._oTableHelper=null;this._addPromise("listBinding");}else{this._oTable=T;this._oObserver.observe(T,{aggregations:["_content"]});this._sTableType=_(T);T.addDelegate({onmouseover:function(E){var I=q(E.target).control(0);if(I&&I.isA("sap.m.ColumnListItem")){I.setType("Active");}}});p.call(this,this._oTable._oTable,"insert");n.call(this);o.call(this);r.call(this);}return;}if(i.name==="_content"){p.call(this,i.child,i.mutation);return;}if(["rows","items"].indexOf(i.name)!==-1&&i.mutation==="ready"){n.call(this);return;}if(i.name==="config"){s.call(this);}if(i.name==="plugins"){this._oUITableSelectionPlugin=i.mutation==="remove"||!i.child.isA("sap.ui.table.plugins.SelectionPlugin")?undefined:i.child;if(this._oUITableSelectionPlugin){this._oUITableSelectionPlugin.attachEvent("selectionChange",this._handleSelectionChange,this);}}F.prototype._observeChanges.apply(this,arguments);};m.prototype._getTable=function(){return this._oTable;};function r(){var i=this._getPriorityFilterBar();if(this._oTable&&i&&this._oTable.getFilter()!==i.getId()){this._oTable.setFilter(i);}}function s(){if(this._oTableHelper){this._oTableHelper.adjustTable.call(this);}}m.prototype.getContent=function(){return this._retrievePromise("wrappedContent",function(){return l(["sap/ui/layout/FixFlex","sap/m/VBox","sap/m/ScrollContainer"]).then(function(i){var v=i[0];var V=i[1];var w=i[2];if(!this._oContentLayout){this._oFilterBarVBox=new V(this.getId()+"-FilterBarBox",{visible:"{$this>/_filterBarVisible}"});this._oFilterBarVBox.addStyleClass("sapMdcValueHelpPanelFilterbar");this._oFilterBarVBox._oWrapper=this;this._oFilterBarVBox.getItems=function(){var x=this._oWrapper._getPriorityFilterBar.call(this._oWrapper);var I=x?[x]:[];return I;};this._oTableBox=new V(this.getId()+"-TB",{height:"100%"});this._oTableBox.addStyleClass("sapMdcValueHelpPanelTableBox");this._oTableBox._oWrapper=this;this._oTableBox.getItems=function(){var T=this._oWrapper._sTableType==="ResponsiveTable"?this._oWrapper._oScrollContainer:this._oWrapper._oTable;var I=T?[T]:[];return I;};this._oContentLayout=new v(this.getId()+"-FF",{minFlexSize:200,fixContent:this._oFilterBarVBox,flexContent:this._oTableBox});this._oScrollContainer=new w(this.getId()+"-SC",{height:"calc(100% - 0.5rem)",width:"100%",vertical:true});this._oScrollContainer._oWrapper=this;this._oScrollContainer.getContent=function(){var x=[];var T=this._oWrapper&&this._oWrapper._oTable;if(T){x.push(T);}return x;};}this.setAggregation("displayContent",this._oContentLayout);if(!this._getPriorityFilterBar()){return this._createDefaultFilterBar().then(function(){this._oFilterBarVBox.invalidate();return this._oContentLayout;}.bind(this));}return this._oContentLayout;}.bind(this));}.bind(this));};m.prototype.getListBinding=function(){var T=this.getTable();return T&&T.getRowBinding();};m.prototype._getListBindingInfo=function(){return this._oTableHelper&&this._oTableHelper.getListBindingInfo();};m.prototype.onShow=function(){if(this._oTable){var i=F.prototype._isSingleSelect.apply(this)?M.Single:M.Multi;if(this._oTable.getSelectionMode()===M.None){this._oTable.setSelectionMode(i);}if(this._oTable.getSelectionMode()!==i){throw new Error("Table selectionMode needs to be "+i);}}F.prototype.onShow.apply(this,arguments);};m.prototype.onHide=function(){this._bSearchTriggered=false;F.prototype.onHide.apply(this,arguments);};m.prototype._createFiltersFromBarConditions=function(i){var v=this._getTypesForConditions(i);var w=i&&v&&b.createFilters(i,v,undefined,this.getCaseSensitive());return w&&[].concat(w);};m.prototype.applyFilters=function(i){var T=this.getTable();var v=this._getPriorityFilterBar();if(T&&v){var w=this.getListBinding();var x=w&&w.isSuspended();if(w&&!x&&!this._bSearchTriggered){var y=v.getSearch()||"";var B=w.mParameters.$search||"";var z=this._createFiltersFromBarConditions(v.getConditions());var A=w.aApplicationFilters.reduce(function(R,H){return R.concat(H._bMultiFilter?H.aFilters:H);},[]);var D=!d(z,A);var E=y!==B;var G=T._oTable&&T._oTable.getShowOverlay&&T._oTable.getShowOverlay();if(D||E||G){this._handleScrolling();v.triggerSearch();this._bSearchTriggered=true;}}if(x){w.resume();}if(!w&&T.getAutoBindOnInit()){this._retrievePromise("listBinding").then(function(){this.applyFilters(i);}.bind(this));}}};m.prototype._handleScrolling=function(i){return this._oTableHelper&&this._oTableHelper.handleScrolling.call(this,i);};m.prototype.getScrollDelegate=function(){if(!this.isTypeahead()&&this._oScrollContainer){return this._oScrollContainer.getScrollDelegate();}return F.prototype.getScrollDelegate.apply(this,arguments);};m.prototype._handleItemPress=function(E){this._oTableHelper.handleItemPress.call(this,E);};m.prototype._handleSelectionChange=function(E){if(!this._bSelectionIsUpdating){this._oTableHelper.handleSelectionChange.call(this,E);}};m.prototype.isQuickSelectSupported=function(){return true;};m.prototype.setParent=function(P){F.prototype.setParent.apply(this,arguments);s.call(this);};m.prototype._isSingleSelect=function(){if(this._oTable){if(this._oTable.getSelectionMode()===M.Multi){return false;}else{return true;}}else{return F.prototype._isSingleSelect.apply(this,arguments);}};m.prototype.exit=function v(i){C.cleanup(this,["_oContentLayout","_oFilterBarVBox","_oTableBox","_oResourceBundle","_oScrollContainer","_oTableHelper","_bSelectionIsUpdating","_bScrolling","_bBusy","_sTableType","_oUITableSelectionPlugin","_oTable"]);F.prototype.exit.apply(this,arguments);};return m;});
