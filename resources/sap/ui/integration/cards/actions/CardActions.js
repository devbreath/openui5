/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/integration/library","sap/base/Log","sap/ui/base/ManagedObject","sap/ui/integration/cards/actions/CustomAction","sap/ui/integration/cards/actions/DateChangeAction","sap/ui/integration/cards/actions/MonthChangeAction","sap/ui/integration/cards/actions/SubmitAction","sap/ui/integration/cards/actions/NavigationAction","sap/ui/integration/util/BindingHelper","sap/ui/integration/util/BindingResolver","sap/base/strings/capitalize","sap/base/util/deepClone","sap/ui/integration/cards/actions/ShowCardAction","sap/ui/integration/cards/actions/HideCardAction"],function(l,L,M,C,D,a,S,N,B,b,c,d,f,H){"use strict";function _(s){if(s&&typeof s==="object"){return s.name;}return s;}var A=l.CardActionArea,g=l.CardActionType;var h=M.extend("sap.ui.integration.cards.actions.CardActions",{metadata:{library:"sap.ui.integration",properties:{card:{type:"object"},bindingPathResolver:{type:"function"}}}});h.prototype.attach=function(o){var e=o.control,s=o.area;o.actionControl=o.actionControl||o.control;o.enabledPropertyValue=o.enabledPropertyValue||true;o.disabledPropertyValue=o.disabledPropertyValue||false;o.eventName=o.eventName||"press";if(!o.actions){this._fireActionReady(e,s);return;}var i=o.actions[0];if(i&&i.type){o.action=i;this._attachAction(o);}else{this._fireActionReady(e,s);}};h.prototype._attachAction=function(o){var e=o.action,s=o.area,i=o.control,j=o.actionControl,E=o.enabledPropertyName,v=o.enabledPropertyValue,k=o.disabledPropertyValue,m=true,n=this._isSingleAction(s),p=true;if(E){m=false;if(e.service&&!n){this._setControlEnabledStateUsingService(e,i,j,E,v,k);}else{this._setControlEnabledState(e,j,E,v,k);}}if(e.service&&n){this._getSingleActionEnabledState(e,i).then(function(q){if(q){this._attachEventListener(o);}this._fireActionReady(i,s);}.bind(this));return;}if(m){p=e.enabled!==false&&e.enabled!=="false";}if(p){this._attachEventListener(o);}this._fireActionReady(i,s);};h.prototype._setControlEnabledStateUsingService=function(o,e,i,p,E,v){var j=M.bindingParser("{path:''}");j.formatter=function(V){var k=this.getBindingContext(),P,m;if(k){P=k.getPath();}m=b.resolveValue(o.parameters,e,P);if(V.__resolved){if(!V.__enabled||V.__enabled==="false"){return v;}return E;}if(!V.__promise){V.__promise=true;e._oServiceManager.getService(_(o.service)).then(function(n){if(n){n.enabled({parameters:m}).then(function(q){V.__resolved=true;V.__enabled=q;e.getModel().checkUpdate(true);}).catch(function(){V.__resolved=true;V.__enabled=false;});}else{V.__resolved=true;V.__enabled=false;}});}return v;};i.bindProperty(p,j);};h.prototype._setControlEnabledState=function(o,e,p,E,v){var i,V;if(typeof o.enabled==="object"){i=B.formattedProperty(o.enabled,function(j){if(!j||j==="false"){return v;}return E;});}if(i){e.bindProperty(p,i);}else{V=(o.enabled===false||o.enabled==="false")?v:E;e.setProperty(p,V);}};h.prototype._getSingleActionEnabledState=function(o,e){var i=e.getBindingContext(),p,P;if(i){P=i.getPath();}p=b.resolveValue(o.parameters,e,P);return new Promise(function(r){e._oServiceManager.getService(_(o.service)).then(function(n){if(n){n.enabled({parameters:p}).then(function(E){r(E);}).catch(function(){r(false);});}else{r(false);}}).catch(function(){r(false);});});};h.prototype._fireActionReady=function(o,s){var e=s===A.Header;var E=e?"_actionHeaderReady":"_actionContentReady";o.fireEvent(E);};h.prototype._resolveBindingPath=function(e){var o=e.getSource().getBindingContext(),p;if(this.getBindingPathResolver()){p=this.getBindingPathResolver()(e);}else if(o){p=o.getPath();}return p;};h.prototype._handleServiceAction=function(E,o,i){var s=E.getSource();var p=this._resolveBindingPath(E);i._oServiceManager.getService(_(o.service)).then(function(e){if(e){e.navigate({parameters:b.resolveValue(o.parameters,s,p)});}}).catch(function(e){L.error("Navigation service unavailable",e);}).finally(function(){this._processAction(s,o,p);}.bind(this));};h.prototype._attachEventListener=function(o){var e=o.action;o.actionControl["attach"+c(o.eventName)](function(E){var s=E.getSource();if(e.service){this._handleServiceAction(E,e,o.control);}else{this._processAction(s,e,this._resolveBindingPath(E));}}.bind(this));};h.prototype._processAction=function(s,o,p){var e=this._getHostInstance(),i=this.getCard();h.fireAction({card:i,host:e,action:o,parameters:b.resolveValue(o.parameters,s,p),source:s});};h.prototype._getHostInstance=function(){var o=this.getCard();if(o){return o.getHostInstance();}return null;};h.prototype.fireAction=function(s,t,p){h.fireAction({card:this.getCard(),host:this._getHostInstance(),action:{type:t},parameters:p,source:s});};h.fireAction=function(m){var o=m.host,e=m.card,E=e.getAggregation("_extension"),t=m.action.type,p=d(m.parameters,100)||{},i={type:t,card:e,actionSource:m.source},j,k;if(t===g.Submit){p.data=e.getModel("form").getData();}i.parameters=p;j=Object.assign({},i,{manifestParameters:p});k=e.fireAction(j);if(!k){return false;}if(o){k=o.fireAction(i);}if(!k){return false;}if(E){k=E.fireAction(i);}if(k){var n=h._createHandler(m);if(n){n.execute();n.destroy();}}return k;};h.prototype._isSingleAction=function(s){return[A.Header,A.Content,A.ContentItemDetail,A.ActionsStrip].indexOf(s)>-1;};h._createHandler=function(m){var e=null;switch(m.action.type){case g.Custom:e=C;break;case g.DateChange:e=D;break;case g.HideCard:e=H;break;case g.MonthChange:e=a;break;case g.Navigation:e=N;break;case g.ShowCard:e=f;break;case g.Submit:e=S;break;default:L.error("Unknown action type '"+m.action.type+"'. Expected one of "+Object.values(g).join(", "),null,"sap.ui.integration.widgets.Card");}if(e){return new e({config:m.action,parameters:m.parameters,actionHandler:m.card.getManifestEntry("/sap.card/configuration/actionHandlers/"+m.action.type.toLowerCase()),card:m.card,source:m.source});}return null;};return h;});
