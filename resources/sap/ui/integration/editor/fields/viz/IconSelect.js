/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/integration/editor/fields/viz/VizBase","sap/m/Select","sap/ui/core/ListItem","sap/ui/model/json/JSONModel","sap/ui/core/IconPool","sap/base/util/merge","sap/ui/core/Core","sap/base/util/deepClone"],function(V,S,L,J,I,m,C,d){"use strict";var r=C.getLibraryResourceBundle("sap.ui.integration"),D;var c=V.extend("sap.ui.integration.editor.fields.viz.IconSelect",{metadata:{library:"sap.ui.integration",properties:{value:{type:"string",defaultValue:"sap-icon://accept"},allowFile:{type:"boolean",defaultValue:true},allowNone:{type:"boolean",defaultValue:true}}},renderer:V.getMetadata().getRenderer()});c.prototype._initIconModel=function(){var i=I.getIconNames();i=i.sort(function(a,b){return a.toLowerCase().localeCompare(b.toLowerCase());});var e=[];if(!D){i.filter(function(s){var t=I.getIconInfo(s).text||("-"+s).replace(/-(.)/ig,function(M,a){return" "+a.toUpperCase();}).substring(1);e.push({icon:"sap-icon://"+s,key:"sap-icon://"+s,text:t,tooltip:t,enabled:true});});D=d(e,500);}else{e=d(D,500);}e=[{icon:"",text:r.getText("EDITOR_ICON_NONE"),tooltip:"",key:"",enabled:true},{icon:"sap-icon://upload",text:r.getText("EDITOR_ICON_CHOOSE"),tooltip:"",key:"file",enabled:true},{icon:"sap-icon://download",text:r.getText("EDITOR_ICON_SELECTED"),tooltip:"",key:"selected",enabled:false}].concat(e);this._oIconModel=new J(e);this._oIconModel.setSizeLimit(e.length);};c.prototype.onInit=function(){if(r&&r.sLocale!==C.getConfiguration().getLanguage()){r=C.getLibraryResourceBundle("sap.ui.integration");}if(!this._oIconModel){this._initIconModel();}var i=new L({icon:"{iconlist>icon}",text:"{iconlist>text}",tooltip:"{iconlist>tooltip}",key:"{iconlist>key}",enabled:"{iconlist>enabled}"});this._oFileUpload=document.createElement("INPUT");this._oFileUpload.type="file";this._oFileUpload.accept=".png,.jpg,.jpeg,.svg";this._boundFileUploadChange=this._fileUploadChange.bind(this);this._oFileUpload.addEventListener("change",this._boundFileUploadChange);this._oControl=new S({width:"100%",items:{path:"iconlist>/",template:i},change:function(e){var s=e.getSource(),a=e.getSource().getSelectedKey();if(a==="file"){s._customImage=null;this._oFileUpload.click();this._boundFocusBack=this._focusBack.bind(this);s.getDomRef("hiddenSelect").addEventListener("focus",this._boundFocusBack);}else{this.setValue(a);}}.bind(this)});this._oControl.setModel(this._oIconModel,"iconlist");var o=this._oControl.open;this._oControl.open=function(){o&&o.apply(this,arguments);this.getPicker().addStyleClass("sapUiIntegrationIconSelectList");this.getPicker().setContentHeight("400px");};this._oControl.addDelegate({onAfterRendering:function(){var a=this._oControl.getDomRef("labelIcon");if(a){var s=this._oControl._customImage;if(s){a.style.backgroundImage="url('"+s+"')";a.classList.add("sapMSelectListItemIconCustom");}else{a.style.backgroundImage="unset";a.classList.remove("sapMSelectListItemIconCustom");}}}.bind(this)});this._oControl.addDelegate({onsappageup:function(){if(this._oControl.isOpen()){var s=this._oControl.getSelectedIndex();this._oControl.setSelectedIndex(s-50);}}.bind(this),onsappagedown:function(){if(this._oControl.isOpen()){var s=this._oControl.getSelectedIndex();if(s<3){this._oControl.setSelectedIndex(29);}else{this._oControl.setSelectedIndex(s+50);}}}.bind(this),onsapup:function(){if(this._oControl.isOpen()){var a=this.getAllowFile();var A=this.getAllowNone();var f=this._oIconModel.getProperty("/2/enabled");var s=this._oControl.getSelectedIndex();if(s>11+2){this._oControl.setSelectedIndex(s-11);}else if(s>=3){if(A&&!a){this._oControl.setSelectedIndex(0);}else if(f){this._oControl.setSelectedIndex(2);}else{this._oControl.setSelectedIndex(3);}}}}.bind(this),onsapdown:function(){if(this._oControl.isOpen()){var s=this._oControl.getSelectedIndex();if(s>1){this._oControl.setSelectedIndex(s+11);}}}.bind(this),onsapleft:function(){if(this._oControl.isOpen()){this._oControl.onsapup.apply(this._oControl,arguments);}}.bind(this),onsapright:function(){if(this._oControl.isOpen()){this._oControl.onsapdown.apply(this._oControl,arguments);}}.bind(this)},true);};c.prototype.applyStyle=function(R){R.addClass("sapUiIntegrationIconSelect");if(this._oControl&&this._oControl.getWidth){R.addStyle("width",this._oControl.getWidth());}};c.prototype._fileUploadChange=function(){var f=new window.FileReader();f.onload=function(){this.setValue(f.result);this._oControl.invalidate();}.bind(this);if(this._oFileUpload.files.length===1){f.readAsDataURL(this._oFileUpload.files[0]);}};c.prototype._focusBack=function(){this._oControl.getDomRef("hiddenSelect").removeEventListener("focus",this._boundFocusBack);setTimeout(function(){this.setValue(this.getValue());}.bind(this),150);};c.prototype.bindPropertyToControl=function(p,b){if(p==="editable"){var o=m({},b);this._oControl.bindProperty("editable",o);}};c.prototype.setValue=function(v){this.setProperty("value",v,true);if(v&&v.indexOf("data:image/")===0){this._oControl._customImage=v;this._oIconModel.setProperty("/2/enabled",true);this._oControl.setSelectedKey("selected");}else{this._oControl._customImage=null;this._oIconModel.setProperty("/2/enabled",false);this._oControl.setSelectedKey(v);}this._oControl.invalidate();return this;};c.prototype.setAllowFile=function(v){this.setProperty("allowFile",v,true);v=this.getAllowFile();this._oIconModel.setProperty("/1/enabled",v);return this;};c.prototype.setAllowNone=function(v){this.setProperty("allowNone",v,true);v=this.getAllowNone();this._oIconModel.setProperty("/0/enabled",v);return this;};return c;});
