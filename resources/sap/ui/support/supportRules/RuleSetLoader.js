/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/base/util/extend","sap/base/util/ObjectPath","sap/ui/VersionInfo","sap/ui/support/supportRules/RuleSet","sap/ui/support/supportRules/CommunicationBus","sap/ui/support/supportRules/WCBChannels","sap/ui/support/supportRules/RuleSerializer","sap/ui/support/supportRules/Constants","sap/ui/support/supportRules/util/EvalUtils","sap/ui/support/supportRules/util/Utils","sap/ui/thirdparty/jquery"],function(L,b,O,V,R,C,c,d,f,E,U,q){"use strict";var g=(function(){var a;return function(u){if(!a){a=document.createElement('a');}a.href=u;return a.href.replace(/\/$/,'');};})();var s="sprt";var S=sap.ui.require.toUrl("sap/ui/support");var h=S.replace('/sap/ui/support','');var A=g(h);var j={};j._mRuleSets={};j.getRuleSets=function(){return this._mRuleSets;};j.addRuleSet=function(l,r){this._mRuleSets[l]=r;};j.getRuleSet=function(l){return this._mRuleSets[l];};j._fetchSupportRuleSets=function(r,l){var t=this,m=l||sap.ui.getCore().getLoadedLibraries(),o=this._fetchLibraryNamesWithSupportRules(m);var M=new Promise(function(a){V.load({library:"sap.ui.core"}).then(function(e){R.versionInfo=e;o.then(function(i){var k=t._fetchLibraryFiles(i,j._fetchRuleSet);Promise.all(k).then(function(){t._bRulesCreated=true;C.publish(c.UPDATE_SUPPORT_RULES,{sRuleSet:d.serialize(t._mRuleSets),oVersionInfo:R.versionInfo});a();if(r&&typeof r==="function"){r();}});});});});return M;};j.loadAdditionalRuleSets=function(l){var t=this,a=t._fetchLibraryFiles(l,t._fetchRuleSet);Promise.all(a).then(function(){t._bRulesCreated=true;C.publish(c.UPDATE_SUPPORT_RULES,{sRuleSet:d.serialize(t._mRuleSets)});});};j._fetchLibraryNamesWithSupportRules=function(l){return new Promise(function(m){U.canLoadInternalRulesAsync().then(function(a){var o={publicRules:[],internalRules:[],allRules:[]};l=l||{};var e=[];Object.keys(l).forEach(function(i){var M=new Promise(function(r){var k=A+"/"+i.replace(/\./g,'/')+"/.supportrc";q.ajax({type:"GET",dataType:"json",url:k,success:function(n){r({lib:i,rcData:n});},error:function(){r({lib:i,rcData:null});}});});e.push(M);});Promise.all(e).then(function(i){i.forEach(function(k){if(k.rcData){var H=false;if(k.rcData.publicRules){o.publicRules.push(k.lib);H=true;}if(a&&k.rcData.internalRules){o.internalRules.push(k.lib);H=true;}if(H&&o.allRules.indexOf(k.lib)<0){o.allRules.push(k.lib);}}m(o);});});});});};j._fetchLibraryFiles=function(l,p,a){var e=[],t=this,i=sap.ui.require.toUrl("sap/ui/support"),k=i.replace("sap/ui/support",""),m=U.canLoadInternalRules(),H=m&&l.internalRules.length>0,P=0,r=l.publicRules.length;var n=sap.ui.getCore().getConfiguration().getSupportMode();var o=n&&n.indexOf("silent")>-1;if(H){r+=l.internalRules.length;}function u(){P+=1;var v=Math.ceil((P/r)*100);C.publish(c.CURRENT_LOADING_PROGRESS,{value:v});}if(l.publicRules.length>0){l.publicRules.forEach(function(v){var w=t._registerLibraryPath(v,i,k);if(w){var x=t._requireRuleSet(w.customizableLibName,p);if(!o&&!a){x.then(function(){u();});}e.push(x);}});}if(m&&l.internalRules.length>0){l.internalRules.forEach(function(v){var w=t._registerLibraryPath(v,i,k);if(w){var x=t._requireRuleSet(w.internalLibName,p);if(!o&&!a){x.then(function(){u();});}e.push(x);}});}return e;};j._registerLibraryPath=function(l,a,e){if(this._mRuleSets[l]){return null;}var i=l.replace(/\./g,"/");var k=i;var m=this._getLoadFromSupportOrigin();var p={};if(m){k+='/'+s;p[k]=e+i;}var n=k+'/internal';var o=e.replace('resources/','')+'test-resources/'+i+'/internal';p[n]=o;sap.ui.loader.config({paths:p});return{internalLibName:n.replace(/\//g,"."),customizableLibName:k.replace(/\//g,".")};};j._requireRuleSet=function(l,p){var t=this;return new Promise(function(r){try{sap.ui.require([l.replace(/\./g,"/")+"/library.support"],function(){p.call(t,l);r();},r);}catch(e){r();}});};j._fetchRuleSet=function(l){try{var n,o,a,i=O.get(l).library.support;if(!i){throw"The library.support file was not fetched successfully.";}n=l.replace("."+s,"").replace(".internal","");o=b({},i);a=this._mRuleSets[n];if(!(o.ruleset instanceof R)){o=this._createRuleSet(o);}if(a){a.ruleset._mRules=b(a.ruleset._mRules,o.ruleset._mRules);}else{a=o;}this._mRuleSets[n]=a;}catch(e){L.error("["+f.SUPPORT_ASSISTANT_NAME+"] Failed to load RuleSet for "+l+" library",e);}};j._getLoadFromSupportOrigin=function(){var a=new URL(sap.ui.require.toUrl("sap/ui/core"),document.baseURI);var e=new URL(sap.ui.require.toUrl("sap/ui/support"),document.baseURI);return a.origin!==e.origin;};j.fetchNonLoadedRuleSets=function(l){V.load().then(function(v){var o={};v.libraries.forEach(function(a){o[a.name]=a;});return this._fetchLibraryNamesWithSupportRules(o);}.bind(this)).then(function(o){var n=[];o.allRules.forEach(function(a){if(l.indexOf(a)<0){n.push(a);}});C.publish(c.POST_AVAILABLE_LIBRARIES,{libNames:n});});};j._onLibraryChanged=function(e){var t=this;if(e.getParameter("stereotype")==="library"&&j._bRulesCreated){t._oMainPromise=j._fetchSupportRuleSets();}};j.updateRuleSets=function(r){this._oMainPromise=j._fetchSupportRuleSets(r);};j._createRuleSet=function(l){var o={name:l.name,niceName:l.niceName};var r=new R(o);for(var i=0;i<l.ruleset.length;i++){var a=l.ruleset[i];if(Array.isArray(a)){for(var k=0;k<a.length;k++){r.addRule(a[k]);}}else{r.addRule(a);}}return{lib:o,ruleset:r};};j.getAllRules=function(){var r={};Object.keys(this._mRuleSets).map(function(l){r=b(r,this._mRuleSets[l].ruleset.getRules());},this);return r;};j.getAllRuleDescriptors=function(){var r=this.getAllRules();return Object.keys(r).map(function(a){return{libName:r[a].libName,ruleId:a};});};if(E.isEvalAllowed()){j.addRuleSet(f.TEMP_RULESETS_NAME,{lib:{name:f.TEMP_RULESETS_NAME},ruleset:new R({name:f.TEMP_RULESETS_NAME})});}return j;},true);
