/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['sap/ui/base/ManagedObject','sap/ui/thirdparty/URI','sap/base/Log','sap/base/util/extend','sap/base/util/mixedFetch','sap/base/strings/escapeRegExp','sap/ui/core/_IconRegistry','./Core'],function(M,U,L,a,m,b,_){"use strict";var c=sap.ui.getCore().getConfiguration();var l=c.getLanguage();var s=c.getAppCacheBusterMode()==="sync";var B=c.getAppCacheBusterMode()==="batch";var S={index:{},active:false};var v,d,f,x,E;var g=document.baseURI.replace(/\?.*|#.*/g,"");var u=U(sap.ui.require.toUrl("")+"/../");var o=u.toString();if(u.is("relative")){u=u.absoluteTo(g);}var h=u.normalize().toString();var r=U("resources").absoluteTo(h).toString();var F=new RegExp("^"+b(r));var i=function(e){if(e.length>0&&e.slice(-1)!=="/"){e+="/";}return e;};var R=function(h,e){var I=S.index;var j;var k;var n;var p,q;if(Array.isArray(h)&&!B){h.forEach(function(K){R(K,e);});}else if(Array.isArray(h)&&B){var t=i(h[0]);var C=[];L.debug("sap.ui.core.AppCacheBuster.register(\""+t+"\"); // BATCH MODE!");var w=A.normalizeURL(t);L.debug("  --> normalized to: \""+w+"\"");h.forEach(function(K){k=i(K);var N=A.normalizeURL(k);if(!I[n]){C.push(N);}});if(C.length>0){k=w+"sap-ui-cachebuster-info.json?sap-ui-language="+l;j={body:C.join("\n"),headers:{"Accept":m.ContentTypes.JSON,"Content-Type":"text/plain"},mode:"POST"};p=function(K){A.onIndexLoaded(k,K);a(I,K);};q=function(k){L.error("Failed to batch load AppCacheBuster index file from: \""+k+"\".");};}}else{h=i(h);L.debug("sap.ui.core.AppCacheBuster.register(\""+h+"\");");n=A.normalizeURL(h);L.debug("  --> normalized to: \""+n+"\"");if(!I[n]){k=n+"sap-ui-cachebuster-info.json?sap-ui-language="+l;j={headers:{Accept:m.ContentTypes.JSON},mode:"POST"};p=function(K){A.onIndexLoaded(k,K);I[n]=K;};q=function(k){L.error("Failed to load AppCacheBuster index file from: \""+k+"\".");};}}if(j){var y=A.onIndexLoad(k);if(y!=null){L.info("AppCacheBuster index file injected for: \""+k+"\".");p(y);}else{var z=!s&&!!e;if(z){var D=e.startTask("load "+k);var G=p,J=q;p=function(K){G.apply(this,arguments);e.finishTask(D);};q=function(){J.apply(this,arguments);e.finishTask(D,false);};}L.info("Loading AppCacheBuster index file from: \""+k+"\".");m(k,j,!z).then(function(K){if(K.ok){return K.json();}else{throw new Error("Status code: "+K.status);}}).then(p).catch(function(){q(k);});}}};var A={boot:function(e){var C=c.getAppCacheBuster();if(C&&C.length>0){C=C.slice();var j=true;var V=String(C[0]).toLowerCase();if(C.length===1){if(V==="true"||V==="x"){var u=U(o);C=u.is("relative")?[u.toString()]:[];}else if(V==="false"){j=false;}}if(j){A.init();R(C,e);}}},init:function(){S.active=true;v=M.prototype.validateProperty;d=Object.getOwnPropertyDescriptor(HTMLScriptElement.prototype,"src");f=Object.getOwnPropertyDescriptor(HTMLLinkElement.prototype,"href");var C=A.convertURL;var n=A.normalizeURL;var I=function(e){if(this.active===true&&e&&typeof(e)==="string"){e=n(e);return!e.match(F);}return false;}.bind(S);x=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=function(e,q){if(q&&I(q)){arguments[1]=C(q);}x.apply(this,arguments);};E=XMLHttpRequest.prototype.open;M.prototype.validateProperty=function(P,V){var q=this.getMetadata(),t=q.getProperty(P),w;if(t&&t.type==="sap.ui.core.URI"){w=Array.prototype.slice.apply(arguments);try{if(I(w[1])){w[1]=C(w[1]);}}catch(e){}}return v.apply(this,w||arguments);};_._convertUrl=function(e){return C(e);};var j=function(e){var q={get:e.get,set:function(t){if(I(t)){t=C(t);}e.set.call(this,t);},enumerable:e.enumerable,configurable:e.configurable};q.set._sapUiCoreACB=true;return q;};var k=false;try{Object.defineProperty(HTMLScriptElement.prototype,"src",j(d));}catch(p){L.error("Your browser doesn't support redefining the src property of the script tag. Disabling AppCacheBuster as it is not supported on your browser!\nError: "+p);k=true;}try{Object.defineProperty(HTMLLinkElement.prototype,"href",j(f));}catch(p){L.error("Your browser doesn't support redefining the href property of the link tag. Disabling AppCacheBuster as it is not supported on your browser!\nError: "+p);k=true;}if(k){this.exit();}},exit:function(){M.prototype.validateProperty=v;delete _._convertUrl;if(XMLHttpRequest.prototype.open===E){XMLHttpRequest.prototype.open=x;}var e;if((e=Object.getOwnPropertyDescriptor(HTMLScriptElement.prototype,"src"))&&e.set&&e.set._sapUiCoreACB===true){Object.defineProperty(HTMLScriptElement.prototype,"src",d);}if((e=Object.getOwnPropertyDescriptor(HTMLLinkElement.prototype,"href"))&&e.set&&e.set._sapUiCoreACB===true){Object.defineProperty(HTMLLinkElement.prototype,"href",f);}S.index={};S.active=false;S={index:{},active:false};},register:function(h){R(h);},convertURL:function(e){L.debug("sap.ui.core.AppCacheBuster.convertURL(\""+e+"\");");var I=S.index;if(I&&e&&!/^#/.test(e)){var n=A.normalizeURL(e);L.debug("  --> normalized to: \""+n+"\"");if(n&&A.handleURL(n)){for(var h in I){var j=I[h],k,p;if(h&&n.length>=h.length&&n.slice(0,h.length)===h){k=n.slice(h.length);p=k.match(/([^?#]*)/)[1];if(j[p]){e=h+"~"+j[p]+"~/"+k;L.debug("  ==> rewritten to \""+e+"\";");break;}}}}}return e;},normalizeURL:function(e){var u=U(e||"./");if(u.is("relative")){u=u.absoluteTo(g);}return u.normalizeProtocol().normalizeHostname().normalizePort().normalizePath().toString();},handleURL:function(e){return true;},onIndexLoad:function(e){return null;},onIndexLoaded:function(e,I){}};var H=c.getAppCacheBusterHooks();if(H){["handleURL","onIndexLoad","onIndexLoaded"].forEach(function(e){if(typeof H[e]==="function"){A[e]=H[e];}});}return A;},true);
