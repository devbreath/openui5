/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./_ODataMetaModelUtils","sap/base/Log","sap/base/util/extend","sap/base/util/isEmptyObject","sap/base/util/UriParameters","sap/ui/base/BindingParser","sap/ui/base/ManagedObject","sap/ui/base/SyncPromise","sap/ui/model/BindingMode","sap/ui/model/ClientContextBinding","sap/ui/model/Context","sap/ui/model/FilterProcessor","sap/ui/model/MetaModel","sap/ui/model/json/JSONListBinding","sap/ui/model/json/JSONModel","sap/ui/model/json/JSONPropertyBinding","sap/ui/model/json/JSONTreeBinding","sap/ui/performance/Measurement"],function(U,L,e,a,b,B,M,S,c,C,d,F,f,J,g,h,k,l){"use strict";var m=new Map(),o="sap.ui.model.odata.ODataMetaModel",p=[o],P=o+"/load",r=/^((\/dataServices\/schema\/\d+)\/(?:complexType|entityType)\/\d+)\/property\/\d+$/;var O=J.extend("sap.ui.model.odata.ODataMetaListBinding"),R=M.extend("sap.ui.model.odata._resolver",{metadata:{properties:{any:"any"}}});O.prototype.applyFilter=function(){var t=this,i=F.combineFilters(this.aFilters,this.aApplicationFilters);this.aIndices=F.apply(this.aIndices,i,function(v,s){return s==="@sapui.name"?v:t.oModel.getProperty(s,t.oList[v]);},this.mNormalizeCache);this.iLength=this.aIndices.length;};var n=f.extend("sap.ui.model.odata.ODataMetaModel",{constructor:function(i,A,D){var j=D.annotationsLoaded(),t=this;function q(){var s;if(t.bDestroyed){throw new Error("Meta model already destroyed");}l.average(P,"",p);s=JSON.parse(JSON.stringify(i.getServiceMetadata()));t.oModel=new g(s);t.oModel.setDefaultBindingMode(t.sDefaultBindingMode);U.merge(A?A.getAnnotationsData():{},s,t);l.end(P);}f.apply(this);this.oModel=null;this.mContext2Promise={};this.sDefaultBindingMode=c.OneTime;this.oLoadedPromise=j?j.then(q):new Promise(function(s,u){q();s();});this.oLoadedPromiseSync=S.resolve(this.oLoadedPromise);this.oMetadata=i;this.oDataModel=D;this.mQueryCache={};this.mQName2PendingRequest={};this.oResolver=undefined;this.mSupportedBindingModes={"OneTime":true};}});n.prototype._getObject=function(s,j){var q=j,t,u,i,E,N,v,w,x=s||"",y;if(!j||j instanceof d){x=this.resolve(s||"",j);if(!x){L.error("Invalid relative path w/o context",s,o);return null;}}if(x.charAt(0)==="/"){q=this.oModel._getObject("/");x=x.slice(1);}w="/";N=q;while(x){v=undefined;t=undefined;if(x.charAt(0)==='['){try{y=B.parseExpression(x,1);E=y.at;if(x.length===E+1||x.charAt(E+1)==='/'){t=y.result;v=x.slice(0,E+1);x=x.slice(E+2);}}catch(z){if(!(z instanceof SyntaxError)){throw z;}}}if(v===undefined){E=x.indexOf("/");if(E<0){v=x;x="";}else{v=x.slice(0,E);x=x.slice(E+1);}}if(!N){if(L.isLoggable(L.Level.WARNING,o)){L.warning("Invalid part: "+v,"path: "+s+", context: "+(j instanceof d?j.getPath():j),o);}break;}if(t){if(q===j){L.error("A query is not allowed when an object context has been given",s,o);return null;}if(!Array.isArray(N)){L.error("Invalid query: '"+w+"' does not point to an array",s,o);return null;}u=w+v;v=this.mQueryCache[u];if(v===undefined){this.oResolver=this.oResolver||new R({models:this.oModel});for(i=0;i<N.length;i+=1){this.oResolver.bindObject(w+i);this.oResolver.bindProperty("any",t);try{if(this.oResolver.getAny()){this.mQueryCache[u]=v=i;break;}}finally{this.oResolver.unbindProperty("any");this.oResolver.unbindObject();}}}}N=N[v];w=w+v+"/";}return N;};n.prototype._getOrCreateSharedModelCache=function(){var D=this.oDataModel;if(!this.oSharedModelCache){this.oSharedModelCache={bFirstCodeListRequested:false,oModel:new D.constructor(D.getCodeListModelParameters())};}return this.oSharedModelCache;};n.prototype._mergeMetadata=function(i){var E=this.getODataEntityContainer(),j=U.getChildAnnotations(i.annotations,E.namespace+"."+E.name,true),q=E.entitySet.length,s=this.oModel.getObject("/dataServices/schema"),t=this;i.entitySets.forEach(function(u){var v,w,T=u.entityType,N=T.slice(0,T.lastIndexOf("."));if(!t.getODataEntitySet(u.name)){E.entitySet.push(JSON.parse(JSON.stringify(u)));if(!t.getODataEntityType(T)){v=t.oMetadata._getEntityTypeByName(T);w=U.getSchema(s,N);w.entityType.push(JSON.parse(JSON.stringify(v)));U.visitParents(w,i.annotations,"entityType",U.visitEntityType,w.entityType.length-1);}}});U.visitChildren(E.entitySet,j,"EntitySet",s,null,q);};n.prototype._sendBundledRequest=function(){var q=this.mQName2PendingRequest,Q=Object.keys(q),t=this;if(!Q.length){return;}this.mQName2PendingRequest={};Q=Q.sort();Q.forEach(function(s,i){Q[i]=encodeURIComponent(s);});this.oDataModel.addAnnotationUrl("$metadata?sap-value-list="+Q.join(",")).then(function(i){var s;t._mergeMetadata(i);for(s in q){try{q[s].resolve(i);}catch(E){q[s].reject(E);}}},function(E){var s;for(s in q){q[s].reject(E);}});};n.prototype.bindContext=function(s,i,j){return new C(this,s,i,j);};n.prototype.bindList=function(s,i,j,q,t){return new O(this,s,i,j,q,t);};n.prototype.bindProperty=function(s,i,j){return new h(this,s,i,j);};n.prototype.bindTree=function(s,i,j,q){return new k(this,s,i,j,q);};n.prototype.destroy=function(){f.prototype.destroy.apply(this,arguments);if(this.oSharedModelCache){this.oSharedModelCache.oModel.destroy();delete this.oSharedModelCache;}return this.oModel&&this.oModel.destroy.apply(this.oModel,arguments);};n.prototype.fetchCodeList=function(t){var i=this;return this.oLoadedPromiseSync.then(function(){var s,j,q,u,v,w,x,y,z,A="com.sap.vocabularies.CodeList.v1."+t,D=i.getODataEntityContainer()[A];if(!D||!D.Url.String){return null;}if(D.Url.String!=="./$metadata"){throw new Error(A+"/Url/String has to be './$metadata' for the service "+i.oDataModel.getCodeListModelParameters().serviceUrl);}v=D.CollectionPath.String;x=i.oDataModel.getMetadataUrl();s=x+"#"+v;y=m.get(s);if(y){return y;}j=s+"#"+i.getId();y=m.get(j);if(y){return y;}u=i._getOrCreateSharedModelCache();q=u.oModel;z=new S(function(E,G){var H=b.fromURL(x),I=H.get("sap-client"),K=H.get("sap-language"),N={$skip:0,$top:5000};if(I){N["sap-client"]=I;}if(K){N["sap-language"]=K;}q.read("/"+v,{error:G,success:E,urlParameters:N});});w=new S(function(E,G){try{E(i._getPropertyNamesForCodeListCustomizing(v));}catch(H){G(H);}});y=S.all([z,w]).then(function(E){var G=E[0].results,H=E[1];m.set(s,y);m.delete(j);return G.reduce(function(I,K){var N=K[H.code],Q={Text:K[H.text],UnitSpecificScale:K[H.unitSpecificScale]};if(H.standardCode){Q.StandardCode=K[H.standardCode];}if(Q.UnitSpecificScale===null){L.error("Ignoring customizing w/o unit-specific scale for code "+N+" from "+v,i.oDataModel.getCodeListModelParameters().serviceUrl,o);}else{I[N]=Q;}return I;},{});}).catch(function(E){if(q.bDestroyed){m.delete(s);m.delete(j);}else{L.error("Couldn't load code list: "+v+" for "+i.oDataModel.getCodeListModelParameters().serviceUrl,E,o);}throw E;}).finally(function(){if(u.bFirstCodeListRequested){if(!q.bDestroyed){q.destroy();}delete i.oSharedModelCache;}else{u.bFirstCodeListRequested=true;}});m.set(j,y);return y;});};n.prototype.getMetaContext=function(s){var A,E,i,j,q,N,t,u,Q;function v(w){var x=w.indexOf("(");return x>=0?w.slice(0,x):w;}if(!s){return null;}u=s.split("/");if(u[0]!==""){throw new Error("Not an absolute path: "+s);}u.shift();t=v(u[0]);E=this.getODataEntitySet(t);if(E){Q=E.entityType;}else{j=this.getODataFunctionImport(t);if(j){if(u.length===1){q=this.getODataFunctionImport(t,true);}Q=j.returnType;if(Q.lastIndexOf("Collection(",0)===0){Q=Q.slice(11,-1);}}else{throw new Error("Entity set or function import not found: "+t);}}u.shift();while(u.length){i=this.getODataEntityType(Q);if(i){N=v(u[0]);A=this.getODataAssociationEnd(i,N);}else{i=this.getODataComplexType(Q);}if(A){Q=A.type;if(A.multiplicity==="1"&&N!==u[0]){throw new Error("Multiplicity is 1: "+u[0]);}u.shift();}else{q=this.getODataProperty(i,u,true);if(u.length){throw new Error("Property not found: "+u.join("/"));}break;}}q=q||this.getODataEntityType(Q,true);return this.createBindingContext(q);};n.prototype.getODataAssociationEnd=function(E,N){var i=E?U.findObject(E.navigationProperty,N):null,A=i?U.getObject(this.oModel,"association",i.relationship):null,j=A?U.findObject(A.end,i.toRole,"role"):null;return j;};n.prototype.getODataAssociationSetEnd=function(E,N){var A,i=null,j=this.getODataEntityContainer(),q=E?U.findObject(E.navigationProperty,N):null;if(j&&q){A=U.findObject(j.associationSet,q.relationship,"association");i=A?U.findObject(A.end,q.toRole,"role"):null;}return i;};n.prototype.getODataComplexType=function(q,A){return U.getObject(this.oModel,"complexType",q,A);};n.prototype.getODataEntityContainer=function(A){var v=A?undefined:null,s=this.oModel.getObject("/dataServices/schema");if(s){s.forEach(function(q,i){var j=U.findIndex(q.entityContainer,"true","isDefaultEntityContainer");if(j>=0){v=A?"/dataServices/schema/"+i+"/entityContainer/"+j:q.entityContainer[j];}});if(!v&&s.length===1&&s[0].entityContainer&&s[0].entityContainer.length===1){v=A?"/dataServices/schema/0/entityContainer/0":s[0].entityContainer[0];}}return v;};n.prototype.getODataEntitySet=function(N,A){return U.getFromContainer(this.getODataEntityContainer(),"entitySet",N,A);};n.prototype.getODataEntityType=function(q,A){return U.getObject(this.oModel,"entityType",q,A);};n.prototype.getODataFunctionImport=function(N,A){var i=N&&N.indexOf('/')>=0?N.split('/'):undefined,E=i?U.getObject(this.oModel,"entityContainer",i[0]):this.getODataEntityContainer();return U.getFromContainer(E,"functionImport",i?i[1]:N,A);};n.prototype.getODataProperty=function(t,N,A){var i,j=Array.isArray(N)?N:[N],q=null,s;while(t&&j.length){i=U.findIndex(t.property,j[0]);if(i<0){break;}j.shift();q=t.property[i];s=t.$path+"/property/"+i;if(j.length){t=this.getODataComplexType(q.type);}}return A?s:q;};n.prototype.getODataValueLists=function(i){var j=false,q,s=i.getPath(),t=this.mContext2Promise[s],u=this;if(t){return t;}q=r.exec(s);if(!q){throw new Error("Unsupported property context with path "+s);}t=new Promise(function(v,w){var x=i.getObject(),Q,V=U.getValueLists(x);if(!(""in V)&&x["sap:value-list"]){j=true;Q=u.oModel.getObject(q[2]).namespace+"."+u.oModel.getObject(q[1]).name;u.mQName2PendingRequest[Q+"/"+x.name]={resolve:function(y){e(x,(y.annotations.propertyAnnotations[Q]||{})[x.name]);V=U.getValueLists(x);if(a(V)){w(new Error("No value lists returned for "+s));}else{delete u.mContext2Promise[s];v(V);}},reject:w};setTimeout(u._sendBundledRequest.bind(u),0);}else{v(V);}});if(j){this.mContext2Promise[s]=t;}return t;};n.prototype.getProperty=function(){return this._getObject.apply(this,arguments);};n.prototype.isList=function(){return this.oModel.isList.apply(this.oModel,arguments);};n.prototype.loaded=function(){return this.oLoadedPromise;};n.prototype.refresh=function(){throw new Error("Unsupported operation: ODataMetaModel#refresh");};n.prototype.requestCurrencyCodes=function(){return Promise.resolve(this.fetchCodeList("CurrencyCodes"));};n.prototype.requestUnitsOfMeasure=function(){return Promise.resolve(this.fetchCodeList("UnitsOfMeasure"));};n.prototype.setLegacySyntax=function(i){if(i){throw new Error("Legacy syntax not supported by ODataMetaModel");}};n.prototype.setProperty=function(){throw new Error("Unsupported operation: ODataMetaModel#setProperty");};n.prototype._getPropertyNamesForCodeListCustomizing=function(s){var i="/"+s+"/##",t=this.oDataModel.getObject(i),A=t["Org.OData.Core.V1.AlternateKeys"],K=n._getKeyPath(t,i),j=this.oDataModel.getObject("/"+s+"/"+K+"/##");if(A){if(A.length!==1){throw new Error("Single alternative expected: "+i+"Org.OData.Core.V1.AlternateKeys");}else if(A[0].Key.length!==1){throw new Error("Single key expected: "+i+"Org.OData.Core.V1.AlternateKeys/0/Key");}K=A[0].Key[0].Name.Path;}return{code:K,standardCode:j["com.sap.vocabularies.CodeList.v1.StandardCode"]&&j["com.sap.vocabularies.CodeList.v1.StandardCode"].Path,text:j["com.sap.vocabularies.Common.v1.Text"].Path,unitSpecificScale:j["com.sap.vocabularies.Common.v1.UnitSpecificScale"].Path};};n._getKeyPath=function(t,T){var K=t.key.propertyRef;if(K&&K.length===1){return K[0].name;}throw new Error("Single key expected: "+T);};n.getCodeListTerm=function(D){if(D==="/##@@requestCurrencyCodes"){return"CurrencyCodes";}else if(D==="/##@@requestUnitsOfMeasure"){return"UnitsOfMeasure";}return undefined;};return n;});
