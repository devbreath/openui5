/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/assert","sap/base/Log","sap/base/util/extend","sap/base/util/isEmptyObject","sap/base/util/uid","sap/ui/model/_Helper","sap/ui/model/ChangeReason","sap/ui/model/Context","sap/ui/model/Filter","sap/ui/model/TreeBinding","sap/ui/model/TreeBindingUtils","sap/ui/model/odata/v2/ODataTreeBinding"],function(c,L,e,d,u,_,C,f,F,T,g,O){"use strict";var s="sap.ui.model.odata.ODataTreeBindingFlat";var h=function(){if(!(this instanceof T)||this._bIsAdapted){return;}for(var a in h.prototype){if(h.prototype.hasOwnProperty(a)){this[a]=h.prototype[a];}}this.mParameters=this.mParameters||{};this._iPageSize=0;this._aNodes=this._aNodes||[];this._aNodeCache=[];this._aCollapsed=this._aCollapsed||[];this._aExpanded=this._aExpanded||[];this._aRemoved=[];this._aAdded=[];this._aNodeChanges=[];this._aAllChangedNodes=[];this._mSubtreeHandles={};this._iLowestServerLevel=null;this._aExpandedAfterSelectAll=this._aExpandedAfterSelectAll||[];this._mSelected=this._mSelected||{};this._mDeselected=this._mDeselected||{};this._bSelectAll=false;this._iLengthDelta=0;if(this.mParameters.collapseRecursive===undefined){this.bCollapseRecursive=true;}else{this.bCollapseRecursive=!!this.mParameters.collapseRecursive;}this._bIsAdapted=true;this._bReadOnly=true;this._aPendingRequests=[];this._aPendingChildrenRequests=[];this._aPendingSubtreeRequests=[];this._bSubmitChangesCalled=false;};h.prototype.setNumberOfExpandedLevels=function(l){this.resetData();O.prototype.setNumberOfExpandedLevels.apply(this,arguments);};h.prototype.getContexts=function(S,l,t){return this._getContextsOrNodes(false,S,l,t);};h.prototype._getContextsOrNodes=function(r,S,l,t){if(!this.isResolved()||this.isInitial()){return[];}S=S||0;l=l||this.oModel.iSizeLimit;t=t||0;this._iPageSize=l;this._iThreshold=t;if(this._aNodes.length==0&&!this.isLengthFinal()){this._loadData(S,l,t);}var R=[];var n=this._retrieveNodeSection(S,l);this._aNodeCache=[];var a;var b=0;var j=0;var G={};for(var i=0;i<n.length;i++){var N=n[i];this._aNodeCache[S+i]=N&&N.context?N:undefined;R.push(N.context);if(!N.context){if(N.serverIndex!=undefined){if(a==undefined){a=N.serverIndex;}j=N.serverIndex;}else if(N.positionInParent!=undefined){var p=N.parent;G[p.key]=G[p.key]||[];G[p.key].push(N);}}}b=1+Math.max(j-(a||0),0);if(a!=undefined&&b){this._loadData(a,b,t);}for(var m in G){var o=this._calculateRequestParameters(G[m]);this._loadChildren(G[m][0].parent,o.skip,o.top);}if(r){return n;}else{return R;}};h.prototype._calculateRequestParameters=function(m){var i,M=m[0].positionInParent,p=m[0].parent,a=Math.min(M+Math.max(this._iThreshold,m.length),p.children.length);for(i=M;i<a;i++){var o=p.children[i];if(o){break;}}return{skip:M,top:i-M};};h.prototype._retrieveNodeSection=function(S,l){return this._bReadOnly?this._indexRetrieveNodeSection(S,l):this._mapRetrieveNodeSection(S,l);};h.prototype._mapRetrieveNodeSection=function(S,l){var n=-1;var N=[];this._map(function(o,r,i,I,p){n++;if(n>=S){if(!o){if(i=="serverIndex"){o={serverIndex:I};}else if(i=="positionInParent"){o={positionInParent:I,parent:p};}}N.push(o);}if(N.length>=l){r.broken=true;}});return N;};h.prototype._indexRetrieveNodeSection=function(S,l){var i,n=[],N,o;for(i=S;i<S+l;i++){N=this.getNodeInfoByRowIndex(i);if(N.index!==undefined&&N.index<this._aNodes.length){o=this._aNodes[N.index];if(!o){o={serverIndex:N.index};}}else if(N.parent){o=N.parent.children[N.childIndex];if(!o){o={parent:N.parent,positionInParent:N.childIndex};}}if(o){n.push(o);o=null;}}return n;};h.prototype.getNodes=function(S,l,t){return this._getContextsOrNodes(true,S,l,t);};h.prototype._map=function(m){var a,t,b,k,r={broken:false};a=function(n){if(n.addedSubtrees.length>0&&!n.nodeState.collapsed){for(var j=0;j<n.addedSubtrees.length;j++){var S=n.addedSubtrees[j];t(n,S);if(r.broken){return;}}}};t=function(n,S){var o=S._getSubtree();if(S){if(Array.isArray(o)){if(S._oSubtreeRoot){k(o,S._oSubtreeRoot.serverIndex,S._oSubtreeRoot,S._oSubtreeRoot.originalLevel||0,n.level+1);}else{k(o,null,null,0,n.level+1);}}else{S._oSubtreeRoot.level=n.level+1;b(S._oSubtreeRoot,false,S._oNewParentNode,-1,S._oSubtreeRoot);}}};b=function(n,I,p,P,o){if(!I){if(!n.nodeState.removed||o==n){m(n,r,"positionInParent",P,p);if(r.broken){return;}}}a(n);if(r.broken){return;}if(n&&n.children&&n.nodeState.expanded){for(var i=0;i<n.children.length;i++){var j=n.children[i];if(j&&!j.nodeState.removed&&!j.nodeState.reinserted){j.level=n.level+1;}if(j&&!j.nodeState.removed){b(j,false,n,i,o);}else if(!j){m(j,r,"positionInParent",i,n);}if(r.broken){return;}}}};k=function(j,S,I,l,n){for(var i=0;i<j.length;i++){var N=j[i];if(N&&N.nodeState&&N.nodeState.removed&&N!=I){if(!N.initiallyCollapsed){i+=N.magnitude;}continue;}if(N&&l>=0&&n>=0){N.level=N.originalLevel||0;var o=(N.level-l)||0;N.level=n+o||0;}if(S===null){m(N,r,"newNode");}else{m(N,r,"serverIndex",S+i);}if(r.broken){return;}if(N&&N.nodeState){if(!N.initiallyCollapsed&&N.nodeState.collapsed){i+=N.magnitude;}else if(N.initiallyCollapsed&&N.nodeState.expanded){b(N,true);if(r.broken){return;}}else if(!N.initiallyCollapsed&&N.nodeState.expanded){a(N);}}if(r.broken){return;}}};k(this._aNodes,0,null);};h.prototype._loadData=function(S,t,i){var a=this;if(!this.bSkipDataEvents){this.fireDataRequested();}this.bSkipDataEvents=false;return this._requestServerIndexNodes(S,t,i).then(function(r){a._addServerIndexNodes(r.oData,r.iSkip);a._fireChange({reason:C.Change});a.fireDataReceived({data:r.oData});},function(E){var A=E.statusCode===0;if(!A){a._aNodes=[];a._bLengthFinal=true;a._fireChange({reason:C.Change});a.fireDataReceived();}});};h.prototype._restoreServerIndexNodes=function(S,t,i){var a=this;return this._requestServerIndexNodes(S,t,0,i).then(function(r){a._addServerIndexNodes(r.oData,r.iSkip);return r;});};h.prototype._addServerIndexNodes=function(D,S){var E,k,I,i,t=function(n,b){return(!n.isDeepOne&&!n.initiallyCollapsed&&n.serverIndex<I&&n.serverIndex+n.magnitude>=I);};if(!this._bLengthFinal){var a=D.__count?parseInt(D.__count):0;this._aNodes[a-1]=undefined;this._bLengthFinal=true;}if(D.results&&D.results.length>0){for(i=0;i<D.results.length;i++){E=D.results[i];k=this.oModel.getKey(E);I=S+i;var m=E[this.oTreeProperties["hierarchy-node-descendant-count-for"]];if(m<0){m=0;L.error("The entry data with key '"+k+"' under binding path '"+this.getPath()+"' has a negative 'hierarchy-node-descendant-count-for' which isn't allowed.");}var n=this._aNodes[I]=this._aNodes[I]||{key:k,context:this.oModel.getContext("/"+k),magnitude:m,level:E[this.oTreeProperties["hierarchy-level-for"]],originalLevel:E[this.oTreeProperties["hierarchy-level-for"]],initiallyCollapsed:E[this.oTreeProperties["hierarchy-drill-state-for"]]==="collapsed",initiallyIsLeaf:E[this.oTreeProperties["hierarchy-drill-state-for"]]==="leaf",nodeState:{isLeaf:E[this.oTreeProperties["hierarchy-drill-state-for"]]==="leaf",expanded:E[this.oTreeProperties["hierarchy-drill-state-for"]]==="expanded",collapsed:E[this.oTreeProperties["hierarchy-drill-state-for"]]==="collapsed",selected:this._mSelected[k]?this._mSelected[k].nodeState.selected:false},children:[],addedSubtrees:[],serverIndex:I,parent:null,originalParent:null,isDeepOne:false};if(this._iLowestServerLevel===null){this._iLowestServerLevel=n.level;}else{this._iLowestServerLevel=Math.min(this._iLowestServerLevel,n.level);}if(this._bSelectAll){if(!this._aExpandedAfterSelectAll.some(t)){this.setNodeSelection(n,true);}}}}};h.prototype._requestServerIndexNodes=function(S,t,j,I){return new Promise(function(r,k){var R={iSkip:S,iTop:t+(j||0),iThreshold:j};this._aPendingRequests.sort(function(a,b){return a.iSkip-b.iSkip;});for(var i=0;i<this._aPendingRequests.length;i++){if(g._determineRequestDelta(R,this._aPendingRequests[i])===false){return;}}S=R.iSkip;t=R.iTop;function l(D){var a=this._aPendingRequests.indexOf(R);this._aPendingRequests.splice(a,1);r({oData:D,iSkip:S,iTop:t});}function m(E){var a=this._aPendingRequests.indexOf(R);this._aPendingRequests.splice(a,1);k(E);}var U=["$skip="+S,"$top="+t];if(!this._bLengthFinal||I){U.push("$inlinecount=allpages");}if(this.sCustomParams){U.push(this.sCustomParams);}var o=new F(this.oTreeProperties["hierarchy-level-for"],"LE",this.getNumberOfExpandedLevels());var n=[o];if(this.aApplicationFilters){n=n.concat(this.aApplicationFilters);}var A=this.getResolvedPath();if(A){R.oRequestHandle=this.oModel.read(A,{urlParameters:U,filters:[new F({filters:n,and:true})],sorters:this.aSorters||[],success:l.bind(this),error:m.bind(this),groupId:this.sRefreshGroupId?this.sRefreshGroupId:this.sGroupId});this._aPendingRequests.push(R);}}.bind(this));};h.prototype._propagateMagnitudeChange=function(p,D){while(p!=null&&(p.initiallyCollapsed||p.isDeepOne)){p.magnitude+=D;if(!p.nodeState.expanded){return;}p=p.parent;}};h.prototype._getInitialMagnitude=function(n){var D=0,o;if(n.isDeepOne){return 0;}if(n.children){for(var i=0;i<n.children.length;i++){o=n.children[i];D+=o.magnitude+1;}}return n.magnitude-D;};h.prototype._loadChildren=function(p,S,t){var a=this;if(!this.bSkipDataEvents){this.fireDataRequested();}this.bSkipDataEvents=false;this._requestChildren(p,S,t).then(function(r){a._addChildNodes(r.oData,p,r.iSkip);a._fireChange({reason:C.Change});a.fireDataReceived({data:r.oData});},function(E){var A=E.statusCode===0;if(!A){if(p.childCount===undefined){p.children=[];p.childCount=0;a._fireChange({reason:C.Change});}a.fireDataReceived();}});};h.prototype._restoreChildren=function(p,S,t){var a=this,P=p.context.getProperty(this.oTreeProperties["hierarchy-node-for"]);return this._requestChildren(p,S,t,true).then(function(r){var n;a._map(function(N,R){if(N&&N.context.getProperty(a.oTreeProperties["hierarchy-node-for"])===P){n=N;R.broken=true;}});if(n){a._addChildNodes(r.oData,n,r.iSkip);a.expand(n,true);}return r;});};h.prototype._addChildNodes=function(D,p,S){if(p.childCount==undefined&&D&&D.__count){var a=D.__count?parseInt(D.__count):0;p.childCount=a;p.children[a-1]=undefined;if(p.nodeState.expanded){this._propagateMagnitudeChange(p,a);}else{p.magnitude=a;}this._cleanTreeStateMaps();}if(D.results&&D.results.length>0){for(var i=0;i<D.results.length;i++){var E=D.results[i];this._createChildNode(E,p,S+i);}}};h.prototype._createChildNode=function(E,p,P){var k=this.oModel.getKey(E);var i;if(p.containingServerIndex!==undefined){i=p.containingServerIndex;}else{i=p.serverIndex;}var n=p.children[P]=p.children[P]||{key:k,context:this.oModel.getContext("/"+k),magnitude:0,level:p.level+1,originalLevel:p.level+1,initiallyCollapsed:E[this.oTreeProperties["hierarchy-drill-state-for"]]==="collapsed",initiallyIsLeaf:E[this.oTreeProperties["hierarchy-drill-state-for"]]==="leaf",nodeState:{isLeaf:E[this.oTreeProperties["hierarchy-drill-state-for"]]==="leaf",expanded:E[this.oTreeProperties["hierarchy-drill-state-for"]]==="expanded",collapsed:E[this.oTreeProperties["hierarchy-drill-state-for"]]==="collapsed",selected:this._mSelected[k]?this._mSelected[k].nodeState.selected:false},positionInParent:P,children:[],addedSubtrees:[],parent:p,originalParent:p,isDeepOne:true,containingServerIndex:i};if(this._bSelectAll&&this._aExpandedAfterSelectAll.indexOf(p)===-1){this.setNodeSelection(n,true);}return n;};h.prototype._requestChildren=function(p,S,t,I){return new Promise(function(r,j){var R={sParent:p.key,iSkip:S,iTop:t};this._aPendingChildrenRequests.sort(function(a,b){return a.iSkip-b.iSkip;});for(var i=0;i<this._aPendingChildrenRequests.length;i++){var P=this._aPendingChildrenRequests[i];if(P.sParent===R.sParent){if(g._determineRequestDelta(R,P)===false){return;}}}S=R.iSkip;t=R.iTop;function k(D){var a=this._aPendingChildrenRequests.indexOf(R);this._aPendingChildrenRequests.splice(a,1);r({oData:D,iSkip:S,iTop:t});}function l(E){var a=this._aPendingChildrenRequests.indexOf(R);this._aPendingChildrenRequests.splice(a,1);j(E);}var U=["$skip="+S,"$top="+t];if(p.childCount==undefined||I){U.push("$inlinecount=allpages");}if(this.sCustomParams){U.push(this.sCustomParams);}var o=new F(this.oTreeProperties["hierarchy-parent-node-for"],"EQ",p.context.getProperty(this.oTreeProperties["hierarchy-node-for"]));var m=[o];if(this.aApplicationFilters){m=m.concat(this.aApplicationFilters);}var A=this.getResolvedPath();if(A){R.oRequestHandle=this.oModel.read(A,{urlParameters:U,filters:[new F({filters:m,and:true})],sorters:this.aSorters||[],success:k.bind(this),error:l.bind(this),groupId:this.sRefreshGroupId?this.sRefreshGroupId:this.sGroupId});this._aPendingChildrenRequests.push(R);}}.bind(this));};h.prototype._loadSubTree=function(p,l){var t=this;var m;if(p.serverIndex!==undefined&&!p.initiallyCollapsed){var M=[];var S;var a=p.serverIndex+1;var b=a+p.magnitude;for(var i=a;i<b;i++){if(this._aNodes[i]===undefined){if(!S){S={iSkip:i,iTop:1};M.push(S);}else{S.iTop++;}}else{S=null;}}if(M.length){m=Promise.all(M.map(function(o){return t._loadData(o.iSkip,o.iTop);}));}}if(!m){m=Promise.resolve();}return m.then(function(){if(!t.bSkipDataEvents){t.fireDataRequested();}t.bSkipDataEvents=false;return t._requestSubTree(p,l).then(function(r){t._addSubTree(r.oData,p);t.fireDataReceived({data:r.oData});},function(E){L.warning("ODataTreeBindingFlat: Error during subtree request",E.message);var A=E.statusCode===0;if(!A){t.fireDataReceived();}});});};h.prototype._addSubTree=function(D,S){if(D.results&&D.results.length>0){var n,p,E,N,P,a=[],m={},i,j,k;if(S.serverIndex!==undefined&&!S.initiallyCollapsed){a=this._aNodes.slice(S.serverIndex,S.serverIndex+S.magnitude+1);}else{a.push(S);}for(j=a.length-1;j>=0;j--){N=a[j];if(N.nodeState.isLeaf){continue;}if(N.initiallyCollapsed||N.isDeepOne){N.childCount=undefined;if(N.magnitude&&N.nodeState.expanded){this._propagateMagnitudeChange(N.parent,-N.magnitude);}N.magnitude=0;}m[N.context.getProperty(this.oTreeProperties["hierarchy-node-for"])]=N;}for(i=0;i<D.results.length;i++){E=D.results[i];n=E[this.oTreeProperties["hierarchy-node-for"]];if(m[n]){continue;}p=E[this.oTreeProperties["hierarchy-parent-node-for"]];P=m[p];if(P.childCount===undefined){P.childCount=0;}N=P.children[P.childCount];if(N){a.push(N);if(N.childCount){N.childCount=undefined;if(N.initiallyCollapsed||N.isDeepOne){N.magnitude=0;}}}else{N=this._createChildNode(E,P,P.childCount);if(N.nodeState.expanded){this._aExpanded.push(N);this._sortNodes(this._aExpanded);}}P.childCount++;if(P.nodeState.expanded){this._propagateMagnitudeChange(P,1);}else{P.magnitude++;}if(!N.nodeState.isLeaf){m[n]=N;}}for(k=a.length-1;k>=0;k--){N=a[k];if(!N.nodeState.expanded&&!N.nodeState.isLeaf){this.expand(N,true);}}}};h.prototype._requestSubTree=function(p,l){return new Promise(function(r,a){var R={sParent:p.key,iLevel:l};for(var i=0;i<this._aPendingSubtreeRequests.length;i++){var P=this._aPendingSubtreeRequests[i];if(P.sParent===R.sParent&&P.iLevel===R.iLevel){return;}}function b(D){var m=this._aPendingSubtreeRequests.indexOf(R);this._aPendingSubtreeRequests.splice(m,1);r({oData:D,sParent:R.sParent,iLevel:R.iLevel});}function j(E){var m=this._aPendingSubtreeRequests.indexOf(R);this._aPendingSubtreeRequests.splice(m,1);a(E);}var U=[];if(this.sCustomParams){U.push(this.sCustomParams);}var n=new F(this.oTreeProperties["hierarchy-node-for"],"EQ",p.context.getProperty(this.oTreeProperties["hierarchy-node-for"]));var o=new F(this.oTreeProperties["hierarchy-level-for"],"LE",l);var k=[n,o];if(this.aApplicationFilters){k=k.concat(this.aApplicationFilters);}var A=this.getResolvedPath();if(A){R.oRequestHandle=this.oModel.read(A,{urlParameters:U,filters:[new F({filters:k,and:true})],sorters:this.aSorters||[],success:b.bind(this),error:j.bind(this),groupId:this.sRefreshGroupId?this.sRefreshGroupId:this.sGroupId});this._aPendingSubtreeRequests.push(R);}}.bind(this));};h.prototype.findNode=function(r){return this._bReadOnly?this._indexFindNode(r):this._mapFindNode(r);};h.prototype._mapFindNode=function(r){if(this.isInitial()){return undefined;}var o=this._aNodeCache[r];if(o){return o;}var n=-1;this._map(function(N,R,i,I,p){n++;if(n===r){o=N;R.broken=true;}});return o;};h.prototype._indexFindNode=function(r){if(this.isInitial()){return undefined;}var n=this._aNodeCache[r];if(n){return n;}var N=this.getNodeInfoByRowIndex(r);if(N.parent){n=N.parent.children[N.childIndex];}else{n=this._aNodes[N.index];}this._aNodeCache[r]=n;return n;};h.prototype.toggleIndex=function(r){var t=this.findNode(r);c(t!=undefined,"toggleIndex("+r+"): Node not found!");if(t){if(t.nodeState.expanded){this.collapse(t);}else{this.expand(t);}}};h.prototype.expand=function(r,S){var t=r;if(typeof r!=="object"){t=this.findNode(r);c(t!=undefined,"expand("+r+"): Node not found!");}if(t.nodeState.expanded){return;}t.nodeState.expanded=true;t.nodeState.collapsed=false;var i=this._aCollapsed.indexOf(t);if(i!=-1){this._aCollapsed.splice(i,1);}this._aExpanded.push(t);this._sortNodes(this._aExpanded);if(t.serverIndex!==undefined){this._aNodeChanges[t.serverIndex]=true;}if(this._bSelectAll){this._aExpandedAfterSelectAll.push(t);}if(t.initiallyCollapsed&&t.childCount==undefined){this._loadChildren(t,0,this._iPageSize+this._iThreshold);}else{this._propagateMagnitudeChange(t.parent,t.magnitude);}this._cleanTreeStateMaps();this._aNodeCache=[];if(!S){this._fireChange({reason:C.Expand});}};h.prototype.expandToLevel=function(l){this.setNumberOfExpandedLevels(l);};h.prototype.expandNodeToLevel=function(i,l,S){if(!this._bReadOnly){return Promise.reject(new Error("ODataTreeBindingFlat: expandNodeToLevel is not supported while there are pending changes in the hierarchy"));}var o=this.findNode(i);return this._loadSubTree(o,l).then(function(){if(!S){this._fireChange({reason:C.Expand});}}.bind(this));};h.prototype.collapse=function(r,S){var t=r;if(typeof r!=="object"){t=this.findNode(r);c(t!=undefined,"expand("+r+"): Node not found!");}if(t.nodeState.collapsed){return;}t.nodeState.expanded=false;t.nodeState.collapsed=true;var i=this._aExpanded.indexOf(t);if(i!=-1){this._aExpanded.splice(i,1);}if(this._bSelectAll){i=this._aExpandedAfterSelectAll.indexOf(t);if(i!==-1){this._aExpandedAfterSelectAll.splice(i,1);}}this._aCollapsed.push(t);this._sortNodes(this._aCollapsed);if(t.isDeepOne){this._propagateMagnitudeChange(t.parent,t.magnitude*-1);}if(t.serverIndex!==undefined){this._aNodeChanges[t.serverIndex]=true;}this._cleanUpSelection();this._cleanTreeStateMaps();this._aNodeCache=[];if(!S){this._fireChange({reason:C.Collapse});}};h.prototype.collapseToLevel=function(l){var o=-1,a=[],r;if(this.bCollapseRecursive){for(var k in this._mSelected){var S=this._mSelected[k];if(S.level>l){r=this.getRowIndexByNode(S);a.push(r);if(this._sLeadSelectionKey==k){o=r;}this.setNodeSelection(S,false);}}}this.setNumberOfExpandedLevels(l);if(this.bCollapseRecursive&&a.length){this._publishSelectionChanges({rowIndices:a,oldIndex:o,leadIndex:-1});}};h.prototype._getInvisibleSelectedNodes=function(){var a=[];var i=true;var b=function(n,B){if(n.nodeState.collapsed||(n.nodeState.removed&&!n.nodeState.reinserted)){i=false;B.broken=true;}};for(var k in this._mSelected){var S=this._mSelected[k];i=true;this._up(S,b,false);if(!i){a.push(S);}}return a;};h.prototype._cleanUpSelection=function(b){var i=this._getInvisibleSelectedNodes();i.forEach(function(S){if(S.key==this._sLeadSelectionKey){this._sLeadSelectionKey=null;}if(this.bCollapseRecursive||b){this.setNodeSelection(S,false);}}.bind(this));if((this.bCollapseRecursive||b)&&i.length){this._publishSelectionChanges({rowIndices:[],indexChangesCouldNotBeDetermined:true});}};h.prototype._isInSubtree=function(a,o){var i=false;var b=function(n,B){if(n==a){B.broken=true;i=true;}};this._up(o,b,false);return i;};h.prototype._up=function(n,U,o){var r={broken:false};var p=this._getParent(n,o);if(p){this._structuralUp(p,U,r,o);}else{this._flatUp(n,U,r,true);}};h.prototype._structuralUp=function(n,U,b,o){var p=n;do{U(p,b);if(b.broken){return;}n=p;p=this._getParent(p);}while(p);this._flatUp(n,U,b);};h.prototype._flatUp=function(n,U,b,I){var S=n.serverIndex,i=I?S-1:S,o,p;for(;i>=0;i--){if(this._aNodeChanges[i]){o=this._aNodes[i];if(o.initiallyCollapsed){continue;}if(o.serverIndex+o.magnitude>=S){U(o,b);if(b.broken){return;}p=this._getParent(o);if(p){this._structuralUp(p,U,b);return;}}else{continue;}}}};h.prototype._getParent=function(n,o){return o?n.originalParent:n.parent;};h.prototype._cleanTreeStateMaps=function(){this._iLengthDelta=this._bReadOnly?this._indexCleanTreeStateMaps():this._mapCleanTreeStateMaps();};h.prototype._indexCleanTreeStateMaps=function(){return this._calcIndexDelta(this._aNodes.length);};h.prototype._mapCleanTreeStateMaps=function(){var a=this._aCollapsed.concat(this._aRemoved).concat(this._aExpanded).concat(this._aAdded),v=true,V,D=0,b=function(n,B){if(n.nodeState.collapsed||(n.nodeState.removed&&!n.nodeState.reinserted)){v=false;B.broken=true;}},S={};var i=[[0,1],[-1,0]];a.forEach(function(n){if(S[n.key]){return;}else{S[n.key]=true;}if(n.nodeState.added){if(!n.nodeState.removed||n.nodeState.reinserted){v=true;this._up(n,b,false);if(v){D++;}}}else if(n.nodeState.collapsed||n.nodeState.expanded||n.nodeState.removed){v=true;this._up(n,b,false);if(v){if(n.nodeState.removed&&!n.nodeState.reinserted){if(n.isDeepOne||n.initiallyCollapsed){D-=1;}else{D-=(n.magnitude+1);}}else{if(n.nodeState.collapsed&&n.serverIndex!==undefined&&!n.initiallyCollapsed){D-=n.magnitude;}if(n.nodeState.expanded&&(n.isDeepOne||n.initiallyCollapsed)){D+=n.children.length;}}}if(n.nodeState.reinserted){V=v;v=true;this._up(n,b,true);var j=(i[v|0][V|0]);if(j){if(n.isDeepOne){D+=j*1;}else if(n.initiallyCollapsed){D+=j;}else{D+=j*(1+n.magnitude);}}}}}.bind(this));return D;};h.prototype.isLengthFinal=function(){return this._bLengthFinal;};h.prototype.getLength=function(){return this._aNodes.length+this._iLengthDelta;};h.prototype.getContextByIndex=function(r){if(this.isInitial()){return undefined;}var n=this.findNode(r);return n&&n.context;};h.prototype.getNodeByIndex=function(r){if(this.isInitial()){return undefined;}var n=this.findNode(r);return n;};h.prototype.isExpanded=function(r){var n=this.findNode(r);return n&&n.nodeState.expanded;};h.prototype.hasChildren=function(o){if(!o){return false;}var n=this._findNodeByContext(o);var N=n&&n.node;return!(N&&N.nodeState.isLeaf);};h.prototype.nodeHasChildren=function(n){return!(n&&n.nodeState.isLeaf);};h.prototype._hasChangedEntity=function(m){var b=false;this._map(function(n,r){if(n.key in m){b=true;r.broken=true;}});return b;};h.prototype._isRefreshAfterChangeAllowed=function(){return!this._isRestoreTreeStateSupported();};h.prototype._isRestoreTreeStateSupported=function(){return(this._bRestoreTreeStateAfterChange&&(!this.aApplicationFilters||this.aApplicationFilters.length===0));};h.prototype._hasPendingChanges=function(a){var o;if(!this.isResolved()||!this._aAllChangedNodes.length){return false;}o=this._optimizeChanges();if(o.added.length||o.moved.length||o.removed.length){return true;}o.creationCancelled.forEach(function(n){var i=a.indexOf(n.key);if(i>-1){a.splice(i,1);}});return false;};h.prototype._getPendingChanges=function(){var a,k,o,p,m={};if(this.isResolved()){o=this._optimizeChanges();a=o.added.concat(o.moved);k=this.oTreeProperties["hierarchy-node-for"];p=this.oTreeProperties["hierarchy-parent-node-for"];a.forEach(function(n){m[n.key]={};m[n.key][p]=n.parent.context.getProperty(k);});o.removed.forEach(function(n){m[n.key]={};});o.creationCancelled.forEach(function(n){m[n.key]=null;});}return m;};h.prototype._resetChanges=function(p){var P,r=this.getResolvedPath();if(!r||!this._aAllChangedNodes.length){return;}if(p){P=p.some(function(a){return a===r;});if(!P){return;}}this._aRemoved.forEach(function(n){h._resetMovedOrRemovedNode(n);});this._aAdded.forEach(function(n){h._resetParentState(n);});this._mSubtreeHandles={};this._aAdded=[];this._aRemoved=[];this._aAllChangedNodes=[];this._aNodeCache=[];this._cleanTreeStateMaps();this._fireChange({reason:C.Change});};h.prototype.setNodeSelection=function(n,i){c(n,"Node must be defined!");n.nodeState.selected=i;if(i){delete this._mDeselected[n.key];this._mSelected[n.key]=n;}else{delete this._mSelected[n.key];this._mDeselected[n.key]=n;if(n.key===this._sLeadSelectionKey){this._sLeadSelectionKey=null;}}};h.prototype.isIndexSelected=function(r){var n=this.findNode(r);return n&&n.nodeState?n.nodeState.selected:false;};h.prototype.isIndexSelectable=function(r){var n=this.findNode(r);return!!n;};h.prototype._clearSelection=function(){return this._bReadOnly?this._indexClearSelection():this._mapClearSelection();};h.prototype._indexClearSelection=function(){var o=-1,a=[],S,n,r;this._bSelectAll=false;this._aExpandedAfterSelectAll=[];for(S in this._mSelected){n=this._mSelected[S];this.setNodeSelection(n,false);r=this.getRowIndexByNode(n);a.push(r);if(this._sLeadSelectionKey==S){o=r;}}return{rowIndices:a,oldIndex:o,leadIndex:-1};};h.prototype._mapClearSelection=function(){var n=-1;var o=-1;var m=0;var a=[];this._bSelectAll=false;this._aExpandedAfterSelectAll=[];for(var k in this._mSelected){if(k){m++;}}this._map(function(N,r,i,I,p){n++;if(N&&N.nodeState.selected){this.setNodeSelection(N,false);a.push(n);if(this._sLeadSelectionKey==N.key){o=n;}if(a.length==m){r.broken=true;}}}.bind(this));return{rowIndices:a,oldIndex:o,leadIndex:-1};};h.prototype.setSelectedIndex=function(r){var n=this.findNode(r);if(n){var o=this._clearSelection();var i=o.rowIndices.indexOf(r);if(i>=0){o.rowIndices.splice(i,1);}else{o.rowIndices.push(r);}o.leadKey=n.key;o.leadIndex=r;this.setNodeSelection(n,true);this._publishSelectionChanges(o);}else{L.warning("ODataTreeBindingFlat: The selection of index '"+r+"' was ignored. Please make sure to only select rows, for which data has been fetched to the client.");}};h.prototype.getSelectedIndex=function(){return this._bReadOnly?this._indexGetSelectedIndex():this._mapGetSelectedIndex();};h.prototype._indexGetSelectedIndex=function(){if(!this._sLeadSelectionKey||d(this._mSelected)){return-1;}var S=this._mSelected[this._sLeadSelectionKey];if(S){return this.getRowIndexByNode(S);}else{return-1;}};h.prototype._mapGetSelectedIndex=function(){if(!this._sLeadSelectionKey||d(this._mSelected)){return-1;}var n=-1;this._map(function(N,r){n++;if(N){if(N.key===this._sLeadSelectionKey){r.broken=true;}}}.bind(this));return n;};h.prototype.getSelectedIndices=function(){return this._bReadOnly?this._indexGetSelectedIndices():this._mapGetSelectedIndices();};h.prototype._indexGetSelectedIndices=function(){var n=this._getSelectedNodesInfo();return n.map(function(N){return N.rowIndex;});};h.prototype._mapGetSelectedIndices=function(){var r=[];if(d(this._mSelected)){return r;}var n=-1;this._map(function(N){n++;if(N){if(N.nodeState&&N.nodeState.selected){r.push(n);}}});return r;};h.prototype.getSelectedNodesCount=function(){var S;if(this._bSelectAll){if(this._bReadOnly){var r=[],n=0,k;this._aExpandedAfterSelectAll.sort(function(a,b){var A=this._getRelatedServerIndex(a);var B=this._getRelatedServerIndex(b);c(A!=undefined,"getSelectedNodesCount: (containing) Server-Index not found for node 'a'");c(B!=undefined,"getSelectedNodesCount: (containing) Server-Index not found node 'b'");if(A==B&&a.isDeepOne&&b.isDeepOne){return a.originalLevel-b.originalLevel;}return A-B;}.bind(this));var l=-1,N,j,i;for(i=0;i<this._aExpandedAfterSelectAll.length;i++){N=this._aExpandedAfterSelectAll[i];j=this._getRelatedServerIndex(N);if(j<=l&&!N.initiallyCollapsed){continue;}if(N.initiallyCollapsed){l=j;}else{l=j+N.magnitude;}r.push(N);n+=N.magnitude;}var m=function(N,b){if(r.indexOf(N)!==-1){n--;b.broken=true;}};for(k in this._mSelected){this._up(this._mSelected[k],m,true);}var I;var o=function(N,b){if(N.nodeState.collapsed||(N.nodeState.removed&&!N.nodeState.reinserted)||r.indexOf(N)!==-1){I=false;b.broken=true;}};for(k in this._mDeselected){I=true;this._up(this._mDeselected[k],o,true);if(I){n++;}}S=this.getLength()-n;}else{S=0;this._map(function(N,R,a,b,P){var q;if(N){if(N.nodeState.selected){S++;}}else if(N===undefined&&a==="serverIndex"){var t=true;for(var i=b-1;i>=0;i--){if(this._aNodeChanges[i]){q=this._aNodes[i];if(q.serverIndex+q.magnitude>=b&&this._aExpandedAfterSelectAll.indexOf(q)!==-1){t=false;break;}}}if(t){S++;}}}.bind(this));}}else{var p=this._getInvisibleSelectedNodes();S=Math.max(Object.keys(this._mSelected).length-p.length,0);}return S;};h.prototype.getSelectedContexts=function(){return this._bReadOnly?this._indexGetSelectedContexts():this._mapGetSelectedContexts();};h.prototype._indexGetSelectedContexts=function(){var n=this._getSelectedNodesInfo();return n.map(function(N){return N.node.context;});};h.prototype._mapGetSelectedContexts=function(){var r=[];if(d(this._mSelected)){return r;}var m=function(n){if(n){if(n.nodeState.selected&&!n.isArtificial){r.push(n.context);}}};this._map(m);return r;};h.prototype.setSelectionInterval=function(a,t){var I,i,m=this._clearSelection(),b={},r=[],S=this._setSelectionInterval(a,t,true);for(i=0;i<m.rowIndices.length;i++){I=m.rowIndices[i];b[I]=true;}for(i=0;i<S.rowIndices.length;i++){I=S.rowIndices[i];if(b[I]){delete b[I];}else{b[I]=true;}}for(I in b){if(b[I]){r.push(parseInt(I));}}this._publishSelectionChanges({rowIndices:r,oldIndex:m.oldIndex,leadIndex:S.leadIndex,leadKey:S.leadKey});};h.prototype._setSelectionInterval=function(i,t,S){return this._bReadOnly?this._indexSetSelectionInterval(i,t,S):this._mapSetSelectionInterval(i,t,S);};h.prototype._indexSetSelectionInterval=function(a,t,S){var n=Math.min(a,t),N=Math.max(a,t),b=[],j=[],o,k,i,p;S=!!S;for(i=n;i<=N;i++){k=this.findNode(i);if(k){if(k.nodeState.selected!==S){j.push(i);}if(k.key===this._sLeadSelectionKey){o=i;}this.setNodeSelection(k,S);b.push(k);}}p={rowIndices:j,oldIndex:o,leadIndex:o&&!S?-1:undefined};if(b.length>0&&S){p.leadKey=b[b.length-1].key;p.leadIndex=N;}return p;};h.prototype._mapSetSelectionInterval=function(i,t,S){var n=Math.min(i,t);var N=Math.max(i,t);var a=[];var b=[];var j=Math.abs(N-n)+1;var o;var k=-1;var m=function(q,r,I,v,P){k++;if(q){if(k>=n&&k<=N){if(q.nodeState.selected!==!!S){b.push(k);}if(q.key===this._sLeadSelectionKey){o=k;}this.setNodeSelection(q,!!S);a.push(q);if(a.length===j){r.broken=true;}}}}.bind(this);this._map(m);var p={rowIndices:b,oldIndex:o,leadIndex:o&&!S?-1:undefined};if(a.length>0&&S){var l=a[a.length-1];p.leadKey=l.key;p.leadIndex=N;}return p;};h.prototype.addSelectionInterval=function(i,t){var p=this._setSelectionInterval(i,t,true);this._publishSelectionChanges(p);};h.prototype.removeSelectionInterval=function(i,t){var p=this._setSelectionInterval(i,t,false);this._publishSelectionChanges(p);};h.prototype.selectAll=function(){if(this._bReadOnly){this._indexSelectAll();}else{this._mapSelectAll();}};h.prototype._indexSelectAll=function(){this._bSelectAll=true;this._aExpandedAfterSelectAll=[];var p={rowIndices:[],oldIndex:-1,selectAll:true};var l=this.getLength(),i,n;for(i=0;i<l;i++){n=this.findNode(i);if(n&&!n.isArtificial){if(n.key===this._sLeadSelectionKey){p.oldIndex=i;}if(!n.nodeState.selected){p.rowIndices.push(i);}this.setNodeSelection(n,true);p.leadKey=n.key;p.leadIndex=i;}}this._publishSelectionChanges(p);};h.prototype._mapSelectAll=function(){this._bSelectAll=true;this._aExpandedAfterSelectAll=[];var p={rowIndices:[],oldIndex:-1,selectAll:true};var n=-1;this._map(function(N){if(!N||!N.isArtificial){n++;}if(N){if(N.key===this._sLeadSelectionKey){p.oldIndex=n;}if(N){if(!N.isArtificial&&!N.nodeState.selected){p.rowIndices.push(n);}this.setNodeSelection(N,true);p.leadKey=N.key;p.leadIndex=n;}}}.bind(this));this._publishSelectionChanges(p);};h.prototype.clearSelection=function(S){var o=this._clearSelection();if(!S){this._publishSelectionChanges(o);}};h.prototype._publishSelectionChanges=function(p){p.oldIndex=p.oldIndex||this.getSelectedIndex();p.rowIndices.sort(function(a,b){return a-b;});if(p.leadIndex>=0&&p.leadKey){this._sLeadSelectionKey=p.leadKey;}else if(p.leadIndex===-1){this._sLeadSelectionKey=undefined;}else{p.leadIndex=p.oldIndex;}if(p.rowIndices.length>0||(p.leadIndex!=undefined&&p.leadIndex!==-1)||p.indexChangesCouldNotBeDetermined){this.fireSelectionChanged(p);}};h.prototype.setCollapseRecursive=function(b){this.bCollapseRecursive=!!b;};h.prototype.resetData=function(){O.prototype.resetData.apply(this,arguments);this._aNodes=[];this._aNodeCache=[];this._aCollapsed=[];this._aExpanded=[];this._aExpandedAfterSelectAll=[];this._mSelected={};this._mDeselected={};this._aAdded=[];this._aRemoved=[];this._aNodeChanges=[];this._aAllChangedNodes=[];this._bLengthFinal=false;this._iLowestServerLevel=null;this._bSelectAll=false;this._bReadOnly=true;this._iLengthDelta=0;};h.prototype._findNodeByContext=function(o){for(var i in this._aNodeCache){if(this._aNodeCache[i]&&this._aNodeCache[i].context==o){return{node:this._aNodeCache[i],index:parseInt(i)};}}var n=-1;var N;this._map(function(a,r,I,b,p){n++;if(a){if(a.context===o){N=a;r.broken=true;}}});return{node:N,index:n};};h.prototype.createEntry=function(p){var n,r=this.getResolvedPath();if(r){p=p||{};p.groupId=this.oModel._resolveGroup(r).groupId;p.refreshAfterChange=false;n=this.oModel.createEntry(r,p);}else{L.warning("ODataTreeBindingFlat: createEntry failed, as the binding path could not be resolved.");}return n;};h.prototype.submitChanges=function(p){var r=this.getResolvedPath();if(!r){L.error("#submitChanges failed: binding is unresolved",this.getPath(),s);return;}this._bSubmitChangesCalled=true;p=p||{};p.groupId=this.oModel._resolveGroup(r).groupId;this.oModel.submitChanges(p);};h.prototype._submitChanges=function(p){var H,o,G=p.groupId,r=this.getResolvedPath(),R=false,t=this;function a(E){L.error("Tree state restoration request failed for binding: "+r,E,s);}if(!r||G&&G!==this.oModel._resolveGroup(r).groupId){this._bSubmitChangesCalled=false;return;}o=this._optimizeChanges();H=Object.values(o).some(function(b){return b.length;});if(!H&&!this._bSubmitChangesCalled){return;}this.bRefresh=false;this._bSubmitChangesCalled=false;p.success=function(D,b){var i,j=D.__batchResponses&&D.__batchResponses[0]&&D.__batchResponses[0].__changeResponses;if(j&&j.length>0){i=j.some(function(k){var S=parseInt(k.statusCode);return S<200||S>299;});if(i){}else if(!R&&t._isRestoreTreeStateSupported()){t._restoreTreeState(o).catch(function(E){a(E);t._refresh(true);});}else if(!t.bRefresh){t._refresh(true);}}else if(b){L.warning("#submitChanges: no change response in batch response",r,s);}};this._generateSubmitData(o,function(E){a(E);R=true;});};h.prototype._generateSubmitData=function(o,r){var a=o.added,b=o.creationCancelled,m=o.moved,R=o.removed,i={error:r,groupId:this.oModel._resolveGroup(this.getResolvedPath()).groupId},t=this;function j(n){c(n.context,"Node does not have a context.");var p=n.parent.context.getProperty(t.oTreeProperties["hierarchy-node-for"]);t.oModel.setProperty(t.oTreeProperties["hierarchy-parent-node-for"],p,n.context);}a.forEach(j);m.forEach(function(n){j(n);if(this._isRestoreTreeStateSupported()){this._generatePreorderPositionRequest(n,i);this._generateSiblingsPositionRequest(n,i);}}.bind(this));R.forEach(function(n){this._generateDeleteRequest(n);L.debug("ODataTreeBindingFlat: DELETE "+n.key);}.bind(this));b.forEach(function(n){this._generateDeleteRequest(n);}.bind(this));};h.prototype._generatePreorderPositionRequest=function(n,p){var i,k,o,S,U,a=[],r=this.getResolvedPath(),b=[],t=this;if(!r){return;}p=p||{};o=p.success||function(){};S=function(D){t._updateNodeInfoAfterSave(n,D.results||[]);o.apply(null,arguments);};if(this.aApplicationFilters){a=a.concat(this.aApplicationFilters);}for(i=this._aTreeKeyProperties.length-1;i>=0;i--){k=this._aTreeKeyProperties[i];b.push(k);a.push(new F(k,"EQ",n.context.getProperty(k)));}a.push(new F(this.oTreeProperties["hierarchy-level-for"],"LE",this.getNumberOfExpandedLevels()));U=_.extend({},this.mParameters);b=b.concat([this.oTreeProperties["hierarchy-node-for"],this.oTreeProperties["hierarchy-node-descendant-count-for"],this.oTreeProperties["hierarchy-drill-state-for"],this.oTreeProperties["hierarchy-preorder-rank-for"]]);U.select=b.join(",");this.oModel.read(r,{filters:[new F({filters:a,and:true})],error:p.error,groupId:p.groupId||this.sGroupId,sorters:this.aSorters,success:S,urlParameters:this.oModel.createCustomParams(U)});};h.prototype._generateSiblingsPositionRequest=function(n,p){var G,U,a,b;if(p){G=p.groupId||this.sGroupId;a=p.success;b=p.error;}U=e({},this.mParameters);U.select=this.oTreeProperties["hierarchy-sibling-rank-for"];this.oModel.read(n.context.getPath(),{urlParameters:this.oModel.createCustomParams(U),groupId:G,success:a,error:b});};h.prototype._nodeIsOnTopLevel=function(n){if(n&&n.serverIndex>=0){var p=n.parent==null;if(p){if(n.originalLevel==this._iLowestServerLevel){return true;}else{return false;}}}else{L.warning("ODataTreeBindingFlat.nodeIsOnTopLevel: Node is not defined or not a server-indexed node.");}return undefined;};h.prototype._generateDeleteRequest=function(n){var o=n.context;if(n.nodeState.added){this.oModel.deleteCreatedEntry(o);return undefined;}else{var D=this.oModel.remove(o.getPath(),{groupId:this.oModel._resolveGroup(this.getResolvedPath()).groupId,refreshAfterChange:false});return D;}};h.prototype._filterChangeForServerSections=function(o){var a={};a.removed=o.removed.filter(function(r){return!r.isDeepOne;});a.added=o.added.filter(function(A){return!A.isDeepOne;});o.moved.forEach(function(m){if(!m.newIsDeepOne){a.added.push(m);}if(!m.isDeepOne){a.removed.push(m);}});return a;};h.prototype._filterChangesForDeepSections=function(o){var m={};o.removed.forEach(function(r){var p;if(r.isDeepOne){p=r.parent;if(!m[p.key]){m[p.key]={added:[],removed:[]};}m[p.key].removed.push(r);}});o.added.forEach(function(a){var p;if(a.isDeepOne){p=a.parent;if(!m[p.key]){m[p.key]={added:[],removed:[]};}m[p.key].added.push(a);}});o.moved.forEach(function(M){var p;if(M.newIsDeepOne){p=M.parent;if(!m[p.key]){m[p.key]={added:[],removed:[]};}m[p.key].added.push(M);}if(M.isDeepOne){p=M.originalParent;if(!m[p.key]){m[p.key]={added:[],removed:[]};}m[p.key].removed.push(M);}});return m;};h.prototype._optimizeOptimizedChanges=function(o){var A,t=this;A=o.added.slice();A.sort(function(a,b){var I=a.newIsDeepOne!==undefined?a.newIsDeepOne:a.isDeepOne,j=b.newIsDeepOne!==undefined?b.newIsDeepOne:b.isDeepOne;if(I&&j){return 0;}if(I){return 1;}if(j){return-1;}return a.context.getProperty(t.oTreeProperties["hierarchy-preorder-rank-for"])-b.context.getProperty(t.oTreeProperties["hierarchy-preorder-rank-for"]);});var i=-1;A=A.filter(function(n,a){if(n.newIsDeepOne!==undefined?n.newIsDeepOne:n.isDeepOne){return true;}if(a<=i){return false;}var m=n.context.getProperty(t.oTreeProperties["hierarchy-node-descendant-count-for"]);if(m){i=a+m;}return true;});return{added:A,removed:o.removed,moved:o.moved};};h.prototype._updateNodeInfoAfterSave=function(n,E){var i,I,o=n.context,D=this.oTreeProperties["hierarchy-drill-state-for"],k=this.oTreeProperties["hierarchy-node-for"],N=o.getProperty(k);I=!E.some(function(a){return N===a[k];});i=o.getProperty(D)==="collapsed";if(this._aAdded.includes(n)){n.isDeepOne=I;n.initiallyCollapsed=i;}else{n.newIsDeepOne=I;n.newInitiallyCollapsed=i;}};h.prototype._requestExtraInfoForAddedNodes=function(a){var P=[],t=this;a.forEach(function(n){var p=new Promise(function(r,b){t._generatePreorderPositionRequest(n,{success:r,error:b});});P.push(p);});P=P.map(function(p){return p.then(function(r){return{responseData:r};},function(E){return{error:E};});});return Promise.all(P).then(function(D){var A=0;D.forEach(function(o){if(o.error){if(o.error.statusCode===0){A++;}else{throw new Error("Tree state restoration request failed. Complete or partial tree state might get lost. Error: "+(o.error.message.value||o.error.message));}}});return A===0;});};h.prototype._restoreTreeState=function(o){var t=this;this._abortPendingRequest();o=o||{creationCancelled:[],added:[],removed:[],moved:[]};if(!this.bSkipDataEvents){this.fireDataRequested();}this.bSkipDataEvents=false;return this._requestExtraInfoForAddedNodes(o.added).then(function(n){if(n){return t._executeRestoreTreeState(o).then(function(D){if(D){t._fireChange({reason:C.Change});t.fireDataReceived({data:D});return D;}return undefined;});}return undefined;});};h.prototype._executeRestoreTreeState=function(o){var a,b,D,S,m={},p=[],t=this;S=this._collectServerSections(this._aNodes);o=this._optimizeOptimizedChanges(o);a=this._filterChangeForServerSections(o);this._adaptSections(S,a);S.forEach(function(j,i){p.push(t._restoreServerIndexNodes(j.iSkip,j.iTop,i===0));});D=this._filterChangesForDeepSections(o);S=this._collectDeepNodes();S.forEach(function(i){var j=i.aChildSections,P=i.oParentNode,a=D[P.key];if(a){t._adaptSections(j,a,{ignoreMagnitude:true,indexName:"positionInParent"});}j.forEach(function(k){p.push(t._restoreChildren(P,k.iSkip,k.iTop));});});this._aCollapsed.forEach(function(i){m[i.key]=true;});b=this._aCollapsed.length;this.resetData(true);p=p.map(function(i){return i.then(function(r){return{responseData:r};},function(E){return{error:E};});});return Promise.all(p).then(function(i){var A=0;i.forEach(function(j){var E=j.error;if(E){if(E.statusCode===0){A++;}else{throw new Error("Tree state restoration request failed. Complete or partial"+" tree state might get lost. Error: "+(E.message.value||E.message));}}});if(A<i.length){if(b>0){t._map(function(n,r){if(n&&m[n.key]){t.collapse(n,true);b--;if(b===0){r.broken=true;}}});}return i;}return undefined;});};h.prototype._collectServerSections=function(n){var S=[];var o;for(var i=0;i<n.length;i++){if(n[i]!==undefined){if(!o){o={iSkip:i,iTop:1};S.push(o);}else{o.iTop++;}}else{o=null;}}return S;};h.prototype._adaptSections=function(S,o,p){var r=o.removed||[],A=o.added||[],I=(p&&p.indexName)||"serverIndex",N,q,t,R,v,w=0,M,P,x,y,z,B,D,E=0,G,H,J=[];for(var l=A.length-1;l>=0;l--){N=A[l];if(N.newIsDeepOne!==undefined?N.newIsDeepOne:N.isDeepOne){H=this.oTreeProperties["hierarchy-sibling-rank-for"];}else{H=this.oTreeProperties["hierarchy-preorder-rank-for"];if(N.newInitiallyCollapsed!==undefined?!N.newInitiallyCollapsed:!N.initiallyCollapsed){M=N.context.getProperty(this.oTreeProperties["hierarchy-node-descendant-count-for"]);}}P=N.context.getProperty(H);if(P===undefined){L.warning("ODataTreeBindingFlat","Missing "+H+" value for node "+N.key);break;}J.push({position:P,magnitude:M||0,assignedToSection:false});}for(var i=0;i<S.length;i++){q=S[i];D=E;x=y;y=0;G=0;for(var j=r.length-1;j>=0;j--){N=r[j];P=N[I];if(P>=q.iSkip&&P<=q.iSkip+q.iTop){if(I==="serverIndex"){w++;}M=(p&&p.ignoreMagnitude)?0:this._getInitialMagnitude(N);v=(1+M);R=(q.iSkip+q.iTop)-P-v;if(R>0){G-=v;}else{G-=(q.iSkip+q.iTop)-P;if(R<0){y=P+v;}}D-=v;}}if(q.iSkip<=x){z=q.iSkip-x;G+=z;if(q.iTop+G<0){y=x;}}q.iSkip+=E;q.iTop+=G;if(q.iTop>0){E=0;G=0;for(var k=0;k<J.length;k++){t=J[k];P=t.position;B=(p&&p.ignoreMagnitude)?1:t.magnitude+1;if(P>=q.iSkip&&P<=q.iSkip+q.iTop){G+=B;J[k].assignedToSection=true;}else if(P<q.iSkip){E+=B;}}q.iSkip+=E;q.iTop+=G;q.iTop+=w;}if(q.iTop<=0){S.splice(i,1);i--;}E=D;}for(var m=0;m<J.length;m++){t=J[m];B=(p&&p.ignoreMagnitude)?1:t.magnitude+1;if(!t.assignedToSection){S.push({iSkip:t.position,iTop:B});}}S.sort(function(a,b){return a.iSkip-b.iSkip;});for(var n=0;n<S.length;n++){if(n+1<S.length){q=S[n];var K=S[n+1];if(q.iSkip+q.iTop===K.iSkip){q.iTop+=K.iTop;S.splice(n+1,1);n--;}}}};h.prototype._optimizeChanges=function(){var r=[],j=[],A=[],m=[];var I=false;var k=function(N,b){if(N.nodeState.removed&&!N.nodeState.reinserted){I=true;b.broken=true;}};var p=[];var t=function(N){if((N.isDeepOne||N.serverIndex>=0)&&p.indexOf(N)==-1){p.push(N);}if(N.nodeState.added){j.push(N);}};this._aAllChangedNodes.forEach(function(N){I=false;this._up(N,k,false);if(I){t(N);}else if(N.nodeState.removed&&!N.nodeState.reinserted){t(N);}else if(N.nodeState.added){A.push(N);}else{m.push(N);}}.bind(this));p.sort(function(a,b){var l=this._getRelatedServerIndex(a);var B=this._getRelatedServerIndex(b);c(l!=undefined,"_generateSubmitData: (containing) Server-Index not found for node 'a'");c(B!=undefined,"_generateSubmitData: (containing) Server-Index not found node 'b'");if(l==B&&a.isDeepOne&&b.isDeepOne){if(a.parent===b.parent){return a.positionInParent-b.positionInParent;}else{return a.originalLevel-b.originalLevel;}}return l-B;}.bind(this));var n=function(D){var b=false;this._up(D,function(P,B){if(P.nodeState.removed&&!P.nodeState.reinserted){b=true;B.broken=true;}},true);return b;}.bind(this);for(var i=0;i<p.length;i++){var D=p[i];if(!n(D)){r.push(D);}}return{removed:r,creationCancelled:j,added:A,moved:m};};h.prototype._collectDeepNodes=function(){var D=[],t=this;this._map(function(n){if(n&&n.nodeState.expanded&&(n.isDeepOne||n.initiallyCollapsed||n.initiallyIsLeaf)){D.push({oParentNode:n,aChildSections:t._collectServerSections(n.children)});}});return D;};h.prototype._trackChangedNode=function(n){if(this._aAllChangedNodes.indexOf(n)==-1){this._aAllChangedNodes.push(n);}};h.prototype.addContexts=function(p,v){var n=this._findNodeByContext(p),N=n.node,m=this.getModel(),o,a;c(p&&v,"ODataTreeBinding.addContexts() was called with incomplete arguments!");if(N){this._bReadOnly=false;if(N.nodeState&&N.nodeState.isLeaf){N.nodeState.isLeaf=false;N.nodeState.collapsed=true;}if(!Array.isArray(v)){if(v instanceof f){v=[v];}else{L.warning("ODataTreeBinding.addContexts(): The child node argument is not of type sap.ui.model.Context.");}}var b=function(i){return function(){return[i];};};v=v.slice();v.reverse();for(var j=0;j<v.length;j++){a=v[j];if(!(a instanceof f)){L.warning("ODataTreeBindingFlat.addContexts(): no valid child context given!");return;}o=this._mSubtreeHandles[a.getPath()];this._ensureHierarchyNodeIDForContext(a);if(o&&o._isRemovedSubtree){L.info("ODataTreeBindingFlat.addContexts(): Existing context added '"+a.getPath()+"'");o._oNewParentNode=N;o._oSubtreeRoot.nodeState.reinserted=true;o._oSubtreeRoot.originalParent=o._oSubtreeRoot.originalParent||o._oSubtreeRoot.parent;o._oSubtreeRoot.parent=N;o._oSubtreeRoot.containingSubtreeHandle=o;this._trackChangedNode(o._oSubtreeRoot);}else{L.info("ODataTreeBindingFlat.addContexts(): Newly created context added.");this._ensureHierarchyNodeIDForContext(a);var i={context:a,key:m.getKey(a),parent:N,nodeState:{isLeaf:true,collapsed:false,expanded:false,selected:false,added:true},addedSubtrees:[],children:[],magnitude:0};this._trackChangedNode(i);this._aAdded.push(i);o={_getSubtree:b(i),_oSubtreeRoot:null,_oNewParentNode:N};}N.addedSubtrees.unshift(o);if(N.serverIndex!==undefined){this._aNodeChanges[N.serverIndex]=true;}}this._aNodeCache=[];this._cleanTreeStateMaps();this._fireChange({reason:C.Add});}else{L.warning("The given parent context could not be found in the tree. No new sub-nodes were added!");}};h.prototype._ensureHierarchyNodeIDForContext=function(o){if(o){var n=o.getProperty(this.oTreeProperties["hierarchy-node-for"]);if(o.isTransient()&&!n){this.oModel.setProperty(this.oTreeProperties["hierarchy-node-for"],u(),o);}}};h.prototype.removeContext=function(o){var t=this;var n=this._findNodeByContext(o);var N=n.node;var i=n.index;if(N){this._bReadOnly=false;N.nodeState.removed=true;this._aRemoved.push(N);this._trackChangedNode(N);if(N.serverIndex!==undefined){this._aNodeChanges[N.serverIndex]=true;}if(N.containingSubtreeHandle&&N.parent!=null){var a=N.parent.addedSubtrees.indexOf(N.containingSubtreeHandle);if(a!=-1){N.parent.addedSubtrees.splice(a,1);N.nodeState.reinserted=false;N.parent=null;}}this._aNodeCache=[];this.setNodeSelection(N,false);this._cleanUpSelection(true);this._cleanTreeStateMaps();this._fireChange({reason:C.Remove});this._mSubtreeHandles[o.getPath()]={_removedFromVisualIndex:i,_isRemovedSubtree:true,_oSubtreeRoot:N,_getSubtree:function(){if(N.serverIndex!=undefined&&!N.initiallyCollapsed){return t._aNodes.slice(N.serverIndex,N.serverIndex+N.magnitude+1);}else{return N;}},getContext:function(){return o;},_restore:function(){N.nodeState.removed=false;var b=t._aRemoved.indexOf(N);if(b!=-1){t._aRemoved.splice(b,1);}this._aNodeCache=[];t._cleanTreeStateMaps();t._fireChange({reason:C.Add});}};return o;}else{L.warning("ODataTreeBinding.removeContexts(): The given context is not part of the tree. Was it removed already?");}return undefined;};h.prototype._getRelatedServerIndex=function(n){if(n.serverIndex===undefined){return n.containingServerIndex;}else{return n.serverIndex;}};h.prototype.getNodeInfoByRowIndex=function(r){var i=0,E=0,n,t,v=-1;while(i<this._aCollapsed.length||E<this._aExpanded.length){if(this._aCollapsed[i]&&this._aExpanded[E]){if(this._getRelatedServerIndex(this._aCollapsed[i])>this._getRelatedServerIndex(this._aExpanded[E])){n=this._aExpanded[E];E++;t=false;}else{n=this._aCollapsed[i];i++;t=true;}}else if(this._aCollapsed[i]){n=this._aCollapsed[i];i++;t=true;}else{n=this._aExpanded[E];E++;t=false;}if(r<=this._getRelatedServerIndex(n)){break;}if(t){if(!n.isDeepOne&&!n.initiallyCollapsed&&n.serverIndex>v){r+=n.magnitude;v=n.serverIndex+n.magnitude;}}else if(n.serverIndex>v){if(!n.isDeepOne&&n.initiallyCollapsed){r-=n.magnitude;}if(r<=n.serverIndex){return this._calcDirectIndex(n,r+n.magnitude-n.serverIndex-1);}}}return{index:r};};h.prototype._calcDirectIndex=function(n,I){var o,i,m;for(i=0;i<n.children.length;i++){o=n.children[i];if(I===0){return{parent:n,childIndex:i};}m=o?o.magnitude:0;I--;if(!o||o.nodeState.collapsed){continue;}if(I<m){return this._calcDirectIndex(o,I);}else{I-=m;}}return undefined;};h.prototype.getRowIndexByNode=function(n){var D=0;var o;var i;if(n.isDeepOne){while(n.parent){D+=n.positionInParent+1;for(i=0;i<n.positionInParent;i++){o=n.parent.children[i];if(o&&o.nodeState.expanded){D+=o.magnitude;}}n=n.parent;}}return this._calcIndexDelta(n.serverIndex)+n.serverIndex+D;};h.prototype._getSelectedNodesInfo=function(){var n=[];if(d(this._mSelected)){return n;}var i=true;var a=function(N,b){if(N.nodeState.collapsed||(N.nodeState.removed&&!N.nodeState.reinserted)){i=false;b.broken=true;}};for(var k in this._mSelected){var S=this._mSelected[k];i=true;this._up(S,a,false);if(i){n.push({node:S,rowIndex:this.getRowIndexByNode(S)});}}n.sort(function(N,o){return N.rowIndex-o.rowIndex;});return n;};h.prototype._calcIndexDelta=function(E){var i,I,m,a=0,b=0,l=0;for(i=0;i<this._aCollapsed.length;i++){var o=this._aCollapsed[i];if(this._getRelatedServerIndex(o)>=E){break;}if(!o.isDeepOne){if(o.serverIndex>=l&&!o.initiallyCollapsed){a-=o.magnitude;l=o.serverIndex+o.magnitude;}else{}}else{}}m=this._aCollapsed.filter(function(N){return N.serverIndex>=0&&N.serverIndex<E&&!N.isDeepOne&&!N.initiallyCollapsed;});var j=function(n){return m.some(function(N){return n>N.serverIndex&&n<N.serverIndex+N.magnitude;});};for(i=0;i<this._aExpanded.length;i++){var k=this._aExpanded[i],n=this._getRelatedServerIndex(k);if(n>=E){break;}if(k.isDeepOne){var p=k.parent;var y=false;while(p){if(p.nodeState.collapsed){y=true;break;}p=p.parent;}I=j(n);if(!y&&!I){b+=k.children.length;}}else if(k.initiallyCollapsed){I=j(n);if(!I){b+=k.children.length;}}}return b+a;};h.prototype._sortNodes=function(n){var S=function(a,b){var A=this._getRelatedServerIndex(a);var B=this._getRelatedServerIndex(b);return A-B;}.bind(this);n.sort(S);};h.prototype._abortPendingRequest=function(){if(this._aPendingRequests.length||this._aPendingChildrenRequests.length){this.bSkipDataEvents=true;var i,j;for(i=this._aPendingRequests.length-1;i>=0;i--){this._aPendingRequests[i].oRequestHandle.abort();}this._aPendingRequests=[];for(j=this._aPendingChildrenRequests.length-1;j>=0;j--){this._aPendingChildrenRequests[j].oRequestHandle.abort();}this._aPendingChildrenRequests=[];}};h.prototype.attachSelectionChanged=function(D,a,l){this.attachEvent("selectionChanged",D,a,l);return this;};h.prototype.detachSelectionChanged=function(a,l){this.detachEvent("selectionChanged",a,l);return this;};h.prototype.fireSelectionChanged=function(p){this.fireEvent("selectionChanged",p);return this;};h.prototype.getRootContexts=function(){};h.prototype.getNodeContexts=function(){};h._resetMovedOrRemovedNode=function(n){h._resetParentState(n);n.level=n.originalLevel;n.parent=n.originalParent;delete n.containingSubtreeHandle;delete n.nodeState.removed;delete n.nodeState.reinserted;};h._resetParentState=function(n){var p=n.parent;if(p){p.addedSubtrees=[];if(p.initiallyIsLeaf){p.nodeState.isLeaf=true;p.nodeState.expanded=false;p.nodeState.collapsed=false;}}};return h;},true);
