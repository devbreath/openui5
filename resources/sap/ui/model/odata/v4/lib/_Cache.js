/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./_GroupLock","./_Helper","./_Requestor","sap/base/Log","sap/base/util/isEmptyObject","sap/ui/base/SyncPromise","sap/ui/model/odata/ODataUtils"],function(_,a,b,L,c,S,O){"use strict";var C="sap.ui.model.odata.v4.lib._Cache",r=/\(\$uid=[-\w]+\)$/,d=/^\$inactive\./,m="@com.sap.vocabularies.Common.v1.Messages",e=/^-?\d+$/,f=/^([^(]*)(\(.*\))$/;function g(i,P,n,D){if(n.$count!==undefined){s(i,P,n,n.$count+D);}}function h(R,P){return P===""||R===P||R.startsWith(P+"/");}function s(i,P,n,v){if(typeof v==="string"){v=parseInt(v);}a.updateExisting(i,P,n,{$count:v});}function j(R,i,q,n,G,t){this.iActiveUsages=1;this.mChangeListeners={};this.mChangeRequests={};this.fnGetOriginalResourcePath=G;this.iInactiveSince=Infinity;this.mEditUrl2PatchPromise={};this.oPendingRequestsPromise=null;this.mPostRequests={};this.sReportedMessagesPath=undefined;this.oRequestor=R;this.bSentRequest=false;this.bSortExpandSelect=n;this.setResourcePath(i);this.setQueryOptions(q);this.bSharedRequest=t;}j.prototype._delete=function(G,E,P,i,D,n){var q=P.split("/"),v=q.pop(),t=q.join("/"),u=this;this.checkSharedRequest();return this.fetchValue(_.$cached,t).then(function(w){var x=j.from$skip(v,w),y,z=v?w[x]||w.$byPredicate[x]:w,H,I=typeof x==="number"?x:undefined,K=a.getPrivateAnnotation(z,"predicate"),A=a.buildPath(t,Array.isArray(w)?K:v),R,T=a.getPrivateAnnotation(z,"transient"),B=a.getPrivateAnnotation(z,"transientPredicate");if(T){if(typeof T!=="string"){throw new Error("No 'delete' allowed while waiting for server response");}u.oRequestor.removePost(T,z);return undefined;}if(z["@$ui5.context.isDeleted"]){throw new Error("Must not delete twice: "+E);}z["@$ui5.context.isDeleted"]=true;if(Array.isArray(w)){y=u.addDeleted(w,I,K,G,!!B);u.removeElement(w,I,K,t);n(I,-1);}H={"If-Match":i||z};E+=u.oRequestor.buildQueryString(u.sMetaPath,u.mQueryOptions,true);R=G?u.oRequestor.request("DELETE",E,G.getUnlockedCopy(),H,undefined,undefined,function(){},undefined,a.buildPath(u.getOriginalResourcePath(z),A)):S.resolve();a.addByPath(u.mChangeRequests,A,R);return S.all([R.catch(function(F){if(F.status!==404){throw F;}}),I===undefined&&!D&&u.requestCount(G||u.oRequestor.lockGroup("$auto",u)),G&&G.unlock()]).then(function(){if(Array.isArray(w)){w.$deleted.splice(w.$deleted.indexOf(y),1);delete w.$byPredicate[K];delete w.$byPredicate[B];}else if(v){a.updateExisting(u.mChangeListeners,t,w,j.makeUpdateData([v],null));}else{z["$ui5.deleted"]=true;}u.oRequestor.getModelInterface().reportStateMessages(u.sResourcePath,{},[A]);},function(F){var J;delete z["@$ui5.context.isDeleted"];if(Array.isArray(w)){g(u.mChangeListeners,t,w,1);I=y.index;J=w.$deleted.indexOf(y);u.adjustIndexes(t,w,I,1,J);w.splice(I,0,z);w.$deleted.splice(J,1);if(B){w.$created+=1;if(!t){u.iActiveElements+=1;}}n(I,1);}throw F;}).finally(function(){a.removeByPath(u.mChangeRequests,A,R);});});};j.prototype.addDeleted=function(E,I,P,G,n){var D={created:n,groupId:G&&G.getGroupId(),predicate:P,index:I},i;E.$deleted=E.$deleted||[];for(i=0;i<E.$deleted.length;i+=1){if(I<E.$deleted[i].index){break;}}E.$deleted.splice(i,0,D);return D;};j.prototype.addPendingRequest=function(){var R;if(!this.oPendingRequestsPromise){this.oPendingRequestsPromise=new S(function(i){R=i;});this.oPendingRequestsPromise.$count=0;this.oPendingRequestsPromise.$resolve=R;}this.oPendingRequestsPromise.$count+=1;};j.prototype.adjustIndexes=function(P,E,I,n,D,q){if(!P){this.aReadRequests.forEach(function(R){if(R.iStart>=I){R.iStart+=n;R.iEnd+=n;}});}(E.$deleted||[]).forEach(function(t,i){if(I<t.index||D<i||q&&(I===0||!t.created)){t.index+=n;}});};j.prototype.calculateKeyPredicate=function(i,t,M){var P,T=t[M];if(T&&T.$Key){P=a.getKeyPredicate(i,M,t);if(P){a.setPrivateAnnotation(i,"predicate",P);}}return P;};j.prototype.checkSharedRequest=function(){if(this.bSharedRequest){throw new Error(this+" is read-only");}};j.prototype.create=function(G,P,i,t,E,A,n,q){var u=this.getValue(i),v=G.getGroupId(),K=E&&E["@$ui5.keepTransientPath"],w,R,x=this;function y(){var I=u.indexOf(E);a.removeByPath(x.mPostRequests,i,E);u.splice(I,1);u.$created-=1;if(!E["@$ui5.context.isInactive"]){x.iActiveElements-=1;g(x.mChangeListeners,i,u,-1);}delete u.$byPredicate[t];x.adjustIndexes(i,u,I,-1);G.cancel();}function z(){x.addPendingRequest();a.setPrivateAnnotation(E,"transient",new Promise(function(D){R=D;}));q();}function B(D,F){a.setPrivateAnnotation(E,"transient",v);a.addByPath(x.mPostRequests,i,E);return S.all([x.oRequestor.request("POST",D,F,null,w,z,y,undefined,a.buildPath(x.sResourcePath,i,t)),x.fetchTypes()]).then(function(H){var I=H[0],J,M;a.deletePrivateAnnotation(E,"postBody");a.deletePrivateAnnotation(E,"transient");E["@$ui5.context.isTransient"]=false;a.removeByPath(x.mPostRequests,i,E);x.visitResponse(I,H[1],a.getMetaPath(a.buildPath(x.sMetaPath,i)),i+t,K);J=a.getPrivateAnnotation(I,"predicate");if(J){a.setPrivateAnnotation(E,"predicate",J);if(K){J=t;}else if(t in u.$byPredicate){u.$byPredicate[J]=E;a.updateTransientPaths(x.mChangeListeners,t,J);}}M=a.getQueryOptionsForPath(x.mQueryOptions,i).$select;a.updateSelected(x.mChangeListeners,a.buildPath(i,J||t),E,I,M);x.removePendingRequest();R(true);return E;},function(H){if(H.canceled){throw H;}if(R){x.removePendingRequest();R();}n(H);if(x.fetchTypes().isRejected()){throw H;}v=v.replace(d,"");v=x.oRequestor.getGroupSubmitMode(v)==="API"?v:"$parked."+v;return B(D,x.oRequestor.lockGroup(v,x,true,true));});}this.checkSharedRequest();if(!Array.isArray(u)){throw new Error("Create is only supported for collections; '"+i+"' does not reference a collection");}E=a.publicClone(E,true)||{};w=a.merge({},E);a.setPrivateAnnotation(E,"postBody",w);a.setPrivateAnnotation(E,"transientPredicate",t);E["@$ui5.context.isTransient"]=true;if(v.startsWith("$inactive.")){E["@$ui5.context.isInactive"]=true;}else{this.iActiveElements+=1;g(this.mChangeListeners,i,u,1);}if(A){u.splice(u.$created,0,E);}else{u.unshift(E);}u.$created+=1;u.$byPredicate=u.$byPredicate||{};u.$byPredicate[t]=E;x.adjustIndexes(i,u,0,1,0,true);return P.then(function(D){D+=x.oRequestor.buildQueryString(x.sMetaPath,x.mQueryOptions,true);return B(D,G);});};j.prototype.deregisterChangeListener=function(P,i){if(!(this.bSharedRequest&&P)){a.removeByPath(this.mChangeListeners,P,i);}};j.prototype.drillDown=function(D,P,G,n){var q=S.resolve(D),E,t,I=false,u,T=false,v=this;function w(i,A){L[A?"info":"error"]("Failed to drill-down into "+P+", invalid segment: "+i,v.toString(),C);return undefined;}function x(V,i,y,A){var z,B=u.slice(0,y).join("/"),F=a.getMetaPath(B),R;if(Array.isArray(V)){return w(i,i==="0");}if(I){return w(i,true);}if(i.includes("@")){z=i.split("@")[0];F=a.getMetaPath(B.split("@")[0]);if(T||z in V||V[z+"@$ui5.noData"]||a.isSelected(F,v.mQueryOptions)){return w(i,true);}}return v.oRequestor.getModelInterface().fetchMetadata(v.sMetaPath+"/"+F).then(function(H){var J;if(!H){return w(i);}if(H.$Type==="Edm.Stream"&&!z){R=V[i+"@odata.mediaReadLink"]||V[i+"@mediaReadLink"];if(R){return R;}if(V[i+"@$ui5.noData"]||a.isSelected(F,v.mQueryOptions)){return a.buildPath(v.oRequestor.getServiceUrl()+v.sResourcePath,B);}}if(!T){J=V[a.getAnnotationKey(V,".Permissions",i)];if(J===0||J==="None"){return undefined;}if(!E&&!Array.isArray(D)){E=D;t=0;}return E&&!A&&v.fetchLateProperty(G,E,u.slice(0,t).join("/"),u.slice(t).join("/"),u.slice(t,y).join("/"))||w(i);}if(H.$kind==="NavigationProperty"){return null;}if(!H.$Type.startsWith("Edm.")){return{};}if("$DefaultValue"in H){return H.$Type==="Edm.String"?H.$DefaultValue:a.parseLiteral(H.$DefaultValue,H.$Type,B);}return null;});}if(!P){return q;}u=P.split("/");return u.reduce(function(y,z,i){return y.then(function H(V,A){var B,M,F;if(z==="$count"){return Array.isArray(V)?V.$count:w(z);}if(V===undefined||V===null){return undefined;}if(typeof V!=="object"||z==="@$ui5._"||Array.isArray(V)&&(z[0]==="$"||z==="length")){return w(z);}if(a.hasPrivateAnnotation(V,"predicate")){E=V;t=i;}F=V;T=T||V["@$ui5.context.isTransient"];M=f.exec(z);if(M){if(M[1]){V=V[M[1]];}if(V){V=V.$byPredicate&&V.$byPredicate[M[2]];}}else{B=j.from$skip(z,V);if(n&&B===z&&(V[z]===undefined||V[z]===null)){V[z]={};}V=V[B];}if(V===undefined&&z[0]!=="#"&&z[0]!=="@"){V=x(F,z,i+1,A);if(V instanceof S&&V.isPending()){return V.then(function(){return H(F,true);});}}if(z.includes("@")){I=true;}return V;});},q);};j.prototype.fetchLateProperty=function(G,R,i,n,M){var F,q,t,I=n.indexOf("@"),u,P,Q,v,w=a.getMetaPath(i),T=this.fetchTypes().getResult(),U,x=this;function y(z,B){var A=a.buildPath(F,B),E=T[A],D;if(!E){E=x.oRequestor.fetchType(T,A).getResult();}if(B){(E.$Key||[]).forEach(function(K){if(typeof K==="object"){K=K[Object.keys(K)[0]];}U.push(a.buildPath(B,K));});}if(z.$expand){D=Object.keys(z.$expand)[0];y(z.$expand[D],a.buildPath(B,D));}}if(!this.mLateQueryOptions){return undefined;}if(I>=0){if(n.startsWith("@$ui5.",I)){return undefined;}n=n.slice(0,I);}U=[n];F=a.buildPath(this.sMetaPath,w);Q=a.intersectQueryOptions(a.getQueryOptionsForPath(this.mLateQueryOptions,i),[n],this.oRequestor.getModelInterface().fetchMetadata,F);if(!Q){return undefined;}y(Q);q=a.buildPath(this.sResourcePath,i);v=q+this.oRequestor.buildQueryString(F,Q,false,true);P=this.mPropertyRequestByPath[v];if(!P){u=q+this.oRequestor.buildQueryString(F,this.mQueryOptions,true);t=a.getPrivateAnnotation(R,"groupId");P=this.oRequestor.request("GET",u,t?this.oRequestor.lockGroup(t,this):G.getUnlockedCopy(),undefined,undefined,undefined,undefined,F,undefined,false,Q).then(function(D){x.visitResponse(D,T,F,i);return D;});this.mPropertyRequestByPath[v]=P;}return P.then(function(D){var N=a.getPrivateAnnotation(D,"predicate"),z=a.getPrivateAnnotation(R,"predicate");if(z&&N&&z!==N){throw new Error("GET "+v+": Key predicate changed from "+z+" to "+N);}if(R["@odata.etag"]&&D["@odata.etag"]!==R["@odata.etag"]){throw new Error("GET "+v+": ETag changed");}a.updateSelected(x.mChangeListeners,i,R,D,U);return a.drillDown(R,M.split("/"));}).finally(function(){delete x.mPropertyRequestByPath[v];});};j.prototype.fetchTypes=function(){var P,t,i=this;function n(B,q){if(q&&q.$expand){Object.keys(q.$expand).forEach(function(N){var M=B;N.split("/").forEach(function(u){M+="/"+u;P.push(i.oRequestor.fetchType(t,M));});n(M,q.$expand[N]);});}}if(!this.oTypePromise){P=[];t={};P.push(this.oRequestor.fetchType(t,this.sMetaPath));n(this.sMetaPath,this.mQueryOptions);this.oTypePromise=S.all(P).then(function(){return t;});}return this.oTypePromise;};j.prototype.getAllElements=function(P){var A;if(P){return this.getValue(P);}A=this.aElements.map(function(E){return E instanceof S?undefined:E;});A.$count=this.aElements.$count;return A;};j.prototype.getCreatedElements=function(P){var i=this.getValue(P);return i?i.slice(0,i.$created):[];};j.prototype.getDownloadQueryOptions=function(q){return q;};j.prototype.getDownloadUrl=function(P,i){var q=this.mQueryOptions;if(P){q=a.getQueryOptionsForPath(q,P);q=a.merge({},i,q);}return this.oRequestor.getServiceUrl()+a.buildPath(this.sResourcePath,P)+this.oRequestor.buildQueryString(a.buildPath(this.sMetaPath,a.getMetaPath(P)),this.getDownloadQueryOptions(q));};j.prototype.getLateQueryOptions=function(){return this.mLateQueryOptions;};j.prototype.getQueryOptions=function(){return this.mQueryOptions;};j.prototype.getValue=function(i){throw new Error("Unsupported operation");};j.prototype.getOriginalResourcePath=function(E){return this.fnGetOriginalResourcePath&&this.fnGetOriginalResourcePath(E)||this.sResourcePath;};j.prototype.getResourcePath=function(){return this.sResourcePath;};j.prototype.hasChangeListeners=function(){return!c(this.mChangeListeners);};j.prototype.hasPendingChangesForPath=function(P,i,I){var t=this;return Object.keys(this.mChangeRequests).some(function(R){return a.hasPathPrefix(R,P)&&!(i&&t.mChangeRequests[R].every(function(n){return n.$isKeepAlive();}));})||Object.keys(this.mPostRequests).some(function(R){return I&&!R?false:a.hasPathPrefix(R,P)&&t.mPostRequests[R].some(function(E){return!E["@$ui5.context.isInactive"];});});};j.prototype.hasSentRequest=function(){return this.bSentRequest;};j.prototype.patch=function(P,D){var t=this;this.checkSharedRequest();return this.fetchValue(_.$cached,P).then(function(i){a.updateExisting(t.mChangeListeners,P,i,D);return i;});};j.prototype.refreshSingle=function(G,P,i,n,K,D){var t=this;this.checkSharedRequest();return this.fetchValue(_.$cached,P).then(function(E){var q=Object.assign({},a.getQueryOptionsForPath(t.mQueryOptions,P)),R;if(i!==undefined){n=a.getPrivateAnnotation(E[i],"predicate");}R=a.buildPath(t.sResourcePath,P,n);if(K&&t.mLateQueryOptions){a.aggregateExpandSelect(q,t.mLateQueryOptions);}delete q.$apply;delete q.$count;delete q.$filter;delete q.$orderby;delete q.$search;R+=t.oRequestor.buildQueryString(t.sMetaPath,q,false,t.bSortExpandSelect);t.bSentRequest=true;return S.all([t.oRequestor.request("GET",R,G,undefined,undefined,D),t.fetchTypes()]).then(function(u){var v=u[0];t.replaceElement(E,i,n,v,u[1],P);});});};j.prototype.refreshSingleWithRemove=function(G,P,i,n,K,D,q){var t=this;this.checkSharedRequest();return S.all([this.fetchValue(_.$cached,P),this.fetchTypes()]).then(function(R){var E=R[0],u,I,v={},w,x,Q=Object.assign({},a.getQueryOptionsForPath(t.mQueryOptions,P)),y,z=a.buildPath(t.sResourcePath,P),A=[],T=R[1];if(i!==undefined){u=E[i];n=a.getPrivateAnnotation(u,"predicate");}else{u=E.$byPredicate[n];}x=a.getKeyFilter(u,t.sMetaPath,T);I=(Q.$filter?"("+Q.$filter+") and ":"")+x;delete Q.$count;delete Q.$orderby;t.bSentRequest=true;if(K){if(t.mLateQueryOptions){a.aggregateExpandSelect(Q,t.mLateQueryOptions);}v=Object.assign({},Q);v.$filter=I;Q.$filter=x;delete Q.$search;y=z+t.oRequestor.buildQueryString(t.sMetaPath,Q,false,t.bSortExpandSelect);A.push(t.oRequestor.request("GET",y,G,undefined,undefined,D));if(i!==undefined&&(x!==I||v.$search)){delete v.$select;delete v.$expand;v.$count=true;v.$top=0;w=z+t.oRequestor.buildQueryString(t.sMetaPath,v);A.push(t.oRequestor.request("GET",w,G.getUnlockedCopy()));}}else{Q.$filter=I;y=z+t.oRequestor.buildQueryString(t.sMetaPath,Q,false,t.bSortExpandSelect);A.push(t.oRequestor.request("GET",y,G,undefined,undefined,D));}return S.all(A).then(function(R){var B=R[0].value,F=R[1]&&R[1]["@odata.count"]==="0";if(B.length>1){throw new Error("Unexpected server response, more than one entity returned.");}else if(B.length===0){t.removeElement(E,i,n,P);t.oRequestor.getModelInterface().reportStateMessages(t.sResourcePath,{},[P+n]);q(false);}else if(F){t.removeElement(E,i,n,P);t.replaceElement(E,undefined,n,B[0],T,P);q(true);}else{t.replaceElement(E,i,n,B[0],T,P);}});});};j.prototype.registerChangeListener=function(P,i){if(!(this.bSharedRequest&&P)){a.addByPath(this.mChangeListeners,P,i);}};j.prototype.removeElement=function(E,i,P,n){var q=E.$byPredicate[P],D=q["@$ui5.context.isDeleted"],t=a.getPrivateAnnotation(q,"transientPredicate");if(i!==undefined){i=j.getElementIndex(E,P,i);E.splice(i,1);g(this.mChangeListeners,n,E,-1);}if(!D){delete E.$byPredicate[P];}if(t){E.$created-=1;if(!n){this.iActiveElements-=1;}if(!D){delete E.$byPredicate[t];}}if(i!==undefined){this.adjustIndexes(n,E,i,-1);if(!n&&!t){this.iLimit-=1;}}return i;};j.prototype.removeMessages=function(){if(this.sReportedMessagesPath){this.oRequestor.getModelInterface().reportStateMessages(this.sReportedMessagesPath,{});this.sReportedMessagesPath=undefined;}};j.prototype.removePendingRequest=function(){if(this.oPendingRequestsPromise){this.oPendingRequestsPromise.$count-=1;if(!this.oPendingRequestsPromise.$count){this.oPendingRequestsPromise.$resolve();this.oPendingRequestsPromise=null;}}};j.prototype.replaceElement=function(E,i,P,n,t,q){var u,T;if(i===undefined){E.$byPredicate[P]=n;}else{i=j.getElementIndex(E,P,i);u=E[i];E[i]=E.$byPredicate[P]=n;T=a.getPrivateAnnotation(u,"transientPredicate");if(T){n["@$ui5.context.isTransient"]=false;E.$byPredicate[T]=n;a.setPrivateAnnotation(n,"transientPredicate",T);}}this.visitResponse(n,t,a.getMetaPath(a.buildPath(this.sMetaPath,q)),q+P);};j.prototype.requestCount=function(G){var E,q,R,t=this;if(this.mQueryOptions&&this.mQueryOptions.$count){q=Object.assign({},this.mQueryOptions);delete q.$expand;delete q.$orderby;delete q.$select;E=this.getFilterExcludingCreated();if(E){q.$filter=q.$filter?"("+q.$filter+") and "+E:E;}q.$top=0;R=this.sResourcePath+this.oRequestor.buildQueryString(this.sMetaPath,q);return this.oRequestor.request("GET",R,G.getUnlockedCopy()).catch(function(i){if(i.cause&&i.cause.status===404){return t.oRequestor.request("GET",R,G.getUnlockedCopy());}throw i;}).then(function(i){var n=parseInt(i["@odata.count"])+t.iActiveElements;s(t.mChangeListeners,"",t.aElements,n);t.iLimit=n;});}};j.prototype.resetChangesForPath=function(P){var t=this;Object.keys(this.mChangeRequests).reverse().forEach(function(R){var n,i;if(a.hasPathPrefix(R,P)){n=t.mChangeRequests[R];for(i=n.length-1;i>=0;i-=1){t.oRequestor.removeChangeRequest(n[i]);}delete t.mChangeRequests[R];}});Object.keys(this.mPostRequests).forEach(function(R){var E,T,i;if(h(R,P)){E=t.mPostRequests[R];for(i=E.length-1;i>=0;i-=1){T=a.getPrivateAnnotation(E[i],"transient");if(!T.startsWith("$inactive.")){t.oRequestor.removePost(T,E[i]);}}}});};j.prototype.setActive=function(A){if(A){this.iActiveUsages+=1;this.iInactiveSince=Infinity;}else{this.iActiveUsages-=1;if(!this.iActiveUsages){this.iInactiveSince=Date.now();this.mChangeListeners={};}}};j.prototype.setLateQueryOptions=function(q){if(q){this.mLateQueryOptions={$select:q.$select,$expand:q.$expand};}else{this.mLateQueryOptions=null;}};j.prototype.setProperty=function(P,v,E){var t=this;this.checkSharedRequest();return this.fetchValue(_.$cached,E,null,null,true).then(function(i){a.updateAll(t.mChangeListeners,E,i,j.makeUpdateData(P.split("/"),v));});};j.prototype.setQueryOptions=function(q,F){this.checkSharedRequest();if(this.bSentRequest&&!F){throw new Error("Cannot set query options: Cache has already sent a request");}this.mQueryOptions=q;this.sQueryString=this.oRequestor.buildQueryString(this.sMetaPath,q,false,this.bSortExpandSelect);};j.prototype.setResourcePath=function(R){this.checkSharedRequest();this.sResourcePath=R;this.sMetaPath=a.getMetaPath("/"+R);this.oTypePromise=undefined;this.mLateQueryOptions=null;this.mPropertyRequestByPath={};};j.prototype.toString=function(){return this.oRequestor.getServiceUrl()+this.sResourcePath+this.sQueryString;};j.prototype.update=function(G,P,v,E,i,n,u,q,t,I){var w,x=P.split("/"),U,y=this;this.checkSharedRequest();try{w=this.fetchValue(_.$cached,n);}catch(z){if(!z.$cached||this.oPromise!==null){throw z;}w=this.oPromise=S.resolve({"@odata.etag":"*"});}return w.then(function(A){var F=a.buildPath(n,P),B=G.getGroupId(),D,H,J,K,M,T,N,Q=j.makeUpdateData(x,v);function R(){a.removeByPath(y.mChangeRequests,F,H);a.updateExisting(y.mChangeListeners,n,A,D);}function V(X){if(arguments.length===0){M=true;return D;}a.updateNonExisting(D,X);}function W(X,Y){var Z={"If-Match":A},$;function a1(){$=y.oRequestor.lockGroup(B,y,true);t();}if(q){Z.Prefer="return=minimal";}H=y.oRequestor.request("PATCH",i,X,Z,Q,a1,R,undefined,a.buildPath(y.getOriginalResourcePath(A),n),Y,undefined,undefined,V);H.$isKeepAlive=I;a.addByPath(y.mChangeRequests,F,H);return S.all([H,y.fetchTypes()]).then(function(b1){var c1=b1[0];a.removeByPath(y.mChangeRequests,F,H);if(M){return;}if(!q){y.visitResponse(c1,b1[1],a.getMetaPath(a.buildPath(y.sMetaPath,n)),n);}a.updateExisting(y.mChangeListeners,n,A,q?{"@odata.etag":c1["@odata.etag"]}:c1);},function(z){var b1=B;if(!E){R();throw z;}a.removeByPath(y.mChangeRequests,F,H);if(z.canceled){throw z;}$.unlock();$=undefined;E(z);if(M){return y.mEditUrl2PatchPromise[i];}switch(y.oRequestor.getGroupSubmitMode(B)){case"API":break;case"Auto":if(!y.oRequestor.hasChanges(B,A)){b1="$parked."+B;}break;default:throw z;}y.mEditUrl2PatchPromise[i]=W(y.oRequestor.lockGroup(b1,y,true,true),true);return y.mEditUrl2PatchPromise[i];}).finally(function(){if($){$.unlock();}delete y.mEditUrl2PatchPromise[i];});}if(!A){throw new Error("Cannot update '"+P+"': '"+n+"' does not exist");}T=a.getPrivateAnnotation(A,"transient");if(T){if(typeof T!=="string"){throw new Error("No 'update' allowed while waiting for server response");}if(T.startsWith("$parked.")||T.startsWith("$inactive.")){K=T;T=T.slice(T.indexOf(".")+1);}if(T!==B){throw new Error("The entity will be created via group '"+T+"'. Cannot patch via group '"+B+"'");}}D=j.makeUpdateData(x,a.drillDown(A,x));J=a.getPrivateAnnotation(A,"postBody");if(J){a.updateAll({},n,J,Q);if(A["@$ui5.context.isInactive"]){Q["@$ui5.context.isInactive"]=false;y.iActiveElements+=1;g(y.mChangeListeners,"",y.aElements,1);}}a.updateAll(y.mChangeListeners,n,A,Q);if(u){U=u.split("/");u=a.buildPath(n,u);N=y.getValue(u);if(N===undefined){L.debug("Missing value for unit of measure "+u+" when updating "+F,y.toString(),C);}else{a.merge(T?J:Q,j.makeUpdateData(U,N));}}if(T){if(K){a.setPrivateAnnotation(A,"transient",T);y.oRequestor.relocate(K,J,T);}G.unlock();return Promise.resolve();}y.oRequestor.relocateAll("$parked."+B,B,A);i+=y.oRequestor.buildQueryString(y.sMetaPath,y.mQueryOptions,true);return W(G);});};j.prototype.visitResponse=function(R,t,n,q,K,u){var v,H=false,P={},w=this.oRequestor.getServiceUrl()+this.sResourcePath,x=this;function y(M,i,D){H=true;if(M&&M.length){P[i]=M;M.forEach(function(E){if(E.longtextUrl){E.longtextUrl=a.makeAbsolute(E.longtextUrl,D);}});}}function z(i,D){return D?a.makeAbsolute(D,i):i;}function A(I,M,D,E){var F={},G,J,N,i;for(i=0;i<I.length;i+=1){J=I[i];G=D===""?u+i:i;if(J&&typeof J==="object"){B(J,M,D,E,G);N=a.getPrivateAnnotation(J,"predicate");if(!D){v.push(N||G.toString());}if(N){F[N]=J;I.$byPredicate=F;}}}}function B(i,M,I,D,E){var F,G,T=t[M],J=T&&T[m]&&T[m].$Path,N;D=z(D,i["@odata.context"]);G=x.calculateKeyPredicate(i,t,M);if(E!==undefined){I=a.buildPath(I,G||E);}else if(!K&&G){F=r.exec(I);if(F){I=I.slice(0,-F[0].length)+G;}}if(q&&!v){v=[I];}if(J){N=a.drillDown(i,J.split("/"));if(N!==undefined){y(N,I,D);}}Object.keys(i).forEach(function(Q){var U,V=M+"/"+Q,W=i[Q],X=a.buildPath(I,Q);if(Q.endsWith("@odata.mediaReadLink")||Q.endsWith("@mediaReadLink")){i[Q]=a.makeAbsolute(W,D);}if(Q===J||Q.includes("@")){return;}if(Array.isArray(W)){W.$created=0;W.$count=undefined;U=i[Q+"@odata.count"];if(U){s({},"",W,U);}else if(!i[Q+"@odata.nextLink"]){s({},"",W,W.length);}A(W,V,X,z(D,i[Q+"@odata.context"]));}else if(W&&typeof W==="object"){B(W,V,X,D);}});}if(u!==undefined){v=[];A(R.value,n||this.sMetaPath,"",z(w,R["@odata.context"]));}else if(R&&typeof R==="object"){B(R,n||this.sMetaPath,q||"",w);}if(H){this.sReportedMessagesPath=this.getOriginalResourcePath(R);this.oRequestor.getModelInterface().reportStateMessages(this.sReportedMessagesPath,P,v);}};function k(R,i,q,n,D,t){j.call(this,R,i,q,n,function(){return D;},t);this.iActiveElements=0;this.oBackup=null;this.sContext=undefined;this.aElements=[];this.aElements.$byPredicate={};this.aElements.$count=undefined;this.aElements.$created=0;this.aElements.$tail=undefined;this.iLimit=Infinity;this.aReadRequests=[];this.bServerDrivenPaging=false;this.oSyncPromiseAll=undefined;}k.prototype=Object.create(j.prototype);k.prototype.addKeptElement=function(E){this.aElements.$byPredicate[a.getPrivateAnnotation(E,"predicate")]=E;};k.prototype.createEmptyElement=function(P){var E={};a.setPrivateAnnotation(E,"predicate",P);this.aElements.$byPredicate[P]=E;return E;};k.prototype.doReplaceWith=function(i,E){var n=this.aElements[i];if(n&&a.hasPrivateAnnotation(n,"transientPredicate")&&!a.hasPrivateAnnotation(E,"transientPredicate")){a.setPrivateAnnotation(E,"transientPredicate",a.getPrivateAnnotation(E,"predicate"));}this.aElements[i]=E;this.addKeptElement(E);};k.prototype.fetchValue=function(G,P,i,n,q){var E,F=P.split("/")[0],t,u=this;G.unlock();if(this.aElements.$byPredicate[F]){t=S.resolve();}else if((G===_.$cached||F!=="$count")&&this.aElements[F]!==undefined){t=S.resolve(this.aElements[F]);}else{if(!this.oSyncPromiseAll){E=this.aElements.$tail?this.aElements.concat(this.aElements.$tail):this.aElements;this.oSyncPromiseAll=S.all(E);}t=this.oSyncPromiseAll;}return t.then(function(){u.registerChangeListener(P,n);return u.drillDown(u.aElements,P,G,q);});};k.prototype.fill=function(P,q,E){var i,n=Math.max(this.aElements.length,1024);if(E>n){if(this.aElements.$tail&&P){throw new Error("Cannot fill from "+q+" to "+E+", $tail already in use, # of elements is "+this.aElements.length);}this.aElements.$tail=P;E=this.aElements.length;}for(i=q;i<E;i+=1){this.aElements[i]=P;}this.oSyncPromiseAll=undefined;};k.prototype.getFilterExcludingCreated=function(){var E,K=[],t,i,n=this;function q(E){var u;t=t||n.fetchTypes().getResult();u=a.getKeyFilter(E,n.sMetaPath,t);if(u){K.push(u);}}for(i=0;i<this.aElements.$created;i+=1){E=this.aElements[i];if(!E["@$ui5.context.isTransient"]){q(E);}}(this.aElements.$deleted||[]).forEach(function(D){if(D.created){q(n.aElements.$byPredicate[D.predicate]);}});return K.length?"not ("+K.sort().join(" or ")+")":undefined;};k.prototype.getQueryString=function(){var E=this.getFilterExcludingCreated(),q=Object.assign({},this.mQueryOptions),F=q.$filter,Q=this.sQueryString;if(E){if(F){q.$filter="("+F+") and "+E;Q=this.oRequestor.buildQueryString(this.sMetaPath,q,false,this.bSortExpandSelect);}else{Q+=(Q?"&":"?")+"$filter="+a.encode(E,false);}}return Q;};k.prototype.getReadOffset=function(G,i){var n=0;(this.aElements.$deleted||[]).forEach(function(D){if(D.groupId!==G&&!D.created&&D.index<=i){n+=1;}});return n;};k.prototype.getResourcePathWithQuery=function(i,E){var n=this.aElements.$created,q=this.getQueryString(),D=q?"&":"?",t=E-i,R=this.sResourcePath+q;if(i<n){throw new Error("Must not request created element");}i-=n;if(i>0||t<Infinity){R+=D+"$skip="+i;}if(t<Infinity){R+="&$top="+t;}return R;};k.prototype.getValue=function(P){var i;if(!P){return this.aElements;}i=this.fetchValue(_.$cached,P);if(i.isFulfilled()){return i.getResult();}i.caught();};k.prototype.handleCount=function(G,t,n,E,R,F){var q=R["@odata.count"],u=this.aElements.$created,v,w=-1,x=this.aElements.$count,y,z=R.value.length,i;E-=F;z-=F;if(q){v=parseInt(q)-F;if(F===t||n===u&&z===v){this.iLimit=w=v;}else{y=this.requestCount(this.oRequestor.getUnlockedAutoCopy(G));}}if(R["@odata.nextLink"]){this.bServerDrivenPaging=true;if(E<this.aElements.length){for(i=n+z;i<E;i+=1){delete this.aElements[i];}}else{this.aElements.length=n+z;}}else if(z<E-n){if(w===-1){w=x&&x-this.iActiveElements;}w=Math.min(w!==undefined?w:Infinity,n-u+z);this.aElements.length=u+w;this.iLimit=w;if(!q&&w>0&&!this.aElements[w-1]){w=undefined;}}if(w!==-1){s(this.mChangeListeners,"",this.aElements,w!==undefined?w+this.iActiveElements:undefined);}return y;};k.prototype.handleResponse=function(R,n,t){var E,q=this.aElements,u=q.$created,K,v=0,P,w=R.value.length,i;this.sContext=R["@odata.context"];this.visitResponse(R,t,undefined,undefined,undefined,n);for(i=0;i<w;i+=1){E=R.value[i];P=a.getPrivateAnnotation(E,"predicate");if(P){K=q.$byPredicate[P];if(K){if(!K["@odata.etag"]||E["@odata.etag"]===K["@odata.etag"]){if(u&&q.lastIndexOf(K,u-1)>=0){v+=1;q[n+w-v]=undefined;continue;}a.updateNonExisting(K,E);E=K;}else if(this.hasPendingChangesForPath(P)){throw new Error("Modified on client and on server: "+this.sResourcePath+P);}}q.$byPredicate[P]=E;}q[n+i-v]=E;}return v;};k.prototype.read=function(I,n,P,G,D){var q=0,E,t,u,v=this.oPendingRequestsPromise||this.aElements.$tail,R,T=0,i,w=this;if(I<0){throw new Error("Illegal index "+I+", must be >= 0");}if(n<0){throw new Error("Illegal length "+n+", must be >= 0");}if(v){return v.then(function(){return w.read(I,n,P,G,D);});}for(i=0;i<this.aElements.$created;i+=1){E=this.aElements[i];if(a.getPrivateAnnotation(E,"transient")===G.getGroupId()){T+=1;}if(w.oBackup&&!E["@$ui5.context.isTransient"]){q+=1;}}R=O._getReadIntervals(this.aElements,I,n,this.bServerDrivenPaging?0:Math.max(P,T,q),this.aElements.$created+this.iLimit);if(T&&(R.length>1||R.length&&R[0].start>this.aElements.$created)){G.unlock();return this.oRequestor.waitForBatchResponseReceived(G.getGroupId()).then(function(){return w.read(I,n,P,w.oRequestor.getUnlockedAutoCopy(G),D);});}R.forEach(function(x){w.requestElements(x.start,x.end,G.getUnlockedCopy(),T,D);D=undefined;});G.unlock();u=I+n+P;t=this.aElements.slice(I,u);if(this.aElements.$tail&&u>this.aElements.length){t.push(this.aElements.$tail);}return S.all(t).then(function(){var x=w.aElements.slice(I,I+n);x.$count=w.aElements.$count;return{"@odata.context":w.sContext,value:x};});};k.prototype.refreshKeptElements=function(G,i){var t=this,P=Object.keys(this.aElements.$byPredicate).filter(q).sort(),T;function n(){var K,Q=a.merge({},t.mQueryOptions);if(t.mLateQueryOptions){a.aggregateExpandSelect(Q,t.mLateQueryOptions);}delete Q.$count;delete Q.$orderby;delete Q.$search;K=P.map(function(u){return a.getKeyFilter(t.aElements.$byPredicate[u],t.sMetaPath,T);});Q.$filter=K.join(" or ");if(K.length>1){Q.$top=K.length;}return t.sResourcePath+t.oRequestor.buildQueryString(t.sMetaPath,Q,false,true);}function q(u){var E=t.aElements.$byPredicate[u];return a.getPrivateAnnotation(E,"predicate")===u&&!t.hasPendingChangesForPath(u);}if(P.length===0){return undefined;}T=this.fetchTypes().getResult();return this.oRequestor.request("GET",n(),G).then(function(R){var u;t.visitResponse(R,T,undefined,undefined,undefined,0);u=R.value.$byPredicate||{};P.forEach(function(v){var E,I;if(v in u){a.updateAll(t.mChangeListeners,v,t.aElements.$byPredicate[v],u[v]);}else{E=t.aElements.$byPredicate[v];if(a.getPrivateAnnotation(E,"transientPredicate")){I=t.removeElement(t.aElements,-1,v,"");}else{delete t.aElements.$byPredicate[v];}i(v,I);}});});};k.prototype.requestElements=function(i,E,G,t,D){var n=this.getReadOffset(G.getGroupId(),i),P,R={iEnd:E,iStart:i},q=this;this.aReadRequests.push(R);this.bSentRequest=true;P=S.all([this.oRequestor.request("GET",this.getResourcePathWithQuery(i+n,E+n),G,undefined,undefined,D),this.fetchTypes()]).then(function(u){var F;if(q.aElements.$tail===P){q.aElements.$tail=undefined;}F=q.handleResponse(u[0],R.iStart,u[1]);return q.handleCount(G,t,R.iStart,R.iEnd,u[0],F);}).catch(function(u){q.fill(undefined,R.iStart,R.iEnd);throw u;}).finally(function(){q.aReadRequests.splice(q.aReadRequests.indexOf(R),1);});this.fill(P,i,E);return P;};k.prototype.requestSideEffects=function(G,P,q,t){var E,M=-1,u,Q,v={},R,w,T=this.fetchTypes().getResult(),x=this;this.checkSharedRequest();if(this.oPendingRequestsPromise){return this.oPendingRequestsPromise.then(function(){return x.requestSideEffects(G,P,q,t);});}Q=a.intersectQueryOptions(Object.assign({},this.mQueryOptions,this.mLateQueryOptions),P,this.oRequestor.getModelInterface().fetchMetadata,this.sMetaPath,"",true);if(!Q){return S.resolve();}if(t){E=[this.aElements.$byPredicate[q[0]]];}else{q.forEach(function(i){v[i]=true;});E=this.aElements.filter(function(n,i){var y;if(!n){return false;}if(a.hasPrivateAnnotation(n,"transient")){M=i;return false;}y=a.getPrivateAnnotation(n,"predicate");if(v[y]||a.hasPrivateAnnotation(n,"transientPredicate")){M=i;delete v[y];return true;}delete x.aElements[i];delete x.aElements.$byPredicate[y];return false;});this.aElements.length=M+1;if(!E.length){return S.resolve();}Object.keys(v).forEach(function(i){E.push(x.aElements.$byPredicate[i]);});}Q.$filter=E.map(function(i){return a.getKeyFilter(i,x.sMetaPath,T);}).join(" or ");if(E.length>1){Q.$top=E.length;}a.selectKeyProperties(Q,T[this.sMetaPath]);delete Q.$count;delete Q.$orderby;delete Q.$search;u=a.extractMergeableQueryOptions(Q);R=this.sResourcePath+this.oRequestor.buildQueryString(this.sMetaPath,Q,false,true);return this.oRequestor.request("GET",R,G,undefined,undefined,undefined,undefined,this.sMetaPath,undefined,false,u,this,function(i){if(arguments.length){P=P.concat(i);}else{w=true;return P;}}).then(function(y){var z,A,i,n;function B(D){D=D.slice(A.length+1);return!P.some(function(F){return a.getRelativePath(D,F)!==undefined;});}if(w){return;}if(y.value.length!==E.length){throw new Error("Expected "+E.length+" row(s), but instead saw "+y.value.length);}x.visitResponse(y,T,undefined,"",false,NaN);for(i=0,n=y.value.length;i<n;i+=1){z=y.value[i];A=a.getPrivateAnnotation(z,"predicate");a.updateAll(x.mChangeListeners,A,x.aElements.$byPredicate[A],z,B);}});};k.prototype.reset=function(K,G){var B=this.aElements.$byPredicate,n=this.mChangeListeners,q=0,E,t,i,u=this;if(G){this.oBackup={iActiveElements:this.iActiveElements,mChangeListeners:this.mChangeListeners,sContext:this.sContext,aElements:this.aElements.slice(),$byPredicate:B,$count:this.aElements.$count,$created:this.aElements.$created,iLimit:this.iLimit};}for(i=0;i<this.aElements.$created;i+=1){E=this.aElements[i];t=a.getPrivateAnnotation(E,"transient");if(G?"@$ui5.context.isInactive"in E||t&&t!==G:t){K.push(a.getPrivateAnnotation(E,"predicate")||a.getPrivateAnnotation(E,"transientPredicate"));this.aElements[q]=E;q+=1;}else{this.iActiveElements-=1;}}this.mChangeListeners={};this.sContext=undefined;this.aElements.length=this.aElements.$created=q;this.aElements.$byPredicate={};this.aElements.$count=undefined;this.iLimit=Infinity;Object.keys(n).forEach(function(P){if(K.includes(P.split("/")[0])){u.mChangeListeners[P]=n[P];}});K.forEach(function(P){u.aElements.$byPredicate[P]=B[P];});if(n[""]){this.mChangeListeners[""]=n[""];a.fireChange(this.mChangeListeners,"");}};k.prototype.restore=function(R){if(R){this.iActiveElements=this.oBackup.iActiveElements;this.mChangeListeners=this.oBackup.mChangeListeners;this.sContext=this.oBackup.sContext;this.aElements.length=this.oBackup.aElements.length;this.oBackup.aElements.forEach(function(E,i){this[i]=E;},this.aElements);this.aElements.$byPredicate=this.oBackup.$byPredicate;this.aElements.$count=this.oBackup.$count;this.aElements.$created=this.oBackup.$created;this.iLimit=this.oBackup.iLimit;}this.oBackup=null;};function l(R,i,q){j.call(this,R,i,q);this.oPromise=null;}l.prototype=Object.create(j.prototype);l.prototype._delete=function(){throw new Error("Unsupported");};l.prototype.create=function(){throw new Error("Unsupported");};l.prototype.fetchValue=function(G,i,D,n,q){var t=this;if(q){throw new Error("Unsupported argument: bCreateOnDemand");}if(this.oPromise){G.unlock();}else{this.bSentRequest=true;this.oPromise=S.resolve(this.oRequestor.request("GET",this.sResourcePath+this.sQueryString,G,undefined,undefined,D,undefined,this.sMetaPath));}return this.oPromise.then(function(R){t.registerChangeListener("",n);return R&&typeof R==="object"?R.value:R;});};l.prototype.update=function(){throw new Error("Unsupported");};function o(R,i,q,n,t,G,P,M,E){j.call(this,R,i,q,n,G,t);this.sMetaPath=M||this.sMetaPath;this.bPost=P;this.bPosting=false;if(E){this.oPromise=S.resolve({});}else{this.oPromise=null;}}o.prototype=Object.create(j.prototype);o.prototype.fetchValue=function(G,P,D,i,n){var R=this.sResourcePath+this.sQueryString,t=this;if(this.oPromise){G.unlock();}else{if(this.bPost){throw new Error("Cannot fetch a value before the POST request");}this.oPromise=S.all([this.oRequestor.request("GET",R,G,undefined,undefined,D,undefined,this.sMetaPath),this.fetchTypes()]).then(function(q){t.visitResponse(q[0],q[1]);return q[0];});this.bSentRequest=true;}return this.oPromise.then(function(q){if(q&&q["$ui5.deleted"]){throw new Error("Cannot read a deleted entity");}t.registerChangeListener(P,i);return t.drillDown(q,P,G,n);});};o.prototype.getValue=function(P){var i;if(this.oPromise&&this.oPromise.isFulfilled()){i=this.drillDown(this.oPromise.getResult(),P,_.$cached);if(i.isFulfilled()){return i.getResult();}i.caught();}};o.prototype.post=function(G,D,E,i,n){var q,H=E?{"If-Match":i&&"@odata.etag"in E?"*":E}:{},t="POST",u=this;function v(w){u.bPosting=true;return S.all([u.oRequestor.request(t,u.sResourcePath+u.sQueryString,w,H,D),u.fetchTypes()]).then(function(R){u.visitResponse(R[0],R[1]);u.bPosting=false;return R[0];},function(x){u.bPosting=false;if(n&&x.strictHandlingFailed){return n(x).then(function(y){var z;if(y){delete H["Prefer"];return v(w.getUnlockedCopy());}z=Error("Action canceled due to strict handling");z.canceled=true;throw z;});}throw x;});}this.checkSharedRequest();if(!this.bPost){throw new Error("POST request not allowed");}if(this.bPosting){throw new Error("Parallel POST requests not allowed");}if(E){q=G.getGroupId();this.oRequestor.relocateAll("$parked."+q,q,E);}if(D){t=D["X-HTTP-Method"]||t;delete D["X-HTTP-Method"];if(this.oRequestor.isActionBodyOptional()&&!Object.keys(D).length){D=undefined;}}this.bSentRequest=true;if(n){H["Prefer"]="handling=strict";}this.oPromise=v(G);return this.oPromise;};o.prototype.requestSideEffects=function(G,P,R){var M,q,i,n,t=this;this.checkSharedRequest();q=this.oPromise&&a.intersectQueryOptions(Object.assign({},this.mQueryOptions,this.mLateQueryOptions),P,this.oRequestor.getModelInterface().fetchMetadata,this.sMetaPath);if(!q){return S.resolve();}if(this.oPromise.isRejected()){throw new Error(this+": Cannot call requestSideEffects, cache is broken: "+this.oPromise.getResult().message);}M=a.extractMergeableQueryOptions(q);R=(R||this.sResourcePath)+this.oRequestor.buildQueryString(this.sMetaPath,q,false,true);i=S.all([this.oRequestor.request("GET",R,G,undefined,undefined,undefined,undefined,this.sMetaPath,undefined,false,M,this,function(u){if(arguments.length){P=P.concat(u);}else{n=true;return P;}}),this.fetchTypes(),this.fetchValue(_.$cached,"")]).then(function(u){return u;}).then(function(u){var N=u[0],v=u[2];if(n){return;}a.setPrivateAnnotation(N,"predicate",a.getPrivateAnnotation(v,"predicate"));t.visitResponse(N,u[1]);a.updateAll(t.mChangeListeners,"",v,N,function(w){return!P.some(function(x){return a.getRelativePath(w,x)!==undefined;});});});return i;};o.prototype.resetProperty=function(P){var D=this.oPromise.getResult();if(D){P.split("/").some(function(i){delete D["@odata.etag"];if(typeof D[i]==="object"){D=D[i];return false;}delete D[i];return true;});}};function p(R,i,q){var n=i.split("/"),t=n[0],u=t+JSON.stringify(q),v=R.$mSingletonCacheByPath;l.call(this,R,i,{});if(!v){v=R.$mSingletonCacheByPath={};}this.oSingleton=v[u];if(!this.oSingleton){this.oSingleton=v[u]=new o(R,t,q,undefined,undefined,undefined,undefined,undefined,true);}this.sRelativePath=i.split(t+"/")[1];}p.prototype=Object.create(l.prototype);p.prototype.fetchValue=function(G,i,D,n,q){var P=this.oSingleton.sResourcePath+"/"+this.sRelativePath,t,M=this.oMetadataPromise||this.oRequestor.getModelInterface().fetchMetadata("/"+a.getMetaPath(P)),u=this;return M.then(function(){if(!u.oMetadataPromise){t=u.oSingleton.getLateQueryOptions()||{};a.aggregateExpandSelect(t,a.wrapChildQueryOptions("/"+u.oSingleton.sResourcePath,u.sRelativePath,{},u.oRequestor.getModelInterface().fetchMetadata));u.oSingleton.setLateQueryOptions(t);}u.oMetadataPromise=M;return u.oSingleton.fetchValue(G,u.sRelativePath,D,n,q);});};p.prototype.reset=function(){this.oSingleton.resetProperty(this.sRelativePath);};j.create=function(R,i,q,n,D,t){var u,K,P,v,w;if(t){P=i+R.buildQueryString(a.getMetaPath("/"+i),q,false,n);w=R.$mSharedCollectionCacheByPath;if(!w){w=R.$mSharedCollectionCacheByPath={};}v=w[P];if(v){v.setActive(true);}else{K=Object.keys(w);u=K.length;if(u>100){K.filter(function(x){return!w[x].iActiveUsages;}).sort(function(x,y){return w[x].iInactiveSince-w[y].iInactiveSince;}).every(function(x){delete w[x];u-=1;return u>100;});}v=w[P]=new k(R,i,q,n,D,t);}return v;}return new k(R,i,q,n,D);};j.createProperty=function(R,i,q){if(i.includes("(")||i.endsWith("/$count")){return new l(R,i,q);}return new p(R,i,q);};j.createSingle=function(R,i,q,n,t,G,P,M){return new o(R,i,q,n,t,G,P,M);};j.from$skip=function(i,n){return e.test(i)?(n.$created||0)+Number(i):i;};j.getElementIndex=function(E,K,i){var n=E[i];if(!n||a.getPrivateAnnotation(n,"predicate")!==K){i=E.indexOf(E.$byPredicate[K]);}return i;};j.makeUpdateData=function(P,v){return P.reduceRight(function(V,i){var R={};R[i]=V;return R;},v);};return j;},false);
