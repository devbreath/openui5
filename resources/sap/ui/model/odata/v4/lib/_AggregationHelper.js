/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./_Helper","./_Parser","sap/ui/model/Filter"],function(_,a,F){"use strict";var r=/,|%2C|%2c/,d={aggregate:{"*":{grandTotal:"boolean",max:"boolean",min:"boolean",name:"string",subtotals:"boolean",unit:"string",with:"string"}},"grandTotal like 1.84":"boolean",grandTotalAtBottomOnly:"boolean",group:{"*":{additionally:["string"]}},groupLevels:["string"],search:"string",subtotalsAtBottomOnly:"boolean"},b=new RegExp("^("+a.sODataIdentifier+"(?:/"+a.sODataIdentifier+")*"+")(?:"+a.sWhitespace+"+(?:asc|desc))?$"),R={expandTo:/^[1-9]\d*$/,hierarchyQualifier:"string"},c;function e(A,g,f,G,h,i,j){var D=A.aggregate[h],k=D.name||h,u=D.unit,w=D.with;if(G){if(w==="average"||w==="countdistinct"){throw new Error("Cannot aggregate totals with '"+w+"'");}k=h;h="UI5grand__"+h;}if(w){k+=" with "+w+" as "+h;}else if(D.name){k+=" as "+h;}f.push(k);if(u&&!f.includes(u)&&!j.includes(u,i+1)&&!g.includes(u)){f.push(u);}}function s(q){var t=[];if(q.$skip){t.push("skip("+q.$skip+")");}delete q.$skip;if(q.$top<Infinity){t.push("top("+q.$top+")");}delete q.$top;return t.join("/");}c={buildApply:function(A,q,l,f,m){var g,h="",G=[],i=A["grandTotal like 1.84"],j,I,L,M=[],S,k=[];function p(n,o){var t,D=A.aggregate[n];if(D[o]){t="UI5"+o+"__"+n;M.push(n+" with "+o+" as "+t);if(m){m[t]={measure:n,method:o};}}}if(A.hierarchyQualifier){return c.buildApply4Hierarchy(A,q);}q=Object.assign({},q);A.groupLevels=A.groupLevels||[];I=!l||l>A.groupLevels.length;A.group=A.group||{};A.groupLevels.forEach(function(n){A.group[n]=A.group[n]||{};});j=I?Object.keys(A.group).sort().filter(function(n){return!A.groupLevels.includes(n);}):[A.groupLevels[l-1]];if(!l){j=A.groupLevels.concat(j);}A.aggregate=A.aggregate||{};g=Object.keys(A.aggregate).sort();if(l===1&&!f){g.filter(function(n){return A.aggregate[n].grandTotal;}).forEach(e.bind(null,A,[],G,i));}if(!f){g.forEach(function(n){p(n,"min");p(n,"max");});}g.filter(function(n){return I||A.aggregate[n].subtotals;}).forEach(e.bind(null,A,j,k,false));if(k.length){h="aggregate("+k.join(",")+")";}if(j.length){j.forEach(function(n){var o=A.group[n].additionally;if(o){j.push.apply(j,o);}});h="groupby(("+j.join(",")+(h?"),"+h+")":"))");}if(f){delete q.$count;}else if(q.$count){M.push("$count as UI5__count");delete q.$count;}if(q.$filter){h+="/filter("+q.$filter+")";delete q.$filter;}if(q.$orderby){h+="/orderby("+q.$orderby+")";delete q.$orderby;}S=s(q);if(i&&G.length){if(A.groupLevels.length){throw new Error("Cannot combine visual grouping with grand total");}h+="/concat(aggregate("+G.join(",")+"),aggregate("+M.join(",")+"),"+(S||"identity")+")";}else{if(M.length){h+="/concat(aggregate("+M.join(",")+"),"+(S||"identity")+")";}else if(S){h+="/"+S;}if(l===1&&q.$$leaves&&!f){L="groupby(("+Object.keys(A.group).sort().join(",")+"))/aggregate($count as UI5__leaves)";}delete q.$$leaves;if(G.length){h="concat("+(L?L+",":"")+"aggregate("+G.join(",")+"),"+h+")";}else if(L){h="concat("+L+","+h+")";}}if(A.search){h="search("+A.search+")/"+h;}if(q.$$filterBeforeAggregate){h="filter("+q.$$filterBeforeAggregate+")/"+h;delete q.$$filterBeforeAggregate;}if(h){q.$apply=h;}return q;},buildApply4Hierarchy:function(A,q){var f,h=A.hierarchyQualifier,p=A.$path,n=q?A.$fetchMetadata(p+"/@Org.OData.Aggregation.V1.RecursiveHierarchy#"+h+"/NodeProperty/$PropertyPath").getResult():"???",m;function g(P){if(q.$select){if(!m){m=A.$fetchMetadata(p+"/@com.sap.vocabularies.Hierarchy.v1.RecursiveHierarchy#"+h).getResult();}q.$select.push(m[P].$PropertyPath);}}q=Object.assign({},q);if(q.$select){q.$select=q.$select.slice();}if(q.$$filterBeforeAggregate){f="descendants($root"+p+","+h+","+n+",filter("+q.$$filterBeforeAggregate+"),1)";delete q.$$filterBeforeAggregate;}else{f="com.sap.vocabularies.Hierarchy.v1.TopLevels(HierarchyNodes=$root"+p+",HierarchyQualifier='"+h+"',NodeProperty='"+n+"',Levels="+(A.expandTo||1)+")";if(A.expandTo>1){g("DescendantCountProperty");g("DistanceFromRootProperty");}}g("DrillStateProperty");q.$apply=f;return q;},checkTypeof:function(v,t,p){if(Array.isArray(t)){if(!Array.isArray(v)){throw new Error("Not an array value for '"+p+"'");}v.forEach(function(E,i){c.checkTypeof(E,t[0],p+"/"+i);});}else if(t instanceof RegExp){if(!t.test(v)){throw new Error("Not a matching value for '"+p+"'");}}else if(typeof t==="object"){var I="*"in t;if(typeof v!=="object"||!v||Array.isArray(v)){throw new Error("Not an object value for '"+p+"'");}Object.keys(v).forEach(function(k){if(!I&&!(k in t)){throw new Error("Unsupported property: '"+p+"/"+k+"'");}c.checkTypeof(v[k],t[I?"*":k],p+"/"+k);});}else if(typeof v!==t){throw new Error("Not a "+t+" value for '"+p+"'");}},createPlaceholder:function(l,i,p){var P={"@$ui5.node.level":l};_.setPrivateAnnotation(P,"index",i);_.setPrivateAnnotation(P,"parent",p);return P;},extractSubtotals:function(A,g,C,E){var l=g["@$ui5.node.level"];Object.keys(A.aggregate).forEach(function(f){var D=A.aggregate[f],i,u=D.unit;if(!D.subtotals){return;}C[f]=g[f];if(E){E[f]=null;}if(u){C[u]=g[u];if(E){i=A.groupLevels.indexOf(u);if(i<0||i>=l){E[u]=null;}}}});},filterOrderby:function(q,A,l){var f=c.getFilteredOrderby(q.$orderby,A,l);q=Object.assign({},q);if(f){q.$orderby=f;}else{delete q.$orderby;}return q;},getAllProperties:function(A){var f=Object.keys(A.aggregate),g=Object.keys(A.group),h=f.concat(g);f.forEach(function(i){var u=A.aggregate[i].unit;if(u){h.push(u);}});g.forEach(function(G){var i=A.group[G].additionally;if(i){i.forEach(function(j){h.push(j.includes("/")?j.split("/"):j);});}});return h;},getFilteredOrderby:function(o,A,l){var i=!l||l>A.groupLevels.length;function f(n){return Object.keys(A.aggregate).some(function(j){var D=A.aggregate[j];return D.subtotals&&n===D.unit;});}function g(n){if(n in A.group&&(!l||!A.groupLevels.includes(n))){return true;}return Object.keys(A.aggregate).some(function(j){return n===A.aggregate[j].unit;})||Object.keys(A.group).some(function(G){return(!l||!A.groupLevels.includes(G))&&h(n,G);});}function h(n,G){return n===G||A.group[G].additionally&&A.group[G].additionally.includes(n);}if(o){return o.split(r).filter(function(O){var m=b.exec(O),n;if(m){n=m[1];return n in A.aggregate&&(i||A.aggregate[n].subtotals)||i&&g(n)||!i&&(h(n,A.groupLevels[l-1])||f(n));}return true;}).join(",");}},getOrCreateExpandedObject:function(A,g){var C,E=_.getPrivateAnnotation(g,"expanded");if(!E){C={"@$ui5.node.isExpanded":false};_.setPrivateAnnotation(g,"collapsed",C);E={"@$ui5.node.isExpanded":true};_.setPrivateAnnotation(g,"expanded",E);if(A.subtotalsAtBottomOnly!==undefined){c.extractSubtotals(A,g,C,A.subtotalsAtBottomOnly?E:null);}}return E;},hasGrandTotal:function(A){return A&&Object.keys(A).some(function(f){return A[f].grandTotal;});},hasMinOrMax:function(A){return A&&Object.keys(A).some(function(f){var D=A[f];return D.min||D.max;});},isAffected:function(A,f,S){function g(i,p){if(i.endsWith("/*")){i=i.slice(0,-2);}return _.hasPathPrefix(p,i)||_.hasPathPrefix(i,p);}function h(i,j){return j.some(function(o){return o.aFilters?h(i,o.aFilters):g(i,o.sPath);});}return S.some(function(i){var j=g.bind(null,i);return i===""||i==="*"||Object.keys(A.aggregate).some(function(k){var D=A.aggregate[k];return g(i,D.name||k);})||Object.keys(A.group).some(j)||A.groupLevels.some(j)||h(i,f);});},removeUI5grand__:function(g){Object.keys(g).forEach(function(k){if(k.startsWith("UI5grand__")){g[k.slice(10)]=g[k];delete g[k];}});},setAnnotations:function(E,i,I,l,A){_.setAnnotation(E,"@$ui5.node.isExpanded",i);_.setAnnotation(E,"@$ui5.node.isTotal",I);E["@$ui5.node.level"]=l;if(A){A.forEach(function(p){if(Array.isArray(p)){_.createMissing(E,p);}else if(!(p in E)){E[p]=null;}});}},splitFilter:function(f,A){var g=[],h=[];function i(f){return f.aFilters?f.aFilters.some(i):f.sPath in A.aggregate;}function j(f){if(f.aFilters&&f.bAnd){f.aFilters.forEach(j);}else{(i(f)?g:h).push(f);}}function w(k){return k.length>1?new F(k,true):k[0];}if(!A||!A.aggregate){return[f];}j(f);return[w(g),w(h)];},validateAggregation:function(A,p,f,g){if(A.hierarchyQualifier&&!g){throw new Error("Missing parameter autoExpandSelect at model");}c.checkTypeof(A,A.hierarchyQualifier?R:d,"$$aggregation");A.$fetchMetadata=f;A.$path=p;}};return c;},false);
