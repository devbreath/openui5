/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/util/each","sap/base/util/merge","sap/base/util/ObjectPath","sap/base/Log","sap/ui/core/Component","sap/ui/fl/apply/_internal/flexState/appDescriptorChanges/prepareAppDescriptorMap","sap/ui/fl/apply/_internal/flexState/changes/prepareChangesMap","sap/ui/fl/apply/_internal/flexState/compVariants/prepareCompVariantsMap","sap/ui/fl/apply/_internal/flexState/controlVariants/prepareVariantsMap","sap/ui/fl/apply/_internal/flexState/Loader","sap/ui/fl/apply/_internal/flexState/ManifestUtils","sap/ui/fl/initial/_internal/StorageUtils","sap/ui/fl/LayerUtils","sap/ui/fl/Utils","sap/ui/fl/write/_internal/FlexInfoSession"],function(_,e,m,O,L,C,p,a,b,c,d,M,S,f,U,F){"use strict";var g={};var h={};var i={};var j={};var k;var l;var n;var o={appDescriptorChanges:{prepareFunction:p,pathInResponse:[]},changes:{prepareFunction:a,pathInResponse:["changes"]},variants:{prepareFunction:c,pathInResponse:["variants","variantChanges","variantDependentControlChanges","variantManagementChanges"]},compVariants:{prepareFunction:b,pathInResponse:["comp.variants","comp.standardVariants","comp.defaultVariants","comp.changes"]}};var q={compVariants:{},variants:{}};function r(P){var N=C.get(P.componentId);P.componentData=P.componentData||N.getComponentData()||{};P.manifest=P.manifest||P.rawManifest||N.getManifestObject();P.reference=P.reference||M.getFlexReference(P);}function s(R,N){if(!h[R]){throw new Error("State is not yet initialized");}if(!h[R].preparedMaps[N]){if(!h[R].storageResponse){h[R].storageResponse=y(h[R].unfilteredStorageResponse);}var P={unfilteredStorageResponse:h[R].unfilteredStorageResponse,storageResponse:h[R].storageResponse,componentId:h[R].componentId,componentData:h[R].componentData,reference:R};h[R].preparedMaps[N]=g.callPrepareFunction(N,P);}return h[R].preparedMaps[N];}function t(R){return s(R,"appDescriptorChanges");}function u(R){return s(R,"changes");}function v(R){return s(R,"variants");}function w(R){return s(R,"compVariants");}function x(P){if(P.reference.endsWith(".Component")){var N=P.reference.split(".");N.pop();var R=N.join(".");h[R]=m({},{storageResponse:{changes:S.getEmptyFlexDataResponse()},unfilteredStorageResponse:{changes:S.getEmptyFlexDataResponse()},preparedMaps:{},componentId:P.componentId,partialFlexState:P.partialFlexState});j[R]=j[P.reference];}}function y(R){var N=m({},R);var P=N.changes;var Q=J("URLParsing");if(f.isLayerFilteringRequired(Q)){e(o,function(T,V){V.pathInResponse.forEach(function(W){O.set(W,f.filterChangeDefinitionsByMaxLayer(O.get(W,P),Q),P);});});}return N;}function z(P){j[P.reference]=d.loadFlexData(P).then(function(R){h[P.reference]=m({},{unfilteredStorageResponse:R,preparedMaps:{},componentId:P.componentId,componentData:P.componentData,partialFlexState:P.partialFlexState});x(P);B(P.reference);A(P.reference,R);return R;});return j[P.reference];}function A(R,N){var P=N&&N.changes||{};if(P.info!==undefined){var Q=F.getByReference(R);if(Q===null){Q={};}Q.allContextsProvided=P.info.allContextsProvided;F.setByReference(Q,R);}}function B(R){var N=J("ShellNavigation");if(N&&!i[R]){i[R]=E.bind(null,R);N.registerNavigationFilter(i[R]);}}function D(R){var N=J("ShellNavigation");if(N){if(i[R]){N.unregisterNavigationFilter(i[R]);delete i[R];}}}function E(R,N,P){var Q=J("ShellNavigation");if(Q){try{var T=f.getMaxLayerTechnicalParameter(N,J("URLParsing"));var V=f.getMaxLayerTechnicalParameter(P,J("URLParsing"));if(T!==V){g.clearFilteredResponse(R);}}catch(W){L.error(W.message);}return Q.NavigationFilterStatus.Continue;}return undefined;}function G(N){var P=h[N.reference];if(P.partialFlexState===true&&N.partialFlexState!==true){P.partialFlexState=false;N.partialFlexData=m({},P.unfilteredStorageResponse.changes);N.reInitialize=true;}return N;}function H(N){var P=h[N.reference].componentId;if(!N.reInitialize&&P!==N.componentId){N.reInitialize=true;}return N;}function I(){return Promise.all([U.getUShellService("ShellNavigation"),U.getUShellService("URLParsing")]).then(function(N){k=N[0];l=N[1];}).catch(function(N){L.error("Error getting service from Unified Shell: "+N.message);});}function J(N){if(U.getUshellContainer()){if(N==="ShellNavigation"){return k;}else if(N==="URLParsing"){return l;}}return undefined;}function K(){return Promise.all([U.requireAsync("sap/ui/fl/ChangePersistenceFactory")]).then(function(N){n=N[0];}).catch(function(N){L.error("Error loading modules: "+N.message);});}g.initialize=function(P){return Promise.all([I(),K()]).then(function(){r(P);var N=P.reference;if(j[N]){return j[N].then(G.bind(null,P)).then(H).then(function(Q){return Q.reInitialize?z(Q):h[N].unfilteredStorageResponse;});}return z(P);}).then(function(P){if(!h[P.reference].componentData){var N=C.get(P.componentId);h[P.reference].componentData=N?N.getComponentData():P.componentData;}}.bind(null,P));};g.clearAndInitialize=function(P){r(P);g.clearState(P.reference);g.clearState(U.normalizeReference(P.reference));return g.initialize(P);};g.clearState=function(R){if(R){D(R);delete h[R];delete j[R];if(n&&(n._instanceCache||{}).hasOwnProperty(R)){n._instanceCache[R].removeDirtyChanges();}}else{Object.keys(h).forEach(function(R){D(R);});h={};j={};}};g.setInitialNonFlCompVariantData=function(R,P,N,V){q.compVariants[R]=q.compVariants[R]||{};q.compVariants[R][P]={};q.compVariants[R][P].standardVariant=N;q.compVariants[R][P].variants=V;};g.getInitialNonFlCompVariantData=function(R){return q.compVariants[R];};g.setFakeStandardVariant=function(R,N,P){var V=g.getVariantsState(R);if(!V[Object.keys(P)[0]]){m(V,P);q.variants[R]=q.variants[R]||{};q.variants[R][N]=q.variants[R][N]||{};m(q.variants[R][N],P);}};g.resetFakedStandardVariants=function(R,N){if(q.variants[R]){delete q.variants[R][N];}};g.clearFilteredResponse=function(R){if(h[R]){h[R].preparedMaps={};delete h[R].storageResponse;}};g.getUIChanges=function(R){return u(R).changes;};g.getAppDescriptorChanges=function(R){return t(R).appDescriptorChanges;};g.getVariantsState=function(R){var V=v(R);if(q.variants[R]){e(q.variants[R],function(N,P){if(h[R].componentId===N){e(P,function(Q,T){if(!V[Q]){V[Q]=T;}});}});}return V;};g.getUI2Personalization=function(R){return h[R].unfilteredStorageResponse.changes.ui2personalization;};g.getCompVariantsMap=function(R){return w(R);};g.callPrepareFunction=function(N,P){return o[N].prepareFunction(P);};g.getStorageResponse=function(R){if(j[R]){return j[R].then(function(){return h[R].unfilteredStorageResponse;});}return Promise.resolve();};g.getFlexObjectsFromStorageResponse=function(R){return h[R]&&h[R].unfilteredStorageResponse.changes;};return g;});
