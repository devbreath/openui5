/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/each","sap/base/util/includes","sap/base/util/isEmptyObject","sap/base/util/merge","sap/base/util/ObjectPath","sap/base/util/values","sap/base/Log","sap/ui/fl/apply/_internal/controlVariants/Utils","sap/ui/fl/apply/_internal/flexObjects/FlexObjectFactory","sap/ui/fl/Change","sap/ui/fl/LayerUtils"],function(e,i,a,m,O,v,L,V,F,C,b){"use strict";function c(x,y){var z=m({},x);y.forEach(function(A){z[A.fileName]={instance:F.createFromFileContent(A),controlChanges:[],variantChanges:{}};});return z;}function d(x,y,R){var z=m({},x);y.forEach(function(A){var B=new C(A);B.setState(C.states.PERSISTED);var D=z[A.variantReference];D=D||s(A.variantReference,R);D.controlChanges.push(B);z[A.variantReference]=D;});return z;}function f(x,y,R){var z=m({},x);y.forEach(function(A){var B=z[A.selector.id];B=B||s(A.selector.id,R);var D=B.variantChanges[A.changeType]||[];D.push(A);B.variantChanges[A.changeType]=D;z[A.selector.id]=B;});return z;}function g(x){var y=m({},x);v(x).forEach(function(z){var S=O.get("variantChanges.setVisible",z);if(S&&S.length>0){var A=w(S);if(!A.getContent().visible&&A.getContent().createdByReset){delete y[z.instance.getId()];}}});return y;}function r(x,R){var y=m({},x);v(y).forEach(function(z){var A=z.instance.getVariantReference();var B;if(A){B=j(y,A,z.instance.getVariantManagementReference(),R);}z.controlChanges=h(B,z.instance.getLayer()).concat(z.controlChanges);});return y;}function h(R,x){if(!R){return[];}return v(m({},R.controlChanges)).filter(function(y){return b.compareAgainstCurrentLayer(y.getLayer(),x)===-1;});}function j(x,y,z,R){var A=x[y];if(!A&&y===z){A=s(y,R);x[y]=A;}return A;}function k(S,R){var x={};x=c(x,S.variants);x=d(x,S.variantDependentControlChanges,R);x=f(x,S.variantChanges,R);x=g(x);x=r(x,R);return x;}function l(){return{variantManagementChanges:{},variants:[]};}function n(R,x,T){var y=m({},R);v(x).forEach(function(z){var A=z.instance.getVariantManagementReference();if(!y[A]){y[A]=l();}z=u(z);if(!y[A].currentVariant&&z.instance.getVisible()&&i(T,z.instance.getId())){y[A].currentVariant=z.instance.getId();}y[A].defaultVariant=A;var S=V.getIndexToSortVariant(y[A].variants,z);y[A].variants.splice(S,0,z);});return y;}function o(R,x){var y=m({},R);x.forEach(function(z){var A=z.selector.id;if(!y[A]){y[A]=l();}var B=z.changeType;if(!y[A].variantManagementChanges[B]){y[A].variantManagementChanges[B]=[];}y[A].variantManagementChanges[B].push(z);y[A]=t(y[A]);});return y;}function p(R,x){var y=m({},R);e(y,function(z,A){var S=A.variants.findIndex(function(D){return D.instance.getId()===z;});var B;if(S===-1){B=s(z,x);}else{B=A.variants[S];A.variants.splice(S,1);}A.variants.unshift(B);});return y;}function q(x,y,T,R){var z={};z=n(z,x,T);z=o(z,y);z=p(z,R);return z;}function s(x,R){var y=sap.ui.getCore().getLibraryResourceBundle("sap.ui.fl");return{instance:F.createFlVariant({id:x,variantManagementReference:x,variantName:y.getText("STANDARD_VARIANT_TITLE"),user:V.DEFAULT_AUTHOR,reference:R}),variantChanges:{},controlChanges:[]};}function t(x){var y=m({},x);var z=y.variantManagementChanges;var A;if(!a(z)){A=w(z["setDefault"]);if(A){y.defaultVariant=A.getContent().defaultVariant;}}return y;}function u(x){var y=m({},x);var z=y.variantChanges;var A;e(z,function(B,D){switch(B){case"setTitle":A=w(D);if(A){y.instance.setName(A.getText("title"),true);}break;case"setFavorite":A=w(D);if(A){y.instance.setFavorite(A.getContent().favorite);}break;case"setExecuteOnSelect":A=w(D);if(A){y.instance.setExecuteOnSelection(A.getContent().executeOnSelect);}break;case"setVisible":A=w(D);if(A){y.instance.setVisible(A.getContent().visible);}break;case"setContexts":A=w(D);if(A){y.instance.setContexts(A.getContent().contexts);}break;default:L.error("No valid changes on variant "+y.content.content.title+" available");}});return y;}function w(x){if(x.length>0){return new C(x[x.length-1]);}return false;}return function(P){if(a(P)||!O.get("storageResponse.changes.variants",P)){return{};}var T=O.get(["technicalParameters",V.VARIANT_TECHNICAL_PARAMETER],P.componentData)||[];var x=k(P.storageResponse.changes,P.reference);x=q(x,P.storageResponse.changes.variantManagementChanges,T,P.reference);return x;};});
