/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/util/restricted/_pick","sap/base/util/includes","sap/base/util/isEmptyObject","sap/base/util/ObjectPath","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/fl/apply/_internal/controlVariants/Utils","sap/ui/fl/apply/_internal/flexObjects/States","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/Change","sap/ui/fl/LayerUtils","sap/ui/fl/Utils"],function(_,a,i,b,O,L,J,V,S,F,C,c,U){"use strict";var d={};var u={};function g(p){var r=[];if(p.variantData.instance.getVariantReference()){r=d.getControlChangesForVariant(Object.assign(p,{vReference:p.variantData.instance.getVariantReference()}));return r.filter(function(R){return c.compareAgainstCurrentLayer(R.getLayer(),p.variantData.instance.getLayer())===-1;});}return r;}function e(p){var v=d.getContent(p.reference);var l=O.get([p.vmReference,"variants"],v);return l||[];}function f(v,o,A){var s=o.changeType;if(!v){v={};}if(!v[s]){v[s]=[];}if(A){v[s].push(o);return true;}return v[s].some(function(E,I){if(E.fileName===o.fileName){v[s].splice(I,1);return true;}});}function h(o,l){var s=k(o);l[s].push(o);}function j(o,l){var s=k(o);var m=-1;l[s].some(function(E,I){if(E.fileName===o.fileName){m=I;return true;}});if(m>-1){l[s].splice(m,1);}}function k(o){switch(o.fileType){case"change":return"variantDependentControlChanges";case"ctrl_variant":return"variants";case"ctrl_variant_change":return"variantChanges";case"ctrl_variant_management_change":return"variantManagementChanges";default:}}d.addUpdateStateListener=function(r,l){u[r]=l;};d.removeUpdateStateListener=function(r){delete u[r];};d.getContent=function(r){return F.getVariantsState(r);};d.addFakeStandardVariant=function(r,s,o){F.setFakeStandardVariant(r,s,o);};d.clearFakedStandardVariants=function(r,s){F.resetFakedStandardVariants(r,s);};d.getControlChangesForVariant=function(p){var r=[];var v=d.getVariant(p);if(v){r=v.controlChanges.filter(function(o){return(p.includeDirtyChanges!==false||o.getState()===C.states.PERSISTED);});}return r;};d.getVariantChangesForVariant=function(p){var v=d.getVariant(p);return v&&v.variantChanges||{};};d.getVariant=function(p){var v;var o=d.getContent(p.reference);p.vReference=p.vReference||o[p.vmReference].defaultVariant;var l=e(p);l.some(function(m){if(m.instance.getId()===p.vReference){v=m;return true;}});return v;};d.getCurrentVariantReference=function(p){var v=d.getContent(p.reference);var o=v[p.vmReference];return o.currentVariant||o.defaultVariant;};d.getVariantManagementReferences=function(r){var v=d.getContent(r);return Object.keys(v);};d.addVariantToVariantManagement=function(p){var v=d.getContent(p.reference);var l=v[p.vmReference].variants.slice().splice(1);var I=V.getIndexToSortVariant(l,p.variantData);if(p.variantData.instance.getVariantReference()){var r=g(p);p.variantData.controlChanges=r.concat(p.variantData.controlChanges);}v[p.vmReference].variants.splice(I+1,0,p.variantData);return I+1;};d.removeVariantFromVariantManagement=function(p){var I;var v=d.getContent(p.reference);var l=v[p.vmReference].variants.some(function(o,m){if(o.instance.getId()===p.variant.getId()){I=m;return true;}});if(l){v[p.vmReference].variants.splice(I,1);}return I;};d.setVariantData=function(p){var v=d.getContent(p.reference);var l=v[p.vmReference].variants;var o=l[p.previousIndex];if(o.instance.getId()!==p.vmReference){l.splice(p.previousIndex,1);var s=V.getIndexToSortVariant(l.slice(1),o);l.splice(s+1,0,o);return s+1;}l.splice(p.previousIndex,1,o);return p.previousIndex;};d.addChangeToVariant=function(p){var E=d.getControlChangesForVariant(p);var l=E.map(function(o){return o.getDefinition().fileName;});if(!i(l,p.change.getDefinition().fileName)){var v=d.getVariant(p);v.controlChanges=E.concat([p.change]);return true;}return false;};d.removeChangeFromVariant=function(p){var l=d.getControlChangesForVariant(p);var v=d.getVariant(p);var m=false;if(v){v.controlChanges=l.filter(function(o){if(!m&&o.getId()===p.change.getId()){m=true;return false;}return true;});}return m;};d.getInitialChanges=function(p){var v=d.getContent(p.reference);return Object.keys(v).reduce(function(I,s){if((p.vmReference&&p.vmReference===s)||!p.vmReference){var l=v[s].currentVariant?"currentVariant":"defaultVariant";var A=Object.assign({},p,{vmReference:s,vReference:v[s][l],includeDirtyChanges:false});return I.concat(d.getControlChangesForVariant(A));}return I;},[]);};d.fillVariantModel=function(p){var v=d.getContent(p.reference);return Object.keys(v).reduce(function(o,s){o[s]={defaultVariant:v[s].defaultVariant,variants:[]};if(v[s].currentVariant){o[s].currentVariant=v[s].currentVariant;}e(Object.assign(p,{vmReference:s})).forEach(function(l,m){var n=l.instance;o[s].variants[m]=JSON.parse(JSON.stringify({key:n.getId(),title:n.getName(),layer:n.getLayer(),favorite:n.getFavorite(),executeOnSelect:n.getExecuteOnSelection(),visible:n.getVisible(),author:n.getSupportInformation().user,contexts:n.getContexts()}));});return o;},{});};d.updateChangesForVariantManagementInMap=function(p){var v=d.getContent(p.reference);var o=v[p.vmReference];if(p.changeContent.fileType==="ctrl_variant_change"){o.variants.some(function(l){if(l.instance.getId()===p.changeContent.selector.id){f(l.variantChanges,p.changeContent,p.add);}});}else if(p.changeContent.fileType==="ctrl_variant_management_change"){f(o.variantManagementChanges,p.changeContent,p.add);}};d.setCurrentVariant=function(p){var v=d.getContent(p.reference);if(O.get([p.vmReference],v)){v[p.vmReference].currentVariant=p.newVReference;}};d.updateVariantsState=function(p){var v=d.getContent(p.reference);if(b(v)){L.error("Variant state is not initialized yet");return;}var o=F.getFlexObjectsFromStorageResponse(p.reference);if(p.changeToBeAddedOrDeleted){switch(p.changeToBeAddedOrDeleted.getState()){case S.NEW:h(p.changeToBeAddedOrDeleted.convertToFileContent(),o);break;case S.DELETE:j(p.changeToBeAddedOrDeleted.convertToFileContent(),o);break;default:}if(u[p.reference]){u[p.reference]();}}};d.waitForInitialVariantChanges=function(p){var l=d.getInitialChanges({vmReference:p.vmReference,reference:p.reference});var m=l.reduce(function(n,o){var s=o.getSelector();var q=J.bySelector(s,p.appComponent);if(q&&U.indexOfObject(n,{selector:q})===-1){n.push({selector:q});}return n;},[]);return m.length?p.flexController.waitForChangesToBeApplied(m):Promise.resolve();};return d;});
