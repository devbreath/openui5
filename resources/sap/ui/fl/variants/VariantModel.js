/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/util/restricted/_isEqual","sap/base/util/each","sap/base/util/includes","sap/base/util/isEmptyObject","sap/base/util/merge","sap/base/util/ObjectPath","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/BusyIndicator","sap/ui/fl/apply/_internal/changes/Reverter","sap/ui/fl/apply/_internal/controlVariants/URLHandler","sap/ui/fl/apply/_internal/flexObjects/FlexObjectFactory","sap/ui/fl/apply/_internal/flexState/controlVariants/Switcher","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagementState","sap/ui/fl/apply/_internal/controlVariants/Utils","sap/ui/fl/Change","sap/ui/fl/Layer","sap/ui/fl/LayerUtils","sap/ui/fl/Utils","sap/ui/fl/registry/Settings","sap/ui/model/json/JSONModel"],function(_,a,e,i,b,m,O,L,J,B,R,U,F,S,V,c,C,d,f,g,h,j){"use strict";var k={};function l(E,P){return p(function(A,D){var M=D.model;var G=D.vmReference;var H=false;var T=A.key;var I=A.key;return Promise.resolve().then(function(){if(O.get([G,"currentVariant"],M.oData)&&M.oData[G].currentVariant!==M.oData[G].originalCurrentVariant){I=M.oData[G].originalCurrentVariant;H=true;return M.updateCurrentVariant({variantManagementReference:G,newVariantReference:T,appComponent:M.oAppComponent,internallyCalled:true});}}).then(function(){if(O.get([G,"modified"],M.oData)===true){var K=V.getControlChangesForVariant({reference:M.sFlexReference,vmReference:G,vReference:I});return n({changes:K,vmReference:G,vReference:I,revert:!H,model:M}).then(function(){M.oData[G].originalCurrentVariant=T;M.oData[G].modified=false;M.checkUpdate(true);});}}).then(function(){if(!H){M._callVariantSwitchListeners(G,M.oData[G].currentVariant);}});}.bind(null,E.getParameters(),P),P.model,P.vmReference);}function n(P){var A=P.model._getDirtyChangesFromVariantChanges(P.changes);A=A.reverse();return Promise.resolve().then(function(){if(P.revert){return R.revertMultipleChanges(A,{appComponent:P.model.oAppComponent,modifier:J,flexController:P.model.oFlexController});}}).then(function(){A.forEach(function(D){V.removeChangeFromVariant({reference:P.model.sFlexReference,change:D,vmReference:P.vmReference,vReference:P.vReference});P.model.oFlexController.deleteChange(D,P.model.oAppComponent);});});}function o(M,A,D){if(D||M.oData[A]){M.oData[A].variantBusy=D;}M.checkUpdate();}function p(A,M,D){M._oVariantSwitchPromise=M._oVariantSwitchPromise.catch(function(){}).then(o.bind(null,M,D,true)).then(A).then(o.bind(null,M,D,false)).catch(function(E){o(M,D,false);throw E;});M.oFlexController.setVariantSwitchPromise(M._oVariantSwitchPromise);return M._oVariantSwitchPromise;}function s(A,D){k[A]=D;}function q(P,A){return S.switchVariant(P).then(function(){this.oData[P.vmReference].originalCurrentVariant=P.newVReference;this.oData[P.vmReference].currentVariant=P.newVReference;if(this.oData[P.vmReference].updateVariantInURL){U.updateVariantInURL({vmReference:P.vmReference,newVReference:P.newVReference,model:this});}this._callVariantSwitchListeners(P.vmReference,P.newVReference,undefined,A);this.checkUpdate();}.bind(this));}function u(A){h.getInstance().then(function(D){if(!D.isVariantPersonalizationEnabled()){A.remove=false;A.rename=false;A.change=false;}});}function r(A,D,E){var G=E?f.getCurrentLayer():d.USER;if((A.layer===G)&&(A.key!==D)){return true;}return false;}function w(A){return new Promise(function(D){if(A.getDomRef()){D();}else{A.addEventDelegate({onAfterRendering:function(){D();}});}});}var t=j.extend("sap.ui.fl.variants.VariantModel",{constructor:function(D,P){this.pSequentialImportCompleted=Promise.resolve();j.apply(this,[D]);this.sharing={PRIVATE:"private",PUBLIC:"public"};this.oFlexController=P.flexController;this.oChangePersistence=this.oFlexController._oChangePersistence;this.sFlexReference=this.oChangePersistence.getComponentName();this.oAppComponent=P.appComponent;this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.fl");this._oVariantSwitchPromise=Promise.resolve();this._oVariantAppliedListeners={};if(b(D)){try{D=V.fillVariantModel({reference:this.sFlexReference});}catch(E){L.error("Variants Map was not found: "+E.message);}}if(D&&typeof D==="object"){Object.keys(D).forEach(function(K){D[K].variants.forEach(function(A){if(!D[K].currentVariant&&(A.key===D[K].defaultVariant)){D[K].currentVariant=A.key;}A.originalTitle=A.title;A.originalFavorite=A.favorite;A.originalExecuteOnSelect=A.executeOnSelect;A.originalVisible=A.visible;A.originalContexts=A.contexts;});D[K].originalCurrentVariant=D[K].currentVariant;D[K].originalDefaultVariant=D[K].defaultVariant;});this.setData(D);}V.addUpdateStateListener(this.sFlexReference,v.bind(this));}});function v(){this.checkDirtyStateForControlModels(Object.keys(this.oData||{}));}t.prototype.initialize=function(){return Promise.resolve().then(function(){var A=g.getUshellContainer();if(A){var D=[g.getUShellService("UserInfo"),g.getUShellService("URLParsing"),g.getUShellService("CrossApplicationNavigation"),g.getUShellService("ShellNavigation")];return Promise.all(D).then(function(E){s("UserInfo",E[0]);s("URLParsing",E[1]);s("CrossApplicationNavigation",E[2]);s("ShellNavigation",E[3]);}).catch(function(E){throw new Error("Error getting service from Unified Shell: "+E);});}return undefined;}).then(function(){U.initialize({model:this});}.bind(this));};t.prototype.updateCurrentVariant=function(P){var A={vmReference:P.variantManagementReference,currentVReference:this.oData[P.variantManagementReference].originalCurrentVariant,newVReference:P.newVariantReference,flexController:this.oFlexController,appComponent:P.appComponent||this.oAppComponent,modifier:J,reference:this.sFlexReference};if(P.internallyCalled){return q.call(this,A,P.scenario);}return p(q.bind(this,A,P.scenario),this,P.variantManagementReference);};t.prototype.getCurrentVariantReference=function(A){return this.oData[A].currentVariant;};t.prototype.getVariantManagementReference=function(A){var D="";var I=-1;Object.keys(this.oData).some(function(K){return this.oData[K].variants.some(function(E,G){if(E.key===A){D=K;I=G;return true;}});}.bind(this));return{variantManagementReference:D,variantIndex:I};};t.prototype.getVariant=function(A,D){return V.getVariant({reference:this.sFlexReference,vmReference:D||this.getVariantManagementReference(A).variantManagementReference,vReference:A});};t.prototype.getVariantTitle=function(A,D){var T="";this.oData[D].variants.some(function(E){if(E.key===A){T=E.title;return true;}});return T;};function x(A,D){var E=V.getVariantChangesForVariant({vmReference:A,reference:this.sFlexReference});var G=this.oData[A].currentVariant;var H=this.oData[A].defaultVariant;if(D.getExecuteOnSelectionForStandardDefault()&&G===H&&G===A&&!E.setExecuteOnSelect){var I=V.getVariant({reference:this.sFlexReference,vmReference:A,vReference:A});I.instance.setExecuteOnSelection(true);this.oData[A].variants[0].originalExecuteOnSelect=true;this.oData[A].variants[0].executeOnSelect=true;return true;}return false;}t.prototype.attachVariantApplied=function(P){var A=sap.ui.getCore().byId(P.vmControlId);var D=this.getVariantManagementReferenceForControl(A);return this.waitForVMControlInit(D).then(function(D,P){if(!this._oVariantAppliedListeners[D]){this._oVariantAppliedListeners[D]={};}var I=x.call(this,D,A);if(P.callAfterInitialVariant||I){var E={appComponent:this.oAppComponent,reference:this.sFlexReference,vmReference:D,flexController:this.oFlexController};V.waitForInitialVariantChanges(E).then(function(){var G=V.getCurrentVariantReference({vmReference:D,reference:this.sFlexReference});this._callVariantSwitchListeners(D,G,P.callback);}.bind(this));}return w(P.control).then(function(){if(c.getRelevantVariantManagementControlId(P.control,this.getVariantManagementControlIds())===P.vmControlId){this.oData[D].showExecuteOnSelection=true;this.checkUpdate(true);this._oVariantAppliedListeners[D][P.control.getId()]=P.callback;}else{L.error("Error in attachVariantApplied: The passed VariantManagement ID does not match the responsible VariantManagement control");}}.bind(this));}.bind(this,D,P));};t.prototype._callVariantSwitchListeners=function(A,N,D,E){if(this._oVariantAppliedListeners[A]){var G;this.oData[A].variants.some(function(H){if(H.key===N){G=m({},H);return true;}});if(E){G.createScenario=E;}if(D){D(G);}else{e(this._oVariantAppliedListeners[A],function(H,D){D(G);});}}};t.prototype.detachVariantApplied=function(A,D){var E=this.getVariantManagementReferenceForControl(sap.ui.getCore().byId(A));if(this._oVariantAppliedListeners[E]){delete this._oVariantAppliedListeners[E][D];}};t.prototype.addChange=function(A){var D=A.getVariantReference();var E=this.getVariantManagementReference(D).variantManagementReference;if(A.getState()===C.states.NEW){this.oData[E].modified=true;}this.checkUpdate(true);return V.addChangeToVariant({reference:this.sFlexReference,change:A,vmReference:E,vReference:D});};t.prototype.removeChange=function(A){var D=A.getVariantReference();var E=this.getVariantManagementReference(D).variantManagementReference;var G=V.removeChangeFromVariant({reference:this.sFlexReference,change:A,vmReference:E,vReference:D});this.checkDirtyStateForControlModels([E]);return G;};t.prototype._getVariantTitleCount=function(N,A){var D=this.getData();return D[A].variants.reduce(function(E,G){if(N.toLowerCase()===G.title.toLowerCase()&&G.visible){E++;}return E;},0);};function y(A,P){var D={id:P.newVariantReference,variantName:P.title,contexts:P.contexts,layer:P.layer,reference:A.getFlexObjectMetadata().reference,generator:P.generator,variantManagementReference:P.variantManagementReference};if(P.currentVariantComparison===1){if(P.sourceVariantSource.instance.getLayer()===P.layer){D.variantReference=P.sourceVariantSource.instance.getVariantReference();}else{D.variantReference=A.getVariantReference();}}else if(P.currentVariantComparison===0){D.variantReference=A.getVariantReference();}else if(P.currentVariantComparison===-1){D.variantReference=P.sourceVariantReference;}return F.createFlVariant(D);}t.prototype._duplicateVariant=function(P){var A=P.sourceVariantReference;var D=P.variantManagementReference;var E=this.getVariant(A);var G=V.getControlChangesForVariant({vmReference:D,vReference:A,reference:this.sFlexReference}).map(function(M){return M.getDefinition();});P.currentVariantComparison=f.compareAgainstCurrentLayer(E.instance.getLayer(),P.layer);if(P.currentVariantComparison===1){P.sourceVariantSource=this.getVariant(E.instance.getVariantReference());}var H={instance:y(E.instance,P),controlChanges:G,variantChanges:{}};G=H.controlChanges.slice();var I={};var K;H.controlChanges=G.reduce(function(M,N){if(f.compareAgainstCurrentLayer(N.layer,P.layer)>=0){I=m({},N);I.layer=P.layer;I.variantReference=H.instance.getId();if(!I.support){I.support={};}I.support.sourceChangeFileName=N.fileName;I.packageName="$TMP";K=C.createInitialFileContent(I);M.push(new C(K));}return M;},[]);return H;};t.prototype.copyVariant=function(P){var D=this._duplicateVariant(P);D.generator=P.generator;var A={key:D.instance.getId(),layer:P.layer,title:D.instance.getName(),originalTitle:D.instance.getName(),originalExecuteOnSelect:D.instance.getExecuteOnSelection(),executeOnSelect:false,favorite:true,originalFavorite:true,rename:true,change:true,remove:true,visible:true,originalVisible:true,sharing:P.layer===d.USER?this.sharing.PRIVATE:this.sharing.PUBLIC,originalContexts:D.instance.getContexts(),contexts:D.instance.getContexts()};var E=[];[D.instance].concat(D.controlChanges).forEach(function(G){E.push(this.oChangePersistence.addDirtyChange(G));}.bind(this));var I=V.addVariantToVariantManagement({variantData:D,reference:this.sFlexReference,vmReference:P.variantManagementReference});this.oData[P.variantManagementReference].variants.splice(I,0,A);return this.updateCurrentVariant({variantManagementReference:P.variantManagementReference,newVariantReference:D.instance.getId(),appComponent:P.appComponent,internallyCalled:true,scenario:"saveAs"}).then(function(){return E;});};t.prototype.removeVariant=function(P){var A=this.oChangePersistence.getDirtyChanges().filter(function(D){return(D.getVariantReference&&D.getVariantReference()===P.variant.getId())||D.getId()===P.variant.getId();});return this.updateCurrentVariant({variantManagementReference:P.variantManagementReference,newVariantReference:P.sourceVariantReference,appComponent:P.component}).then(function(){var I=V.removeVariantFromVariantManagement({reference:this.sFlexReference,variant:P.variant,vmReference:P.variantManagementReference});this.oData[P.variantManagementReference].variants.splice(I,1);this.checkUpdate();A.forEach(function(D){this.oChangePersistence.deleteChange(D);}.bind(this));}.bind(this));};t.prototype.collectModelChanges=function(A,D){var E=this.getData()[A];var M=E.variants;var G=[];var P={};M.forEach(function(H){if(H.originalTitle!==H.title){P={variantReference:H.key,changeType:"setTitle",title:H.title,originalTitle:H.originalTitle,layer:D};G.push(P);}if(H.originalFavorite!==H.favorite){P={variantReference:H.key,changeType:"setFavorite",favorite:H.favorite,originalFavorite:H.originalFavorite,layer:D};G.push(P);}if(H.originalExecuteOnSelect!==H.executeOnSelect){P={variantReference:H.key,changeType:"setExecuteOnSelect",executeOnSelect:H.executeOnSelect,originalExecuteOnSelect:H.originalExecuteOnSelect,layer:D};G.push(P);}if(!H.visible&&H.originalVisible){P={variantReference:H.key,changeType:"setVisible",visible:false,layer:D};G.push(P);}if(!a(H.originalContexts,H.contexts)){P={variantReference:H.key,changeType:"setContexts",layer:D,contexts:H.contexts,originalContexts:H.originalContexts};G.push(P);}});if(E.originalDefaultVariant!==E.defaultVariant){P={variantManagementReference:A,changeType:"setDefault",defaultVariant:E.defaultVariant,originalDefaultVariant:E.originalDefaultVariant,layer:D};G.push(P);}return G;};t.prototype.manageVariants=function(A,D,E,G,H){return new Promise(function(I){A.attachEventOnce("manage",{resolve:I,variantManagementReference:D,layer:E},this.fnManageClickRta,this);A.openManagementDialog(true,G,H);}.bind(this));};t.prototype.addVariantChange=function(A,P){var D=this.setVariantProperties(A,P);var N={};var E={vmReference:A,add:true,reference:this.sFlexReference};N.changeType=P.changeType;N.layer=P.layer;N.generator=P.generator;if(P.changeType==="setDefault"){N.fileType="ctrl_variant_management_change";N.selector=J.getSelector(A,P.appComponent);}else{N.fileType="ctrl_variant_change";N.selector=J.getSelector(P.variantReference,P.appComponent);}var G=this.oFlexController.createBaseChange(N,P.appComponent);G.setContent(D);if(P.changeType==="setTitle"){G.setText("title",P.title,"XFLD");}E.changeContent=G.getDefinition();V.updateChangesForVariantManagementInMap(E);this.oChangePersistence.addDirtyChange(G);return G;};t.prototype.deleteVariantChange=function(A,P,D){var E={vmReference:A,add:false,reference:this.sFlexReference,changeContent:undefined};this.setVariantProperties(A,P,true);E.changeContent=D.getDefinition();V.updateChangesForVariantManagementInMap(E);this.oChangePersistence.deleteChange(D);};t.prototype.setVariantProperties=function(A,P,D){var E=-1;var G;var H=this.getData();var I=this.getVariant(P.variantReference,A).instance;if(P.variantReference){E=this.getVariantManagementReference(P.variantReference).variantIndex;G=H[A].variants[E];}var K={};switch(P.changeType){case"setTitle":K.title=P.title;G.title=P.title;G.originalTitle=G.title;I.setName(P.title,true);break;case"setFavorite":K.favorite=P.favorite;G.favorite=P.favorite;G.originalFavorite=G.favorite;I.setFavorite(P.favorite);break;case"setExecuteOnSelect":K.executeOnSelect=P.executeOnSelect;G.executeOnSelect=P.executeOnSelect;G.originalExecuteOnSelect=G.executeOnSelect;I.setExecuteOnSelection(P.executeOnSelect);break;case"setVisible":K.visible=P.visible;K.createdByReset=false;G.visible=P.visible;G.originalVisible=G.visible;I.setVisible(P.visible);break;case"setContexts":K.contexts=P.contexts;G.contexts=P.contexts;G.originalContexts=P.contexts;I.setContexts(P.contexts);break;case"setDefault":K.defaultVariant=P.defaultVariant;H[A].defaultVariant=P.defaultVariant;H[A].originalDefaultVariant=H[A].defaultVariant;var M=U.getStoredHashParams({model:this});if(M){if(H[A].defaultVariant!==H[A].currentVariant&&M.indexOf(H[A].currentVariant)===-1){U.update({parameters:M.concat(H[A].currentVariant),updateURL:!this._bDesignTimeMode,updateHashEntry:true,model:this});}else if(H[A].defaultVariant===H[A].currentVariant&&M.indexOf(H[A].currentVariant)>-1){M.splice(M.indexOf(H[A].currentVariant),1);U.update({parameters:M,updateURL:!this._bDesignTimeMode,updateHashEntry:true,model:this});}}if(D&&H[A].currentVariant!==P.defaultVariant){this.updateCurrentVariant({variantManagementReference:A,newVariantReference:P.defaultVariant,appComponent:P.appComponent});}break;default:break;}var N=V.getContent(this.sFlexReference);if(E>-1){var Q=V.setVariantData({variantData:K,vmReference:A,previousIndex:E,reference:this.sFlexReference});H[A].variants.splice(E,1);H[A].variants.splice(Q,0,G);}else if(N[A]){N[A].defaultVariant=P.defaultVariant;}this.setData(H);this.checkUpdate(true);return K;};t.prototype._ensureStandardVariantExists=function(A){var D=this.getData();var E=D[A]||{};var G=_(E,["initPromise"]);if(!D[A]||b(G)){D[A]=m(E,{currentVariant:A,originalCurrentVariant:A,defaultVariant:A,originalDefaultVariant:A,variants:[{key:A,title:this._oResourceBundle.getText("STANDARD_VARIANT_TITLE"),originalTitle:this._oResourceBundle.getText("STANDARD_VARIANT_ORIGINAL_TITLE"),favorite:true,originalFavorite:true,executeOnSelect:false,originalExecuteOnSelect:false,visible:true,originalVisible:true,contexts:{},originalContexts:{},author:c.DEFAULT_AUTHOR}]});this.setData(D);var H={};H[A]={defaultVariant:A,variantManagementChanges:{},variants:[{instance:F.createFlVariant({id:A,variantManagementReference:A,variantName:this._oResourceBundle.getText("STANDARD_VARIANT_TITLE"),user:c.DEFAULT_AUTHOR,reference:this.sFlexReference}),controlChanges:[],variantChanges:{}}]};try{V.addFakeStandardVariant(this.sFlexReference,this.oAppComponent.getId(),H);}catch(I){L.error("Variants Map was not found: "+I.message);}}};t.prototype.setModelPropertiesForControl=function(A,D,E){this.oData[A].modified=false;this.oData[A].showFavorites=true;var G=this._bDesignTimeMode;if(G!==D){this._bDesignTimeMode=D;if(D){U.clearAllVariantURLParameters({model:this});}else if(G){U.update({parameters:U.getStoredHashParams({model:this}),updateURL:true,updateHashEntry:false,model:this});}}if(!(typeof this.fnManageClick==="function"&&typeof this.fnManageClickRta==="function")){this._initializeManageVariantsEvents();}E.detachManage(this.fnManageClick,this);if(D&&this.oData[A]._isEditable){this.oData[A].variantsEditable=false;this.oData[A].variants.forEach(function(H){H.rename=true;H.change=true;H.sharing=this.sharing.PUBLIC;H.remove=r(H,A,D);}.bind(this));}else if(this.oData[A]._isEditable){E.attachManage({variantManagementReference:A},this.fnManageClick,this);this.oData[A].variantsEditable=true;this.oData[A].variants.forEach(function(H){H.remove=r(H,A,D);switch(H.layer){case d.USER:H.rename=true;H.change=true;H.sharing=this.sharing.PRIVATE;u(H);break;case d.PUBLIC:var I=this._oUserInfoService&&this._oUserInfoService.getUser();var K=!I||I.getId().toUpperCase()===H.author.toUpperCase()||h.getInstanceOrUndef().isKeyUser();H.remove=K;H.rename=K;H.change=K;H.sharing=this.sharing.PUBLIC;break;default:H.rename=false;H.change=false;H.sharing=this.sharing.PUBLIC;}}.bind(this));}else{this.oData[A].variantsEditable=false;this.oData[A].variants.forEach(function(H){H.remove=false;H.rename=false;H.change=false;});}};t.prototype._initializeManageVariantsEvents=function(){this.fnManageClickRta=function(E,D){var A=this.collectModelChanges(D.variantManagementReference,D.layer);D.resolve(A);};this.fnManageClick=function(E,D){if(!this.oFlexController||!V.getContent(this.sFlexReference)){return;}var A=this.collectModelChanges(D.variantManagementReference,d.USER);var G=[];A.forEach(function(H){H.appComponent=this.oAppComponent;G.push(this.addVariantChange(D.variantManagementReference,H));}.bind(this));this.oChangePersistence.saveDirtyChanges(this.oAppComponent,false,G);};};function z(A,D,E,G){if(!this._bDesignTimeMode){return A.saveSequenceOfDirtyChanges(D,G).then(function(H){if(H){var I=H.response[0];this.oData[E].variants.forEach(function(K){if(K.key===I.fileName){K.author=I.support.user;}});}}.bind(this));}return Promise.resolve();}t.prototype._handleSaveEvent=function(E){if(!this._bDesignTimeMode){var A=E.getSource();var P=E.getParameters();return this._handleSave(A,P);}return Promise.resolve();};t.prototype._handleSave=function(A,P){var D=g.getAppComponentForControl(A);var E=this.getLocalId(A.getId(),D);var N;return p(function(G,D,P){var H=P.def;var I=P.execute;var K=this.getCurrentVariantReference(G);var M=V.getControlChangesForVariant({reference:this.sFlexReference,vmReference:G,vReference:K});if(P.overwrite){return this.oFlexController.saveSequenceOfDirtyChanges(this._getDirtyChangesFromVariantChanges(M),D);}var Q=P.layer||(P.public?d.PUBLIC:d.USER);var T=P.layer||d.USER;var W=P.newVariantReference||g.createDefaultFileName();var X={variantManagementReference:G,appComponent:D,layer:Q,title:P.name,contexts:P.contexts,sourceVariantReference:K,newVariantReference:W,generator:P.generator};return this.copyVariant(X).then(function(Y){if(H){var Z={changeType:"setDefault",defaultVariant:W,originalDefaultVariant:this.oData[G].defaultVariant,appComponent:D,layer:T,variantManagementReference:G};var $=this.addVariantChange(G,Z);Y.push($);}if(I){var a1={changeType:"setExecuteOnSelect",executeOnSelect:true,variantReference:W,appComponent:D,layer:T,variantManagementReference:G};var b1=this.addVariantChange(G,a1);Y.push(b1);}N=Y;return n({changes:M,vmReference:G,vReference:K,model:this}).then(z.bind(this,this.oFlexController,Y,G,D));}.bind(this));}.bind(this,E,D,P),this,E).then(function(){this.oData[E].modified=false;this.checkUpdate(true);return N;}.bind(this));};t.prototype.getLocalId=function(I,A){return J.getSelector(I,A).id;};t.prototype.getVariantManagementReferenceForControl=function(A){var D=A.getId();var E=g.getAppComponentForControl(A);return(E&&E.getLocalId(D))||D;};t.prototype.switchToDefaultForVariantManagement=function(A){if(this.oData[A].currentVariant!==this.oData[A].defaultVariant){B.show(200);this.updateCurrentVariant({variantManagementReference:A,newVariantReference:this.oData[A].defaultVariant}).then(function(){B.hide();});}};t.prototype.switchToDefaultForVariant=function(A){Object.keys(this.oData).forEach(function(D){if(!A||this.oData[D].currentVariant===A){this.switchToDefaultForVariantManagement(D);}}.bind(this));};t.prototype.registerToModel=function(A){var D=this.getVariantManagementReferenceForControl(A);this._ensureStandardVariantExists(D);this.oData[D]._isEditable=A.getEditable();this.oData[D].showExecuteOnSelection=false;A.attachEvent("select",{vmReference:D,model:this},l);A.attachSave(this._handleSaveEvent,this);this.setModelPropertiesForControl(D,false,A);var E=A.getUpdateVariantInURL();this.oData[D].updateVariantInURL=E;U.registerControl({vmReference:D,updateURL:!!E,model:this});U.handleModelContextChange({model:this,vmControl:A});if(this.oData[D].initPromise){this.oData[D].initPromise.resolveFunction();delete this.oData[D].initPromise;}this.oData[D].init=true;};t.prototype.waitForVMControlInit=function(A){if(!this.oData[A]){this.oData[A]={};}else if(this.oData[A].init){return Promise.resolve();}this.oData[A].initPromise={};this.oData[A].initPromise.promise=new Promise(function(D){this.oData[A].initPromise.resolveFunction=D;}.bind(this));return this.oData[A].initPromise.promise;};t.prototype._getDirtyChangesFromVariantChanges=function(A){var D=A.map(function(E){return E.getDefinition().fileName;});return this.oChangePersistence.getDirtyChanges().filter(function(E){return i(D,E.getId())&&!E.assignedToVariant;});};t.prototype.checkDirtyStateForControlModels=function(A){A.forEach(function(D){var E=this.oData[D];var G=this.getCurrentVariantReference(D);var H=V.getControlChangesForVariant({reference:this.sFlexReference,vmReference:D,vReference:G});var I=this._getDirtyChangesFromVariantChanges(H);E.modified=I.length>0;}.bind(this));this.checkUpdate(true);};t.prototype.getCurrentControlVariantIds=function(){return Object.keys(this.oData||{}).reduce(function(A,D){return A.concat([this.oData[D].currentVariant]);}.bind(this),[]);};t.prototype.getVariantManagementControlIds=function(){var A;return Object.keys(this.oData||{}).reduce(function(D,E){if(this.oAppComponent.byId(E)){A=this.oAppComponent.createId(E);}else{A=E;}D.push(A);return D;}.bind(this),[]);};t.prototype.destroy=function(){V.clearFakedStandardVariants(this.sFlexReference,this.oAppComponent.getId());V.removeUpdateStateListener(this.sFlexReference);j.prototype.destroy.apply(this);};t.prototype.getUShellService=function(A){return g.getUshellContainer()&&k[A];};return t;});
