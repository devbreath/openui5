/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/model/Context","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/VariantItem","sap/m/VariantManagement","sap/ui/fl/Utils","sap/ui/fl/registry/Settings","sap/ui/core/Control","sap/ui/core/library",'sap/base/Log'],function(C,F,a,V,M,f,b,c,d,L){"use strict";var T=d.TitleLevel;var e=c.extend("sap.ui.fl.variants.VariantManagement",{metadata:{interfaces:["sap.m.IOverflowToolbarContent"],library:"sap.ui.fl",designtime:"sap/ui/fl/designtime/variants/VariantManagement.designtime",properties:{updateVariantInURL:{type:"boolean",group:"Misc",defaultValue:false},resetOnContextChange:{type:"boolean",group:"Misc",defaultValue:true},modelName:{type:"string",group:"Misc",defaultValue:""},editable:{type:"boolean",group:"Misc",defaultValue:true},showSetAsDefault:{type:"boolean",group:"Misc",defaultValue:true},manualVariantKey:{type:"boolean",group:"Misc",defaultValue:false},inErrorState:{type:"boolean",group:"Misc",defaultValue:false},executeOnSelectionForStandardDefault:{type:"boolean",group:"Misc",defaultValue:false},displayTextForExecuteOnSelectionForStandardVariant:{type:"string",group:"Misc",defaultValue:""},headerLevel:{type:"sap.ui.core.TitleLevel",group:"Appearance",defaultValue:T.Auto}},events:{initialized:{},save:{parameters:{name:{type:"string"},overwrite:{type:"boolean"},key:{type:"string"},execute:{type:"boolean"},'public':{type:"boolean"},def:{type:"boolean"},tile:{type:"boolean"}}},cancel:{},manage:{parameters:{renamed:{type:"object[]"},deleted:{type:"string[]"},exe:{type:"object[]"},def:{type:"string"}}},select:{parameters:{key:{type:"string"}}}},associations:{"for":{type:"sap.ui.core.Control",multiple:true}},aggregations:{_embeddedVM:{type:"sap.m.VariantManagement",multiple:false,visibility:"hidden"}}},renderer:{apiVersion:2,render:function(r,o){r.openStart("div",o);r.openEnd();r.renderControl(o._oVM);r.close("div");}}});e.prototype.init=function(){c.prototype.init.apply(this);this.addStyleClass("sapUiFlVarMngmt");this._oRb=sap.ui.getCore().getLibraryResourceBundle("sap.ui.fl");this.setModelName(f.VARIANT_MODEL_NAME);this.attachModelContextChange(this._setModel,this);this._oVM=new M(this.getId()+"-vm");this.setAggregation("_embeddedVM",this._oVM,true);this._aCancelEventHandlers=[];this._aSaveEventHandlers=[];this._aManageEventHandlers=[];this._aSelectEventHandlers=[];this._oVM.attachManage(this._fireManage,this);this._oVM.attachCancel(this._fireCancel,this);this._oVM.attachSave(this._fireSave,this);this._oVM.attachSelect(this._fireSelect,this);this._updateWithSettingsInfo();};e.prototype.getOverflowToolbarConfig=function(){return{canOverflow:false,invalidationEvents:["save","manage","select"]};};e.prototype.attachCancel=function(p,g,o){this.attachEvent("cancel",p,g,o);return this;};e.prototype._findCallback=function(A,g,o){var m=-1;A.some(function(E,n){if((E.fCallback===g)&&(E.oObj===o)){m=n;}return(m>=0);});return m;};e.prototype.detachCancel=function(g,o){var n=this._findCallback(this._aCancelEventHandlers,g,o);if(n>=0){this.detachEvent("cancel",g,o);this._aCancelEventHandlers.splice(n,1);}return this;};e.prototype.fireManage=function(E){this._oVM.fireManage(E);};e.prototype.fireSave=function(E){this._oVM.fireSave(E);};e.prototype._fireCancel=function(E){for(var i=0;i<this._aCancelEventHandlers.length;i++){E.oSource=this;this._aCancelEventHandlers[i].fCallbackBound(E,this._aCancelEventHandlers[i].mProps);}};e.prototype.attachSave=function(p,g,o){this.attachEvent("save",p,g,o);return this;};e.prototype.detachSave=function(g,o){var n=this._findCallback(this._aSaveEventHandlers,g,o);if(n>-1){this.detachEvent("save",g,o);this._aSaveEventHandlers.splice(n,1);}return this;};e.prototype._fireSave=function(E){this._handleAllListeners(E,this._aSaveEventHandlers);};e.prototype.hasListeners=function(E){var i=["save","select","cancel","manage"];if(i.indexOf(E)>-1){var g=null;if(E==="select"){g=this._aSelectEventHandlers;}else if(E==="save"){g=this._aSaveEventHandlers;}else if(E==="manage"){g=this._aManageEventHandlers;}else if(E==="cancel"){g=this._aCancelEventHandlers;}return(g.length>0);}return c.prototype.hasListeners.apply(this,arguments);};e.prototype.attachEvent=function(E,p,g,o){var i=["save","select","cancel","manage"];if(i.indexOf(E)>-1){var h=null;var j=g;if(typeof(p)==="function"){j=p;o=g;p=undefined;}o=o===this?undefined:o;if(E==="select"){h=this._aSelectEventHandlers;}else if(E==="save"){h=this._aSaveEventHandlers;}else if(E==="manage"){h=this._aManageEventHandlers;}else if(E==="cancel"){h=this._aCancelEventHandlers;}h.push({fCallback:j,fCallbackBound:o?j.bind(o):j,oObj:o,mProps:p});}else{c.prototype.attachEvent.apply(this,arguments);}};e.prototype.attachEventOnce=function(E,p,g,o){var n;if(E==="manage"){n=this._findCallback(this._aManageEventHandlers,g,o);if((n>-1)&&this._aManageEventHandlers[n].bOnce){this._aManageEventHandlers.splice(n,1);}this.attachManage(p,g,o);n=this._findCallback(this._aManageEventHandlers,g,o);if(n>-1){this._aManageEventHandlers[n].bOnce=true;}}else if(E==="save"){n=this._findCallback(this._aSaveEventHandlers,g,o);if((n>-1)&&this._aSaveEventHandlers[n].bOnce){this._aSaveEventHandlers.splice(n,1);}this.attachSave(p,g,o);n=this._findCallback(this._aSaveEventHandlers,g,o);if(n>-1){this._aSaveEventHandlers[n].bOnce=true;}}else if(E==="select"){n=this._findCallback(this._aSelectEventHandlers,g,o);if((n>-1)&&this._aSelectEventHandlers[n].bOnce){this._aSelectEventHandlers.splice(n,1);}this.attachSelect(p,g,o);n=this._findCallback(this._aSelectEventHandlers,g,o);if(n>-1){this._aSelectEventHandlers[n].bOnce=true;}}else{c.prototype.attachEventOnce.apply(this,arguments);}};e.prototype.attachManage=function(p,g,o){this.attachEvent("manage",p,g,o);return this;};e.prototype._handleAllListeners=function(E,g){var i=0;var o=[];while(i<g.length){E.oSource=this;g[i].fCallbackBound(E,g[i].mProps);if(g[i]){if(g[i].hasOwnProperty("bOnce")&&g[i].bOnce){o.push(i);}i+=1;}}for(i=o.length-1;i>-1;i--){g.splice(o[i],1);}};e.prototype._fireManage=function(E){this._handleAllListeners(E,this._aManageEventHandlers);};e.prototype.detachManage=function(g,o){var n=this._findCallback(this._aManageEventHandlers,g,o);if(n>-1){this.detachEvent("manage",g,o);this._aManageEventHandlers.splice(n,1);}return this;};e.prototype.attachSelect=function(p,g,o){this.attachEvent("select",p,g,o);return this;};e.prototype._fireSelect=function(E){this._handleAllListeners(E,this._aSelectEventHandlers);};e.prototype.detachSelect=function(g,o){var n=this._findCallback(this._aSelectEventHandlers,g,o);if(n>-1){this.detachEvent("select",g,o);this._aSelectEventHandlers.splice(n,1);}return this;};e.prototype._createSaveAsDialog=function(){this._oVM._createSaveAsDialog();};e.prototype._handleVariantSaveAs=function(n){this._oVM._handleVariantSaveAs(n);};e.prototype.getFocusDomRef=function(){if(this._oVM){return this._oVM.oVariantPopoverTrigger.getFocusDomRef();}return null;};e.prototype.getManageDialog=function(){if(this._oVM){return this._oVM.oManagementDialog;}return null;};e.prototype.getVariants=function(){var i=[];if(this.oContext&&this.oContext.getObject()){i=this.oContext.getObject().variants.filter(function(I){if(!I.hasOwnProperty("visible")){return true;}return I.visible;});}return i;};e.prototype.getTitle=function(){return this._oVM.getTitle();};e.prototype.setPopoverTitle=function(t){this._oVM.setPopoverTitle(t);return this;};e.prototype.setHeaderLevel=function(v){this.setProperty("headerLevel",v);this._oVM.setLevel(v);return this;};e.prototype.setEditable=function(v){this.setProperty("editable",v);this._oVM.setShowFooter(v);return this;};e.prototype.setShowExecuteOnSelection=function(v){this.setProperty("showExecuteOnSelection",v);this._oVM.setSupportApplyAutomatically(v);return this;};e.prototype.setShowSetAsDefault=function(v){this.setProperty("showSetAsDefault",v);this._oVM.setSupportDefault(v);return this;};e.prototype.setExecuteOnSelectionForStandardDefault=function(v){this.setProperty("executeOnSelectionForStandardDefault",v);this._oVM.setExecuteOnSelectionForStandardDefault(v);return this;};e.prototype.setDisplayTextForExecuteOnSelectionForStandardVariant=function(v){this.setProperty("displayTextForExecuteOnSelectionForStandardVariant",v);this._oVM.setDisplayTextForExecuteOnSelectionForStandardVariant(v);return this;};e.prototype.setManualVariantKey=function(v){this.setProperty("manualVariantKey",v);this._oVM._setShowManualVariantKey(v);return this;};e.prototype.setInErrorState=function(v){this.setProperty("inErrorState",v);this._oVM.setInErrorState(v);return this;};e.prototype.openManagementDialog=function(g,s,r){this._oVM.openManagementDialog(g,s,r);};e.prototype.openSaveAsDialogForKeyUser=function(s,r){this._oVM.openSaveAsDialog(s,r);};e.prototype.setEditable=function(v){this._oVM.setProperty("showFooter",v);return this;};e.prototype.setCurrentVariantKey=function(k){this._oVM.setSelectedKey(k);};e.prototype.getCurrentVariantKey=function(){return this._oVM.getSelectedKey();};e.prototype.setDefaultVariantKey=function(k){this._oVM.setDefaultKey(k);};e.prototype.getDefaultVariantKey=function(){return this._oVM.getDefaultKey();};e.prototype.getModified=function(){return this._oVM.getModified();};e.prototype.setModified=function(g){this._oVM.setModified(g);};e.prototype.getStandardVariantKey=function(){return this._oVM.getStandardVariantKey();};e.prototype._getEmbeddedVM=function(){return this._oVM;};e.prototype._updateWithSettingsInfo=function(){b.getInstance().then(function(s){if(this._oVM){this._oVM.setShowSaveAs(s.isVariantPersonalizationEnabled());this._oVM.setSupportPublic(s.isPublicFlVariantEnabled());}}.bind(this)).catch(function(E){L.error(E);});};e.prototype.getModelName=function(){return this.getProperty("modelName");};e.prototype.setModelName=function(m){if(this.getModelName()){this.oContext=null;this._aCancelEventHandlers=[];this._aSaveEventHandlers=[];this._aManageEventHandlers=[];this._aSelectEventHandlers=[];}this.setProperty("modelName",m);return this;};e.prototype._setModel=function(){this._setBindingContext();};e.prototype._setBindingContext=function(){var m;var l;var s=this.getModelName();if(!this.oContext){m=this.getModel(s);if(m){l=this._getLocalId(m);if(l){this.oContext=new C(m,"/"+l);this.setBindingContext(this.oContext,s);if(m.registerToModel){m.registerToModel(this);}this.fireInitialized();this._oVM.setModel(m,s);this._oVM.setSupportDefault(true);this._createItemsModel(s);this._oVM.bindProperty("selectedKey",{path:this.oContext+"/currentVariant",model:s});this._oVM.bindProperty("defaultKey",{path:this.oContext+"/defaultVariant",model:s});this._oVM.bindProperty("modified",{path:this.oContext+"/modified",model:s});this._oVM.bindProperty("supportFavorites",{path:this.oContext+"/showFavorites",model:s});this._oVM.bindProperty("supportApplyAutomatically",{path:this.oContext+"/showExecuteOnSelection",model:s});this._oVM.bindProperty("showFooter",{path:this.oContext+"/variantsEditable",model:s});this._oVM.setPopoverTitle(this._oRb.getText("VARIANT_MANAGEMENT_VARIANTS"));}}}};e.prototype._createItemsModel=function(m){var i=new V({key:"{"+m+">key}",title:"{"+m+">title}",sharing:"{"+m+">sharing}",remove:"{"+m+">remove}",favorite:"{"+m+">favorite}",originalFavorite:"{"+m+">originalFavorite}",executeOnSelect:"{"+m+">executeOnSelect}",originalExecuteOnSelect:"{"+m+">originalExecuteOnSelect}",rename:"{"+m+">rename}",originalTitle:"{"+m+">originalTitle}",visible:"{"+m+">visible}",changeable:"{"+m+">change}",author:"{"+m+">author}",contexts:"{"+m+">contexts}",originalContexts:"{"+m+">originalContexts}"});this._oVM.bindAggregation("items",{path:this.oContext+"/variants",model:m,template:i,filters:new F({path:"visible",operator:a.EQ,value1:true})});};e.prototype._getLocalId=function(m){var s=this.getModelName();if(!s){return null;}if(s!==f.VARIANT_MODEL_NAME){return this.getId();}return m.getVariantManagementReferenceForControl(this);};e.prototype._getInnerItems=function(){var i=[];if(this.oContext&&this.oContext.getObject()){i=this.oContext.getObject().variants.filter(function(I){if(!I.hasOwnProperty("visible")){return true;}return I.visible;});}return i;};e.prototype._getInnerItemByKey=function(k){var i=null;var I=this._getInnerItems();I.some(function(E){if(E.key===k){i=E;}return(i!==null);});return i;};e.prototype.registerApplyAutomaticallyOnStandardVariant=function(g){this._fRegisteredApplyAutomaticallyOnStandardVariant=g;return this;};e.prototype.getApplyAutomaticallyOnVariant=function(v){var E=false;if(v){E=v.executeOnSelect;if(this._fRegisteredApplyAutomaticallyOnStandardVariant&&this.getDisplayTextForExecuteOnSelectionForStandardVariant()&&(v.key===this._oVM.getStandardVariantKey())){try{E=this._fRegisteredApplyAutomaticallyOnStandardVariant(v);}catch(g){L.error("callback for determination of apply automatically on standard variant failed");}}}return E;};e.prototype.exit=function(){this._oVM.detachManage(this._fireManage,this);this._oVM.detachCancel(this._fireCancel,this);this._oVM.detachSelect(this._fireSelect,this);this._oVM.detachSave(this._fireSave,this);c.prototype.exit.apply(this,arguments);this._oVM=undefined;this._fRegisteredApplyAutomaticallyOnStandardVariant=null;this.oContext=undefined;this._oRb=undefined;this._aCancelEventHandlers=undefined;this._aSaveEventHandlers=undefined;this._aManageEventHandlers=undefined;this._aSelectEventHandlers=undefined;};e.prototype.addFor=function(v){this.addAssociation("for",v);return this;};return e;});
