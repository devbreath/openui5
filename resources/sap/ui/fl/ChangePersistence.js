/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_union","sap/base/util/includes","sap/base/util/merge","sap/base/util/UriParameters","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Component","sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/apply/_internal/changes/Utils","sap/ui/fl/apply/_internal/flexObjects/FlexObject","sap/ui/fl/apply/_internal/flexObjects/FlexObjectFactory","sap/ui/fl/apply/_internal/flexState/changes/DependencyHandler","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagementState","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/initial/_internal/StorageUtils","sap/ui/fl/registry/Settings","sap/ui/fl/write/_internal/condenser/Condenser","sap/ui/fl/write/_internal/Storage","sap/ui/fl/write/api/Version","sap/ui/fl/Cache","sap/ui/fl/Change","sap/ui/fl/LayerUtils","sap/ui/fl/Layer","sap/ui/fl/Utils","sap/ui/model/json/JSONModel","sap/ui/performance/Measurement"],function(u,i,m,U,L,J,C,A,a,F,b,D,V,c,S,d,e,f,g,h,j,k,l,n,o,M){"use strict";var p=function(Q){this._mComponent=Q;this._mChanges=D.createEmptyDependencyMap();this._bChangesMapCreated=false;this._mChangesInitial=m({},this._mChanges);if(!this._mComponent||!this._mComponent.name){L.error("The Control does not belong to an SAPUI5 component. Personalization and changes for this control might not work as expected.");throw new Error("Missing component name.");}this._aDirtyChanges=[];this._oMessagebundle=undefined;this._mChangesEntries={};this._bHasChangesOverMaxLayer=false;this.HIGHER_LAYER_CHANGES_EXIST="higher_layer_changes_exist";};function q(Q,R){var T;if(R instanceof j||R instanceof F){T=R;this._mChangesEntries[T.getId()]=T;}else{if(!this._mChangesEntries[R.fileName]){if(R.changeType==="codeExt"){this._mChangesEntries[R.fileName]=b.createFromFileContent(R);}else{this._mChangesEntries[R.fileName]=new j(R);}}T=this._mChangesEntries[R.fileName];T.setState(j.states.PERSISTED);}return T;}p.prototype.getComponentName=function(){return this._mComponent.name;};p.prototype.getCacheKey=function(Q){return h.getCacheKey(this._mComponent,Q);};function r(Q){var R=Q instanceof j?Q.getDefinition():Q;var T=false;if((R.fileType==="ctrl_variant")||(R.fileType==="ctrl_variant_change")||(R.fileType==="ctrl_variant_management_change")){T=R.variantManagementReference||R.variantReference||(R.selector&&R.selector.id);}return R.fileType==="change"||T;}p.prototype.getChangesForComponent=function(Q,R){return n.getUShellService("URLParsing").then(function(T){this._oUShellURLParsingService=T;return h.getChangesFillingCache(this._mComponent,Q,R);}.bind(this)).then(function(Q,W){var T=m({},W);var X=Q&&Q.component&&n.getAppComponentForControl(Q.component);var Y=S.isStorageResponseFilled(T.changes);if(!Y){return[];}var Z=T.changes.changes;if(!this._oMessagebundle&&T.messagebundle&&X){if(!X.getModel("i18nFlexVendor")){if(Z.some(function(e1){return e1.layer===l.VENDOR;})){this._oMessagebundle=T.messagebundle;var $=new o(this._oMessagebundle);X.setModel($,"i18nFlexVendor");}}}var _=Q&&Q.currentLayer;var a1=!(Q&&Q.ignoreMaxLayerParameter);var b1=function(){return true;};if(_){Z=k.filterChangeOrChangeDefinitionsByCurrentLayer(Z,_);}else if(k.isLayerFilteringRequired(this._oUShellURLParsingService)&&a1){b1=s.bind(this);Z=Z.filter(b1);}else if(this._bHasChangesOverMaxLayer&&!a1){this._bHasChangesOverMaxLayer=false;return this.HIGHER_LAYER_CHANGES_EXIST;}var c1=T.changes&&Q&&Q.includeCtrlVariants;var d1=this._getAllCtrlVariantChanges(T,c1,b1);Z=Z.concat(d1);return this._checkAndGetChangeInstances(Z,T);}.bind(this,Q));};p.prototype._checkAndGetChangeInstances=function(Q,R){return Q.filter(r).map(q.bind(this,R));};function s(Q){if(k.isOverMaxLayer(t(Q),this._oUShellURLParsingService)){if(!this._bHasChangesOverMaxLayer){this._bHasChangesOverMaxLayer=true;}return false;}return true;}function t(Q){var R;if(typeof Q.isA==="function"&&(Q.isA("sap.ui.fl.apply._internal.flexObjects.FlVariant")||Q.isA("sap.ui.fl.Change"))){R=Q.getLayer();}else{R=Q.layer;}return R;}p.prototype._getAllCtrlVariantChanges=function(Q,R,T){if(!R){return V.getInitialChanges({reference:this._mComponent.name});}return["variants","variantChanges","variantDependentControlChanges","variantManagementChanges"].reduce(function(W,X){if(Q.changes[X]){return W.concat(Q.changes[X]);}return W;},[]).filter(T);};p.prototype.loadChangesMapForComponent=function(Q){return this.getChangesForComponent({component:Q}).then(R.bind(this));function R(T){M.start("fl.createDependencyMap","Measurement of creating initial dependency map");this._mChanges=D.createEmptyDependencyMap();T.forEach(this.addChangeAndUpdateDependencies.bind(this,Q));this._mChangesInitial=m({},this._mChanges);M.end("fl.createDependencyMap","Measurement of creating initial dependency map");this._bChangesMapCreated=true;return this.getChangesMapForComponent.bind(this);}};p.prototype.checkForOpenDependenciesForControl=function(Q,R){return D.checkForOpenDependenciesForControl(this._mChanges,J.getControlIdBySelector(Q,R),R);};function v(Q){var R=m({},this._mChangesInitial.mDependencies);return R[Q.getId()];}function w(Q,R,T,W){var X;var Y=[];Q.controlsDependencies.forEach(function(Z){if(!J.bySelector(Z,T)){X=J.getControlIdBySelector(Z,T);Y.push(Z);this._mChanges.mControlsWithDependencies[X]=this._mChanges.mControlsWithDependencies[X]||[];if(!i(this._mChanges.mControlsWithDependencies[X],W.getId())){this._mChanges.mControlsWithDependencies[X].push(W.getId());}}}.bind(this));Q.dependencies=R;Q.controlsDependencies=Y;if(R.length||Y.length){this._mChanges.mDependencies[W.getId()]=Q;}}p.prototype.copyDependenciesFromInitialChangesMapSync=function(Q,R,T){var W=v.call(this,Q);if(W){var X=[];W.dependencies.forEach(function(Y){if(R(Y)){this._mChanges.mDependentChangesOnMe[Y]=this._mChanges.mDependentChangesOnMe[Y]||[];this._mChanges.mDependentChangesOnMe[Y].push(Q.getId());X.push(Y);}}.bind(this));w.call(this,W,X,T,Q);}return this._mChanges;};p.prototype.copyDependenciesFromInitialChangesMap=function(Q,R,T){var W=v.call(this,Q);if(W){var X=[];return W.dependencies.reduce(function(Y,Z){return Y.then(function(){return R(Z);}).then(function($){if($){this._mChanges.mDependentChangesOnMe[Z]=this._mChanges.mDependentChangesOnMe[Z]||[];this._mChanges.mDependentChangesOnMe[Z].push(Q.getId());X.push(Z);}}.bind(this));}.bind(this),Promise.resolve()).then(function(){w.call(this,W,X,T,Q);return this._mChanges;}.bind(this));}return Promise.resolve(this._mChanges);};p.prototype.addChangeAndUpdateDependencies=function(Q,R,T){R.setInitialApplyState();if(T){D.insertChange(R,this._mChanges,T);}D.addChangeAndUpdateDependencies(R,Q,this._mChanges);};p.prototype._addRunTimeCreatedChangeAndUpdateDependencies=function(Q,R){D.addRuntimeChangeAndUpdateDependencies(R,Q,this._mChanges,this._mChangesInitial);};p.prototype.getChangesMapForComponent=function(){return this._mChanges;};p.prototype.getAllUIChanges=function(Q){var R=u(this.getChangesMapForComponent().aChanges,Q.includeDirtyChanges&&this.getDirtyChanges()).filter(function(T){return(Boolean(T)&&T.getFileType()==="change"&&k.compareAgainstCurrentLayer(T.getLayer(),Q.layer)===0);});return R;};p.prototype.isChangeMapCreated=function(){return this._bChangesMapCreated;};p.prototype.getChangesForView=function(Q){return this.getChangesForComponent(Q).then(function(R){return R.filter(a.filterChangeByView.bind(undefined,Q));});};p.prototype.addChange=function(Q,R){var T=this.addDirtyChange(Q);this._addRunTimeCreatedChangeAndUpdateDependencies(R,T);this._mChangesEntries[T.getId()]=T;this._addPropagationListener(R);return T;};p.prototype.addDirtyChange=function(Q){var R;if(typeof Q.isA==="function"&&(Q.isA("sap.ui.fl.Change")||Q.isA("sap.ui.fl.apply._internal.flexObjects.FlexObject"))){R=Q;}else{R=new j(Q);}if(this._aDirtyChanges.indexOf(R)===-1){this._aDirtyChanges.push(R);}return R;};p.prototype._addPropagationListener=function(Q){var R=n.getAppComponentForControl(Q);if(R instanceof C){var T=function(Z){return!Z._bIsSapUiFlFlexControllerApplyChangesOnControl;};var W=R.getPropagationListeners().every(T);if(W){var X=sap.ui.require("sap/ui/fl/FlexControllerFactory");var Y=X.create(this.getComponentName());var Z=A.applyAllChangesForControl.bind(A,this.getChangesMapForComponent.bind(this),R,Y);Z._bIsSapUiFlFlexControllerApplyChangesOnControl=true;R.addPropagationListener(Z);}}};p.prototype._deleteNotSavedChanges=function(Q,R,T){Q.filter(function(W){return!R.some(function(X){return W.getId()===X.getId();});}).forEach(function(W){if(T){this.removeChange(W);h.deleteChange(this._mComponent,W.getDefinition());}else{this.deleteChange(W);}}.bind(this));};function x(Q,R){var T=Q.map(function(X){return X[R]();});var W=T.filter(function(X,Y,T){return T.indexOf(X)===Y;});return W.length===1;}function y(Q,R){var T=false;if(!Q||R.length<2||!x(R,"getLayer")){return false;}var W=R[0].getLayer();if([l.CUSTOMER,l.USER].includes(W)){T=true;}var X=U.fromURL(window.location.href);if(X.has("sap-ui-xx-condense-changes")){T=X.get("sap-ui-xx-condense-changes")==="true";}return T;}function z(Q){var R=d.getInstanceOrUndef()&&d.getInstanceOrUndef().isCondensingEnabled();if(R&&!x(Q,"getNamespace")){R=false;}return R;}function B(Q,R,T,W){this._massUpdateCacheAndDirtyState(R,T);this._deleteNotSavedChanges(Q,R,W);}function E(Q,R){if(!Q.length){return[];}var T=Q[0].getLayer();var W=this._mChanges.aChanges.filter(function(X){if(T===l.CUSTOMER&&R){return X.getState()===j.states.PERSISTED&&R.includes(X.getId());}return X.getState()===j.states.PERSISTED&&k.compareAgainstCurrentLayer(X.getLayer(),T)===0;});return W.concat(Q);}p.prototype.saveDirtyChanges=function(Q,R,T,W,X){var Y=T||this._aDirtyChanges;var Z=E.call(this,Y,X);var $=(z(Z)&&y(Q,Z));var _=$?Z:Y;var a1=_.slice(0);var b1=Y.slice(0);var c1=H(Y);var d1=I(Y);if(d1.length===1&&c1.length===1&&d1[0]===j.states.NEW){var e1=Promise.resolve(a1);if(y(Q,a1)){e1=e.condense(Q,a1);}return e1.then(function(f1){var g1=c1[0];var h1=Y[0].getLayer();if($){return f.condense({allChanges:_,condensedChanges:f1,layer:h1,transport:g1,isLegacyVariant:false,parentVersion:W}).then(function(i1){B.call(this,_,f1,R,true);return i1;}.bind(this));}if(f1.length){return f.write({layer:h1,flexObjects:K(f1),transport:g1,isLegacyVariant:false,parentVersion:W}).then(function(i1){B.call(this,_,f1,R);return i1;}.bind(this));}this._deleteNotSavedChanges(_,f1);}.bind(this));}return this.saveSequenceOfDirtyChanges(b1,R,W);};p.prototype.saveSequenceOfDirtyChanges=function(Q,R,T){var W;if(T){var X=Q.filter(function(Y){return Y.getState()===j.states.NEW;});W=[].concat(X).shift();}return Q.reduce(function(Y,Z){return Y.then(G.bind(undefined,Z,W,T)).then(this._updateCacheAndDirtyState.bind(this,Z,R));}.bind(this),Promise.resolve());};function G(Q,R,T){switch(Q.getState()){case j.states.NEW:if(T!==undefined){T=Q===R?T:g.Number.Draft;}return f.write({layer:Q.getLayer(),flexObjects:[Q.getDefinition()],transport:Q.getRequest(),parentVersion:T});case j.states.DELETED:return f.remove({flexObject:Q.getDefinition(),layer:Q.getLayer(),transport:Q.getRequest(),parentVersion:T});default:}}p.prototype._updateCacheAndDirtyState=function(Q,R){this._aDirtyChanges=this._aDirtyChanges.filter(function(T){return Q.getId()!==T.getId();});if(!R){if(n.isChangeRelatedToVariants(Q)){V.updateVariantsState({reference:this._mComponent.name,changeToBeAddedOrDeleted:Q});}else{switch(Q.getState()){case j.states.NEW:Q.setState(j.states.PERSISTED);h.addChange(this._mComponent,Q.convertToFileContent());break;case j.states.DELETED:h.deleteChange(this._mComponent,Q.convertToFileContent());break;case j.states.DIRTY:Q.setState(j.states.PERSISTED);h.updateChange(this._mComponent,Q.convertToFileContent());break;}}}};p.prototype._massUpdateCacheAndDirtyState=function(Q,R){Q.forEach(function(T){this._updateCacheAndDirtyState(T,R);},this);};function H(Q){var R=[];Q.forEach(function(T){var W=T.getRequest();if(R.indexOf(W)===-1){R.push(W);}});return R;}function I(Q){var R=[];Q.forEach(function(T){var W=T.getState();if(R.indexOf(W)===-1){R.push(W);}});return R;}function K(Q){var R=[];Q.forEach(function(T){R.push(T.convertToFileContent());});return R;}p.prototype.getDirtyChanges=function(){return this._aDirtyChanges;};p.prototype.deleteChange=function(Q,R){var T=this._aDirtyChanges.indexOf(Q);if(T>-1){if(Q.getState()===j.states.DELETED){return;}this._aDirtyChanges.splice(T,1);this._deleteChangeInMap(Q,R);return;}Q.markForDeletion();this.addDirtyChange(Q);this._deleteChangeInMap(Q,R);};p.prototype.removeChange=function(Q){var R=this._aDirtyChanges.indexOf(Q);if(R>-1){this._aDirtyChanges.splice(R,1);}this._deleteChangeInMap(Q);};p.prototype._deleteChangeInMap=function(Q,R){var T=Q.getId();D.removeChangeFromMap(this._mChanges,T);D.removeChangeFromDependencies(R?this._mChangesInitial:this._mChanges,T);};function N(Q,R){return(R.getRequest()==="$TMP"||R.getRequest()==="")&&R.getLayer()===Q;}function O(Q,R){return R.getState()===j.states.PERSISTED&&R.getLayer()===Q;}function P(){var Q=[];var R=c.getCompVariantsMap(this.getComponentName());for(var T in R){for(var W in R[T].byId){Q.push(R[T].byId[W]);}}return Q;}p.prototype.transportAllUIChanges=function(R,Q,T,W){return this.getChangesForComponent({currentLayer:T,includeCtrlVariants:true}).then(function(X){var Y=P.call(this);X=X.concat(Y.filter(N.bind(this,T)));return f.publish({transportDialogSettings:{rootControl:R,styleClass:Q},layer:T,reference:this.getComponentName(),localChanges:X,appVariantDescriptors:W});}.bind(this));};p.prototype._getChangesFromMapByNames=function(Q){return this._mChanges.aChanges.filter(function(R){return Q.indexOf(R.getId())!==-1;});};p.prototype.removeDirtyChanges=function(Q,R,T,W,X){var Y=[].concat(Q||[]);var Z=this._aDirtyChanges;var $=Z.filter(function(_){var a1=true;if(Y.length&&!Y.includes(_.getLayer())){return false;}if(W&&_.getDefinition().support.generator!==W){return false;}if(T){var b1=_.getSelector();a1=T.getId()===J.getControlIdBySelector(b1,R);}if(X){a1=a1&&X.indexOf(_.getChangeType())!==-1;}return a1;});$.forEach(function(_){var a1=Z.indexOf(_);Z.splice(a1,1);});return Promise.resolve($);};p.prototype.resetChanges=function(Q,R,T,W){var X=T&&T.length>0;var Y=W&&W.length>0;var Z=d.getInstanceOrUndef()&&d.getInstanceOrUndef().isPublicLayerAvailable();var $=R===undefined&&T===undefined&&W===undefined;var _=[];if(Z&&$){_=P.call(this).filter(O.bind(this,Q));}return this.getChangesForComponent({currentLayer:Q,includeCtrlVariants:true}).then(function(a1){a1=a1.concat(_);var b1={reference:this.getComponentName(),layer:Q,changes:a1};if(R){b1.generator=R;}if(X){b1.selectorIds=T;}if(Y){b1.changeTypes=W;}return f.reset(b1);}.bind(this)).then(function(a1){var b1=[];if(T||W){var c1=[];if(a1&&a1.response&&a1.response.length>0){a1.response.forEach(function(d1){c1.push(d1.fileName);});}h.removeChanges(this._mComponent,c1);b1=this._getChangesFromMapByNames(c1);}return b1;}.bind(this));};return p;});
