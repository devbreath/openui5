/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/LayerUtils","sap/ui/fl/Layer","sap/ui/fl/Utils","sap/ui/fl/write/api/Version","sap/ui/fl/write/api/VersionsAPI","sap/ui/fl/write/api/FeaturesAPI","sap/ui/fl/write/api/PersistenceWriteAPI","sap/ui/fl/write/_internal/FlexInfoSession"],function(L,a,U,V,b,F,P,c){"use strict";var m={flp:{set:function(p,k,v){p[k]=[v];return p;},get:function(p,k){return p[k]&&p[k][0];},remove:function(p,k){delete p[k];return p;}},standalone:{set:function(p,k,v){return U.handleUrlParameters(p,k,v);},get:function(p,k){return U.getParameter(k);},remove:function(p,k,v){return U.handleUrlParameters(p,k,v);}}};function i(r){var u=!!U.getParameter(V.UrlParameter,r.URLParsingService);if(u){return Promise.resolve(false);}return F.isVersioningEnabled(r.layer).then(function(v){return v&&b.isDraftAvailable({control:r.selector,layer:r.layer});});}function d(r){var u=this.hasMaxLayerParameterWithValue({value:r.layer},r.URLParsingService);var f=r.layer===a.USER;if(f||u){return Promise.resolve(false);}return P.hasHigherLayerChanges({selector:r.selector,ignoreMaxLayerParameter:r.ignoreMaxLayerParameter,upToLayer:r.layer,includeCtrlVariants:r.includeCtrlVariants,includeDirtyChanges:true});}function n(r){var f=c.get(r.selector);if(f&&f.initialAllContexts){return false;}if(f===null||f.allContextsProvided===undefined){var p={selector:r.selector,layer:r.layer};return P.getResetAndPublishInfo(p).then(function(o){if(f===null||!f.initialAllContexts){o.initialAllContexts=true;}c.set(o,r.selector);return!o.allContextsProvided;});}f.initialAllContexts=true;c.set(f,r.selector);return!f.allContextsProvided;}function e(C){var f=c.get(C);return f&&!f.allContextsProvided;}var R={getReloadReasonsForStart:function(r){return Promise.all([d.call(this,r),i(r),n(r)]).then(function(f){r.hasHigherLayerChanges=f[0];r.isDraftAvailable=f[1];r.allContexts=f[2];return r;});},hasVersionParameterWithValue:function(p,u){return U.hasParameterAndValue(V.UrlParameter,p.value,u);},removeInfoSessionStorage:function(C){c.remove(C);},hasMaxLayerParameterWithValue:function(p,u){var s=L.FL_MAX_LAYER_PARAM;return U.hasParameterAndValue(s,p.value,u);},handleUrlParameters:function(r,s){var p=false;if(!r.ignoreMaxLayerParameter&&r.hasHigherLayerChanges){r.parameters=m[s].remove(r.parameters,L.FL_MAX_LAYER_PARAM,r.layer);p=true;}var C=m[s].get(r.parameters,V.UrlParameter);if(r.versionSwitch&&C!==r.version){r.parameters=m[s].remove(r.parameters,V.UrlParameter,C);r.parameters=m[s].set(r.parameters,V.UrlParameter,r.version);p=true;}if(C&&r.removeVersionParameter||C===V.Number.Draft&&r.removeDraft){r.parameters=m[s].remove(r.parameters,V.UrlParameter,C);p=true;}return p;},handleParametersOnStart:function(r,s){var p=false;if(r.hasHigherLayerChanges){r.parameters=m[s].set(r.parameters,L.FL_MAX_LAYER_PARAM,r.layer);p=true;}if(r.isDraftAvailable){r.parameters=m[s].set(r.parameters,V.UrlParameter,V.Number.Draft);p=true;}return p;},initialDraftGotActivated:function(r){if(r.versioningEnabled){var u=this.hasVersionParameterWithValue({value:V.Number.Draft},r.URLParsingService);return!b.isDraftAvailable({control:r.selector,layer:r.layer})&&u;}return false;},getReloadMethod:function(r){var o={NOT_NEEDED:"NO_RELOAD",RELOAD_PAGE:"HARD_RELOAD",VIA_HASH:"CROSS_APP_NAVIGATION"};r.reloadMethod=o.NOT_NEEDED;r.isDraftAvailable=r.isDraftAvailable||R.hasVersionParameterWithValue({value:V.Number.Draft},r.URLParsingService);r.hasVersionUrlParameter=!!U.getParameter(V.UrlParameter,r.URLParsingService);if(r.activeVersion&&r.activeVersion!==V.Number.Original&&r.hasVersionUrlParameter){r.activeVersionNotSelected=!R.hasVersionParameterWithValue({value:r.activeVersion},r.URLParsingService);}r.hasHigherLayerChanges=R.hasMaxLayerParameterWithValue({value:r.layer},r.URLParsingService);r.initialDraftGotActivated=R.initialDraftGotActivated(r);if(r.initialDraftGotActivated){r.isDraftAvailable=false;}r.allContexts=e(r.selector);if(r.changesNeedReload||r.isDraftAvailable||r.hasHigherLayerChanges||r.initialDraftGotActivated||r.activeVersionNotSelected||r.allContexts){r.reloadMethod=o.RELOAD_PAGE;if(!r.changesNeedReload&&U.getUshellContainer()){r.reloadMethod=o.VIA_HASH;}}c.remove(r.selector);return r;}};return R;});
