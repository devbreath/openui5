/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/apply/_internal/flexState/ManifestUtils","sap/ui/fl/apply/_internal/flexObjects/States","sap/ui/fl/apply/_internal/ChangesController","sap/ui/fl/write/_internal/flexState/compVariants/CompVariantState","sap/ui/fl/apply/_internal/flexState/compVariants/CompVariantMerger","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagementState","sap/ui/fl/ChangePersistenceFactory","sap/ui/fl/LayerUtils","sap/ui/fl/apply/_internal/flexState/compVariants/Utils","sap/ui/fl/Utils"],function(_,F,M,S,C,a,b,V,c,L,d,U){"use strict";var e={};function i(p){p.reference=M.getFlexReferenceForControl(p.selector);return F.initialize({componentId:p.componentId||U.getAppComponentForControl(p.selector).getId(),reference:p.reference,componentData:{},manifest:{}});}function g(p){var m=F.getCompVariantsMap(p.reference);var E=[];if(p.invalidateCache){var D=F.getInitialNonFlCompVariantData(p.reference);if(D){Object.keys(D).forEach(function(P){m._initialize(P,D[P].variants);b.merge(P,m[P],D[P].standardVariant);});}}for(var P in m){var l=m[P];for(var I in l.byId){E.push(l.byId[I]);}}return L.filterChangeOrChangeDefinitionsByCurrentLayer(E,p.currentLayer);}function s(p){var r=M.getFlexReferenceForControl(p.selector);return a.persistAll(r);}function f(p){if(!p.reference){var A=C.getAppComponentForSelector(p.selector);p.reference=M.getFlexReferenceForControl(A);}return c.getChangePersistenceForComponent(p.reference);}function h(l,o){var m=U.getAppComponentForControl(o);var n=m.getModel(U.VARIANT_MODEL_NAME);var p=n&&n.sFlexReference;var v=V.getVariantManagementReferences(p);if(v.length===0){return l;}var q=v.map(function(r){return n.getCurrentVariantReference(r);});return l.filter(function(r){return q.some(function(t){return r.getVariantReference()===t||!r.getVariantReference();});});}function j(p){var o=f(p);return o.getChangesForComponent(_(p,["invalidateCache","selector"]),p.invalidateCache).then(function(P){var D=[];if(p.includeDirtyChanges){D=o.getDirtyChanges();}var l=P.concat(D);if(p.onlyCurrentVariants){return h(l,p.selector);}return l;});}function k(p,A){var o=C.getFlexControllerInstance(p.selector);var D=C.getDescriptorFlexControllerInstance(p.selector);return o.saveAll(A,p.skipUpdateCache,p.draft,p.layer,p.removeOtherLayerChanges).then(D.saveAll.bind(D,A,p.skipUpdateCache,p.draft,p.layer,p.removeOtherLayerChanges));}e.getFlexObjects=function(p){return i(p).then(function(){return j(p);}).then(function(l){return g(p).concat(l);});};e.getDirtyFlexObjects=function(p){p.includeDirtyChanges=true;var o=f(p);var l=o.getDirtyChanges();var m=g(p);return l.concat(m).filter(function(n){return n.getState()!==S.PERSISTED;});};e.saveFlexObjects=function(p){var A=C.getAppComponentForSelector(p.selector);return Promise.all([s(p),k(p,A)]).then(function(){if(p.layer){p.currentLayer=p.layer;}p.componentId=A.getId();p.invalidateCache=true;return e.getFlexObjects(_(p,"skipUpdateCache"));});};return e;});
