/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/util/restricted/_pick","sap/base/util/UriParameters","sap/ui/fl/Change","sap/ui/fl/Layer","sap/ui/fl/Utils","sap/ui/fl/apply/_internal/flexObjects/CompVariant","sap/ui/fl/apply/_internal/flexObjects/CompVariantRevertData","sap/ui/fl/apply/_internal/flexObjects/FlexObjectFactory","sap/ui/fl/apply/_internal/flexObjects/RevertData","sap/ui/fl/apply/_internal/flexObjects/States","sap/ui/fl/apply/_internal/flexObjects/UpdatableChange","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/apply/_internal/flexState/compVariants/CompVariantMerger","sap/ui/fl/registry/Settings","sap/ui/fl/write/_internal/Storage","sap/ui/fl/write/_internal/Versions","sap/ui/fl/write/api/Version"],function(_,a,U,C,L,b,c,d,F,R,S,e,f,g,h,j,V,k){"use strict";function l(i,P){var E=m("/draftFilenames",P);if(E){return i.getState()===C.states.NEW||E.includes(i.getId());}return true;}function m(P,i){var i={reference:b.normalizeReference(i.reference),layer:i.layer};if(V.hasVersionsModel(i)){return V.getVersionsModel(i).getProperty(P);}return undefined;}function n(i,P){var E=i.getFlexObjectMetadata?i.getFlexObjectMetadata().changeType:i.getChangeType();if(!["defaultVariant","updateVariant"].includes(E)){return false;}var G=i.getLayer()===P.layer;var H=i.getPackage();var N=!H||H==="$TMP";return G&&N&&l(i,P);}function o(M,i){if(i.isVariant()){return M.variants;}var E=i.getChangeType();switch(E){case"defaultVariant":return M.defaultVariants;case"standardVariant":return M.standardVariants;default:return M.changes;}}function u(O,E){for(var i=0;i<O.length;i++){if(O[i].fileName===E.fileName){O.splice(i,1,E);break;}}}function p(i,E,P){return j.update({flexObject:i.convertToFileContent?i.convertToFileContent():i.getDefinition(),layer:i.getLayer(),transport:i.getRequest(),parentVersion:P}).then(function(G){if(G&&G.response){i.setResponse(G.response);if(P){V.onAllChangesSaved({reference:G.response.reference,layer:G.response.layer});}}else{i.setState(S.PERSISTED);}}).then(function(){var O=o(E.changes.comp,i);var G=i.convertToFileContent?i.convertToFileContent():i.getDefinition();u(O,G);return G;});}function r(O,E){for(var i=O.length-1;i>=0;i--){var G=O[i].fileName||(O[i].getId());if((G||O[i].getId())===E){O.splice(i,1);break;}}}function q(i,E){delete E.byId[i.getId()];if(i.getChangeType()==="standardVariant"){E.standardVariantChange=undefined;}else{r(o(E,i),i.getId());}}function s(i,E,G,P){var H=i.convertToFileContent?i.convertToFileContent():i.getDefinition();return j.remove({flexObject:H,layer:i.getLayer(),transport:i.getRequest(),parentVersion:P}).then(function(){q(i,E);}).then(function(){r(o(G.changes.comp,i),H.fileName);return H;});}function t(P){var i={};if(typeof(P.texts)==="object"){Object.keys(P.texts).forEach(function(E){i[E]={value:P.texts[E],type:"XFLD"};});}return i;}function v(i){return i&&[S.NEW,S.DIRTY,S.DELETED].includes(i.getState());}function w(i){return i.variants.concat(i.changes).concat(i.defaultVariants).concat(i.standardVariantChange);}function x(P){if(P.layer){return P.layer;}if(P.isUserDependent){return L.USER;}var i=U.fromQuery(window.location.search).get("sap-ui-layer")||"";i=i.toUpperCase();if(i){return i;}if(!P.fileType==="variant"){return L.CUSTOMER;}var E=h.getInstanceOrUndef().isPublicLayerAvailable();return E?L.PUBLIC:L.CUSTOMER;}function y(P){var i=f.getCompVariantsMap(P.reference)._getOrCreate(P.persistencyKey);return i.byId[P.id];}function z(i){if(i instanceof c){i.removeAllRevertData();}}function A(i,P){i.storeExecuteOnSelection(P.executeOnSelection);i.storeFavorite(P.favorite);i.storeContexts(P.contexts);i.storeName(P.name);i.storeContent(P.content||i.getContent());return i;}function B(i,P){i.setExecuteOnSelection(P.executeOnSelection);i.setFavorite(P.favorite);i.setContexts(P.contexts);i.setName(P.name);i.setContent(P.content||i.getContent());return i;}var D={};D.setDefault=function(P){var i={defaultVariantName:P.defaultVariantId};P.layer=P.layer||U.fromQuery(window.location.search).get("sap-ui-layer")||L.USER;var E=f.getCompVariantsMap(P.reference)._getOrCreate(P.persistencyKey);var G="defaultVariant";var H=E.defaultVariants;var I=H[H.length-1];if(!I||!n(I,P)){var J={fileName:b.createDefaultFileName(G),fileType:"change",changeType:G,layer:P.layer,content:i,namespace:b.createNamespace(P,"changes"),reference:P.reference,selector:{persistencyKey:P.persistencyKey},support:P.support||{}};J.support.generator=J.support.generator||"CompVariantState."+G;J.support.sapui5Version=sap.ui.version;I=new e(J);E.defaultVariants.push(I);E.byId[I.getId()]=I;I.addRevertInfo(new R({type:D.operationType.NewChange}));}else{I.addRevertInfo(new R({type:D.operationType.ContentUpdate,content:{previousState:I.getState(),previousContent:I.getContent()}}));I.setContent(i);}return I;};D.revertSetDefaultVariantId=function(P){var i=f.getCompVariantsMap(P.reference)._getOrCreate(P.persistencyKey);var E=i.defaultVariants;var G=E[E.length-1];var H=G.popLatestRevertInfo();if(H.getType()===D.operationType.ContentUpdate){G.setContent(H.getContent().previousContent);G.setState(H.getContent().previousState);}else{G.setState(C.states.DELETED);i.defaultVariants.pop();}};D.addVariant=function(P){if(!P){return undefined;}var i=P.changeSpecificData;i.layer=x(i);i.changeType=i.type;i.texts=t(i);var E=Object.assign({},i,_(P,"changeSpecificData"));var G=F.createCompVariant(E);var H=f.getCompVariantsMap(P.reference);var M=H._getOrCreate(P.persistencyKey);M.variants.push(G);M.byId[G.getId()]=G;return G;};D.updateVariant=function(P){function i(K,M){var O=K.getLayer()===M;var Q=K.getPackage();var T=!Q||Q==="$TMP";var W=K.getChanges().some(function(X){return X.getLayer()===M;});return K.getPersisted()&&O&&T&&!W&&l(K,P);}function E(K){return K.getChanges().reverse().find(function(O){return O.getChangeType()==="updateVariant"&&n(O,P);});}function G(P,K,O,Q){var T={type:O,change:Q,content:{previousState:K.getState(),previousContent:K.getContent(),previousFavorite:K.getFavorite(),previousExecuteOnSelection:K.getExecuteOnSelection(),previousContexts:K.getContexts(),previousName:K.getName()}};K.addRevertData(new d(T));}function H(P,K){G(P,K,D.operationType.ContentUpdate);if(P.executeOnSelection!==undefined){K.storeExecuteOnSelection(P.executeOnSelection);}if(P.favorite!==undefined){K.storeFavorite(P.favorite);}if(P.contexts){K.storeContexts(P.contexts);}if(P.name){K.storeName(P.name);}if(P.transportId){K.setRequest(P.transportId);}K.storeContent(P.content||K.getContent());}function I(P,K,O){var Q=O.getRevertData()||[];var T=O.getContent();var W={previousContent:Object.assign({},T),previousState:O.getState(),change:a(Object.assign({},P),["favorite","executeOnSelection","contexts","content","name"])};Q.push(W);O.setRevertData(Q);if(P.executeOnSelection!==undefined){T.executeOnSelection=P.executeOnSelection;}if(P.favorite!==undefined){T.favorite=P.favorite;}if(P.contexts){T.contexts=P.contexts;}if(P.content){T.variantContent=P.content;}if(P.name){T.texts={variantName:{value:P.name,type:"XFLD"}};}O.setContent(T);if(P.transportId){O.setRequest(P.transportId);}G(P,K,D.operationType.UpdateVariantViaChangeUpdate,O);g.applyChangeOnVariant(K,O);}function J(P,K){function O(T){var W=T.getDefinition();var X=f.getCompVariantsMap(T.getComponent());var Y=T.getSelector().persistencyKey;X[Y].changes.push(T);X[Y].byId[T.getId()]=T;return W;}var Q=C.createInitialFileContent({changeType:"updateVariant",layer:M,fileType:"change",reference:P.reference,packageName:P.packageName,content:{},selector:{persistencyKey:P.persistencyKey,variantId:K.getVariantId()}});["favorite","executeOnSelection","contexts"].forEach(function(W){if(P[W]!==undefined){Q.content[W]=P[W];}});if(P.content!==undefined){Q.content.variantContent=P.content;}if(P.name){Q.texts.variantName={value:P.name,type:"XFLD"};}var T=new C(Q);if(P.transportId){T.setRequest(P.transportId);}O(T);G(P,K,D.operationType.NewChange,T);g.applyChangeOnVariant(K,T);}var K=y(P);var M=x(P);if(i(K,M)){H(P,K);}else{var N=E(K);if(N){I(P,K,N);}else{J(P,K);}}return K;};D.operationType={StateUpdate:"StateUpdate",ContentUpdate:"ContentUpdate",NewChange:"NewChange",UpdateVariantViaChange:"UpdateVariantViaChange",UpdateVariantViaChangeUpdate:"UpdateVariantViaChangeUpdate"};D.removeVariant=function(P){var i=y(P);var E=i.getState();if(!P.revert){var G=new d({type:D.operationType.StateUpdate,content:{previousState:E}});i.addRevertData(G);}if(E===S.NEW){var H=f.getCompVariantsMap(P.reference);var I=H._getOrCreate(P.persistencyKey);q(i,I);return i;}i.markForDeletion();return i;};D.revert=function(P){function i(I){var K=I.getSelector().persistencyKey;var M=f.getCompVariantsMap(I.getComponent());delete M[K].byId[I.getId()];M[K].changes=M[K].changes.filter(function(N){return N!==I;});}var E=y(P);var G=E.getRevertData().pop();E.removeRevertData(G);var H=G.getContent();var I;switch(G.getType()){case D.operationType.ContentUpdate:A(E,Object.assign({name:H.previousName,content:H.previousContent,favorite:H.previousFavorite,executeOnSelection:H.previousExecuteOnSelection,contexts:H.previousContexts},a(P,["reference","persistencyKey","id"])));break;case D.operationType.NewChange:I=G.getChange();E.removeChange(I);i(I);B(E,Object.assign({name:H.previousName,content:H.previousContent,favorite:H.previousFavorite,executeOnSelection:H.previousExecuteOnSelection,contexts:H.previousContexts},a(P,["reference","persistencyKey","id"])));break;case D.operationType.UpdateVariantViaChangeUpdate:I=G.getChange();B(E,Object.assign({name:H.previousName,content:H.previousContent,favorite:H.previousFavorite,executeOnSelection:H.previousExecuteOnSelection,contexts:H.previousContexts},a(P,["reference","persistencyKey","id"])));var J=I.getRevertData().pop();I.setContent(J.previousContent);I.setState(J.previousState);break;case D.operationType.StateUpdate:default:break;}E.setState(H.previousState);return E;};D.overrideStandardVariant=function(P){var i=f.getCompVariantsMap(P.reference)[P.persistencyKey];var E=i.byId[i.standardVariant.getVariantId()];E.setExecuteOnSelection(!!P.executeOnSelection);var G=E.getChanges();E.removeAllChanges();G.forEach(function(H){g.applyChangeOnVariant(E,H);});};D.persist=function(P){function i(K,M,N){return j.write({flexObjects:[K.convertToFileContent?K.convertToFileContent():K.getDefinition()],layer:K.getLayer(),transport:K.getRequest(),isLegacyVariant:K.isVariant(),parentVersion:N}).then(function(O){if(O&&O.response&&O.response[0]){K.setResponse(O.response[0]);if(N){V.onAllChangesSaved({reference:O.response[0].reference,layer:O.response[0].layer});}}else{K.setState(S.PERSISTED);}}).then(function(){var O=K.convertToFileContent?K.convertToFileContent():K.getDefinition();o(M.changes.comp,K).push(O);return O;});}function E(K,J,M,N){switch(K.getState()){case S.NEW:z(K);return i(K,M,N);case S.DIRTY:z(K);return p(K,M,N);case S.DELETED:z(K);return s(K,J,M,N);default:break;}}var G=P.reference;var H=P.persistencyKey;var I=f.getCompVariantsMap(G);var J=I._getOrCreate(H);return f.getStorageResponse(G).then(function(K){var M=w(J).filter(v);var N=M.map(function(O,Q){if(Q===0){var T=m("/persistedVersion",{layer:O.getLayer(),reference:O.getFlexObjectMetadata?O.getFlexObjectMetadata().reference:O.getDefinition().reference});return E(O,J,K,T).then(function(){var N=M.map(function(O,Q){if(Q!==0){var W=T?k.Number.Draft:undefined;return E(O,J,K,W);}});return N;});}});return Promise.all(N);});};D.persistAll=function(i){var E=_(f.getCompVariantsMap(i),"_getOrCreate","_initialize");var P=Object.keys(E).map(function(G){return D.persist({reference:i,persistencyKey:G});});return Promise.all(P);};return D;});
